<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Theory type_Decls (Isabelle2019: June 2019)</title>
<link media="all" rel="stylesheet" type="text/css" href="isabelle.css"/>
</head>

<body>
<div class="head"><h1>Theory type_Decls</h1>

<span class="command">theory</span> <span class="name">type_Decls</span><br/>
<span class="keyword">imports</span> <a href="NonDetMonad_call.html"><span class="name">NonDetMonad_call</span></a> <a href="commfunc.html"><span class="name">commfunc</span></a><br/>

</div>
<div class="source">
<pre class="source"><span class="keyword1"><span class="command">theory</span></span><span> </span><span>type_Decls</span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lib/Monad_WP/NonDetMonad&quot;</span></span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;lib/Monad_WP/NonDetMonad_call&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;../common/commfunc&quot;</span></span></span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;data types definitions and states&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;System Data types&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>u16</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>u32</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>u64</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>i64</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>usize</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>isize</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>u8</span><span> </span><span class="delimiter">=</span><span> </span><span>char</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>vm_id</span><span> </span><span class="delimiter">=</span><span> </span><span>u64</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>cpu_id</span><span> </span><span class="delimiter">=</span><span> </span><span>u64</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>vcpu_num</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>region_num</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>page_num</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>region_size</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>page_free</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>page_last</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>mem_region_index</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>page_index</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span> 
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>bitmap_region</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; page_num &#8658; mem_region_index option  &quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>bitmap_heap</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; page_num &#8658; page_index option &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;GIC_SGIS_NUM = nat 16&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;GIC_PPIS_NUM  = nat 16&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;BITMAP_UNIT_LEN = nat 32&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;INTERRUPT_NUM_MAX = nat 1024&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;GIC_INTS_MAX &#8801; INTERRUPT_NUM_MAX&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;GIC_PRIVINT_NUM = GIC_SGIS_NUM + GIC_PPIS_NUM&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;CPU_MASTER &#8801; nat 0&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;INTERRUPT_IRQ_IPI &#8801; nat 1&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*definition &quot;PAGE_SIZE &#8801; nat 4096&quot;*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>bitmap</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bool list&quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*type_synonym BITMAP = &quot;bool list&quot;*)</span></span></span></span></span><span>                                    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* Generic BITMAP definition *)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*type_synonym irq_handler_t = &quot;u64 &#8658; u64 &#8658; (u64, unit)nondet_monad&quot;   IRQ Handler *)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>context&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span>gpr</span><span class="delimiter">::</span><span class="string"><span class="delete"><span class="delete">&quot;u64 list&quot;</span></span></span><span>
</span><span>                  </span><span>spsr</span><span class="delimiter">::</span><span>u64</span><span>
</span><span>                  </span><span>elr</span><span class="delimiter">::</span><span>u64</span><span>
</span><span>                  </span><span>dummy</span><span class="delimiter">::</span><span>u64</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*CCT: not necessary*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>vm_context</span><span> </span><span class="delimiter">=</span><span> </span><span>esr</span><span class="delimiter">::</span><span>u32</span><span>
</span><span>                    </span><span>far</span><span class="delimiter">::</span><span>u64</span><span>
</span><span>                    </span><span>hpfar</span><span class="delimiter">::</span><span>u64</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>spinlock_t</span><span> </span><span class="delimiter">=</span><span> </span><span>u32</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>vm_type</span><span> </span><span class="delimiter">=</span><span>  </span><span>VM_T_OS</span><span> </span><span class="delimiter">|</span><span> </span><span>VM_T_BMA</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*datatype vm_state = VM_S_INV | VM_S_PENDING | VM_S_ACTIVE*)</span></span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*datatype cpu_state = CPU_S_INV | CPU_S_IDLE | CPU_S_RUN*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*datatype vcpu_state = VCPU_S_INV | VCPU_S_PEND | VCPU_S_ACT*)</span></span></span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*another part of vm*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*record vm_if = id::vm_id
               name::string
               type::vm_type
               state::vm_state*)</span></span></span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*definition &quot;read_vm_if_ivc_cfg vi &#8801; (ivc_cfg vi)&quot;
definition &quot;read_vm_if_ivc_master_vcpu_id vi &#8801; (master_vcpu_id vi)&quot;
definition &quot;read_vm_if_ivc_cfg_ptr vi &#8801; (ivc_cfg_ptr vi)&quot;
definition &quot;read_vm_if_ivc_ivc_if vi &#8801; (ivc_if vi)&quot;
definition &quot;read_vm_if_ivc_type vi &#8801; (type vi)&quot;
definition &quot;update_vm_if_ivc_cfg vi icfg &#8801; vi&#10631;ivc_cfg:=icfg&#10632;&quot;
definition &quot;update_vm_if_ivc_cfg_ptr vi icfg &#8801; vi&#10631;ivc_cfg_ptr:=icfg&#10632;&quot;
definition &quot;update_vm_if_ivc_init_time vi t &#8801; vi&#10631;init_time:=t&#10632;&quot;
*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
record pa_region = pa_start :: u64
                   pa_length :: u64
                   offset :: i64
*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
record vm = id::u64
            vcpus::&quot;vcpu_id list&quot;
            address :: &quot;pa_region list&quot;
            (* Interru[t config *)
            intc_dev_id::u64
            int_bitmap::BITMAP
            emu_devs::&quot;irq_handler_t list&quot;

definition &quot;read_vm_id v &#8801; vm.id v&quot;
*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*record vcpu = id::vcpu_id
              phys_id::u64
              vm_id :: u64       
              state :: vcpu_state*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>cpu_pt</span><span> </span><span class="delimiter">=</span><span> </span><span>lvl1</span><span class="delimiter">::</span><span class="string"><span class="delete"><span class="delete">&quot;u64 list&quot;</span></span></span><span>
</span><span>                </span><span>lvl2</span><span class="delimiter">::</span><span class="string"><span class="delete"><span class="delete">&quot;u64 list&quot;</span></span></span><span>
</span><span>                </span><span>lvl3</span><span class="delimiter">::</span><span class="string"><span class="delete"><span class="delete">&quot;u64 list&quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
record vcpu_content = vcpu::vcpu
                      vcpu_state::vcpu                      

record vcpu_pool = content::&quot;vcpu_content list&quot;
                   size::u64
                   active::u64*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
record cpu_if = (*msg_queue::queue*)
                lock::spinlock_t

record cpu = id::u64
             state::cpu_state
             vcpu_pool::&quot;vcpu list&quot;
             active_vcpu::vcpu_id
             running_num :: vcpu_num
             current_irq::u64
*)</span></span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*record mem_region = base :: u64
                    size :: region_size 
                    free :: page_free
                    last :: page_last*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>spin_lock</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;spinlock_t &#8658; (&#39;s, unit)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;spin_lock sp &#8801; return ()&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>spin_unlock</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;spinlock_t &#8658; (&#39;s, unit)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;spin_unlock sp &#8801; return ()&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249; Bitmap Operations&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>extract_list</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; bitmap&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;extract_list mp b e &#8801; (drop b (take e mp))&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_set</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; bitmap&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_set mp b &#8801; (mp[b := True])&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
(b div BITMAP_UNIT_LEN)
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_clear</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; bitmap&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_clear mp b &#8801; mp [(b div BITMAP_UNIT_LEN) := False]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_get</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bitmap) &#8658; u64 &#8658; bool&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_get mp b &#8801; mp ! b&quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
(b div BITMAP_UNIT_LEN)
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_set_consecutive</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; bitmap&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_set_consecutive mp b e &#8801; (take b mp)@(list.map (&#955;f. True) (extract_list mp b e))@(drop e mp)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_clear_consecutive</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; bitmap&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_clear_consecutive mp b e &#8801;
    (take b mp)@(list.map (&#955;f. False) (extract_list mp b e))@(drop e mp)&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">thm</span></span><span> </span><span>bitmap_clear_consecutive_def</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*test*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_clear&#39;</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; (bitmap, unit)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_clear&#39; mp b &#8801;
    modify (&#955;s.  mp [(b div BITMAP_UNIT_LEN) := False])&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_set&#39;</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; (bitmap, unit)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_set&#39; mp b &#8801; modify (&#955;s. (mp[(b div BITMAP_UNIT_LEN) := True]))&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>bmp_set_proof</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#955;s. s&#8800;Nil&#10628;bitmap_set&#39; mp b&#10627;&#955;r s. s=(s[(b div BITMAP_UNIT_LEN) := (
                                                      (s ! (b div BITMAP_UNIT_LEN)) &#8744; True)])&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>unfold</span><span> </span><span>bitmap_set&#39;_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">oops</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap__clear</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; (bitmap, unit)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap__clear mp b &#8801; do cur &#8592; return (mp [(b div BITMAP_UNIT_LEN) := False]);
    return ()
od&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_set_consecutive&#39;</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; (&#39;s, unit)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_set_consecutive&#39; mp st n&#39; &#8801; do
    i &#8592; return 0;
    i &#8592; (whileLoop (&#955;i s. nat i &lt; n&#39;)
    (&#955;i. do
      return (bitmap_set mp (st + nat i));
      return (i+1)
    od)
    (i));
    return ()
od&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_clear_consecutive&#39;</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; (bitmap, unit)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_clear_consecutive&#39; mp st n&#39; &#8801; do
    i &#8592; return 0;
    i &#8592; (whileLoop (&#955;i s. nat i &lt; n&#39;)
    (&#955;i. do
      bitmap__clear mp (st + nat i);
      return (i+1)
    od)
    i);
    return ()
od&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>bmp_clear_proof</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#955;s. s&#8800;Nil&#10628;bitmap_clear&#39; mp b&#10627;&#955;r s. s=(s [(b div BITMAP_UNIT_LEN) := (
                                                    (s ! (b div BITMAP_UNIT_LEN)) &#8743; &#172;(True))])&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>unfold</span><span> </span><span>bitmap_clear&#39;_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">oops</span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*lemma bitmap_set_corr : &quot;mp &#8800; Nil &#10233; &#10627;&#955;s. True&#10628; bitmap_set mp b &#10627;&#955;s r. r=(let i=(b div BITMAP_UNIT_LEN) in return (mp[i:=((mp ! i) &#8744; True)]))&#10628;&quot;
  apply (simp add: bitmap_set_def nth_list_update)
  apply wpsimp
  oops*)</span></span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
return (mp[i:=((mp ! i) &#8744; True)])
*)</span></span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>bitmap_clear_proof</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#955;s. True&#10628; bitmap__clear mp b &#10627;&#955;r s. r=unit&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>bitmap_clear_def</span><span> </span><span>return_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">oops</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_count</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; bool &#8658; (bitmap, u64)nondet_monad&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_count mp st n&#39; f &#8801; return (length (removeAll (&#172;f) (drop st (take (n&#39;+1) mp))))&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bitmap_count&#39;</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; bool &#8658; u64&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_count&#39; mp st n&#39; f &#8801; (length (removeAll (&#172;f) (drop st (take (n&#39;+1) mp))))&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_clear_consecutive [False, True, False, False, True, True, True, False, True] 2 6&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap_set_consecutive [False, True, False, False, True, True, True, False, True] 0 6&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;char_of (nat 5)&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (enumerate 2 [a, b, c, d, e, f, g, h, i])&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;removeAll False [False, True, False, False, True, True, True, False, True]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;dropWhile (&#955;f. True) [False, True, False, False, True, True, True, False, True]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;list.map (&#955;f. False) [False, True, False, False, True, True, True, False, True]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;let A = [False, True, False, False, True, True, True, False, True] 
       in
        append (append (take 2 A) (drop 2 (take 6 A))) (drop 6 A)&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>bmp_mgmt</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; u64 &#8658; u64 &#8658; bitmap&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;bmp_mgmt mp b e &#8801; (take b mp)@(extract_list mp b e)@(drop e mp)&quot;</span></span></span><span>
</span><span>
</span><span>              
</span><span class="keyword2"><span class="keyword">end</span></span></pre>

</div>
</body>
</html>
