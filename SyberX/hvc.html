<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Theory hvc (Isabelle2019: June 2019)</title>
<link media="all" rel="stylesheet" type="text/css" href="isabelle.css"/>
</head>

<body>
<div class="head"><h1>Theory hvc</h1>

<span class="command">theory</span> <span class="name">hvc</span><br/>
<span class="keyword">imports</span> <a href="List_Index.html"><span class="name">List_Index</span></a> <a href="commfunc.html"><span class="name">commfunc</span></a><br/>

</div>
<div class="source">
<pre class="source"><span class="keyword1"><span class="command">theory</span></span><span> </span><span>hvc</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span>Main</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;../util/List_Index&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;../common/commfunc&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* shutting down VM0 euqals to shutdown system   *)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;Data type Declaration&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;Memory&#8250;</span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*mem_heap*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">typedecl</span></span><span> </span><span>Page</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Mem_Heap_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>Heap_Config</span><span> </span><span>region_size</span><span>  </span><span>bitmap_heap</span><span> </span><span>count_heap</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Page list&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>Mem_Heap</span><span> </span><span class="delimiter">=</span><span> </span><span>size</span><span> </span><span class="delimiter">::</span><span> </span><span>region_size</span><span>
</span><span>                  </span><span>freeR</span><span> </span><span class="delimiter">::</span><span> </span><span>page_free</span><span>
</span><span>                  </span><span>mapR</span><span> </span><span class="delimiter">::</span><span> </span><span>bitmap_heap</span><span>
</span><span>                  </span><span>free_countR</span><span> </span><span class="delimiter">::</span><span> </span><span>count_heap</span><span>
</span><span>                  </span><span>pl</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Page list&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>region_num</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>mem_region_index</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>vm_mem_position</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; mem_region_index  &#215; page_index &quot;</span></span></span><span> 
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>bitmap_region</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; page_num &#8658; mem_region_index option  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Mem_Region_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>Mem_Region_CFG</span><span> </span><span>region_size</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Page list&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>Mem_Config</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; mem_region_index &#8658; Mem_Region_Config &quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Mem_VM_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>Mem_VM_Config</span><span> </span><span>region_num</span><span> </span><span>Mem_Config</span><span> </span><span>bitmap_region</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>pa_Map</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;u64 &#8658; region_idx option &quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>ipa_Map</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;u64 &#8658; region_idx option&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VM_REGION_MAPS</span><span> </span><span class="delimiter">=</span><span> </span><span>RegionMapCFG</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pa_Map list&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ipa_Map list&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>map_targetN</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_id &#8658; vcpu_id option &quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>map_targetV</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; vm_id &#8658; vcpu_id option&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>map_isHave</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_id &#8658; nat option &quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>map_vidx</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;vcpu_id list &#8658; vcpu_idx option &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>CPU_Related_MAPS</span><span> </span><span class="delimiter">=</span><span> </span><span>CPUMapsCFG</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;map_targetN list&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;map_targetV list&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;map_isHave list&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;map_vidx list&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>getChMap</span><span> </span><span class="delimiter">=</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;vm_id &#8658; vm_id &#8658; channel_id option&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>availChMap</span><span> </span><span class="delimiter">=</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;vm_port &#8658; vm_id &#8658; channel_id option&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>IVC_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>ivcCFG</span><span> </span><span>channel_num</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;channel list&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Commu_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>CommuCFG</span><span> </span><span>IVC_Config</span><span> </span><span>getChMap</span><span> </span><span>availChMap</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*2020.12.19 14:22 ...... *)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>Mem_VM</span><span> </span><span class="delimiter">=</span><span> </span><span>vm_region</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; mem_region list &quot;</span></span></span><span>
</span><span>                </span><span>map</span><span> </span><span class="delimiter">::</span><span> </span><span>bitmap_region</span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;cpu&#8250;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VM_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>VM_CFG</span><span> </span><span>vm_id</span><span> </span><span>vm_name</span><span> </span><span>vm_type</span><span> </span><span>Alloc_VCPU</span><span> </span><span>Alloc_CPU</span><span> </span><span>bitmap</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pa_region list&quot;</span></span></span><span>  </span><span>Port_Config</span><span> 
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VMS_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>VMS_CFG</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VM_Config list &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VCPU_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>VCPU_CFG</span><span> </span><span>vcpu_id</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VCPUS_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>VCPUS_CFG</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VCPU_Config list &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>CPU_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>CPU_CFG</span><span> </span><span>cpu_id</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>CPUS_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>CPUS_CFG</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;CPU_Config list &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;Interrupts&#8250;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* Interrupts *)</span></span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*type_synonym INTERRUPT_NUM_MAX = nat
type_synonym INTERRUPT_NUM_SIZE = nat


type_synonym interrupt_id = nat
type_synonym interrupt_src = nat

datatype handlers = irq_handler_t interrupt_id interrupt_src
datatype Interrupt_Config = BITMAP bitmap interrupt_id &quot;handlers list&quot;

record Interrupts = Interrupt_hyper_bitmap::bitmap
                    Interrupt_glb_bitmap::bitmap
                    Interrupt_handlers::&quot;handlers list&quot;
*)</span></span></span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*record Interrupt_handlers = handler::&quot;handlers list&quot;*)</span></span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*type_synonym interrupt_handlers = &quot;handlers list&quot;*)</span></span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>assigned</span><span> </span><span class="delimiter">=</span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>port_id</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>channel_id</span><span> </span><span class="delimiter">=</span><span> </span><span>nat</span><span>
</span><span>                
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*datatype Port_Config = Port_CFG vm_port_type vm_id*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>Port_Config_Pair</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Port_Config&#215;Port_Config &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Channel_Config</span><span> </span><span class="delimiter">=</span><span>  </span><span>Channel_CFG</span><span> </span><span>channel_id</span><span> </span><span>assigned</span><span> </span><span>Port_Config_Pair</span><span> </span><span>MSG</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*2021.1.2 22:12*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>COMMU_Config</span><span> </span><span class="delimiter">=</span><span> </span><span>COMMU_CFG</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Channel_Config list&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;vm_id list&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;Component configuration and relevant event&#8250;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>Sys_Config</span><span> </span><span class="delimiter">=</span><span>    </span><span>mhc</span><span> </span><span class="delimiter">::</span><span>  </span><span>Mem_Heap_Config</span><span>
</span><span>                       </span><span>mvc</span><span> </span><span class="delimiter">::</span><span>  </span><span>Mem_VM_Config</span><span>
</span><span>                       </span><span>vmc</span><span> </span><span class="delimiter">::</span><span>  </span><span>VMS_Config</span><span>
</span><span>                    </span><span>regmap</span><span> </span><span class="delimiter">::</span><span>  </span><span>VM_REGION_MAPS</span><span>
</span><span>                     </span><span>vcpuc</span><span> </span><span class="delimiter">::</span><span>  </span><span>VCPUS_Config</span><span>
</span><span>                      </span><span>cpuc</span><span> </span><span class="delimiter">::</span><span>  </span><span>CPUS_Config</span><span>
</span><span>                   </span><span>cpumaps</span><span> </span><span class="delimiter">::</span><span>  </span><span>CPU_Related_MAPS</span><span>
</span><span>                      </span><span>intc</span><span> </span><span class="delimiter">::</span><span>  </span><span>Interrupt_Config</span><span>
</span><span>                      </span><span>irqc</span><span> </span><span class="delimiter">::</span><span>  </span><span>handlers</span><span>
</span><span>                    </span><span>commuc</span><span> </span><span class="delimiter">::</span><span>  </span><span>Commu_Config</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Resource_Type</span><span> </span><span class="delimiter">=</span><span> </span><span>T_CPU</span><span> </span><span class="delimiter">|</span><span> </span><span>T_MEM</span><span> </span><span class="delimiter">|</span><span> </span><span>T_VM</span><span> </span><span class="delimiter">|</span><span> </span><span>T_SYS</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Event</span><span> </span><span class="delimiter">=</span><span> </span><span>HVC</span><span> </span><span class="delimiter">|</span><span> </span><span>IRQ</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Event_Result</span><span> </span><span class="delimiter">=</span><span> </span><span>SUCCEED</span><span> </span><span class="delimiter">|</span><span> </span><span>FAILED</span><span> </span><span class="delimiter">|</span><span> </span><span>UNKNOWN</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
record vm_port =  type :: vm_port_type
                  idV :: vm_id
*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>Commu</span><span> </span><span class="delimiter">=</span><span> </span><span>ivc</span><span> </span><span class="delimiter">::</span><span> </span><span>IVC_State</span><span>
</span><span>               </span><span>getChannel</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;vm_id &#8658; vm_id &#8658; channel_id option&quot;</span></span></span><span>
</span><span>               </span><span>availChannel</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;vm_port &#8658; vm_id &#8658; channel_id option&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*Maybe it is the audit log*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>CPU_MAPS</span><span> </span><span class="delimiter">=</span><span> </span><span>cpu_map_active</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; map_targetN list &quot;</span></span></span><span> 
</span><span>                  </span><span>cpu_map_idByVM</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; map_targetV list &quot;</span></span></span><span> 
</span><span>                  </span><span>cpu_is_haveVCPU</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; map_isHave list &quot;</span></span></span><span> 
</span><span>                  </span><span>get_vcpuIDX</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; map_vidx list&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>VM_MAPS</span><span> </span><span class="delimiter">=</span><span> </span><span>get_paIdX</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pa_Map list &quot;</span></span></span><span>
</span><span>                 </span><span>get_ipaIdX</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ipa_Map list &quot;</span></span></span><span>
</span><span>  
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>Audit</span><span> </span><span class="delimiter">=</span><span>  </span><span>res</span><span>  </span><span class="delimiter">::</span><span> </span><span>Resource_Type</span><span>
</span><span>                </span><span>sub</span><span>  </span><span class="delimiter">::</span><span> </span><span>nat</span><span>
</span><span>               </span><span>event</span><span> </span><span class="delimiter">::</span><span> </span><span>Event</span><span>          
</span><span>              </span><span>result</span><span> </span><span class="delimiter">::</span><span> </span><span>Event_Result</span><span>
</span><span>  
</span><span class="keyword1"><span class="command">record</span></span><span> </span><span>HV</span><span> </span><span class="delimiter">=</span><span>  </span><span>mem_heap</span><span> </span><span class="delimiter">::</span><span> </span><span>Mem_Heap</span><span>
</span><span>             </span><span>mem_vm</span><span> </span><span class="delimiter">::</span><span> </span><span>Mem_VM</span><span>
</span><span>             </span><span>vm</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM list &quot;</span></span></span><span>
</span><span>             </span><span>vm_wk_st</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VM_WORK_STATE list&quot;</span></span></span><span>
</span><span>             </span><span>vm_regionMaps</span><span> </span><span class="delimiter">::</span><span> </span><span>VM_MAPS</span><span>
</span><span>             </span><span>vcpu</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;  VCPU list &quot;</span></span></span><span>
</span><span>             </span><span>vcpu_wk_st</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VCPU_WORK_STATE list&quot;</span></span></span><span>
</span><span>             </span><span>cpu</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPU list &quot;</span></span></span><span>
</span><span>             </span><span>cpu_wk_st</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;CPU_WORK_STATE list&quot;</span></span></span><span>
</span><span>             </span><span>cpu_maps</span><span> </span><span class="delimiter">::</span><span> </span><span>CPU_MAPS</span><span>
</span><span>             </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* cpu_map_active :: &quot;map_targetN list &quot;  *)</span></span></span></span></span><span>
</span><span>             </span><span>interrupts</span><span class="delimiter">::</span><span>Interrupts</span><span> 
</span><span>             </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*interrupt_handlers::Interrupt_handlers*)</span></span></span></span></span><span>
</span><span>             </span><span>commu</span><span> </span><span class="delimiter">::</span><span> </span><span>Commu</span><span>
</span><span>             </span><span>audit</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Audit list&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249; relevant event &#8250;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*relavent event*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Mem_Heap_Event</span><span> </span><span class="delimiter">=</span><span> </span><span>Heap_Rgion_Init</span><span> </span><span class="delimiter">|</span><span> </span><span>Heap_Alloc</span><span> </span><span>page_num</span><span> </span><span class="delimiter">|</span><span> 
</span><span>                          </span><span>Heap_Free</span><span> </span><span>page_index</span><span> </span><span>page_num</span><span> </span><span class="delimiter">|</span><span> </span><span>Heap_Region_Reset</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Mem_VM_Event</span><span> </span><span class="delimiter">=</span><span> </span><span>Mem_VM_Init</span><span> </span><span class="delimiter">|</span><span> </span><span>VM_Region_Alloc</span><span> </span><span>page_num</span><span> </span><span class="delimiter">|</span><span>
</span><span>                        </span><span>VM_Region_Free</span><span> </span><span>mem_region_index</span><span> </span><span>page_num</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>CPU_Event</span><span> </span><span class="delimiter">=</span><span> </span><span>CPU_Init</span><span> </span><span class="delimiter">|</span><span> </span><span>CPU_Report_State</span><span>  
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VCPU_Event</span><span> </span><span class="delimiter">=</span><span> </span><span>VCPU_Init</span><span> </span><span class="delimiter">|</span><span> </span><span>VCPU_RUN</span><span> </span><span>cpu_id</span><span> </span><span class="delimiter">|</span><span>  </span><span>VCPU_SHUTDOWN</span><span> </span><span>vcpu_id</span><span> </span><span class="delimiter">|</span><span>
</span><span>                      </span><span>VCPU_POOL_SWITCH</span><span> </span><span>cpu_id</span><span>   
</span><span>                      
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VM_EVENT</span><span> </span><span class="delimiter">=</span><span> </span><span>VM_Init</span><span> </span><span class="delimiter">|</span><span> </span><span>VMM_SHOWDOWN_VM</span><span> </span><span>vm_id</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>VMM_EVENT</span><span> </span><span class="delimiter">=</span><span> </span><span>VMM_SHOWDOWN_VM</span><span> </span><span>vm_id</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>IVC_EVENT</span><span> </span><span class="delimiter">=</span><span> </span><span>IVC_SEND_MSG</span><span>  </span><span>vm_id</span><span> </span><span>MSG</span><span> </span><span>vm_id</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>SCHED_EVENT</span><span> </span><span class="delimiter">=</span><span>  </span><span>CPU_SCHEDULE</span><span> </span><span>cpu_id</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>Interrupt_Event</span><span> </span><span class="delimiter">=</span><span> </span><span>Interrupt_init</span><span> </span><span class="delimiter">|</span><span>
</span><span>                           </span><span>Interrupt_reserve_int</span><span> </span><span>interrupt_id</span><span> </span><span>handlers</span><span> </span><span class="delimiter">|</span><span>
</span><span>                           </span><span>Interrupt_cpu_enable</span><span> </span><span>interrupt_id</span><span> </span><span>bool</span><span> </span><span class="delimiter">|</span><span>
</span><span>                           </span><span>Interrupt_cpu_ipi_send</span><span> </span><span>cpu_id</span><span> </span><span>interrupt_id</span><span> </span><span class="delimiter">|</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*To review according to IPI*)</span></span></span></span></span><span>
</span><span>                           </span><span>Interrupt_Handler</span><span> </span><span>interrupt_id</span><span> </span><span>interrupt_src</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>HVC_SYS_EVENT</span><span> </span><span class="delimiter">=</span><span> </span><span>SYS_REBOOT</span><span> </span><span class="delimiter">|</span><span> </span><span>SYS_SHUTDOWN</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>HVC_VMM_EVENT</span><span> </span><span class="delimiter">=</span><span> </span><span>VMM_LIST_VM_INFO</span><span>  </span><span class="delimiter">|</span><span> </span><span>VMM_SHUTDOWN_VM</span><span> </span><span>vm_id</span><span> </span><span class="delimiter">|</span><span>
</span><span>                         </span><span>VMM_REBOOT_VM</span><span> </span><span>vm_id</span><span> </span><span class="delimiter">|</span><span> </span><span>VMM_GET_VM_ID</span><span> </span><span>vm_name</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>HVC_IVC_EVENT</span><span> </span><span class="delimiter">=</span><span> </span><span>IVC_SEND_MSG</span><span> </span><span>vm_id</span><span> </span><span>MSG</span><span> </span><span>vm_id</span><span> 
</span><span>                         </span><span class="delimiter">|</span><span> </span><span>IVC_BROADCAST_MSG</span><span> </span><span>vm_id</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;Retrieve Configuration&#39;s element&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_heapSize_HCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_Heap_Config &#8658; region_size &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_heapSize_HCFG (Heap_Config s m c pl0) = s &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_bitMap_HCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_Heap_Config &#8658; bitmap_heap &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_bitMap_HCFG (Heap_Config s m c pl0) = m &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_freeCount_HCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_Heap_Config &#8658; count_heap &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_freeCount_HCFG (Heap_Config s m c pl0) = c &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_pageList_HCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_Heap_Config &#8658; Page list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_pageList_HCFG (Heap_Config s m c pl0) = pl0 &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_regionNum_VCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_VM_Config &#8658; region_num&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_regionNum_VCFG ( Mem_VM_Config n mc br ) = n &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_memConf_VCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_VM_Config &#8658; Mem_Config &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_memConf_VCFG ( Mem_VM_Config n mc br) = mc  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_bitmap_VCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_VM_Config &#8658; bitmap_region &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_bitmap_VCFG ( Mem_VM_Config n mc br) = br  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_regionSize_RCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_Region_Config &#8658; region_size &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_regionSize_RCFG (Mem_Region_CFG s pl0 ) = s &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_pageList_RCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_Region_Config &#8658; Page list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_pageList_RCFG (Mem_Region_CFG s pl0 ) = pl0 &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_VMCFGList</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VMS_Config &#8658; VM_Config list  &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_VMCFGList ( VMS_CFG vcs  ) =  vcs &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_ID_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_Config &#8658; vm_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_ID_VMCFG (VM_CFG id0 nam typ avc ac _ _ _ ) = id0  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_NAME_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_Config &#8658; vm_name &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_NAME_VMCFG (VM_CFG id0 nam typ avc ac _ _ _ ) = nam  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_TYPE_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_Config &#8658; vm_type &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_TYPE_VMCFG (VM_CFG id0 nam typ avc ac _ _ _ ) = typ  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_AVC_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_Config &#8658; Alloc_VCPU &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_AVC_VMCFG (VM_CFG id0 nam typ avc ac _ _ _ ) = avc &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_AC_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_Config &#8658; Alloc_CPU &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_AC_VMCFG (VM_CFG id0 nam typ avc ac _ _ _ ) = ac &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_BITMAP_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VM_Config &#8658; bitmap&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_BITMAP_VMCFG (VM_CFG _ _ _ _ _ bmp _ _) = bmp &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_ADDR_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VM_Config &#8658; pa_region list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_ADDR_VMCFG (VM_CFG _ _ _ _ _ _ addr _) = addr &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_PORTCFG_VMCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VM_Config &#8658; Port_Config &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_PORTCFG_VMCFG (VM_CFG  _ _ _ _ _ _ _ cfg) = cfg &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_ID_VCPUCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VCPU_Config &#8658; vcpu_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_ID_VCPUCFG (VCPU_CFG id0 ) = id0 &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_VCPUCFGList</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VCPUS_Config &#8658; VCPU_Config list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_VCPUCFGList (VCPUS_CFG a) = a &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_ID_CPUCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_Config &#8658; cpu_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_ID_CPUCFG (CPU_CFG id0 ) = id0 &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_CPUCFGList</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPUS_Config &#8658; CPU_Config list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_CPUCFGList (CPUS_CFG a) = a &quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*Interrupt section*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_intIndex_BCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Interrupt_Config &#8658; interrupt_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_intIndex_BCFG (BITMAP _ i _) = i &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_Bitmap_BCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Interrupt_Config &#8658; bitmap &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_Bitmap_BCFG (BITMAP bmp _ _) = bmp &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_Handlers_BCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Interrupt_Config &#8658; handlers list&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_Handlers_BCFG (BITMAP _ _ hdl) = hdl &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_channelCFGList</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; COMMU_Config &#8658; Channel_Config list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_channelCFGList (COMMU_CFG a b) = a &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_vmcList</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; COMMU_Config &#8658; vm_id list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_vmcList (COMMU_CFG a b) = b &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_ID_channelCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Channel_Config &#8658; channel_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_ID_channelCFG (Channel_CFG a b c d) = a &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_assigned_channelCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Channel_Config &#8658; assigned &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_assigned_channelCFG (Channel_CFG a b c d ) = b &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_PortsCFG_channelCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Channel_Config &#8658; Port_Config_Pair &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_PortsCFG_channelCFG (Channel_CFG a b c d ) = c &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_InitalMSG_channelCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Channel_Config &#8658; MSG &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_InitalMSG_channelCFG (Channel_CFG a b c d ) = d &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_paMap_RegionMap</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_REGION_MAPS  &#8658; pa_Map list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_paMap_RegionMap (RegionMapCFG a b) = a &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_ipaMap_RegionMap</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_REGION_MAPS  &#8658; ipa_Map list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_ipaMap_RegionMap (RegionMapCFG a b) = b &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_map1_CPURelatedMap</span><span>  </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_Related_MAPS &#8658; map_targetN list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_map1_CPURelatedMap  (CPUMapsCFG a b c d) = a&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_map2_CPURelatedMap</span><span>  </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_Related_MAPS &#8658; map_targetV list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_map2_CPURelatedMap  (CPUMapsCFG a b c d) = b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_map3_CPURelatedMap</span><span>  </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_Related_MAPS &#8658; map_isHave list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_map3_CPURelatedMap  (CPUMapsCFG a b c d) = c&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_map4_CPURelatedMap</span><span>  </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_Related_MAPS &#8658; map_vidx list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_map4_CPURelatedMap  (CPUMapsCFG a b c d) = d&quot;</span></span></span><span>
</span><span>                               
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_nums_IVCCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; IVC_Config &#8658; channel_num &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_nums_IVCCFG (ivcCFG a b) = a&quot;</span></span></span><span>         
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_chans_IVCCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; IVC_Config &#8658; channel list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_chans_IVCCFG (ivcCFG a b) = b&quot;</span></span></span><span>   
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_ivcCfg_COMMUCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Commu_Config &#8658;  IVC_Config &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_ivcCfg_COMMUCFG (CommuCFG a b c) = a &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_map1_COMMUCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Commu_Config &#8658;  getChMap &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_map1_COMMUCFG (CommuCFG a b c) = b &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>get_map2_COMMUCFG</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Commu_Config &#8658;  availChMap &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_map2_COMMUCFG (CommuCFG a b c) = c &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;relevant Functions and Definitions&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249; Asset Initialization &#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>get_natArr</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; int &#8658; nat list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_natArr numX &#8801; List.map (&#955;x. nat x) [1..numX]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>heap_region_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_Heap_Config =&gt; Mem_Heap &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; heap_region_init cfg &#8801; let 
                              size0 = get_heapSize_HCFG cfg;
                              map0 = get_bitMap_HCFG cfg;
                              count0 = get_freeCount_HCFG cfg;
                              pl0 = get_pageList_HCFG cfg
                            in &#10631;Mem_Heap.size=size0, freeR=size0, mapR=map0, free_countR=count0 , pl=pl0&#10632; &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>mem_region_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Mem_Region_Config &#8658; mem_region &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; mem_region_init cfg &#8801;  let
                             size0 = get_regionSize_RCFG cfg
                            in &#10631; mem_region.sizeB=size0, freeB=size0 &#10632; &quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
definition mem_region_init :: &quot;Mem_Region_Config &#8658; mem_region &quot; where
  &quot; mem_region_init cfg &#8801;  let
                             size0 = get_regionSize_RCFG cfg;
                             pl0  = get_pageList_RCFG cfg
                            in &#10631; mem_region.size=size0, free=size0,last= 0 , pl=pl0 &#10632; &quot;
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>mem_vm_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Mem_VM_Config &#8658; Mem_VM &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; mem_vm_init cfg &#8801;
        let
            regionNum0 = get_regionNum_VCFG cfg;               
            regionNum1 = int regionNum0;
            bitmap0 = get_bitmap_VCFG cfg;
            memConfList = List.map (&#955;x.(get_memConf_VCFG cfg x)) (get_natArr regionNum1);
            memRegionList = List.map (&#955;y.(mem_region_init y)) memConfList
        in &#10631; Mem_VM.vm_region = memRegionList, map = bitmap0 &#10632;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>VM_RegionMaps_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VM_REGION_MAPS &#8658; VM_MAPS &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VM_RegionMaps_init cfg &#8801; 
    let
      map1 = get_paMap_RegionMap cfg;
      map2 = get_ipaMap_RegionMap cfg
    in
      &#10631;get_paIdX = map1 , get_ipaIdX = map2 &#10632;
     &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>CPU_RelatedMaps_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;CPU_Related_MAPS &#8658; CPU_MAPS &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_RelatedMaps_init cfg &#8801;                            
    let
      map1 = get_map1_CPURelatedMap cfg;
      map2 = get_map2_CPURelatedMap cfg;
      map3 = get_map3_CPURelatedMap cfg;
      map4 = get_map4_CPURelatedMap cfg
    in
      &#10631;cpu_map_active = map1 , cpu_map_idByVM = map2, cpu_is_haveVCPU = map3, get_vcpuIDX = map4 &#10632;
     &quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>IVC_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;IVC_Config &#8658; IVC_State &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; IVC_init cfg &#8801;                            
    let
      n = get_nums_IVCCFG cfg;
      l = get_chans_IVCCFG cfg
    in
      &#10631;channel_num = n , channels = l &#10632;
     &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>Commus_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Commu_Config &#8658; Commu &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; Commus_init cfg &#8801;                            
    let
      ivc0 = IVC_init (get_ivcCfg_COMMUCFG cfg);
      map1 = get_map1_COMMUCFG cfg;
      map2 = get_map2_COMMUCFG cfg
    in
      &#10631;ivc = ivc0 , getChannel = map1, availChannel = map2 &#10632;
     &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>VM_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VM_Config &#8658; VM &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>   </span><span class="string"><span class="delete"><span class="delete">&quot; VM_init cfg &#8801; 
        let 
          id0 = get_ID_VMCFG cfg;
          name0 = get_NAME_VMCFG cfg;
          type0 = get_TYPE_VMCFG cfg;
          avc = get_AVC_VMCFG cfg;
          ac = get_AC_VMCFG cfg;
          bmp = get_BITMAP_VMCFG cfg;
          addr = get_ADDR_VMCFG cfg;
          portCFG = get_PORTCFG_VMCFG cfg
        in &#10631; VM.id=id0, name=name0 , type = type0, vcpus=avc, cpus=ac, 
              int_bitmap=bmp,address=addr,port_config=portCFG&#10632; &quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*state=VM_S_INV *)</span></span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>VMS_init</span><span> </span><span class="delimiter">::</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VMS_Config &#8658; VM list&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VMS_init cfg &#8801; 
      List.map (&#955;x.(VM_init x)) (get_VMCFGList cfg) &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;List.replicate 2 (4::int)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>VMWorkState_init</span><span> </span><span class="delimiter">::</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VMS_Config &#8658; VM_WORK_STATE list&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VMWorkState_init cfg &#8801; 
      List.replicate (length (get_VMCFGList cfg)) VM_S_INV  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>VCPU_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VCPU_Config &#8658; VCPU  &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VCPU_init cfg1  &#8801; let
                       id0 = get_ID_VCPUCFG cfg1
                     in &#10631; VCPU.id=id0, physID=0, vmID=0, allocated=False &#10632;&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*state=VCPU_S_PEND*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>VCPUS_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; VCPUS_Config  &#8658; VCPU list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VCPUS_init cfg1 &#8801; List.map  (&#955;x.(VCPU_init x )) (get_VCPUCFGList cfg1) &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>VCPUWorkState_init</span><span> </span><span class="delimiter">::</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VCPUS_Config &#8658; VCPU_WORK_STATE list&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; VCPUWorkState_init cfg &#8801; 
      List.replicate (length (get_VCPUCFGList cfg)) VCPU_S_PEND &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>CPU_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_Config &#8658; CPU  &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; CPU_init cfg &#8801; 
        let
             id0 = get_ID_CPUCFG cfg
        in &#10631; CPU.id=id0, vcpus=[], poolSize=0, active_vcpu = 0, running_num =0 &#10632;&quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*CPU_S_IDLE*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>CPUS_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; CPUS_Config &#8658; CPU list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; CPUS_init cfg &#8801; List.map  (&#955;x.(CPU_init x)) (get_CPUCFGList cfg)    &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>CPUWorkState_init</span><span> </span><span class="delimiter">::</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; CPUS_Config &#8658; CPU_WORK_STATE list&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; CPUWorkState_init cfg &#8801; 
      List.replicate (length (get_CPUCFGList cfg)) CPU_S_IDLE &quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* Interrupt section initialization *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Interrupt_Config &#8658; Interrupts&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; interrupt_init cfg &#8801; let
      b = (get_Bitmap_BCFG cfg);
      hl = (get_Handlers_BCFG cfg)
    in
      &#10631;Interrupt_hyper_bitmap = b, Interrupt_glb_bitmap = b, Interrupt_handlers = hl&#10632;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>HV_init</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; Sys_Config &#8658; HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; HV_init sc &#8801;           
      let
        x1= heap_region_init (mhc sc) ;
        x2= mem_vm_init (mvc sc) ;
        x3= VMS_init (vmc sc) ;
        x4= VMWorkState_init (vmc sc) ;
        x5= VM_RegionMaps_init (regmap sc);
        x6= VCPUS_init (vcpuc sc) ;
        x7= VCPUWorkState_init (vcpuc sc);
        x8= CPUS_init (cpuc sc) ;
        x9= CPUWorkState_init (cpuc sc);
        x10= CPU_RelatedMaps_init (cpumaps sc);
        x11= interrupt_init (intc sc);
        x12 = Commus_init (commuc sc)
      in 
        &#10631;mem_heap=x1 , mem_vm=x2 ,vm =x3 , vm_wk_st=x4 , vm_regionMaps = x5,
          vcpu = x6, vcpu_wk_st = x7, cpu = x8, cpu_wk_st = x9,  cpu_maps=x10,
           interrupts= x11,  commu=x12, audit=Nil&#10632; &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249; Other related functions and definitions&#8250;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249; memory&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>heap_alloc_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV =&gt; page_num =&gt; HV &#215; bool &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; heap_alloc_req hvc numX &#8801; 
    if (numX = 0 &#8744; (numX &gt; Mem_Heap.freeR (mem_heap hvc))) then
      (hvc,False)
    else
        case mapR (mem_heap hvc) numX of
           None &#8658; (hvc,False) |
           Some region_index &#8658; 
                let                  
                  free0 = Mem_Heap.freeR (mem_heap hvc) - numX;
                  mem_heap0 = (mem_heap hvc)&#10631;Mem_Heap.freeR:=free0&#10632;  
                in                        
                  (hvc&#10631;mem_heap:=mem_heap0&#10632;,True)
    &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>heap_free_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; page_index  &#8658; page_num &#8658; HV &#215; bool &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; heap_free_req hvc index0 numX &#8801;
       if (index0 + numX) &lt; Mem_Heap.size (mem_heap hvc) then
                let 
                    map0 = free_countR (mem_heap hvc);
                    free0 = Mem_Heap.freeR (mem_heap hvc) + map0 index0 numX;
                    mem_heap0 = (mem_heap hvc)&#10631;Mem_Heap.freeR:=free0&#10632;
                in
                    (hvc&#10631;mem_heap:=mem_heap0&#10632;,True)
         else (hvc,False)  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>heap_region_reset</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; HV &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; heap_region_reset hvc &#8801;
       let 
          free0 = Mem_Heap.size (mem_heap hvc);
          mem_heap0 = (mem_heap hvc)&#10631;Mem_Heap.freeR:=free0&#10632;
       in
          hvc&#10631;mem_heap:=mem_heap0&#10632; &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>get_memRegion</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; mem_region_index &#8658; mem_region &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_memRegion hvc idx &#8801; (vm_region (mem_vm hvc))!idx &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_region_alloc_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; page_num &#8658; HV &#215; bool &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vm_region_alloc_req hvc numX &#8801; 
      case  Mem_VM.map (mem_vm hvc) numX of
             None &#8658; (hvc,False) |
             Some idx &#8658;
              let          
                free0 = mem_region.freeB (get_memRegion hvc idx);
                region0 = ((vm_region (mem_vm hvc))!idx) &#10631;freeB:= free0-numX &#10632;; 
                vm_region0 = (vm_region (mem_vm hvc))[idx:=region0];
                mem_vm0 = (mem_vm hvc)&#10631;vm_region:=vm_region0&#10632;
              in
                (hvc&#10631;mem_vm:=mem_vm0&#10632;, True) &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_region_clear</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; mem_region_index &#8658; page_num &#8658; HV &#215; bool &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vm_region_clear hvc idx numX &#8801; 
      if idx &lt; (length (vm_region (mem_vm hvc))) &#8743; numX &lt; mem_region.sizeB ((get_memRegion hvc idx)) then
        let                         
          free0 = mem_region.freeB ((vm_region (mem_vm hvc))!idx) + numX ;
          region0 = ((vm_region (mem_vm hvc))!idx) &#10631;mem_region.freeB:=free0&#10632;; 
          vm_region0 = (vm_region (mem_vm hvc))[idx:=region0 ];
          mem_vm0 = (mem_vm hvc)&#10631;vm_region:=vm_region0&#10632;
        in
          (hvc&#10631;mem_vm:=mem_vm0&#10632;,True) 
      else (hvc,False) &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>cpu_report_state</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; CPU_WORK_STATE list &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; cpu_report_state hv &#8801;
      cpu_wk_st hv &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>get_vmid_bycid</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV&#8658; cpu_id &#8658; vm_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; get_vmid_bycid hv cid &#8801; 
          let
              vcid = active_vcpu  ((cpu hv)!cid);
                          vcpu = (vcpu hv)!vcid       
          in vmID vcpu  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>get_vmid_cid_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;  cpu_id &#8658; HV &#8658; vm_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_vmid_cid_req cid hv &#8801;   
                        let
                          vcid = active_vcpu  ((cpu hv)!cid);
                          vcpu = (vcpu hv)!vcid
                         in  
                            vmID vcpu &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249; VCPU&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vcpu_run_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; cpu_id &#8658; HV &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>   </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_run_req hv cid &#8801;
      if running_num((cpu hv)!cid) &gt; 1 then
       let
          vmid = get_vmid_cid_req cid hv;
          cpuN = (cpu_wk_st hv)[cid:=CPU_S_RUN];
          vmN = (vm_wk_st hv)[vmid:=VM_S_ACT]
       in 
          hv&#10631;cpu_wk_st:=cpuN, vm_wk_st:=vmN&#10632; 
    else hv&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>set_active_vcpu_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658; vcpu_id  &#8658; HV &quot;</span></span></span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; set_active_vcpu_req hv cid vcid &#8801; 
    let
      cpu0 = (cpu hv)!cid;
      actido = active_vcpu cpu0;
      vcStas = (vcpu_wk_st hv)[actido:=VCPU_S_PEND, vcid:=VCPU_S_ACT];
      cpuN = cpu0&#10631;active_vcpu:=vcid&#10632;;
      cpus = (cpu hv)[cid:=cpuN]
    in hv&#10631;cpu:=cpus, vcpu_wk_st:=vcStas&#10632; &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vcpu_pool_suspend_req</span><span> </span><span class="delimiter">::</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id  &#8658; vcpu_id  &#8658; HV &#215; bool &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_pool_suspend_req hv cid vcid &#8801;  
      if (length (CPU.vcpus ((cpu hv)!cid)) = 0 &#8744; ((cpu_is_haveVCPU (cpu_maps hv))!cid) vcid = None ) then
        (hv,False)
      else 
        if ((vcpu_wk_st hv)!vcid) = VCPU_S_INV then
          (hv,True)
        else
          let
            vN = (vcpu_wk_st hv)[vcid:=VCPU_S_INV];
            cpu0 = (cpu hv)!cid; 
            cpu1 = cpu0&#10631;running_num:=running_num cpu0 - 1&#10632;;
            cN = (cpu hv)[cid:=cpu1]
          in 
            (hv&#10631;cpu:=cN,vcpu_wk_st:=vN&#10632;,True)&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vcpu_pool_wakeup_req</span><span> </span><span class="delimiter">::</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id  &#8658; vcpu_id  &#8658; HV &#215; bool &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_pool_wakeup_req hv cid vcid &#8801;  
      if (length (CPU.vcpus ((cpu hv)!cid)) = 0 &#8744; ((cpu_is_haveVCPU (cpu_maps hv))!cid) vcid = None ) then
        (hv,False)
      else 
        if &#172;((vcpu_wk_st hv)!vcid) = VCPU_S_INV then
          (hv,True)
        else
          let
            vN = (vcpu_wk_st hv)[vcid:=VCPU_S_PEND];
            cpu0 = (cpu hv)!cid; 
            cpu1 = cpu0&#10631;running_num:=running_num cpu0 + 1&#10632;;
            cN = (cpu hv)[cid:=cpu1]
          in 
            (hv&#10631;cpu:=cN,vcpu_wk_st:=vN&#10632;,True)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vcpu_pool_remove_req</span><span> </span><span class="delimiter">::</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id  &#8658; vcpu_id  &#8658; HV &#215; bool &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_pool_remove_req hv cid vcid &#8801;  
      if (length (CPU.vcpus ((cpu hv)!cid)) = 0 &#8744; ((cpu_is_haveVCPU (cpu_maps hv))!cid) vcid = None ) then
        (hv,False)
      else 
        let
          target = the  ( ((cpu_is_haveVCPU (cpu_maps hv))!cid) vcid );
          cpu0 = (cpu hv)!cid;
          num0 = if &#172;((vcpu_wk_st hv)!vcid) = VCPU_S_INV then 
                    running_num cpu0 -1
                 else
                    running_num cpu0;
          cpu1 = cpu0&#10631;running_num:=num0,CPU.vcpus:=(CPU.vcpus cpu0)[target:= length (vcpu hv)]&#10632;;
          vN = (vcpu_wk_st hv)[vcid:=VCPU_S_INV]
        in
           (hv&#10631;cpu:=(cpu hv)[cid:=cpu1],vcpu_wk_st:=vN&#10632;,True)
&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vcpu_pool_switch_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658; vcpu_id &#8658; HV&quot;</span></span></span><span>   </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;vcpu_pool_switch_req hv cidx target &#8801;
       let
        cpu0 = (cpu hv)!cidx;
        targetOld = active_vcpu cpu0;
        running_num = running_num ((cpu hv)!cidx);
        map0 = ((CPU_MAPS.cpu_map_active (cpu_maps hv))!cidx) 
       in 
        if(&#172;  (target = targetOld &#8744; running_num = 0)) then
          case map0 target of
            None &#8658; hv |
            Some vidx &#8658;  
              if (vidx = targetOld) then
                set_active_vcpu_req hv cidx vidx 
              else
                hv
        else
           hv
&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vcpu_pool_pop_through_vmid_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; cpu_id &#8658; vm_id &#8658; HV &#215; bool &quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_pool_pop_through_vmid_req hv cid vmid &#8801;
     let
       map0 = (cpu_map_idByVM (cpu_maps hv))!cid;
       vcpuPool = CPU.vcpus ((cpu hv)!cid)
     in
       if(length vcpuPool = 0 &#8744; map0 vmid = None) then
          (hv,False)
       else
          (hv,True)
  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>cpu_idle_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658; HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cpu_idle_req hv cid &#8801;
    let 
      wks = (cpu_wk_st hv)[cid:=CPU_S_IDLE]
    in
      hv&#10631;cpu_wk_st:=wks&#10632;
  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vcpu_shutdown_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658; vcpu_id &#8658; HV &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vcpu_shutdown_req hv cid vcid &#8801;
      let 
        map1 = (CPU_MAPS.cpu_map_active (cpu_maps hv)) ! cid;
        map2 = (cpu_is_haveVCPU (cpu_maps hv)) ! cid;
        cpu0 = (cpu hv)!cid;
        ret = map2 vcid;
        limit = length (vcpu hv)
      in
        case ret of
            None &#8658; cpu_idle_req hv cid |
            Some idx &#8658;
              let
                aN = map1 limit;
                vs = (vcpu_wk_st hv)[vcid:=VCPU_S_INV];
                cpu0 = cpu0&#10631;running_num:=running_num cpu0-1&#10632;;
                hv1 = hv&#10631;vcpu_wk_st:=vs,cpu:=(cpu hv)[cid:=cpu0]&#10632;
              in 
                if(running_num cpu0 = 0) then
                  cpu_idle_req hv1 cid
                else
                  if(vcid=active_vcpu cpu0) then                   
                      if(aN = None &#8744; (the aN) = active_vcpu cpu0) then
                        hv1
                      else
                        hv1&#10631;vcpu_wk_st:=(vcpu_wk_st hv1)[the aN:=VCPU_S_ACT],
                           cpu:=(cpu hv1)[cid:= cpu0&#10631;active_vcpu:=the aN&#10632;]&#10632;
                  else
                    hv1
  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*two auxiliary functions*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>get_vmid_cid</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; cpu_id &#8658; vm_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_vmid_cid hv cid &#8801;   
                        let
                          vcid = active_vcpu  ((cpu hv)!cid);
                          vcpu = (vcpu hv)!vcid
                         in  vmID vcpu &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>get_cid_vmid</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; vm_id &#8658; cpu_id &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_cid_vmid hv vmid &#8801;
             let 
              cpuS = cpu hv;
              idx = find_index (&#955;x.(get_vmid_cid hv (CPU.id x)) = vmid ) cpuS
             in idx&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vmm_shutdown_vm_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658;HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vmm_shutdown_vm_req hv cidx &#8801;
    let
      vcidx = active_vcpu ((cpu hv)!cidx);
      vmidx = vmID((vcpu hv)!vcidx);
      ws = vm_wk_st hv;
      hv1 = hv&#10631;vm_wk_st:=ws[vmidx:=VM_S_INV]&#10632; ;
      map1 = (CPU_MAPS.cpu_map_active (cpu_maps hv)) ! cidx;
      map2 = (cpu_is_haveVCPU (cpu_maps hv)) ! cidx;
      cpu0 = (cpu hv)!cidx;
      limit = length (vcpu hv);
      aN = map1 limit;
      vs = (vcpu_wk_st hv)[vcidx:=VCPU_S_INV];
      cpu0 = cpu0&#10631;running_num:=running_num cpu0-1&#10632;;
      hv2 = hv1&#10631;vcpu_wk_st:=vs,cpu:=(cpu hv)[cidx:=cpu0]&#10632;  
    in             
        if(running_num cpu0 = 0) then
          cpu_idle_req hv2 cidx
        else           
          if(aN = None ) then
            hv2
          else
            hv2&#10631;vcpu_wk_st:=(vcpu_wk_st hv2)[the aN:=VCPU_S_ACT],
               cpu:=(cpu hv2)[cidx:= cpu0&#10631;active_vcpu:=the aN&#10632;]&#10632;
&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vmm_reset_vm_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658;HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vmm_reset_vm_req hv cidx &#8801;
    let
      vcidx = active_vcpu ((cpu hv)!cidx);
      vmidx = vmID((vcpu hv)!vcidx);
      vmws = vm_wk_st hv;
      vmwsN = vmws[vmidx:=VM_S_ACT];
      cws = cpu_wk_st hv;
      cwsN = cws[cidx:=CPU_S_RUN]
    in  
      hv&#10631;cpu_wk_st:=cwsN,vm_wk_st:=vmwsN&#10632;  
&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_vcpuid_to_pcpuid_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; vm_id &#8658; vcpu_idx &#8658; HV &#215; cpu_id option &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;vm_vcpuid_to_pcpuid_req hv vmid vidx &#8801;
   let
     vm0 =  (vm hv)!vmid;
     vcpus0 = vcpus vm0
   in
      if(vidx&lt;length vcpus0) then
          (hv, Some (physID ((vcpu hv)!(vcpus0 !vidx))))
      else
        (hv,None)

  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_pcpuid_to_vcpuid_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; vm_id &#8658; cpu_id &#8658; HV &#215; vcpu_idx option &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;vm_pcpuid_to_vcpuid_req hv vmid cid &#8801;
   let
     vm0 =  (vm hv)!vmid;
     vcpus = vcpus vm0;
     map0 = (get_vcpuIDX (cpu_maps hv))!cid
   in
     (hv,map0 vcpus)

  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_pa2ipa_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; vm_id &#8658; u64  &#8658; HV &#215; u64 &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vm_pa2ipa_req hv vmid pa&#8801;
    if (pa = 0) then
      (hv,0)
    else
      let
        regions = address ((vm hv)!vmid);
        ret = ((get_paIdX (vm_regionMaps hv)) ! vmid) pa
      in
        case ret of
           None &#8658; (hv,0)|
           Some idx &#8658; (hv,(pa + offset (regions!idx)))
  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_ipa2pa_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; vm_id &#8658; u64  &#8658; HV &#215; u64 &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vm_ipa2pa_req hv vmid ipa&#8801;
    if (ipa = 0) then
      (hv,0)
    else
      let
        regions = address ((vm hv)!vmid);
        ret = ((get_ipaIdX (vm_regionMaps hv)) ! vmid) ipa
      in
        case ret of
           None &#8658; (hv,0)|
           Some idx &#8658; (hv,(ipa - offset (regions!idx)))
  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*interrupt*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_is_reserved_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; interrupt_id &#8658; (HV&#215;bool)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_is_reserved_req hv n &#8801; (hv, (Interrupt_hyper_bitmap (interrupts hv))!n)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_arch_conflict</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bitmap &#8658; interrupt_id &#8658; bool&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_arch_conflict bmp n &#8801; (bmp!n)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_reserve_int_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; interrupt_id &#8658; handlers &#8658; HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_reserve_int_req hv int_id hdl&#8801; 
    if int_id &lt; (length [(Interrupts.Interrupt_glb_bitmap (interrupts hv))]) then
      let
        x = (Interrupts.Interrupt_handlers (interrupts hv));
        bp = (Interrupts.Interrupt_glb_bitmap (interrupts hv));
        hp = (Interrupts.Interrupt_hyper_bitmap (interrupts hv))
      in
        hv&#10631;interrupts:=&#10631;Interrupt_hyper_bitmap=hp [int_id:=True],
                       Interrupt_glb_bitmap=bp [int_id:=True],
                       Interrupt_handlers=x [int_id := hdl]&#10632;&#10632;
    else
      hv&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
interrupt_handlers::Interrupt_handlers
*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_cpu_enable_req</span><span> </span><span class="delimiter">::</span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; interrupt_id &#8658; bool &#8658; HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_cpu_enable_req hv int_id en &#8801; let
    c = (!) (cpu hv) int_id
  in
    if en then
      hv&#10631;cpu_wk_st:=((cpu_wk_st hv)[int_id:=CPU_S_RUN])&#10632;
    else
      hv&#10631;cpu_wk_st:=((cpu_wk_st hv)[int_id:=CPU_S_IDLE])&#10632;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_cpu_ipi_send_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658; interrupt_id &#8658; HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_cpu_ipi_send_req hv t ip &#8801; let
    x = (!) (cpu_wk_st hv) t
  in
    hv&#10631;cpu_wk_st:=((cpu_wk_st hv)[ip:=(CPU_S_IDLE)])&#10632;
  &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_has_interrupt</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;VM &#8658; interrupt_id &#8658; bool&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;vm_has_interrupt v n &#8801; (int_bitmap v)! n = True&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_vm_inject_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; vm_id &#8658; interrupt_id &#8658; HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_vm_inject_req hv vi int_id &#8801; let
    v = (vm hv)!vi;
    x = v&#10631;int_bitmap:=((int_bitmap v)[int_id:=True])&#10632;
  in
    (hv&#10631;vm:=((vm hv)[int_id:=x])&#10632;)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_vm_register_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; interrupt_src &#8658; interrupt_id &#8658; HV &#215;bool&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_vm_register_req hv src int_id &#8801;
    if (interrupt_arch_conflict (Interrupts.Interrupt_glb_bitmap (interrupts hv)) int_id) then
      (hv , False)
    else
      let
        v = (vm hv)!src;
        iv = v&#10631;int_bitmap:=(int_bitmap v)[int_id:=True]&#10632;;
        gh = (interrupts hv);
        h = gh&#10631;Interrupt_glb_bitmap:=(int_bitmap v)[int_id:=True]&#10632;
      in
        ((hv&#10631;vm:=(vm hv)[int_id:=iv], interrupts:=h&#10632;), True)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>interrupt_handler_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; interrupt_id &#8658; interrupt_src &#8658; (HV &#215; bool option)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;interrupt_handler_req hv int_id src &#8801;
  if (vm_has_interrupt ((vm hv)!src) int_id) then
    ((interrupt_vm_inject_req hv (get_vmid_cid hv src) int_id), Some False)
  else 
    if (snd (interrupt_is_reserved_req hv int_id)) then
      let
        ix = (interrupts hv);
        hdl = (Interrupt_handlers ix)@[(irq_handler_t int_id src)];
        hext = [(irq_handler_t int_id src)]
      in
        (hv&#10631;interrupts:=ix&#10631;Interrupt_handlers:=hdl@hext&#10632;&#10632;, Some True)
    else (hv, None)&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*vm communication*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;find_index (&#955;x.(x=2)) [9..15] &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>insert_channel_msg_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Commu &#8658; channel_id &#8658; MSG &#8658; Commu &quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;insert_channel_msg_req c idx mesg &#8801;
        let
          ivc0 = ivc c;
          channel0 = ((channels ivc0) ! idx)&#10631;msg:=mesg&#10632;;
          channelsN = (channels ivc0)[idx:=channel0];
          ivcN = ivc0&#10631;channels:=channelsN&#10632;
        in
          c&#10631;ivc:=ivcN&#10632;
         &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>ivc_send_msg_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; cpu_id &#8658; vm_id &#8658; MSG &#8658; HV &#215; bool&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; ivc_send_msg_req hv cid vm_tgrt mesg &#8801;
      if (get_vmid_cid_req cid hv = vm_tgrt) then
        (hv,False)
      else
        let
          commu0 = commu hv ;
          vm_src = get_vmid_cid_req cid hv;
          ret =  (getChannel commu0) vm_src vm_tgrt
        in
          if (ret = None) then
            (hv,False)
          else
            let
              cN = insert_channel_msg_req commu0 (the ret) mesg
            in
              (hv&#10631;commu:=cN&#10632;,True)           
   &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vm_init_channel_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; vm_port &#8658; vm_id &#8658; HV&#215;bool&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;vm_init_channel_req hv pt vmid &#8801;
       let
         channels = channels (ivc (commu hv));
         nums = channel_num (ivc (commu hv));
         ret = (availChannel (commu hv)) pt vmid
       in
         if (ret = None) then
            if (nums &#8805; MAX_CHANNEL_NUM) then
              (hv,False)
            else
              let
                idx = nums;
                channel0 = if (vm_port.type pt = RECEIVE) then
                              (channels ! idx)&#10631;flag:=True,portDes:= Some pt&#10632;
                           else
                              (channels ! idx)&#10631;flag:=True,portSrc:= Some pt&#10632;;
                channelsN = channels[idx:=channel0];
                numsN = nums+1;
                ivcN = (ivc (commu hv))&#10631;channels:=channelsN,channel_num:=numsN&#10632;;
                commuN = (commu hv)&#10631;ivc:=ivcN&#10632;
              in
                (hv&#10631;commu:=commuN&#10632;,True)
          else
              let
                idx = the ret;
                channel0 = if (vm_port.type pt = RECEIVE) then
                              (channels ! idx)&#10631;portDes:= Some pt&#10632;
                           else
                              (channels ! idx)&#10631;portSrc:= Some pt&#10632;;
                channelsN = channels[idx:=channel0];
                ivcN = (ivc (commu hv))&#10631;channels:=channelsN&#10632;;
                commuN = (commu hv)&#10631;ivc:=ivcN&#10632;
              in
                (hv&#10631;commu:=commuN&#10632;,True)
   &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>init_port_in_channel_req</span><span> </span><span class="delimiter">::</span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; vm_id &#8658;  HV &#215; nat &quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;init_port_in_channel_req hv idx &#8801;
    let
      channels = channels (ivc (commu hv));
      i = find_index (&#955;x. flag x) channels
    in
      (hv,i)
  &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* whether this channel is available *)</span></span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*vm schedule. Actually change the active vcpu of every cpu *)</span></span></span></span></span><span>   
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>cpu_schedule_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; cpu_id &#8658; HV&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cpu_schedule_req hv cid &#8801; 
    let
        cpu0= (cpu hv)!cid;
        map1 = (CPU_MAPS.cpu_map_active (cpu_maps hv)) ! cid;
        limit = length (vcpu hv);
        aN = map1 limit;
        actOld = active_vcpu cpu0
    in
       if (running_num cpu0)&gt;1 then 
          hv&#10631;vcpu_wk_st:=(vcpu_wk_st hv)[actOld:=VCPU_S_PEND,the aN:=VCPU_S_ACT],
              cpu:=(cpu hv)[cid:= cpu0&#10631;active_vcpu:=the aN&#10632;]&#10632;
       else  hv
 &quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>t</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;int list&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t &#8801; [1,2,3]&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*Add Audit Info*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>audit_append_event</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; Audit &#8658; HV &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;audit_append_event hv a &#8801; 
      let 
        as = audit hv 
      in hv&#10631;audit:= a#as&#10632; &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vmm_list_vm_info_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;HV &#8658; HV &#215; VM_INFO list&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;vmm_list_vm_info_req hv &#8801; 
    let
      vmZ = List.zip (vm hv) (vm_wk_st hv);
      ret = List.map 
            (&#955;x. &#10631;vmId=VM.id (fst x), vmName=VM.name (fst x), vmType=VM.type (fst x),
                  vmState=snd x&#10632;)
             vmZ
    in
      (hv,ret)
   &quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>vmm_get_vm_id_req</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; HV &#8658; vm_name &#8658; HV &#215; vm_id option &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; vmm_get_vm_id_req hv name0 &#8801;
          let
            vms = (vm hv);
            limit = length vms;
            idx = find_index (&#955;x. (name x=name0)) vms
          in 
            if idx&lt;limit  then 
                (hv,Some idx)
            else  
                (hv,None) &quot;</span></span></span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span><span>
</span><span>
</span></pre>

</div>
</body>
</html>
