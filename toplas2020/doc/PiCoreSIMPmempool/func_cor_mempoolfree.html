<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Theory func_cor_mempoolfree (Isabelle2020: April 2020)</title>
<link media="all" rel="stylesheet" type="text/css" href="isabelle.css"/>
</head>

<body>
<div class="head"><h1>Theory func_cor_mempoolfree</h1>

<span class="command">theory</span> <span class="name">func_cor_mempoolfree</span><br/>
<span class="keyword">imports</span> <a href="func_cor_lemma.html"><span class="name">func_cor_lemma</span></a> <a href="../PiCoreSIMP/picore_SIMP_lemma.html"><span class="name">picore_SIMP_lemma</span></a><br/>

</div>
<div class="source">
<pre class="source"><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
Created by Yongwang Zhao (zhaoyw@buaa.edu.cn)
School of Computer Science &amp; Engineering, Beihang University, China
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">theory</span></span><span> </span><span>func_cor_mempoolfree</span><span>
</span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span>func_cor_lemma</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;PiCoreSIMP.picore_SIMP_lemma&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;Functional correctness of $k\_mem\_pool\_free$ &#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;intermediate conditions and their stable to rely cond&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond1_ext t b &#8801;
  &#10627;pool b &#8712; &#180;mem_pools &#8743; level b &lt; length (levels (&#180;mem_pool_info (pool b)))
    &#8743; block b &lt; length (bits (levels (&#180;mem_pool_info (pool b))!(level b)))
    &#8743; data b = block_ptr (&#180;mem_pool_info (pool b)) ((ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ (level b))) (block b)&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond1 t b &#8801;
  Mem_pool_free_pre t &#8745; mp_free_precond1_ext t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond1_ext t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">declare</span></span><span> </span><span class="delimiter">[</span><span class="delimiter">[</span><span>show_types</span><span class="delimiter">]</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond1_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond1 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_pool_free_pre_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_free_precond1_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* precond without freeding_node *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond1_0 t b &#8801;
  {s. inv s &#8743; allocating_node s t = None} &#8745; mp_free_precond1_ext t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond1_0_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond1_0 t b)  (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;inv &#8743; &#180;allocating_node t = None&#10628;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;inv&#10628; &#8745; &#10627;&#180;allocating_node t = None&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_inv_free_rely1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span> </span><span>Mem_pool_free_rely_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_free_precond1_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond2_ext t b &#8801; &#10627;&#180;freeing_node t = Some b&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond2 t b &#8801;
  mp_free_precond1_0 t b &#8745; mp_free_precond2_ext t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond2_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond2_ext t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond2 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(rule stable_int2)
  apply(simp add:stable_inv_free_rely1)
  apply(simp add:mp_free_precond1_ext_stb)*)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_free_precond1_0_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_free_precond2_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond3_ext t b &#8801; &#10627;&#180;need_resched t = False&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond3 t b &#8801; (mp_free_precond2 t b) &#8745; mp_free_precond3_ext t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond3_ext_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond3_ext t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond3_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond3 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond3_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_ext t b &#8801; &#10627;&#180;lsizes t = [ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))]&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4 t b &#8801;
  mp_free_precond3 t b &#8745; mp_free_precond4_ext t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond4_ext_stb</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond4_ext t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>ALIGN4_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x = y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond4_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond4 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_0_ext t b &#8801;
  &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii =  (ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ ii))
                          &#8743; length (&#180;lsizes t) &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_0 t b &#8801; mp_free_precond3 t b &#8745; mp_free_precond4_0_ext t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond4_0_ext_stb</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond4_0_ext t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>ALIGN4_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x = y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond4_0_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond4_0 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_0_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_1 t b &#8801;
  mp_free_precond4_0 t b &#8745; &#10627;length (&#180;lsizes t) = &#180;i t&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond4_1_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond4_1 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_0_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_2 t b &#8801;
  mp_free_precond4_1 t b &#8745; &#10627;&#180;i t &#8804; level b &#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond4_2_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond4_2 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>smt</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_3 t b &#8801;
  mp_free_precond4_0 t b &#8745; (&#10627;&#180;i t &#8804; level b &#10628; &#8745; &#10627;length (&#180;lsizes t) = &#180;i t + 1&#10628;)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond4_3_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond4_3 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_0_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>smt</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond5_ext t b &#8801;
  &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ ii))
                             &#8743; length (&#180;lsizes t) &gt; level b&#10628;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*abbreviation &quot;mp_free_precond5 t b &#8801;
  mp_free_precond3 t b &#8745; &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ ii))
                             &#8743; &#180;i t &gt; level b &#8743; length (&#180;lsizes t) = &#180;i t&#10628;&quot;*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond5 t b &#8801; mp_free_precond3 t b &#8745; mp_free_precond5_ext t b&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond5 t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond5_ext_stb</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond5_ext t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>ALIGN4_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x = y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond5_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond5 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond5_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond6 t b &#8801;
  mp_free_precond5 t b &#8745; &#10627;&#180;free_block_r t = True&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond6_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond6 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond7 t b &#8801;
  mp_free_precond6 t b &#8745; &#10627;&#180;bn t = block b&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond7_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond7 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>smt</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b &#8801;
  mp_free_precond1_0 t b &#8745; &#10627;level b &lt; length (&#180;lsizes t)
     &#8743; (&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ ii))
     &#8743; &#180;bn t &lt; length (bits (levels (&#180;mem_pool_info (pool b))!(&#180;lvl t)))
     &#8743; &#180;bn t = (block b) div (4 ^ (level b - &#180;lvl t))
     &#8743; &#180;lvl t &#8804; level b
     &#8743; (&#180;free_block_r t &#10230;
          (&#8707;blk. &#180;freeing_node t = Some blk &#8743; pool blk = pool b &#8743; level blk = &#180;lvl t &#8743; block blk = &#180;bn t)
        &#8743; &#180;alloc_memblk_data_valid (pool b) (the (&#180;freeing_node t)))
     &#8743; (&#172; &#180;free_block_r t &#10230; &#180;freeing_node t = None)
     &#8998;&#8249;(*&#8743; ((if &#180;freeing_node t &#8800; None then &#180;lvl t + 1 else 0) &gt; 0
          &#10230; &#180;free_block_r t)*) (* this cond is implied by upper conds *)&#8250; &#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
var v = (if &#180;freeing_node t &#8800; None 1 else 0) + &#180;lvl t
the v decrease in each loop
*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*abbreviation &quot;mp_free_precond8_inv t b &#945; &#8801;
  mp_free_precond8 t b &#8745; &#10627; &#945; = (if &#180;freeing_node t &#8800; None then 1 else 0) + &#180;lvl t &#10628;&quot;*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8801;
  mp_free_precond8 t b &#8745; &#10627; &#945; = (if &#180;freeing_node t &#8800; None then &#180;lvl t + 1 else 0) &#10628;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>inv_&#945;gt0_imp_looppre</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628; &#8838; mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>looppre_imp_exist_&#945;gt0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;x &#8712; mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628; &#10233; &#8707;&#945;. x &#8712; mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x &#8712; mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628; &#10233; x &#8712; mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_&#945;gt0_imp_looppre</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span>
</span><span>      </span><span>subsetI</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>                 </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>loopbody_sat_invterm_imp_inv_post</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar, mp_free_precond8_inv t b (&#945; - 1)]
 &#10233; &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Conseq</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>          </span><span>rely</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b (&#945; - 1)&quot;</span></span></span><span>
</span><span>          </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span> </span><span>P</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>stm8_inv_imp_prepost</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; (&#8704;&#945;. &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar, mp_free_precond8_inv t b (&#945; - 1)])
  &#10233; &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;v. v&#8712;mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628; &#10230;
      &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [{v}, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>allpre_eq_pre</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span>                          </span><span>P</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;&#945;. v &#8712; mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>looppre_imp_exist_&#945;gt0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>exE</span><span class="delimiter">)</span><span>
</span><span>
</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>sat_pre_imp_allinpre</span><span class="delimiter">[</span><span>of</span><span> </span><span>P</span><span> </span><span>_</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>    </span><span>loopbody_sat_invterm_imp_inv_post</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>loopbody_sat_invterm_imp_inv_post2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;&#946;&lt;&#945;. &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar, mp_free_precond8_inv t b &#946;]
 &#10233;  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Conseq</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>          </span><span>rely</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b _&quot;</span></span></span><span>
</span><span>          </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span> </span><span>P</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>stm8_inv_imp_prepost2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; (&#8704;&#945;. &#8707;&#946;&lt;&#945;. &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar, mp_free_precond8_inv t b &#946;])
  &#10233; &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;v. v&#8712;mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628; &#10230;
      &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [{v}, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>allpre_eq_pre</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span>                          </span><span>P</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;&#945;. v &#8712; mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>looppre_imp_exist_&#945;gt0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>exE</span><span class="delimiter">)</span><span>
</span><span>
</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>sat_pre_imp_allinpre</span><span class="delimiter">[</span><span>of</span><span> </span><span>P</span><span> </span><span>_</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>    </span><span>loopbody_sat_invterm_imp_inv_post</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>stm8_loopinv0</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b 0 &#8838; &#10627;&#172; &#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>stm8_loopinv_&#945;</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#945; &gt; 0 &#10233; mp_free_precond8_inv t b &#945; &#8838; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>inv_&#945;eq0_eq_looppre</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b 0 = mp_free_precond8 t b &#8745; &#10627;&#172; &#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>alloc_memblk_data_valid_stb_free</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_memblk_data_valid x (pool b) (the (freeing_node x t)) &#10233;
     (x, y) &#8712; lvars_nochange_rel t &#10233;
     (x, y) &#8712; gvars_conf_stable &#10233;
    alloc_memblk_data_valid y (pool b) (the (freeing_node y t))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x (pool b)) = buf (mem_pool_info y (pool b))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_l x t = free_l y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x (pool b)) = max_sz (mem_pool_info y (pool b))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x t = freeing_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond8 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_inv_free_rely</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_ptr_def</span><span> </span><span>ALIGN4_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>          </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_free_rely_def</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>ALIGN4_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>ALIGN4_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>ALIGN4_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_inv_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond8_inv t b &#945;) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl x t = lvl y t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x t = freeing_node y t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_inv_presv_rely</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;s&#8712;mp_free_precond8_inv t b &#945; &#10233; (s,r)&#8712;Mem_pool_free_rely t &#10233; &#8707;&#946;&#8804;&#945;. r&#8712;mp_free_precond8_inv t b &#946;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>exI</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>x</span><span class="delimiter">=</span><span>&#945;</span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_inv_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_1 t b &#945; &#8801;
  mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_1_imp_free_block_r</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_1 t b &#945; &#8838; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stm8_loopinv_&#945;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_1_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond8_1 t b &#945;) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_inv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_1&#39; t b &#8801;
  mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_1&#39;_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond8_1&#39; t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>smt</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_2 t b &#945; &#8801;
  mp_free_precond8_1 t b &#945; &#8745; &#10627;&#180;lsz t = &#180;lsizes t ! (&#180;lvl t)&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_2_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond8_2 t b &#945;) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>smt</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945; &#8801;
  mp_free_precond8_2 t b &#945; &#8745; &#10627;&#180;blk t = block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bn t)&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_3_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond8_3 t b &#945;) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span> </span><span>block_ptr_def</span><span> </span><span>Mem_pool_free_rely_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x = y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t =  blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsz x t =  lsz y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bn x t =  bn y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x (pool b)) =  buf (mem_pool_info y (pool b))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond9 t b &#8801; mp_free_precond1 t b&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond1 t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond9_stb</span><span> </span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond9 t b) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;proof of each statement&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_inv_mempool_info</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va &#8743; inv_bitmap_freelist Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    inv_mempool_info
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
           freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;i&lt;length (levels (mem_pool_info Va (pool b))).
            length (bits (levels (mem_pool_info Va (pool b)) ! i)) = n_max (mem_pool_info Va (pool b)) * 4 ^ i)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_inv_bitmap_freelist</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur Va &#8743; inv_thd_waitq Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va &#8743; inv_bitmap Va &#8743; inv_aux_vars Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    inv_bitmap_freelist
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
           freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i &#8800; level b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j &#8800; block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i &#8800; level b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j &#8800; block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>distinct_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_inv_bitmap</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur Va &#8743; inv_thd_waitq Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va &#8743; inv_bitmap Va &#8743; inv_aux_vars Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    inv_bitmap
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
           freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i - 1 = level b &#8743; j div 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>lessI</span><span> </span><span>nat_neq_iff</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (i - Suc NULL)) ! (j div 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (i - Suc NULL)) ! (j div 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>One_nat_def</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; j * 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (j * 4) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (Suc (j * 4)) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (Suc (j * 4))
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (Suc (j * 4))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; (j * 4 + 3) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4 + 3)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4 + 3)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i - 1 = level b &#8743; j div 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>lessI</span><span> </span><span>nat_neq_iff</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (i - Suc NULL)) ! (j div 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (i - Suc NULL)) ! (j div 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>One_nat_def</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; j * 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (j * 4) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (Suc (j * 4)) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (Suc (j * 4))
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (Suc (j * 4))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; (j * 4 + 3) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4 + 3)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4 + 3)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i - 1 = level b &#8743; j div 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>lessI</span><span> </span><span>nat_neq_iff</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (i - Suc NULL)) ! (j div 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (i - Suc NULL)) ! (j div 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>One_nat_def</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; j * 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (j * 4) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (Suc (j * 4)) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (Suc (j * 4))
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (Suc (j * 4))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; (j * 4 + 3) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4 + 3)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4 + 3)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i - 1 = level b &#8743; j div 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>lessI</span><span> </span><span>nat_neq_iff</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (i - Suc NULL)) ! (j div 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (i - Suc NULL)) ! (j div 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>One_nat_def</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; j * 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (j * 4) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (j * 4)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (Suc (j * 4)) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (Suc (j * 4))
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (Suc (j * 4))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; (j * 4 + 3) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                  = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4 + 3)
                  = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4 + 3)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>              </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>               </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>              </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i - 1 = level b &#8743; j div 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>lessI</span><span> </span><span>nat_neq_iff</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (i - Suc NULL)) ! (j div 4)
                = bits (levels (mem_pool_info Va (pool b)) ! (i - Suc NULL)) ! (j div 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>            </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>            </span><span>One_nat_def</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>            </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; j * 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4)
                = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>            </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>             </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>            </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (j * 4) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (j * 4)
                = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (j * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>            </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>             </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>            </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; Suc (Suc (j * 4)) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! Suc (Suc (j * 4))
                = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! Suc (Suc (j * 4))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>            </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>             </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>            </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc i = level b &#8743; (j * 4 + 3) = block b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>less_Suc_eq</span><span> </span><span>nth_list_update_neq</span><span> </span><span>order_less_irrefl</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (Suc i)) ! (j * 4 + 3)
                = bits (levels (mem_pool_info Va (pool b)) ! (Suc i)) ! (j * 4 + 3)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>            </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>             </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>            </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b &#8743; j = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i - 1 = level b &#8743; j div 4 = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! i) ! j
                = bits (levels (mem_pool_info Va (pool b)) ! i) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>            </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va (pool b)))
               [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                  &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] ! (i - 1)) ! (j div 4)
                = bits (levels (mem_pool_info Va (pool b)) ! (i - 1)) ! (j div 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool_lvl.cases</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>             </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info Va (pool b)) ! (i - Suc NULL)) ! (j div 4) &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info Va (pool b)))
                             [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                                &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;] !
                             i)) = length (bits (levels (mem_pool_info Va (pool b)) ! i))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_inv_auxvars</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur Va &#8743; inv_thd_waitq Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va &#8743; inv_bitmap Va &#8743; inv_aux_vars Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    data b = block_ptr (mem_pool_info Va (pool b)) (ALIGN4 (max_sz (mem_pool_info Va (pool b))) div 4 ^ level b) (block b) &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    allocating_node Va t = None &#10233;
    freeing_node Va t = None &#10233;
    inv_aux_vars
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
         freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>inv_aux_vars_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (&#8704;t n. freeing_node s t = Some n &#10230; get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ta = t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = pool b &#8743; level n = level b &#8743; block n = block b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node
             (Va&#10631;mem_pool_info := (mem_pool_info Va)
                   (pool b := mem_pool_info Va (pool b)
                      &#10631;levels := (levels (mem_pool_info Va (pool b)))
                         [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                            &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
                   freeing_node := freeing_node Va(t &#8614; b)&#10632;) ta = freeing_node Va ta&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool n) (level n) (block n) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool n) (level n) (block n) =
            get_bit
             (mem_pool_info
               (Va&#10631;mem_pool_info := (mem_pool_info Va)
                     (pool b := mem_pool_info Va (pool b)
                        &#10631;levels := (levels (mem_pool_info Va (pool b)))
                           [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                              &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
                     freeing_node := freeing_node Va(t &#8614; b)&#10632;))
             (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; pool n = pool b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level n = level b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; block n = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va ta = Some n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (&#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING &#8743; mem_block_addr_valid s n
                          &#10230; (&#8707;t. freeing_node s t = Some n)) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = pool b &#8743; level n = level b &#8743; block n = block b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool n) (level n) (block n) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_def</span><span> </span><span>set_bit_get_bit_neq</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_def</span><span> </span><span>set_bit_get_bit_neq</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid Va n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mem_block_addr_valid_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;t&#39;. t&#39; &#8800; t &#8743; freeing_node Va t&#39; = Some n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>option.discI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;data b = data n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span> </span><span>mem_block_addr_valid_def</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (&#8704;t n. allocating_node s t = Some n
                          &#10230; get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ta = t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va ta = Some n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = pool b &#8743; level n = level b &#8743; block n = block b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; pool n = pool b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level n = level b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; block n = block b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING &#8743; mem_block_addr_valid s n
                        &#10230; (&#8707;t. allocating_node s t = Some n) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = pool b &#8743; level n = level b &#8743; block n = block b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_def</span><span> </span><span>set_bit_get_bit_neq</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_def</span><span> </span><span>set_bit_get_bit_neq</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid Va n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mem_block_addr_valid_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;t&#39;. t&#39; &#8800; t &#8743; allocating_node Va t&#39; = Some n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>option.discI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;data b = data n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span> </span><span>mem_block_addr_valid_def</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. t1 &#8800; t2 &#8743; freeing_node s t1 = Some n1 &#8743; freeing_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1 &#8800; t &#8743; t2 &#8800; t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1 = t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t2 = Some n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b = n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t2 = t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b = n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. t1 &#8800; t2 &#8743; allocating_node s t1 = Some n1 &#8743; allocating_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1 &#8800; t &#8743; t2 &#8800; t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1 = t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t2 = Some n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b = n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t2 = t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b = n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. allocating_node s t1 = Some n1 &#8743; freeing_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1 &#8800; t &#8743; t2 &#8800; t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1 = t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t2 = Some n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b = n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t2 = t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b = n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_inv_lvl0</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur Va &#8743; inv_thd_waitq Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va
   &#8743; inv_bitmap Va &#8743; inv_aux_vars Va &#8743; inv_bitmap0 Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    data b = block_ptr (mem_pool_info Va (pool b)) (ALIGN4 (max_sz (mem_pool_info Va (pool b))) div 4 ^ level b) (block b) &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    allocating_node Va t = None &#10233;
    freeing_node Va t = None &#10233;
    inv_bitmap0
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
         freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b = i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_inv_lvln</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur Va &#8743; inv_thd_waitq Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va
   &#8743; inv_bitmap Va &#8743; inv_aux_vars Va &#8743; inv_bitmapn Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    data b = block_ptr (mem_pool_info Va (pool b)) (ALIGN4 (max_sz (mem_pool_info Va (pool b))) div 4 ^ level b) (block b) &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    allocating_node Va t = None &#10233;
    freeing_node Va t = None &#10233;
    inv_bitmapn
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
         freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b = length (levels (mem_pool_info Va (pool b))) - 1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b = i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_inv_lvls_not4free</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur Va &#8743; inv_thd_waitq Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va
   &#8743; inv_bitmap Va &#8743; inv_aux_vars Va &#8743; inv_bitmap_not4free Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    data b = block_ptr (mem_pool_info Va (pool b)) (ALIGN4 (max_sz (mem_pool_info Va (pool b))) div 4 ^ level b) (block b) &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    allocating_node Va t = None &#10233;
    freeing_node Va t = None &#10233;
    inv_bitmap_not4free
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
         freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>Let_def</span><span> </span><span>partner_bits_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b = i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b = j div 4 * 4&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b = j div 4 * 4 + 1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b = j div 4 * 4 + 2&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b = j div 4 * 4 + 3&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_smt1_inv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv Va &#10233;
    block b &lt; length (bits (levels (mem_pool_info Va (pool b)) ! level b)) &#10233;
    level b &lt; length (levels (mem_pool_info Va (pool b))) &#10233;
    pool b &#8712; mem_pools Va &#10233;
    data b = block_ptr (mem_pool_info Va (pool b)) (ALIGN4 (max_sz (mem_pool_info Va (pool b))) div 4 ^ level b) (block b) &#10233;
    get_bit (mem_pool_info Va) (pool b) (level b) (block b) = ALLOCATED &#10233;
    allocating_node Va t = None &#10233;
    freeing_node Va t = None &#10233;
    inv (Va&#10631;mem_pool_info := (mem_pool_info Va)
           (pool b := mem_pool_info Va (pool b)
              &#10631;levels := (levels (mem_pool_info Va (pool b)))
                 [level b := (levels (mem_pool_info Va (pool b)) ! level b)
                    &#10631;bits := (bits (levels (mem_pool_info Va (pool b)) ! level b))[block b := FREEING]&#10632;]&#10632;),
           freeing_node := freeing_node Va(t &#8614; b)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_inv_mempool_info</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_inv_bitmap_freelist</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_inv_bitmap</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_inv_auxvars</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_inv_lvl0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_inv_lvln</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_inv_lvls_not4free</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1_h1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_free_pre t &#8745;
          &#10627;pool b &#8712; &#180;mem_pools &#8743;
           level b &lt; length (levels (&#180;mem_pool_info (pool b))) &#8743;
           block b &lt; length (bits (levels (&#180;mem_pool_info (pool b)) ! level b)) &#8743;
           data b =
           block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ level b) (block b)&#10628; &#8745;
          &#10627;&#180;cur = Some t&#10628; &#8745;
          {Va} &#8745;
          &#10627;&#180;get_bit_s (pool b) (level b) (block b) = ALLOCATED&#10628; &#8745;
          {Va} &#8800;
          {} &#10233;
   &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (level b) (block b);;
             &#180;freeing_node := &#180;freeing_node(t &#8614;
             b)) sat<span class="hidden">&#8681;</span><sub>p</sub> [Mem_pool_free_pre t &#8745;
                       &#10627;pool b &#8712; &#180;mem_pools &#8743;
                        level b &lt; length (levels (&#180;mem_pool_info (pool b))) &#8743;
                        block b &lt; length (bits (levels (&#180;mem_pool_info (pool b)) ! level b)) &#8743;
                        data b =
                        block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ level b)
                         (block b)&#10628; &#8745;
                       &#10627;&#180;cur = Some t&#10628; &#8745;
                       {Va} &#8745;
                       &#10627;&#180;get_bit_s (pool b) (level b) (block b) = ALLOCATED&#10628; &#8745;
                       {Va}, {(x, y).
                              x = y}, UNIV, &#10627;&#180;(Pair Va) &#8712; Mem_pool_free_guar t&#10628; &#8745;
                                            (&#10627;&#180;invariant.inv &#8743; &#180;allocating_node t = None&#10628; &#8745;
                                             &#10627;pool b &#8712; &#180;mem_pools &#8743;
                                              level b &lt; length (levels (&#180;mem_pool_info (pool b))) &#8743;
                                              block b &lt; length (bits (levels (&#180;mem_pool_info (pool b)) ! level b)) &#8743;
                                              data b =
                                              block_ptr (&#180;mem_pool_info (pool b))
                                               (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ level b) (block b)&#10628; &#8745;
                                             mp_free_precond2_ext t b)]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Va&#10631;mem_pool_info := set_bit_freeing (mem_pool_info Va) (pool b) (level b) (block b)&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = level b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_smt1_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_smt1_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; AWAIT bits (levels (&#180;mem_pool_info (pool b)) ! level b) ! block b = ALLOCATED THEN
            &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (level b) (block b);;
           &#180;freeing_node := &#180;freeing_node (t := Some b)
            END) sat<span class="hidden">&#8681;</span><sub>p</sub>
    [mp_free_precond1 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond2 t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V &#8800; Va&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond1 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} &#8745;
                     &#10627;get_bit &#180;mem_pool_info (pool b) (level b) (block b) = ALLOCATED&#10628; &#8745;
                     {Va} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;need_resched := &#180;need_resched(t := False)) sat<span class="hidden">&#8681;</span><sub>p</sub>
    [mp_free_precond2 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond3 t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond2 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;need_resched := (need_resched V)(t := False)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;need_resched := (need_resched V)(t := False)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm3</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;lsizes := &#180;lsizes(t := [ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))])) sat<span class="hidden">&#8681;</span><sub>p</sub>
    [mp_free_precond3 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond4 t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond3 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := [ALIGN4 (max_sz (mem_pool_info V (pool b)))])&#10632;)
                          &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := [ALIGN4 (max_sz (mem_pool_info V (pool b)))])&#10632;)
                          &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm41_h1_1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(n::nat) &gt; 0 &#8743; (x::nat) mod y = 0 &#10233; n * x mod y = 0&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm41_h1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>p1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t &#8804; level b&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes V t) = i V t&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv V&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p4</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;i V t. lsizes V t ! ii = ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ ii&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p5</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes V t &#8800; []&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p6</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool b &#8712; mem_pools V&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p7</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p8</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">and</span></span><span>   </span><span>p9</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii = i V t&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)]) ! ii
            = ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ ii&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>p2</span><span> </span><span>p9</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - 1) div 4)]) ! ii
                     = ALIGN4 (lsizes V t ! (i V t - 1) div 4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>nth_append_length</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>p2</span><span> </span><span>p4</span><span> </span><span>p5</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes V t ! (i V t - 1) div 4 = ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ (i V t - 1) div 4&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>One_nat_def</span><span> </span><span>diff_less_mono2</span><span> </span><span>diff_zero</span><span> </span><span>length_greater_0_conv</span><span> </span><span>zero_less_Suc</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">hence</span></span><span> </span><span>a1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes V t ! (i V t - 1) div 4 = ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ (i V t)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>div_mult2_eq</span><span> </span><span>length_greater_0_conv</span><span> </span><span>p2</span><span> </span><span>p5</span><span>
</span><span>          </span><span>plus_1_eq_Suc</span><span> </span><span>power_add</span><span> </span><span>power_commutes</span><span> </span><span>power_one_right</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>p6</span><span> </span><span>p3</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&gt;0. max_sz (mem_pool_info V (pool b))
                      = (4 * n) * (4 ^ (length (levels (mem_pool_info V (pool b)))))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>n</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n &gt; 0 &#8743; max_sz (mem_pool_info V (pool b))
                        = (4 * n) * (4 ^ (length (levels (mem_pool_info V (pool b)))))&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">hence</span></span><span> </span><span>a2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n &gt; 0 &#8743; max_sz (mem_pool_info V (pool b))
              = n * (4 ^ (length (levels (mem_pool_info V (pool b))) + 1))&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">hence</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b)) mod 4 = 0&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">hence</span></span><span> </span><span>a3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V (pool b))) = max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>align40</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">with</span></span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a4</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes V t ! (i V t - 1) div 4 = max_sz (mem_pool_info V (pool b)) div 4 ^ (i V t)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>p1</span><span> </span><span>p2</span><span> </span><span>p7</span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(max_sz (mem_pool_info V (pool b)) div 4 ^ i V t) mod 4 = 0&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ (length (levels (mem_pool_info V (pool b))) + 1) div 4 ^ i V t mod 4 = NULL&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>pow_lt_mod0</span><span class="delimiter">[</span><span>of</span><span> </span><span>4</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b)))+1&quot;</span></span></span><span> </span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm41_h1_1</span><span>
</span><span>      </span><span class="delimiter">[</span><span>of</span><span> </span><span>n</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 * 4 ^ length (levels (mem_pool_info V (pool b))) div 4 ^ i V t&quot;</span></span></span><span> </span><span>4</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>m_mod_div</span><span> </span><span>mempool_free_stm41_h1_1</span><span> </span><span>pow_mod_0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command">with</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>p9</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>align40</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm41</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;lsizes := &#180;lsizes
           (t := &#180;lsizes t @ [ALIGN4 (&#180;lsizes t ! (&#180;i t - 1) div 4)]))
      sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond4_2 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V}, {(s, t). s = t}, UNIV,
            &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; (mp_free_precond2 t b &#8745; &#10627;&#172; &#180;need_resched t&#10628; &#8745;
             &#10627;(&#8704;ii&lt;length (&#180;lsizes t).
                  &#180;lsizes t ! ii = ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ ii) &#8743; &#180;lsizes t &#8800; []&#10628; &#8745;
             (&#10627;&#180;i t &#8804; level b&#10628; &#8745; &#10627;length (&#180;lsizes t) = Suc (&#180;i t)&#10628;))]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_2 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)])&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)])&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; i V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>nth_append</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii = i V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm41_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm4</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (FOR (t &#9656; &#180;i := &#180;i(t := 1));
        &#180;i t &#8804; level b;
        (t &#9656; &#180;i := &#180;i(t := &#180;i t + 1)) DO
        (t &#9656; &#180;lsizes := &#180;lsizes(t := &#180;lsizes t @ [ALIGN4 (&#180;lsizes t ! (&#180;i t - 1) div 4)]))
      ROF) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond4 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond5 t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_1 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* statement: t &#9656; &#180;i := &#180;i(t := 1) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := Suc NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := Suc NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* statement: WHILE &#180;i t &#8804; level b DO *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_3 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* statement: t &#9656; &#180;lsizes := &#180;lsizes(t := &#180;lsizes t @ [ALIGN4 (&#180;lsizes t ! (&#180;i t - 1) div 4)]) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm41</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* statement: (t &#9656; &#180;i := &#180;i(t := &#180;i t + 1)) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond4_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4_3 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := Suc (i V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := Suc (i V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_free_guar_def</span><span> </span><span>Id_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* end of statement: WHILE &#180;i t &#8804; level b DO *)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm5</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;free_block_r := &#180;free_block_r (t := True))
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond5 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond6 t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond5 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;free_block_r := (free_block_r V)(t := True)&#10632;) &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;free_block_r := (free_block_r V)(t := True)&#10632;) &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm6</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;bn := &#180;bn (t := block b))
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond6 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond7 t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond6 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;bn := (bn V)(t := block b)&#10632;) &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;bn := (bn V)(t := block b)&#10632;) &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm7</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;lvl := &#180;lvl (t := level b))
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond7 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond7 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lvl := (lvl V)(t := level b)&#10632;) &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lvl := (lvl V)(t := level b)&#10632;) &#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_ptr_def</span><span> </span><span>inv_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;statement 8&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond1 Va t b &#8801; Va&#10631;mem_pool_info := set_bit_free (mem_pool_info Va) (pool b) (lvl Va t) (bn Va t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond2 Va t b &#8801; (free_stm8_precond1 Va t b)&#10631;freeing_node := (freeing_node Va)(t := None)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_loopinv1 Va t b &#8801;
  {V. let minf0 = (mem_pool_info Va)(pool b);
          lvl0 = (levels minf0) ! (lvl Va t);
          minf1 = (mem_pool_info V)(pool b);
          lvl1 = (levels minf1) ! (lvl Va t) in
      cur V = cur Va &#8743; tick V = tick Va &#8743; thd_state V = thd_state Va &#8743; (V,Va)&#8712;gvars_conf_stable
      &#8743; (&#8704;p. p &#8800; pool b &#10230; mem_pool_info V p = mem_pool_info Va p)
      &#8743; (&#8704;j. j &#8800; lvl Va t &#10230; (levels minf0)!j = (levels minf1)!j)
      &#8743; (bits lvl1 = list_updates_n (bits lvl0) ((bn Va t div 4) * 4) (i V t) NOEXIST)
      &#8743; (free_list lvl1 = removes (map (&#955;ii. block_ptr minf0 (lsz Va t) ((bn Va t div 4) * 4 + ii)) [0..&lt;(i V t)]) (free_list lvl0))
      &#8743; (wait_q minf0 = wait_q minf1)
      &#8743; (&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; V Va)
      &#8743; freeing_node Va t = freeing_node V t &#8743; allocating_node Va t = allocating_node V t &#8743; free_block_r Va t = free_block_r V t
      &#8743; bn Va t = bn V t &#8743; lvl Va t = lvl V t &#8743; lsz Va t = lsz V t &#8743; lsizes Va t = lsizes V t
      &#8743; i V t &#8804; 4}&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>V_free_stm8_loopinv1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0 &#10233; V &#8712; free_stm8_loopinv1 V t b&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 Va t b &#8801; free_stm8_loopinv1 (free_stm8_precond2 Va t b) t b&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond4 Va t b &#8801; free_stm8_precond3 Va t b &#8745; &#10627;&#180;i t = 4&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond30 Va t b &#8801; free_stm8_precond3 Va t b &#8745; &#10627;&#180;i t &lt; 4&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond31 V t b &#8801; V&#10631;bb := (bb V) (t:=(bn V t div 4) * 4 + i V t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond32 V t b &#8801;
  let minf = mem_pool_info V (pool b) in
    V&#10631;mem_pool_info:= (mem_pool_info V) (pool b := minf &#10631;levels := (levels minf)
      [lvl V t := ((levels minf) ! (lvl V t)) &#10631;bits := (bits ((levels minf) ! (lvl V t))) [bb V t := NOEXIST]&#10632;] &#10632;)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond33 V t b &#8801;
  V&#10631;block_pt := (block_pt V) (t:=block_ptr (mem_pool_info V (pool b)) (lsz V t) (bb V t))&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond34 V t b &#8801;
  let minf = mem_pool_info V (pool b) in
    V&#10631;mem_pool_info:= (mem_pool_info V) (pool b := minf &#10631;levels := (levels minf)
      [lvl V t := ((levels minf) ! (lvl V t)) &#10631;free_list := remove1 (block_pt V t) (free_list ((levels minf) ! (lvl V t)))&#10632;] &#10632;)&#10632;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond1 V t b} &#8838; &#10627;&#180;(freeing_node_update (&#955;_. &#180;freeing_node(t := None))) &#8712; {free_stm8_precond2 V t b}&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>block_fits0_h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;maxsz mod mm = 0 &#10233; aa &lt; nmax * mm &#10233;
    maxsz div mm * aa + maxsz div mm  &lt; Suc (nmax * maxsz)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;maxsz div mm * aa &#8804; maxsz div mm * (nmax * mm - 1)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Groups.add_ac</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Groups.mult_ac</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Groups.mult_ac</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_leI</span><span> </span><span>distrib_left</span><span>
</span><span>      </span><span>le_imp_less_Suc</span><span> </span><span>mod_div_self</span><span> </span><span>mult.right_neutral</span><span> </span><span>mult_0_right</span><span> </span><span>mult_Suc_right</span><span> </span><span>mult_less_cancel2</span><span> </span><span>mult_zero_right</span><span> </span><span>not_le</span><span> </span><span>plus_nat.simps</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>block_fits0_h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(lvlt::nat) &gt; 0 &#10233; lvlt &#8804; lvlb &#10233; ivt &lt; (4::nat) &#10233; blockb &lt; nmax * 4 ^ lvlb &#10233;
    blockb div 4 ^ (lvlb - lvlt) div 4 * 4 + ivt &lt; nmax * 4 ^ lvlt&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nmax &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mult_not_zero</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blockb div 4 ^ (lvlb - lvlt) &lt; (nmax * 4 ^ lvlt)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blockb &lt; nmax * 4 ^ (lvlt + (lvlb - lvlt)) &#8743; nmax * 4 ^ lvlt &#8800; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8896;n na nb. &#172; n &lt; na * nb &#8744; n div na &lt; nb &#8744; nb = NULL&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>less_mult_imp_div_less</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mult.commute</span><span> </span><span>mult.left_commute</span><span> </span><span>power_add</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blockb div 4 ^ (lvlb - lvlt) div 4 * 4 + 4 &#8804; nmax * 4 ^ lvlt&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8896;x. x &lt; nmax * 4 ^ lvlt &#10230; x div 4 * 4 + 4 &#8804; nmax * 4 ^ lvlt&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x mod 4 = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>modn0_xy_n</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                 </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>divn_multn_addn_le</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>block_fits0</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V &#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  vt &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;0 &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b
    &#8712; &#10627;block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t)&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>block_fits_def</span><span> </span><span>block_ptr_def</span><span> </span><span>buf_size_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsz vt&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsz (let minf = mem_pool_info vt (pool b)
         in vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t), mem_pool_info := (mem_pool_info vt)
                   (pool b := minf&#10631;levels := (levels minf)[lvl vt t := (levels minf ! lvl vt t)
                      &#10631;bits := (bits (levels minf ! lvl vt t))[bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;]&#10632;)&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bn vt t div 4 * 4 + i vt t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bb (let minf = mem_pool_info vt (pool b)
        in vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t), mem_pool_info := (mem_pool_info vt)
                  (pool b := minf&#10631;levels := (levels minf)[lvl vt t := (levels minf ! lvl vt t)
                  &#10631;bits := (bits (levels minf ! lvl vt t))[bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;]&#10632;)&#10632;) t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info vt (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info
                   (let minf = mem_pool_info vt (pool b)
                    in vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t),
                            mem_pool_info := (mem_pool_info vt)
                              (pool b := minf &#10631;levels := (levels minf)[lvl vt t := (levels minf ! lvl vt t)
                          &#10631;bits := (bits (levels minf ! lvl vt t))[bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;]&#10632;)&#10632;)
                   (pool b))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info vt (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info
                    (let minf = mem_pool_info vt (pool b)
                     in vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t),
                             mem_pool_info := (mem_pool_info vt)
                               (pool b := minf &#10631;levels := (levels minf)[lvl vt t := (levels minf ! lvl vt t)
                          &#10631;bits := (bits (levels minf ! lvl vt t))[bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;]&#10632;)&#10632;)
                    (pool b))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info vt (pool b))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>set_bit_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info vt (pool b))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>set_bit_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsz vt t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bn vt t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">[</span><span>rule_format</span><span class="delimiter">,</span><span>of</span><span> </span><span>V</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool b&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b))) ! level b)) = (n_max (mem_pool_info V (pool b))) * 4 ^ (level b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b)) mod 4 ^ lvl V t = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n. max_sz (mem_pool_info V (pool b)) = (4 * n) * (4 ^ n_levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">[</span><span>rule_format</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>V</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b))) = n_levels (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>ge_pow_mod_0</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add_diff_inverse_nat</span><span> </span><span>add_lessD1</span><span> </span><span>ge_pow_mod_0</span><span> </span><span>le_antisym</span><span> </span><span>nat_less_le</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) div 4 * 4 + i vt t &lt; n_max (mem_pool_info V (pool b)) * 4 ^ lvl V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>block_fits0_h2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i vt t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>block_fits0_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ lvl V t&quot;</span></span></span><span>
</span><span>    </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) div 4 * 4 + i vt t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>block_fits1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V &#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  vt &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  {free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b} &#8745;
                   - &#10627;block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t)&#10628; = {}&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_fits0</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>vt</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_h1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; bn (free_stm8_precond33 (free_stm8_precond32 (vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t)&#10632;) t b) t b) t &#8800;
       bb (free_stm8_precond33 (free_stm8_precond32 (vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t)&#10632;) t b) t b) t &#10233;
    {free_stm8_precond33 (free_stm8_precond32 (vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t)&#10632;) t b) t b}
    &#8838; &#10627;&#180;id &#8712; {let vv = free_stm8_precond33 (free_stm8_precond32 (vt&#10631;bb := (bb vt)(t := bn vt t div 4 * 4 + i vt t)&#10632;) t b) t b
               in if bn vv t = bb vv t then vv else free_stm8_precond34 vv t b}&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1_1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;p. (&#8704;i. length (bits (levels (mem_pool_info vt p) ! i)) =
           length (bits (levels (if p = pool b
                                 then mem_pool_info V (pool b)
                                      &#10631;levels := (levels (mem_pool_info V (pool b)))
                                         [lvl vt t := (levels (mem_pool_info V (pool b)) ! lvl vt t)
                                            &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]&#10632;]&#10632;
                                 else mem_pool_info V p) !
                         i))) &#10233;
  &#8704;j. j &#8800; lvl vt t &#10230; levels (mem_pool_info V (pool b)) ! j = levels (mem_pool_info vt (pool b)) ! j &#10233;
  length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b))) &#10233;
  length (bits ((levels (mem_pool_info vt (pool b)))
                [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                   &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t)
                             NOEXIST)
                      [bn vt t := NOEXIST]&#10632;] !
                ia)) =
  length (bits ((levels (mem_pool_info V (pool b)))
                [lvl vt t := (levels (mem_pool_info V (pool b)) ! lvl vt t)
                   &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]&#10632;] !
                ia))&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl vt t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>list_eq_iff_nth_eq</span><span> </span><span>list_update_beyond</span><span> </span><span>not_less</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1_2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_block_r vt t &#10230; freeing_node V t = None &#10233;
  free_block_r V t = free_block_r vt t &#10233;
  &#945; = (if &#8707;y. freeing_node V t = Some y then lvl V t + 1 else NULL) &#10233;
  block b div 4 ^ (level b - lvl vt t) = bn vt t &#10233;
  V &#8712; (if NULL &lt; (if &#8707;y. freeing_node V t = Some y then lvl V t + 1 else NULL) then UNIV else {}) &#10233;
  free_block_r V t&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv V &#10233;
pool b &#8712; mem_pools V &#10233;
lvl vt t &lt; length (levels (mem_pool_info V (pool b))) &#10233;
bn vt t &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl vt t)) &#10233;
get_bit_s V (pool b) (lvl vt t) (bn vt t) &#8800; FREE &#10233;
    buf (mem_pool_info V (pool b)) + max_sz (mem_pool_info V (pool b)) div 4 ^ lvl vt t * bn vt t
    &#8713; set (free_list (levels (mem_pool_info V (pool b)) ! lvl vt t))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b)) div 4 ^ lvl vt t * bn vt t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                      </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bn vt t * (max_sz (mem_pool_info V (pool b)) div 4 ^ lvl vt t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1_3</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;p. (&#8704;i. length (bits (levels (mem_pool_info vt p) ! i)) =
           length (bits (levels (if p = pool b
                                 then mem_pool_info V (pool b)
                                      &#10631;levels := (levels (mem_pool_info V (pool b)))
                                         [lvl vt t := (levels (mem_pool_info V (pool b)) ! lvl vt t)
                                            &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]&#10632;]&#10632;
                                 else mem_pool_info V p) !
                         i))) &#10233;
  &#8704;j. j &#8800; lvl vt t &#10230; levels (mem_pool_info V (pool b)) ! j = levels (mem_pool_info vt (pool b)) ! j &#10233;
  length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b))) &#10233;
  length (bits ((levels (mem_pool_info vt (pool b)))
                [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                   &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t)
                             NOEXIST)
                      [bn vt t div 4 * 4 + i vt t := NOEXIST],
                      free_list :=
                        remove1 (block_ptr
                                  (mem_pool_info vt (pool b)
                                   &#10631;levels := (levels (mem_pool_info vt (pool b)))
                                      [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                                         &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE])
                                                   (bn vt t div 4 * 4) (i vt t) NOEXIST)
                                            [bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;]&#10632;)
                                  (lsz vt t) (bn vt t div 4 * 4 + i vt t))
                         (removes (map (&#955;ii. block_ptr
                                               (mem_pool_info V (pool b)
                                                &#10631;levels := (levels (mem_pool_info V (pool b)))
                                                   [lvl vt t := (levels (mem_pool_info V (pool b)) ! lvl vt t)
                                                      &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]&#10632;]&#10632;)
                                               (lsz vt t) (bn vt t div 4 * 4 + ii))
                                    [NULL..&lt;i vt t])
                           (free_list (levels (mem_pool_info V (pool b)) ! lvl vt t)))&#10632;] !
                ia)) =
  length (bits ((levels (mem_pool_info V (pool b)))
                [lvl vt t := (levels (mem_pool_info V (pool b)) ! lvl vt t)
                   &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]&#10632;] !
                ia))&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl vt t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>list_eq_iff_nth_eq</span><span> </span><span>list_update_beyond</span><span> </span><span>not_less</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;V &#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  vt &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
    {let vv = free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b in
         if bn vv t = bb vv t then vv else free_stm8_precond34 vv t b}
    &#8838; {s. s&#10631;i := (i s) (t := Suc (i s t))&#10632; &#8712; free_stm8_precond3 V t b}&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
apply(subgoal_tac &quot;length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b)))&quot;)
  prefer 2 apply(simp add:gvars_conf_stable_def gvars_conf_def)
*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                [bn vt t := NOEXIST]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info vt (pool b)))
          [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
             &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                [bn vt t := NOEXIST]&#10632;] !
          lvl vt t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lst_updts_eq_updts_updt</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc (i vt t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]&quot;</span></span></span><span>
</span><span>                                    </span><span class="string"><span class="delete"><span class="delete">&quot;bn vt t div 4 * 4&quot;</span></span></span><span> </span><span>NOEXIST</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info vt (pool b)) ! lvl vt t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                          </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info vt (pool b)))
                      [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                         &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                            [bn vt t := NOEXIST]&#10632;] ! lvl vt t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl vt t &lt; length (levels (mem_pool_info vt (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;removes (map (&#955;ii. buf (mem_pool_info V (pool b)) + lsz vt t * (bn vt t div 4 * 4 + ii)) [NULL..&lt;i vt t] @
                                   [buf (mem_pool_info V (pool b)) + lsz vt t * bn vt t])
                           (free_list (levels (mem_pool_info V (pool b)) ! lvl vt t)) =
                      removes (map (&#955;ii. buf (mem_pool_info V (pool b)) + lsz vt t * (bn vt t div 4 * 4 + ii)) [NULL..&lt;i vt t])
                           (free_list (levels (mem_pool_info V (pool b)) ! lvl vt t))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>rmvs_onemore_same</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info V) (pool b) (lvl vt t) (bn vt t) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_block_r V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1_2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;blk. freeing_node V t = Some blk &#8743; pool blk = pool b &#8743; level blk = lvl vt t &#8743; block blk = bn vt t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_aux_vars_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b)) div 4 ^ lvl vt t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsz vt t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_maxsz_align4</span><span class="delimiter">[</span><span>rule_format</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>V</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool b&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info V) (pool b) (lvl vt t) (bn vt t) &#8800; FREE&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl vt t &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1_3</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                [bn vt t div 4 * 4 + i vt t := NOEXIST]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info vt (pool b)))
          [lvl vt t :=
             ((levels (mem_pool_info vt (pool b)))
              [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                 &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                    [bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;] !
              lvl vt t)
             &#10631;free_list :=
                remove1 (block_ptr
                          (mem_pool_info vt (pool b)
                           &#10631;levels := (levels (mem_pool_info vt (pool b)))
                              [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                                 &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t)
                                           NOEXIST)
                                    [bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;]&#10632;)
                          (lsz vt t) (bn vt t div 4 * 4 + i vt t))
                 (free_list
                   ((levels (mem_pool_info vt (pool b)))
                    [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                       &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                          [bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;] !
                    lvl vt t))&#10632;] !
          lvl vt t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lst_updts_eq_updts_updt</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc (i vt t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]&quot;</span></span></span><span>
</span><span>                                    </span><span class="string"><span class="delete"><span class="delete">&quot;bn vt t div 4 * 4&quot;</span></span></span><span> </span><span>NOEXIST</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl vt t &lt; length (levels (mem_pool_info vt (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info vt (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info vt (pool b)) ! lvl vt t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                          </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info vt (pool b)))
                      [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                         &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                            [bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;] ! lvl vt t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;remove1 (buf (mem_pool_info vt (pool b)) + lsz vt t * (bn vt t div 4 * 4 + i vt t))
                             (free_list (levels (mem_pool_info vt (pool b)) ! lvl vt t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                          </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info vt (pool b)))
                      [lvl vt t :=
                         ((levels (mem_pool_info vt (pool b)))
                          [lvl vt t := (levels (mem_pool_info vt (pool b)) ! lvl vt t)
                             &#10631;bits := (list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl vt t))[bn vt t := FREE]) (bn vt t div 4 * 4) (i vt t) NOEXIST)
                                [bn vt t div 4 * 4 + i vt t := NOEXIST]&#10632;] !
                          lvl vt t)
                         &#10631;free_list :=
                            remove1 (buf (mem_pool_info vt (pool b)) + lsz vt t * (bn vt t div 4 * 4 + i vt t))
                             (free_list (levels (mem_pool_info vt (pool b)) ! lvl vt t))&#10632;] !
                      lvl vt t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info vt (pool b)) = buf (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>rmvs_rev</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(map (&#955;ii. buf (mem_pool_info V (pool b)) + lsz vt t * (bn vt t div 4 * 4 + ii)) [NULL..&lt;i vt t])&quot;</span></span></span><span>
</span><span>                      </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info V (pool b)) + lsz vt t * (bn vt t div 4 * 4 + i vt t)&quot;</span></span></span><span>
</span><span>                      </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info V (pool b)) ! lvl vt t)&quot;</span></span></span><span> </span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; V = Va &#10233;
  V &#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  vt &#8712; free_stm8_precond3 Va t b &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;i := &#180;i(t := Suc (&#180;i t)))
    sat<span class="hidden">&#8681;</span><sub>p</sub> [{let vv = free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b in
           if bn vv t = bb vv t then vv else free_stm8_precond34 vv t b}, {(s, t). s = t}, UNIV, free_stm8_precond3 Va t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span><span> </span><span>1</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* pre &#8838; {s. f s &#8712; post} *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>vt</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; V = Va &#10233;
  V &#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  vt &#8712; free_stm8_precond3 Va t b &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;bb := &#180;bb(t := &#180;bn t div 4 * 4 + &#180;i t);;
      &#180;mem_pool_info := set_bit_noexist &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bb t);;
       &#180;block_pt := &#180;block_pt (t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bb t));;
       IF &#180;bn t &#8800; &#180;bb t &#8743; block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t) THEN
          &#180;mem_pool_info := &#180;mem_pool_info(pool b := remove_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;block_pt t))
        FI;;
       &#180;i := &#180;i(t := Suc (&#180;i t)))
    sat<span class="hidden">&#8681;</span><sub>p</sub> [{vt}, {(s, t). s = t}, UNIV, free_stm8_precond3 Va t b]&quot;</span></span></span><span>
</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{let vv = free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b in
                              if bn vv t = bb vv t then vv else free_stm8_precond34 vv t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond32 (free_stm8_precond31 vt t b) t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond31 vt t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;bb := &#180;bb(t := &#180;bn t div 4 * 4 + &#180;i t);;  *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := set_bit_noexist &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bb t);;  *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;block_pt := &#180;block_pt (t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bb t));; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;bn t &#8800; &#180;bb t &#8743; block_fits (&#180;mem_pool_info (pool b))  *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF body *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>remove_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE body: SKIP *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bn (free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b) t
                 &#8800; bb (free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b) t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b} &#8745;
                   - &#10627;block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t)&#10628;&quot;</span></span></span><span>
</span><span>                    </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b} &#8745;
                   - &#10627;&#180;bn t &#8800; &#180;bb t &#8743; block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t)&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b} &#8745;
                   - &#10627;block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t)&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_fits1</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>vt</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b}&quot;</span></span></span><span>
</span><span>                    </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond33 (free_stm8_precond32 (free_stm8_precond31 vt t b) t b) t b} &#8745;
                   - &#10627;&#180;bn t &#8800; &#180;bb t &#8743; block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t)&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;i := &#180;i(t := &#180;i t + 1) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one_isuc</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>vt</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_set4partbits_while</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; V = Va &#10233;
  V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some(&#180;bb := &#180;bb(t := &#180;bn t div 4 * 4 + &#180;i t);;
      &#180;mem_pool_info := set_bit_noexist &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bb t);;
       &#180;block_pt := &#180;block_pt (t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bb t));;
       IF &#180;bn t &#8800; &#180;bb t &#8743; block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t) THEN
          &#180;mem_pool_info := &#180;mem_pool_info(pool b := remove_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;block_pt t))
        FI;;
       &#180;i := &#180;i(t := Suc (&#180;i t)))
    sat<span class="hidden">&#8681;</span><sub>p</sub> [free_stm8_precond3 Va t b &#8745; &#10627;&#180;i t &lt; 4&#10628;, {(s, t). s = t}, UNIV, free_stm8_precond3 Va t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while_one</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span>
</span><span>  </span><span>Allprecond</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>U</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 Va t b &#8745; &#10627;&#180;i t &lt; 4&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                   </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Some (&#180;bb := &#180;bb(t := &#180;bn t div 4 * 4 + &#180;i t);;
                      &#180;mem_pool_info := set_bit_noexist &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bb t);;
                       &#180;block_pt := &#180;block_pt (t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bb t));;
                       IF &#180;bn t &#8800; &#180;bb t &#8743; block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t) (&#180;lsz t) THEN
                          &#180;mem_pool_info := &#180;mem_pool_info(pool b := remove_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;block_pt t))
                        FI;;
                       &#180;i := &#180;i(t := Suc (&#180;i t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                      </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(x, y). x = y}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                      </span><span>guar</span><span class="delimiter">=</span><span> </span><span>UNIV</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 Va t b&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 Va t b&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_atombody_rest_cond1 V t b &#8801; V&#10631;lvl := (lvl V)(t := lvl V t - 1)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_atombody_rest_cond2 V t b &#8801; V&#10631;bn := (bn V)(t := bn V t div 4)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_atombody_rest_cond3 V t b &#8801;
  let minf = mem_pool_info V (pool b) in
    V&#10631;mem_pool_info:= (mem_pool_info V) (pool b := minf &#10631;levels := (levels minf)
      [lvl V t := ((levels minf) ! (lvl V t)) &#10631;bits := (bits ((levels minf) ! (lvl V t))) [bn V t := FREEING]&#10632;] &#10632;)&#10632;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_cur</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#8998;&#8249;(* {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233; *)&#8250;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_cur y&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur x&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur y&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span> </span><span>inv_cur_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>inv_def</span><span> </span><span>inv_cur_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state V t = RUNNING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_thd_waitq</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#8998;&#8249;(* {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233; *)&#8250;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_thd_waitq y&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_thd_waitq x&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_thd_waitq y&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span> </span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>inv_def</span><span> </span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools V = mem_pools V2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;p. buf (mem_pool_info V2 p) =
       buf (if p = pool b
            then mem_pool_info V (pool b)
                 &#10631;levels := (levels (mem_pool_info V (pool b)))
                    [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)&#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
            else mem_pool_info V p) &#8743;
       max_sz (mem_pool_info V2 p) =
       max_sz (if p = pool b
               then mem_pool_info V (pool b)
                    &#10631;levels := (levels (mem_pool_info V (pool b)))
                       [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                          &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
               else mem_pool_info V p) &#8743;
       n_max (mem_pool_info V2 p) =
       n_max (if p = pool b
              then mem_pool_info V (pool b)
                   &#10631;levels := (levels (mem_pool_info V (pool b)))
                      [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                         &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
              else mem_pool_info V p) &#8743;
       n_levels (mem_pool_info V2 p) =
       n_levels (if p = pool b
                 then mem_pool_info V (pool b)
                      &#10631;levels := (levels (mem_pool_info V (pool b)))
                         [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                            &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
                 else mem_pool_info V p) &#8743;
       length (levels (mem_pool_info V2 p)) =
       length (levels (if p = pool b
                       then mem_pool_info V (pool b)
                            &#10631;levels := (levels (mem_pool_info V (pool b)))
                               [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                  &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
                       else mem_pool_info V p)) &#8743;
       (&#8704;i. length (bits (levels (mem_pool_info V2 p) ! i)) =
            length (bits (levels (if p = pool b
                                  then mem_pool_info V (pool b)
                                       &#10631;levels := (levels (mem_pool_info V (pool b)))
                                          [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                             &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
                                  else mem_pool_info V p) !
                          i))) &#10233;
   ia &lt; length (levels (mem_pool_info V (pool b))) &#10233;
   length (bits (levels (mem_pool_info V (pool b)) ! ia)) = length (bits (levels (mem_pool_info V2 (pool b)) ! ia))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = ia&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  length (bits ((levels (mem_pool_info V2 (pool b)))
     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
     ia)) = length (bits (levels (mem_pool_info V2 (pool b)) ! ia))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc NULL = ia&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h3</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; mem_pools V = mem_pools V2 &#10233;
  p &#8712; mem_pools V2 &#10233;
  &#8704;p&#8712;mem_pools V2.
     NULL &lt; buf (mem_pool_info V p) &#8743;
     (&#8707;n&gt;NULL. max_sz (mem_pool_info V p) = 4 * n * 4 ^ n_levels (mem_pool_info V p)) &#8743;
     NULL &lt; n_max (mem_pool_info V p) &#8743;
     NULL &lt; n_levels (mem_pool_info V p) &#8743;
     n_levels (mem_pool_info V p) = length (levels (mem_pool_info V p)) &#8743;
     (&#8704;i&lt;length (levels (mem_pool_info V p)). length (bits (levels (mem_pool_info V p) ! i)) = n_max (mem_pool_info V p) * 4 ^ i) &#10233;
  mem_pools V = mem_pools V2 &#10233;
  pool b &#8712; mem_pools V2 &#10233; levels (mem_pool_info V p) &#8800; []&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_1&#39;</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j &#8800; lvl V t &#10230;
     (levels (mem_pool_info V (pool b)))
     [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
        &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
     j =
     levels (mem_pool_info V2 (pool b)) ! j &#10233;
 bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
 list_updates_n
  (bits ((levels (mem_pool_info V (pool b)))
         [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
            &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
         lvl V t))
  (block b div 4 ^ (level b - lvl V t) div 4 * 4) 4 NOEXIST &#10233;
 length (bits (levels (mem_pool_info V (pool b)) ! ia)) =
 length (bits ((levels (mem_pool_info V2 (pool b)))
               [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                  &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
               ia))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V2 (pool b))!ia))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc 0 := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0)))[bn V2 t div 4 := FREEING]&#10632;] !
                     ia))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V2 t - Suc 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (list_updates_n
     (bits ((levels (mem_pool_info V (pool b)))
            [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
               &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
            ia))
     (block b div 4 ^ (level b - lvl V t) div 4 * 4) 4 NOEXIST) = length (bits ((levels (mem_pool_info V (pool b)))
            [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
               &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
            ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>length_list_update_n</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
                  [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                     &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
                  ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t &quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ia &#8800; lvl V t *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
    [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
       &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
    ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(levels (mem_pool_info V (pool b)))
        [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
           &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
        ia = levels (mem_pool_info V2 (pool b)) ! ia&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j &#8800; lvl V t &#10230;
     levels (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) ! j
      = levels (mem_pool_info V2 (pool b)) ! j &#10233;
 bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
 list_updates_n (bits (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V t)
    (block b div 4 ^ (level b - lvl V t)) (pool b)) ! lvl V t))
  (block b div 4 ^ (level b - lvl V t) div 4 * 4) 4 NOEXIST &#10233;
 length (bits (levels (mem_pool_info V (pool b)) ! ia)) =
 length (bits ((levels (mem_pool_info V2 (pool b)))
               [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                  &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
               ia))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V2 (pool b))!ia))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc 0 := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0)))[bn V2 t div 4 := FREEING]&#10632;] !
                     ia))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V2 t - Suc 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (list_updates_n
     (bits ((levels (mem_pool_info V (pool b)))
            [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
               &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
            ia))
     (block b div 4 ^ (level b - lvl V t) div 4 * 4) 4 NOEXIST) = length (bits ((levels (mem_pool_info V (pool b)))
            [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
               &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
            ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>length_list_update_n</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
                  [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                     &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
                  ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t &quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ia &#8800; lvl V t *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
    [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
       &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
    ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(levels (mem_pool_info V (pool b)))
        [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
           &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
        ia = levels (mem_pool_info V2 (pool b)) ! ia&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#8998;&#8249;(* {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233; *)&#8250;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_mempool_info y&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info x&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info y&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_ptr_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools V = mem_pools V2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b))) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! ia))
      = length (bits (levels (mem_pool_info V2 (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                            [bn V2 t div 4 := FREEING]&#10632;] !
                     ia)) = length (bits (levels (mem_pool_info V2 (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h3</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_stm8_atombody_rest_one_finalstm_VV2_len</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;p. length (levels (mem_pool_info V2 p)) =
             length (levels (if p = pool b
                             then mem_pool_info V (pool b)
                                  &#10631;levels := (levels (mem_pool_info V (pool b)))
                                     [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                        &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
                             else mem_pool_info V p)) &#10233;
length (levels (mem_pool_info V p)) = length (levels (mem_pool_info V2 p))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_stm8_atombody_rest_one_finalstm_bits_len</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = lvl V2 t &#10233;
 p = pool b &#10233;
 length (bits (levels (if p = pool b
                        then mem_pool_info V (pool b)
                             &#10631;levels := (levels (mem_pool_info V (pool b)))
                                [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                   &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))
                                      [block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
                        else mem_pool_info V p) !
                (lvl V2 t) )) = length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_stm8_atombody_rest_one_finalstm_ltlen</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t &gt; 0 &#10233;
 lvl V2 t = lvl V t &#10233;
 length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))
                   = (n_max (mem_pool_info V (pool b))) * 4 ^ lvl V2 t &#10233;
 block b div 4 ^ (level b - lvl V2 t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)) &#10233;
 block b div 4 ^ (level b - lvl V2 t) div 4 * 4 + 4
                    &#8804; length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>divn_multn_addn_le</span><span class="delimiter">[</span><span>of</span><span> </span><span>4</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))&quot;</span></span></span><span>
</span><span>      </span><span class="string"><span class="delete"><span class="delete">&quot; block b div 4 ^ (level b - lvl V2 t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_stm8_atombody_rest_one_finalstm_jj</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t &gt; 0 &#10233;
 lvl V2 t = lvl V t &#10233;
 length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))
                   = (n_max (mem_pool_info V (pool b))) * 4 ^ lvl V2 t &#10233;
 block b div 4 ^ (level b - lvl V2 t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)) &#10233;
 jj &#8712; {block b div 4 ^ (level b - lvl V t) div 4 * 4 ..&lt;
       block b div 4 ^ (level b - lvl V t) div 4 * 4 + 4} &#10233;
 jj &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V2 t) div 4 * 4 + 4
                    &#8804; length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>free_stm8_atombody_rest_one_finalstm_ltlen</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_bitmap&#39;_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
  list_updates_n
   (bits ((levels (mem_pool_info V (pool b)))
          [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
             &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
          lvl V t))
   (block b div 4 ^ (level b - lvl V t) div 4 * 4) (i V2 t) NOEXIST &#10233;
i V2 t = 4 &#10233;
level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
lvl V t = lvl V2 t &#10233;
lvl V2 t &#8804; level b &#10233;
ia = lvl V t &#10233;
ia &gt; 0 &#10233;
p = pool b &#10233;
block b div 4 ^ (level b - lvl V2 t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)) &#10233;
length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))
    = (n_max (mem_pool_info V (pool b))) * 4 ^ lvl V2 t &#10233;
length (levels (mem_pool_info V (pool b)))=length (levels (mem_pool_info V2 (pool b))) &#10233;
jj &#8712; {block b div 4 ^ (level b - lvl V t) div 4 * 4 ..&lt;
      block b div 4 ^ (level b - lvl V t) div 4 * 4 + 4} &#10233;
get_bit_s (V2&#10631;mem_pool_info := (mem_pool_info V2)
        (pool b := mem_pool_info V2 (pool b)
           &#10631;levels := (levels (mem_pool_info V2 (pool b)))
              [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                 &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                    [bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632;) p ia jj = NOEXIST&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V2 p ia jj&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;list_updates_n
   (bits ((levels (mem_pool_info V (pool b)))
          [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
             &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
          lvl V t))
   (block b div 4 ^ (level b - lvl V t) div 4 * 4) (i V2 t) NOEXIST !
  jj =
  NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>list_updates_n_eq</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) div 4 * 4&quot;</span></span></span><span> </span><span>jj</span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V (pool b)))
              [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                 &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
              lvl V t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V2 t&quot;</span></span></span><span> </span><span>NOEXIST</span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! lvl V t))&quot;</span></span></span><span>
</span><span>                       </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
                       [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                          &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))
                             [block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
                       lvl V t))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>free_stm8_atombody_rest_one_finalstm_jj</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_bitmap&#39;_h2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
        (V2&#10631;mem_pool_info := (mem_pool_info V2)
              (pool b := mem_pool_info V2 (pool b)
                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                          [bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632;)
        p ia jj =
       FREE &#8744;
       get_bit_s
        (V2&#10631;mem_pool_info := (mem_pool_info V2)
              (pool b := mem_pool_info V2 (pool b)
                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                          [bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632;)
        p ia jj =
       FREEING &#8744;
       get_bit_s
        (V2&#10631;mem_pool_info := (mem_pool_info V2)
              (pool b := mem_pool_info V2 (pool b)
                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                          [bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632;)
        p ia jj =
       ALLOCATED &#8744;
       get_bit_s
        (V2&#10631;mem_pool_info := (mem_pool_info V2)
              (pool b := mem_pool_info V2 (pool b)
                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                          [bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632;)
        p ia jj =
       ALLOCATING &#10233;
       get_bit_s
        (V2&#10631;mem_pool_info := (mem_pool_info V2)
              (pool b := mem_pool_info V2 (pool b)
                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                          [bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632;)
        p ia jj =
       NOEXIST &#10233;
       get_bit_s
        (V2&#10631;mem_pool_info := (mem_pool_info V2)
              (pool b := mem_pool_info V2 (pool b)
                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                          [bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632;)
        p (ia - 1) (jj div 4) =
       DIVIDED&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">axiomatization</span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_bitmap</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#8998;&#8249;(* {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233; *)&#8250;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_bitmap y&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">axiomatization</span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_bitmap_freelist</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#8998;&#8249;(* {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233; *)&#8250;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_bitmap_freelist y&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* mempool_free_stm8_atombody_rest_one_finalstm_inv_aux_vars_h1 *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_len_bits1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j &#8800; lvl V t &#10230; levels (mem_pool_info V (pool b)) ! j = levels (mem_pool_info V2 (pool b)) ! j &#10233;
 bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
 list_updates_n
  (bits ((levels (mem_pool_info V (pool b)))
         [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
            &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
         lvl V t))
  (block b div 4 ^ (level b - lvl V t) div 4 * 4) (i V2 t) NOEXIST &#10233;
 (i V2 t) = 4 &#10233;
 length (bits (levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc NULL)))
   = length (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                   &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                (lvl V2 t - Suc NULL)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc NULL)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_1&#39;</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>V2</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc NULL&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc NULL &lt; length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lm11</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t &#8804; level b &#8743; level b &gt; 0 &#8743; level b &lt; length (levels (mem_pool_info V (pool b))) &#8743;
  0 &lt; lvl V2 t  &#10233;
  block b &lt; n_max (mem_pool_info V (pool b)) * 4 ^ level b &#10233;
  block b div 4 ^ (level b - lvl V2 t) = bn V2 t &#10233;
  bn V2 t div 4 &lt; n_max (mem_pool_info V (pool b)) * 4 ^ (lvl V2 t - Suc NULL)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V2 t) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bn V2 t div 4&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b)) * 4 ^ level b div 4 ^ (level b - lvl V2 t) div 4&quot;</span></span></span><span>
</span><span>                    </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b)) * 4 ^ (lvl V2 t - Suc NULL)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Groups.mult_ac</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Groups.mult_ac</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>One_nat_def</span><span> </span><span>add_diff_cancel_left&#39;</span><span> </span><span>div_mult_self1_is_m</span><span>
</span><span>              </span><span>le_Suc_ex</span><span> </span><span>power_add</span><span> </span><span>power_minus_mult</span><span> </span><span>zero_less_numeral</span><span> </span><span>zero_less_power</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b)) * 4 ^ level b mod 4 ^ (level b - lvl V2 t) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mod_minus_0</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V2 t) &lt; n_max (mem_pool_info V (pool b)) * 4 ^ level b div 4 ^ (level b - lvl V2 t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mod_div_gt</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b)) * 4 ^ level b&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ (level b - lvl V2 t)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b)) * 4 ^ level b div 4 ^ (level b - lvl V2 t) mod 4 = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mod_minus_div_4</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mod_div_gt</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V2 t)&quot;</span></span></span><span>
</span><span>    </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b)) * 4 ^ level b div 4 ^ (level b - lvl V2 t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_aux_vars_h2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;pool b &#8712; mem_pools V &#10233;
 inv_mempool_info V &#10233;
 level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
 block b div 4 ^ (level b - lvl V t) = bn V2 t &#10233;
 block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
 lvl V t = lvl V2 t &#10233;
 lvl V2 t &#8804; level b &#10233;
 0 &lt; lvl V2 t  &#10233;
  length (levels (mem_pool_info V (pool b))) = length (levels (mem_pool_info V2 (pool b))) &#10233;
  length (bits (levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc NULL)))
      = length (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) &#10233;
  bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                     (lvl V2 t - Suc NULL)) !
               (bn V2 t div 4) =
               FREEING&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc 0 &lt; length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bn V2 t div 4 &lt; length (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(subgoal_tac &quot;length (bits (levels (mem_pool_info V (pool b)) ! level b))
            = (n_max (mem_pool_info V (pool b))) * 4 ^ level b&quot;)
      prefer 2 apply(simp add: inv_mempool_info_def Let_def) apply auto[1]*)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b)) * 4 ^ (lvl V2 t - Suc NULL)
                        = length (bits (levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc NULL)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>lm11</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* mempool_free_stm8_atombody_rest_one_finalstm_inv_lvln_case1_h1 *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_len_lvls</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;(V2, V&#10631;mem_pool_info := (mem_pool_info V)
             (pool b := mem_pool_info V (pool b)
                &#10631;levels := (levels (mem_pool_info V (pool b)))
                   [lvl V2 t := (levels (mem_pool_info V (pool b)) ! lvl V2 t)
                      &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))[bn V2 t := FREE]&#10632;]&#10632;),
             freeing_node := (freeing_node V)(t := None)&#10632;)
    &#8712; gvars_conf_stable &#10233;
    length (levels (mem_pool_info V2 (pool b))) = length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">axiomatization</span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_aux_vars</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_aux_vars y&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvl0_case1_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;NULL &lt; length (levels (mem_pool_info V2 (pool b))) &#10233;
  (bits (levels (mem_pool_info V2 (pool b)) ! NULL))[ia := FREEING] =
  bits ((levels (mem_pool_info V2 (pool b)))
        [NULL := (levels (mem_pool_info V2 (pool b)) ! NULL)
           &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! NULL))[ia := FREEING]&#10632;] !
        NULL)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvl0_case1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;pool b &#8712; mem_pools V2 &#10233;
  inv V &#10233;
  NULL &lt; lvl V2 t &#10233;
  pool b &#8712; mem_pools V &#10233;
  &#8998;&#8249;(*(V2, V&#10631;mem_pool_info := set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t),
        freeing_node := (freeing_node V)(t := None)&#10632;)
  &#8712; gvars_conf_stable &#10233;
  &#8704;p. p &#8800; pool b &#10230; mem_pool_info V2 p = set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p &#10233;*)&#8250;
  &#8704;j. j &#8800; lvl V2 t &#10230;
      levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) ! j =
      levels (mem_pool_info V2 (pool b)) ! j &#10233;
  lvl V2 t &#8804; level b &#10233;
  lvl V t = lvl V2 t &#10233;
  &#8704;i&lt;length (bits (levels (mem_pool_info V (pool b)) ! NULL)). get_bit_s V (pool b) NULL i &#8800; NOEXIST &#10233;
  ia &lt; length (bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) !
                          (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                     NULL)) &#10233;
  bits ((levels (mem_pool_info V2 (pool b)))
        [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
           &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
        NULL) !
  ia =
  NOEXIST &#10233;
  False&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V (pool b)) ! (lvl V2 t - 1)
                      = levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - 1)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(levels (mem_pool_info V (pool b)))
        [lvl V2 t := (levels (mem_pool_info V (pool b)) ! lvl V2 t)
           &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t))[bn V2 t := FREE]&#10632;] ! (lvl V2 t - 1)
                        = levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - 1)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc 0 = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! 0))
                    = length (bits (levels (mem_pool_info V2 (pool b)) ! 0))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V2 (pool b)))&gt;0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (bits (levels (mem_pool_info V (pool b)) ! 0))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V2 (pool b)) ! NULL))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                                    </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! NULL))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V2 (pool b)) ! NULL))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                                    </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                       [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                          &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                       NULL)) &quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = bn V2 t div 4&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)))
          [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
             &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
          NULL) ! ia = FREEING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;0&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc 0&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ia&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bn V2 t div 4&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V2 (pool b)) ! NULL))[ia := FREEING]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                             </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)))
          [NULL := (levels (mem_pool_info V2 (pool b)) ! NULL)&#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! NULL))
                    [ia := FREEING]&#10632;] ! NULL)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>25</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ia &#8800; bn V2 t div 4 *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)))
          [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
             &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
          NULL) ! ia &#8800; NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;0&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc 0&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V2 (pool b)) ! NULL))[bn V2 t div 4 := FREEING]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                           </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)))
          [NULL := (levels (mem_pool_info V2 (pool b)) ! NULL)&#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! NULL))
                    [bn V2 t div 4 := FREEING]&#10632;] ! NULL)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* lvl V2 t - Suc 0 &#8800; 0 *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)))
          [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
             &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
          NULL) ! ia &#8800; NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V2 (pool b)) ! NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(levels (mem_pool_info V2 (pool b)))
          [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
             &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
          NULL&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V2 (pool b)) ! NULL)) = length (bits ((levels (mem_pool_info V2 (pool b)))
                       [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                          &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                       NULL)) &quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvl0_case2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools V2 &#10233;
  inv V &#10233;
  NULL &lt; lvl V2 t &#10233;
  pool b &#8712; mem_pools V &#10233;
  (V2, V&#10631;mem_pool_info := set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t),
                     freeing_node := (freeing_node V)(t := None)&#10632;)
            &#8712; gvars_conf_stable &#10233;
  &#8704;p. p &#8800; pool b &#10230; mem_pool_info V2 p = set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p &#10233;
  level b &lt; length (lsizes V2 t) &#10233;
  p &#8800; pool b &#10233;
  ia &lt; length (bits (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p) ! NULL)) &#10233;
  get_bit (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t)) p NULL ia = NOEXIST &#10233; False&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (bits (levels (mem_pool_info V p) ! 0)). (bits (levels (mem_pool_info V p) ! 0)) ! i &#8800; NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools V2 =  mem_pools V&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvl0</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
        data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_bitmap0 y&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (bits (levels (mem_pool_info V (pool b)) ! 0)).
                      (bits (levels (mem_pool_info V (pool b)) ! 0)) ! i &#8800; NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V (pool b)) ! (lvl V2 t - 1)
                        = levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - 1)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) ! (lvl V2 t - 1)
                          = levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - 1)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvl0_case1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvl0_case2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond2 V t b&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 V t b&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvln_case1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;pool b &#8712; mem_pools V2 &#10233;
  inv V &#10233;
  NULL &lt; lvl V2 t &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  (V2, V&#10631;mem_pool_info := set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t),
           freeing_node := (freeing_node V)(t := None)&#10632;)
  &#8712; gvars_conf_stable &#10233;
  &#8704;j. j &#8800; lvl V2 t &#10230;
      levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) ! j =
      levels (mem_pool_info V2 (pool b)) ! j &#10233;
  bits (levels (mem_pool_info V2 (pool b)) ! lvl V2 t) =
          list_updates_n (bits (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) ! lvl V2 t))
                         (bn V2 t div 4 * 4) 4 NOEXIST &#10233;
  lvl V2 t &#8804; level b &#10233;
  ia &lt; length (bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                           [bn V2 t div 4 := FREEING]&#10632;] !
                     (length (levels (mem_pool_info V2 (pool b))) - Suc NULL))) &#10233;
  bits ((levels (mem_pool_info V2 (pool b)))
        [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
           &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
        (length (levels (mem_pool_info V2 (pool b))) - Suc NULL)) ! ia = DIVIDED &#10233;
  False&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V2 (pool b)))
                    = length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_len_lvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;let bitsn = bits ((levels (mem_pool_info V (pool b)) ! (length (levels (mem_pool_info V (pool b))) - 1)))
                   in &#8704;i&lt;length bitsn. bitsn ! i &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmapn_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t = length (levels (mem_pool_info V2 (pool b))) - Suc 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)))
        [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
           &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
        (length (levels (mem_pool_info V2 (pool b))) - Suc NULL)) ! ia &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! (length (levels (mem_pool_info V2 (pool b))) - Suc NULL))&quot;</span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)) )
                              [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                                 &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                              (length (levels (mem_pool_info V2 (pool b))) - Suc NULL))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (bits (levels (mem_pool_info V2 (pool b)) ! lvl V2 t)). get_bit_s V2 (pool b) (lvl V2 t) i &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>list_neq_udpt_neq</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)&quot;</span></span></span><span> </span><span>DIVIDED</span><span>
</span><span>                              </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! lvl V2 t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bn V2 t div 4 * 4)&quot;</span></span></span><span> </span><span>4</span><span> </span><span>NOEXIST</span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lst_udptn_set_eq</span><span class="delimiter">[</span><span>of</span><span> </span><span>4</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bn V2 t&quot;</span></span></span><span> </span><span>FREE</span><span> </span><span>NOEXIST</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &quot;lvl V2 t &#8800; length (levels (mem_pool_info V2 (pool b))) - Suc 0&quot; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V2 (pool b)))
        [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
           &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
        (length (levels (mem_pool_info V2 (pool b))) - Suc NULL)) ! ia &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V2 (pool b)) !
          (length (levels (mem_pool_info V2 (pool b))) - Suc NULL)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(levels (mem_pool_info V2 (pool b)))
          [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
             &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
          (length (levels (mem_pool_info V2 (pool b))) - Suc NULL)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V (pool b)) ! (length (levels (mem_pool_info V (pool b))) - 1) =
                      levels (mem_pool_info V2 (pool b)) ! (length (levels (mem_pool_info V (pool b))) - 1)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>One_nat_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_diff_1</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span> </span><span>not_less</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvln_case2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools V2 &#10233;
  inv V &#10233;
  NULL &lt; lvl V2 t &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  (V2, V&#10631;mem_pool_info := set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t),
           freeing_node := (freeing_node V)(t := None)&#10632;)
  &#8712; gvars_conf_stable &#10233;
  &#8704;p. p &#8800; pool b &#10230; mem_pool_info V2 p = set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p &#10233;
  lvl V2 t &#8804; level b &#10233;
  p &#8800; pool b &#10233;
  ia &lt; length (bits (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p) !
                     (length (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p)) - Suc NULL))) &#10233;
  get_bit (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t)) p
   (length (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p)) - Suc NULL) ia =
  DIVIDED &#10233;
  False&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (bits ((levels (mem_pool_info V p) ! (length (levels (mem_pool_info V p)) - 1)))).
                        bits ((levels (mem_pool_info V p) ! (length (levels (mem_pool_info V p)) - 1))) ! i &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools V2 =  mem_pools V&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvln</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_bitmapn y&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvln_case1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvln_case2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc NULL = ia &#10233;
    lvl V2 t - Suc NULL &lt; length (levels (mem_pool_info V2 (pool b))) &#10233;
    (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING] =
    bits (levels (mem_pool_info V2 (pool b)
                  &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;) !
          ia)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1_h2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V2 (pool b))) &#10233;
  jj &lt; length (bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                     ia)) &#10233;
  NULL &lt; ia &#10233;
  length (levels (mem_pool_info V2 (pool b))) = length (levels (mem_pool_info V (pool b))) &#10233;
  length (bits (levels (mem_pool_info V2 (pool b)) ! ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia)) &#10233;
  &#8704;jj&lt;length (bits (levels (mem_pool_info V2 (pool b)) ! ia)).
     &#172; (let bits = bits (levels (mem_pool_info V (pool b)) ! ia); a = jj div 4 * 4
         in bits ! a = FREE &#8743; bits ! (a + 1) = FREE &#8743; bits ! (a + 2) = FREE &#8743; bits ! (a + 3) = FREE) &#10233;
  lvl V2 t - Suc NULL = ia &#10233;
  levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc NULL) = levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL) &#10233;
  &#172; (let bits = (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]; a = jj div 4 * 4
      in bits ! a = FREE &#8743; bits ! (a + 1) = FREE &#8743; bits ! (a + 2) = FREE &#8743; bits ! (a + 3) = FREE)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                       </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lst_updt1_eq_upd</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING)
                  = length (bits (levels (mem_pool_info V2 (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>length_list_update_n</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj&lt;length (list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING).
     &#172; (let a = jj div 4 * 4
         in list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING ! a = FREE &#8743;
            list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING ! (a + 1) = FREE &#8743;
            list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING ! (a + 2) = FREE &#8743;
            list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING ! (a + 3) = FREE)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>partnerbits_udptn_notbit_partbits</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! ia)&quot;</span></span></span><span> </span><span>FREE</span><span> </span><span>FREEING</span><span>
</span><span>          </span><span class="string"><span class="delete"><span class="delete">&quot;list_updates_n (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))) (bn V2 t div 4) 1 FREEING&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bn V2 t div 4)&quot;</span></span></span><span> </span><span>1</span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                         [lvl V2 t - Suc 0 := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0))
                            &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0)))[bn V2 t div 4 := FREEING]&#10632;] !
                         ia)) = length (bits (levels (mem_pool_info V2 (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1_h3</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc NULL &#8800; ia &#10233;
    bits (levels (mem_pool_info V2 (pool b)) ! ia) =
    bits (levels (mem_pool_info V2 (pool b)
                  &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;) !
          ia)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;pool b &#8712; mem_pools V2 &#10233;
  inv V &#10233;
  NULL &lt; lvl V2 t &#10233;
  partner_bits (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) (lvl V2 t) (bn V2 t) &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  (V2, V&#10631;mem_pool_info := set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t),
           freeing_node := (freeing_node V)(t := None)&#10632;)
  &#8712; gvars_conf_stable &#10233;
  block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
  &#8704;j. j &#8800; lvl V2 t &#10230;
      levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) ! j =
      levels (mem_pool_info V2 (pool b)) ! j &#10233;
  level b &lt; length (lsizes V2 t) &#10233;
  bits (levels (mem_pool_info V2 (pool b)) ! lvl V2 t) =
  list_updates_n (bits (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) ! lvl V2 t))
   (bn V2 t div 4 * 4) 4 NOEXIST &#10233;
  lvl V2 t &#8804; level b &#10233;
  ia &lt; length (levels (mem_pool_info V2 (pool b))) &#10233;
  jj &lt; length (bits ((levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))
                          [bn V2 t div 4 := FREEING]&#10632;] !
                    ia)) &#10233;
  NULL &lt; ia &#10233;
  partner_bits
   (mem_pool_info V2 (pool b)
    &#10631;levels := (levels (mem_pool_info V2 (pool b)))
       [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
          &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;)
   ia jj &#10233;
  False&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V2 (pool b)))
                    = length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_len_lvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; partner_bits (mem_pool_info V2 (pool b) &#10631;levels := (levels (mem_pool_info V2 (pool b)))
         [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
            &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;)
     ia jj&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V2 (pool b)) ! ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t = ia&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj&lt;length (bits (levels (mem_pool_info V2 (pool b)) ! ia)).  &#172; partner_bits (mem_pool_info V (pool b)) ia jj&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t = ia&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;partner_bits (mem_pool_info V2 (pool b)) ia jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;partner_bits (mem_pool_info V2 (pool b) &#10631;levels := (levels (mem_pool_info V2 (pool b)))
         [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
            &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;)
     ia jj&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>partner_bits_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! lvl V2 t) =
    list_updates_n (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)) (bn V2 t div 4 * 4) 4 NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lst_udptn_set_eq</span><span class="delimiter">[</span><span>of</span><span> </span><span>4</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bn V2 t&quot;</span></span></span><span> </span><span>FREE</span><span> </span><span>NOEXIST</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>partner_bits_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (let a = jj div 4 * 4
      in list_updates_n (bits (levels (mem_pool_info V (pool b)) ! ia)) (bn V2 t div 4 * 4) 4 NOEXIST ! a = FREE &#8743;
         list_updates_n (bits (levels (mem_pool_info V (pool b)) ! ia)) (bn V2 t div 4 * 4) 4 NOEXIST ! (a + 1) = FREE &#8743;
         list_updates_n (bits (levels (mem_pool_info V (pool b)) ! ia)) (bn V2 t div 4 * 4) 4 NOEXIST ! (a + 2) = FREE &#8743;
         list_updates_n (bits (levels (mem_pool_info V (pool b)) ! ia)) (bn V2 t div 4 * 4) 4 NOEXIST ! (a + 3) = FREE)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>partnerbits_udptn_notbit_partbits</span><span class="delimiter">[</span><span>rule_format</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! ia)&quot;</span></span></span><span> </span><span>FREE</span><span> </span><span>NOEXIST</span><span>
</span><span>          </span><span class="string"><span class="delete"><span class="delete">&quot;list_updates_n (bits (levels (mem_pool_info V (pool b)) ! ia)) (bn V2 t div 4 * 4) 4 NOEXIST&quot;</span></span></span><span>
</span><span>          </span><span class="string"><span class="delete"><span class="delete">&quot;bn V2 t div 4 * 4&quot;</span></span></span><span> </span><span>4</span><span> </span><span>jj</span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* lvl V2 t &#8800; ia *)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* lvl V2 t - Suc 0 = ia *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc 0 = ia&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>partner_bits_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0)))[bn V2 t div 4 := FREEING]&quot;</span></span></span><span>
</span><span>                     </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)
                                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                                    [lvl V2 t - Suc 0 := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0))
                                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;) !
                         ia)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t - Suc NULL &lt; length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc 0) = levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1_h2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* lvl V2 t &#8800; ia *)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* lvl V2 t - Suc 0 &#8800; ia *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! ia)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                       </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)
                                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;) !
                         ia)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1_h3</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V (pool b)) ! ia&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;levels (mem_pool_info V2 (pool b)) ! ia&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                  [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                     &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                  ia)) =
    length (bits (levels (mem_pool_info V2 (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info_h2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools V2 &#10233;
  inv V &#10233;
  NULL &lt; lvl V2 t &#10233;
  partner_bits (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) (pool b)) (lvl V2 t) (bn V2 t) &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  (V2, V&#10631;mem_pool_info := set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t),
           freeing_node := (freeing_node V)(t := None)&#10632;)
  &#8712; gvars_conf_stable &#10233;
  lvl V2 t &#8804; level b &#10233;
  &#8704;p. p &#8800; pool b &#10230; mem_pool_info V2 p = set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p &#10233;
  p &#8800; pool b &#10233;
  ia &lt; length (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p)) &#10233;
  jj &lt; length (bits (levels (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p) ! ia)) &#10233;
  NULL &lt; ia &#10233; partner_bits (set_bit_free (mem_pool_info V) (pool b) (lvl V2 t) (bn V2 t) p) ia jj &#10233; False&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V2 (pool b)))
                    = length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_len_lvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; partner_bits (mem_pool_info V p) ia jj&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools V&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj&lt;length (bits (levels (mem_pool_info V p) ! ia)).  &#172; partner_bits (mem_pool_info V p) ia jj&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
         data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv_bitmap_not4free y&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_not4free_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free_case2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv&#39;</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  inv y&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_cur y &#8743; inv_thd_waitq y &#8743; inv_mempool_info y
              &#8743; inv_bitmap_freelist y &#8743; inv_bitmap y &#8743; inv_aux_vars y
              &#8743; inv_bitmap0 y &#8743; inv_bitmapn y &#8743; inv_bitmap_not4free y&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv y&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_def</span><span class="delimiter">[</span><span>of</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_cur</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_thd_waitq</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_mempool_info</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_bitmap_freelist</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_bitmap</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_aux_vars</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvl0</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvln</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv_lvls_not4free</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632;
                  &#8712; &#10627;&#180;inv&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv&#39;</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
           data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632;&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632;
                  &#8712; &#10627;&#180;allocating_node t = None&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  y = x&#10631;freeing_node := freeing_node x(t &#8614;
      &#10631;pool = pool b, level = lvl x t, block = bn x t,
         data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632; &#10233;
  y &#8712; &#10627;&#180;(Pair V)
      &#8712; {(s, r). (cur s &#8800; Some t &#10230; gvars_nochange s r &#8743; lvars_nochange t s r) &#8743;
                  (cur s = Some t &#10230; invariant.inv s &#10230; invariant.inv r) &#8743; (&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; s r)}&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(cur V &#8800; Some t &#10230; gvars_nochange V y &#8743; lvars_nochange t V y) &#8743;
                  (cur V = Some t &#10230; invariant.inv V &#10230; invariant.inv y) &#8743; (&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; V y)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv&#39;</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span> </span><span>y</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j &#8800; lvl V t &#10230; levels (mem_pool_info V (pool b)) ! j = levels (mem_pool_info V2 (pool b)) ! j &#10233;
          bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
          list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE])
           (block b div 4 ^ (level b - lvl V t) div 4 * 4) 4 NOEXIST &#10233;
 length (bits (levels (mem_pool_info V (pool b)) ! ia)) =
 length (bits ((levels (mem_pool_info V2 (pool b)))
               [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                  &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
               ia))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V2 (pool b))!ia))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                     [lvl V2 t - Suc 0 := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0))
                        &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc 0)))[bn V2 t div 4 := FREEING]&#10632;] !
                     ia))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V2 t - Suc 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (list_updates_n
     (bits ((levels (mem_pool_info V (pool b)))
            [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
               &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
            ia))
     (block b div 4 ^ (level b - lvl V t) div 4 * 4) 4 NOEXIST) = length (bits ((levels (mem_pool_info V (pool b)))
            [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
               &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
            ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>length_list_update_n</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
                  [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                     &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
                  ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t &quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ia &#8800; lvl V t *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
    [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
       &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
    ia)) = length (bits (levels (mem_pool_info V (pool b)) ! ia))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b &#10233;
  x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632;
                  &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>pairv_rId</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>pairv_IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>pairv_IntI</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* gvars_conf_stable *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>V2</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* {(s, r). (cur s &#8800; Some t &#10230; gvars_nochange s r &#8743; lvars_nochange t s r) &#8743;
                    (cur s = Some t &#10230; invariant.inv s &#10230; invariant.inv r) &#8743; (&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; s r)} *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_2</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span> </span><span>x</span><span>
</span><span>      </span><span class="string"><span class="delete"><span class="delete">&quot;x&#10631;freeing_node := freeing_node x(t &#8614;
           &#10631;pool = pool b, level = lvl x t, block = bn x t,
              data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t)
                      (bn x t)&#10632;)&#10632;&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#10627;&#186;tick = &#170;tick&#10628; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_I1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;x&#8712;&#10627;&#180;invariant.inv&#10628; &#10233;
       x&#8712;&#10627;&#180;allocating_node t = None&#10628; &#10233;
       x&#8712;&#10627;&#180;invariant.inv &#8743; &#180;allocating_node t = None&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h3_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv V &#8743;
  pool b &#8712; mem_pools V2 &#8743;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#8743; lvl V2 t &#8804; level b &#8743; NULL &lt; lvl V2 t &#10233;
  mem_pools V = mem_pools V2 &#8743;
  lvl V t = lvl V2 t &#10233;
  n_max (mem_pool_info V (pool b)) * 4 ^ (lvl V2 t - Suc NULL) =
  length (bits (levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc NULL)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h3</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; invariant.inv V &#8743;
   pool b &#8712; mem_pools V2 &#8743;
   level b &lt; length (levels (mem_pool_info V (pool b))) &#8743;
   block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#8743;
   level b &lt; length (lsizes V2 t) &#8743;
   bn V t &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V2 t)) &#8743;
   lvl V2 t &#8804; level b &#8743;
   NULL &lt; lvl V2 t  &#10233;
   mem_pools V = mem_pools V2 &#8743;
   (&#8704;p.
        (&#8704;i. length (bits (levels (mem_pool_info V2 p) ! i)) =
             length (bits (levels (if p = pool b
                                   then mem_pool_info V (pool b)
                                        &#10631;levels := (levels (mem_pool_info V (pool b)))
                                           [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                              &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;]&#10632;
                                   else mem_pool_info V p) !
                           i)))) &#8743;
   (&#8704;p. p &#8800; pool b &#10230; mem_pool_info V2 p = mem_pool_info V p) &#8743;
   (&#8704;j. j &#8800; lvl V t &#10230; levels (mem_pool_info V (pool b)) ! j = levels (mem_pool_info V2 (pool b)) ! j) &#8743;
         bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
         list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE])
          (block b div 4 ^ (level b - lvl V t) div 4 * 4) (i V2 t) NOEXIST &#8743;

   block b div 4 ^ (level b - lvl V t) = bn V2 t &#8743;
   lvl V t = lvl V2 t &#8743; ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t = lsz V2 t &#8743; lsizes V t = lsizes V2 t &#8743; i V2 t &#8804; 4 &#8743; i V2 t = 4 &#10233;
   x = V2&#10631;lvl := (lvl V2)(t := lvl V2 t - Suc NULL), bn := (bn V2)(t := bn V2 t div 4),
            mem_pool_info := (mem_pool_info V2)
              (pool b := mem_pool_info V2 (pool b)
                 &#10631;levels := (levels (mem_pool_info V2 (pool b)))
                    [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                       &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;]&#10632;)&#10632; &#10233;
   bn V2 t div 4
   &lt; length (bits ((levels (mem_pool_info V2 (pool b)))
                   [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                      &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                   (lvl V2 t - Suc NULL)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc NULL)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span> </span><span class="delimiter">=</span><span>
</span><span>                      </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V2 (pool b)))
                                 [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                                    &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                                 (lvl V2 t - Suc NULL))) &quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j &#8800; lvl V t &#10230; levels (mem_pool_info V (pool b)) ! j = levels (mem_pool_info V2 (pool b)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
          list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE])
          (block b div 4 ^ (level b - lvl V t) div 4 * 4) (i V2 t) NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>V2</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(lvl V2 t - Suc NULL)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(n_max (mem_pool_info V (pool b))) * 4 ^  (lvl V2 t - Suc 0)&quot;</span></span></span><span>
</span><span>                   </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! (lvl V2 t - Suc 0)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h3_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! level b))
        = (n_max (mem_pool_info V (pool b))) * 4 ^ level b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>lm11</span><span class="delimiter">[</span><span>of</span><span> </span><span>V2</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>V</span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h4</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;(&#172; free_block_r V2 t &#10230; freeing_node V t = None) &#8743;
         &#945; = (if &#8707;y. freeing_node V t = Some y then lvl V t + 1 else NULL) &#8743;
         V &#8712; (if NULL &lt; &#945; then UNIV else {}) &#10233; free_block_r V2 t&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
  {free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b}
    &#8838; &#10627;&#180;(freeing_node_update
           (&#955;_. &#180;freeing_node(t &#8614;
               &#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
                  data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;)))
        &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b (&#945; - 1)&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subsetI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x = free_stm8_atombody_rest_cond3 (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1), bn := (bn V2)(t := bn V2 t div 4)&#10632;) t b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x&#10631;freeing_node := (freeing_node x) (t := Some &#10631;pool = pool b, level = lvl x t, block = bn x t,
                  data = block_ptr (mem_pool_info x (pool b)) (ALIGN4 (max_sz (mem_pool_info x (pool b))) div 4 ^ lvl x t) (bn x t)&#10632;)&#10632;
                  &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b (&#945;-1)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; &#10627;&#180;invariant.inv &#8743; &#180;allocating_node t = None&#10628; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_I1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_inv</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h2</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#10627;pool b &#8712; &#180;mem_pools &#8743; level b &lt; length (levels (&#180;mem_pool_info (pool b)))
    &#8743; block b &lt; length (bits (levels (&#180;mem_pool_info (pool b))!(level b)))
    &#8743; data b = block_ptr (&#180;mem_pool_info (pool b)) ((ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ (level b))) (block b)&#10628; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>block_ptr_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! level b)) =
                      length (bits ((levels (mem_pool_info V2 (pool b)))
                                 [lvl V2 t - Suc NULL := (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL))
                                    &#10631;bits := (bits (levels (mem_pool_info V2 (pool b)) ! (lvl V2 t - Suc NULL)))[bn V2 t div 4 := FREEING]&#10632;] !
                                 level b)) &quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j &#8800; lvl V t &#10230; levels (mem_pool_info V (pool b)) ! j
                  = levels (mem_pool_info V2 (pool b)) ! j&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) =
         list_updates_n ((bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE])
          (block b div 4 ^ (level b - lvl V t) div 4 * 4) (i V2 t) NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h1_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>V2</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#10627;level b &lt; length (&#180;lsizes t)
     &#8743; (&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ ii))
     &#8743; &#180;bn t &lt; length (bits (levels (&#180;mem_pool_info (pool b))!(&#180;lvl t)))
     &#8743; &#180;bn t = (block b) div (4 ^ (level b - &#180;lvl t))
     &#8743; &#180;lvl t &#8804; level b
     &#8743; (&#180;free_block_r t &#10230;
          (&#8707;blk. &#180;freeing_node t = Some blk &#8743; pool blk = pool b &#8743; level blk = &#180;lvl t &#8743; block blk = &#180;bn t)
        &#8743; &#180;alloc_memblk_data_valid (pool b) (the (&#180;freeing_node t)))
     &#8743; (&#172; &#180;free_block_r t &#10230; &#180;freeing_node t = None) &#10628; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>block_ptr_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h3</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V2 t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Nat.add_diff_assoc</span><span> </span><span>div_mult2_eq</span><span> </span><span>plus_1_eq_Suc</span><span> </span><span>power_add</span><span> </span><span>power_commutes</span><span> </span><span>power_one_right</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_pred</span><span> </span><span>le_imp_less_Suc</span><span> </span><span>nat_le_linear</span><span> </span><span>not_less</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_maxsz_align4</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b)) ! level b)) = (n_max (mem_pool_info V (pool b))) * 4 ^ level b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level b &gt; 0 &quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b &lt; n_max (mem_pool_info V (pool b)) * 4 ^ level b&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V2 t) = bn V2 t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lm11</span><span class="delimiter">[</span><span>of</span><span> </span><span>V2</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>V</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm_h4</span><span class="delimiter">[</span><span>of</span><span> </span><span>V2</span><span> </span><span>t</span><span> </span><span>V</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond2 V t b&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  V2 &#8712; free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628; &#10233;
   &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;lvl := &#180;lvl(t := &#180;lvl t - 1);;
      &#180;bn := &#180;bn(t := &#180;bn t div 4);;
      &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
       &#180;freeing_node := &#180;freeing_node(t &#8614;&#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
          data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;))
  sat<span class="hidden">&#8681;</span><sub>p</sub> [{V2}, {(s, t). s = t}, UNIV,
        &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b (&#945;-1)]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_atombody_rest_cond3 (free_stm8_atombody_rest_cond2 (free_stm8_atombody_rest_cond1 V2 t b) t b) t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_atombody_rest_cond2 (free_stm8_atombody_rest_cond1 V2 t b) t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_atombody_rest_cond1 V2 t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;lvl := &#180;lvl(t := &#180;lvl t - 1);; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;bn := &#180;bn(t := &#180;bn t div 4);;  *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;freeing_node := &#180;freeing_node(t &#8614;&#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
          data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;) *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bn V2&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bn (V2&#10631;lvl := (lvl V2)(t := lvl V2 t - 1)&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one_finalstm</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span> </span><span>V2</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;lvl := &#180;lvl(t := &#180;lvl t - 1);;
      &#180;bn := &#180;bn(t := &#180;bn t div 4);;
      &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
       &#180;freeing_node := &#180;freeing_node(t &#8614;&#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
          data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;))
  sat<span class="hidden">&#8681;</span><sub>p</sub> [free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628;, {(s, t). s = t}, UNIV,
        &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b (&#945; - 1)]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_one</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span>
</span><span>  </span><span>Allprecond</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>U</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                   </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Some (&#180;lvl := &#180;lvl(t := &#180;lvl t - 1);;
                  &#180;bn := &#180;bn(t := &#180;bn t div 4);;
                  &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
                   &#180;freeing_node := &#180;freeing_node(t &#8614;&#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
                      data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;)) &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                      </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(x, y). x = y}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                      </span><span>guar</span><span class="delimiter">=</span><span> </span><span>UNIV</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b (&#945; - 1)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_bd2_cond1 V t b &#8801; V&#10631;j := (j V)(t := lvl V t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_bd2_cond2 V t b &#8801; V&#10631;lbn := (lbn V)(t := bn V t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_bd2_cond3 V t b &#8801; V&#10631;lvl := (lvl V)(t := j V t - 1)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_bd2_cond4 V t b &#8801; V&#10631;bn := (bn V)(t := lbn V t div 4)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_bd2_cond5 V t b &#8801;
  let minf = mem_pool_info V (pool b) in
    V&#10631;mem_pool_info:= (mem_pool_info V) (pool b := minf &#10631;levels := (levels minf)
      [lvl V t := ((levels minf) ! (lvl V t)) &#10631;bits := (bits ((levels minf) ! (lvl V t))) [bn V t := FREEING]&#10632;] &#10632;)&#10632;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_blockfit</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V &#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  free_stm8_precond2 V t b &#8712; &#10627;block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t) (&#180;lsz t)&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_fits_def</span><span> </span><span>block_ptr_def</span><span> </span><span>buf_size_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">[</span><span>rule_format</span><span class="delimiter">,</span><span>of</span><span> </span><span>V</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool b&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b))) ! level b)) = (n_max (mem_pool_info V (pool b))) * 4 ^ (level b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b)) mod 4 ^ lvl V t = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n. max_sz (mem_pool_info V (pool b)) = (4 * n) * (4 ^ n_levels (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">[</span><span>rule_format</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>V</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b))) = n_levels (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>ge_pow_mod_0</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add_diff_inverse_nat</span><span> </span><span>add_lessD1</span><span> </span><span>ge_pow_mod_0</span><span> </span><span>le_antisym</span><span> </span><span>nat_less_le</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) &lt; n_max (mem_pool_info V (pool b)) * 4 ^ lvl V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>add_lessD1</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span> </span><span>le_Suc_ex</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>block_fits0_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ lvl V t&quot;</span></span></span><span>
</span><span>    </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_mempool_info</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info V &#10233;
    inv_mempool_info
     (V&#10631;freeing_node := (freeing_node V)(t := None),
          mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
            (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                        (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
          free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;i&lt;length (levels (mem_pool_info V (pool b))).
              length (bits (levels (mem_pool_info V (pool b)) ! i)) = n_max (mem_pool_info V (pool b)) * 4 ^ i)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap_freelist</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info V &#8743; inv_bitmap_freelist V &#8743; inv_aux_vars V &#10233;
 level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
  block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
  lvl V t &#8804; level b &#10233;
  freeing_node V t = Some blka &#10233;
  pool blka = pool b &#10233;
  level blka = lvl V t &#10233;
  block blka = block b div 4 ^ (level b - lvl V t) &#10233;
  inv_bitmap_freelist
   (V&#10631;freeing_node := (freeing_node V)(t := None),
        mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
          (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                      (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
        free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span> </span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;j &lt; length bts. bts ! j = FREE &#10231; buf mp + j * (max_sz mp div (4 ^ i)) &#8712; set fl *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &#8800; lvl V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj = block b div 4 ^ (level b - lvl V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! ii) ! jj = bits ((levels (mem_pool_info V (pool b)))
                  [lvl V t := ((levels (mem_pool_info V (pool b)))
                      [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                         &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] ! lvl V t)
                     &#10631;free_list := free_list ((levels (mem_pool_info V (pool b))) [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                             &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] ! lvl V t) @
                        [buf (mem_pool_info V (pool b)) + ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                  ii) ! jj&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info V (pool b))!ii)) = length (bits ((levels (mem_pool_info V (pool b)))
                                [lvl V t :=  ((levels (mem_pool_info V (pool b))) [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                       &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] ! lvl V t)
                                   &#10631;free_list := free_list ((levels (mem_pool_info V (pool b))) [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                      &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] ! lvl V t) @
                                      [buf (mem_pool_info V (pool b)) + max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info V (pool b)) ! ii) @
                                        [buf (mem_pool_info V (pool b)) +
                                         max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]  = free_list ((levels (mem_pool_info V (pool b)))
                                  [lvl V t :=  ((levels (mem_pool_info V (pool b)))
                                      [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                         &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
                                      lvl V t)
                                     &#10631;free_list := free_list ((levels (mem_pool_info V (pool b))) [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                             &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !  lvl V t) @
                                        [buf (mem_pool_info V (pool b)) +
                                         max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] ! ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! ii) ! jj = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(buf (mem_pool_info V (pool b)) + jj * (max_sz (mem_pool_info V (pool b)) div 4 ^ ii)
                              &#8712; set (free_list (levels (mem_pool_info V (pool b)) ! ii)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(buf (mem_pool_info V (pool b)) + jj * (max_sz (mem_pool_info V (pool b)) div 4 ^ ii)
                              &#8713; set (free_list (levels (mem_pool_info V (pool b)) ! ii)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info V (pool b)) + max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))
                          &#8800; buf (mem_pool_info V (pool b)) + jj * (max_sz (mem_pool_info V (pool b)) div 4 ^ ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>                      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&gt;NULL. max_sz (mem_pool_info V (pool b)) = 4 * n * 4 ^ n_levels (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t &lt; n_levels (mem_pool_info V (pool b))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>metis</span><span> </span><span>divisors_zero</span><span> </span><span>ge_pow_mod_0</span><span> </span><span>gr0I</span><span> </span><span>mod0_div_self</span><span> </span><span>mult_0_right</span><span> </span><span>power_not_zero</span><span> </span><span>zero_neq_numeral</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info V (pool b)) + jj * (max_sz (mem_pool_info V (pool b)) div 4 ^ ii)
                              &#8713; set (free_list (levels (mem_pool_info V (pool b)) ! ii) @
                                        [buf (mem_pool_info V (pool b)) +
                                         max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))])&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;j &lt; length fl. (&#8707;n. n &lt; n_max mp * (4 ^ i) &#8743; fl ! j = buf mp + n * (max_sz mp div (4 ^ i))) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &#8800; lvl V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info V (pool b)) ! ii) @
                                        [buf (mem_pool_info V (pool b)) +
                                         max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]  = free_list ((levels (mem_pool_info V (pool b)))
                                  [lvl V t :=  ((levels (mem_pool_info V (pool b)))
                                      [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                         &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
                                      lvl V t)
                                     &#10631;free_list := free_list ((levels (mem_pool_info V (pool b))) [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                             &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !  lvl V t) @
                                        [buf (mem_pool_info V (pool b)) +
                                         max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] ! ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (free_list (levels (mem_pool_info V (pool b)) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>nth_append</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj = length (free_list (levels (mem_pool_info V (pool b)) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(free_list (levels (mem_pool_info V (pool b)) ! ii) @
                            [buf (mem_pool_info V (pool b)) +
                             max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]) ! jj
                          = buf (mem_pool_info V (pool b)) +
                             max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) &lt; n_max (mem_pool_info V (pool b)) * 4 ^ ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* distinct fl *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info V (pool b)) ! i))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &#8800; lvl V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info V (pool b)) ! ii) @
                                  [buf (mem_pool_info V (pool b)) +
                                   max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]  = free_list ((levels (mem_pool_info V (pool b)))
                            [lvl V t :=  ((levels (mem_pool_info V (pool b)))
                                [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                   &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !
                                lvl V t)
                               &#10631;free_list := free_list ((levels (mem_pool_info V (pool b))) [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                       &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&#10632;] !  lvl V t) @
                                  [buf (mem_pool_info V (pool b)) +
                                   max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] ! ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info V (pool b)) +
                      max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))
                    &#8713; set (free_list (levels (mem_pool_info V (pool b)) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>               </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_aux_vars_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>15</span><span class="delimiter">)</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;pool b &#8712; mem_pools V &#10233;
    lvl V t &#8804; level b &#10233;
    level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
    block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
    V2 = V&#10631;freeing_node := (freeing_node V)(t := None),
          mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
            (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                        (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
          free_block_r := (free_block_r V)(t := False)&#10632; &#10233;
      &#8707;lv bl. bits (levels (mem_pool_info V2 (pool b)) ! lv) = (bits (levels (mem_pool_info V (pool b)) ! lv)) [bl := FREE]
          &#8743; (&#8704;lv&#39;. lv &#8800; lv&#39; &#10230;  bits (levels (mem_pool_info V2 (pool b)) ! lv&#39;) =  bits (levels (mem_pool_info V (pool b)) ! lv&#39;) )&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) = (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) [block b div 4 ^ (level b - lvl V t) := FREE] &quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;lv&#39;. lvl V t &#8800; lv&#39; &#10230;  bits (levels (mem_pool_info V2 (pool b)) ! lv&#39;) =  bits (levels (mem_pool_info V (pool b)) ! lv&#39;)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>exI</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>x</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span>auto</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap V &#8743; inv_aux_vars V &#10233;
    pool b &#8712; mem_pools V &#10233;
    level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
    block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
    block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
    lvl V t &#8804; level b &#10233;
    freeing_node V t = Some blka &#10233;
    pool blka = pool b &#10233;
    level blka = lvl V t &#10233;
    block blka = block b div 4 ^ (level b - lvl V t) &#10233;
    V2 = V&#10631;freeing_node := (freeing_node V)(t := None),
          mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
            (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                        (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
          free_block_r := (free_block_r V)(t := False)&#10632; &#10233;
    inv_bitmap V2&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p = pool b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;lv bl. bits (levels (mem_pool_info V (pool b)) ! lv) ! bl = FREEING
            &#8743; bits (levels (mem_pool_info V2 (pool b)) ! lv) = (bits (levels (mem_pool_info V (pool b)) ! lv)) [bl := FREE]
            &#8743; (&#8704;lv&#39;. lv &#8800; lv&#39; &#10230;  bits (levels (mem_pool_info V2 (pool b)) ! lv&#39;) =  bits (levels (mem_pool_info V (pool b)) ! lv&#39;) )&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! lvl V t) ! (block b div 4 ^ (level b - lvl V t)) = FREEING &quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_aux_vars_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V2 (pool b)) ! lvl V t) = (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) [block b div 4 ^ (level b - lvl V t) := FREE] &quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;lv&#39;. lvl V t &#8800; lv&#39; &#10230;  bits (levels (mem_pool_info V2 (pool b)) ! lv&#39;) =  bits (levels (mem_pool_info V (pool b)) ! lv&#39;)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>exI</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>x</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V (pool b))) = length (levels (mem_pool_info V2 (pool b)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_mp V (pool b)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;V2&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;V&#10631;freeing_node := (freeing_node V)(t := None),
            mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
              (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                          (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
            free_block_r := (free_block_r V)(t := False)&#10632;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freeing2free</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool b&quot;</span></span></span><span> </span><span>V2</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* p &#8800; pool b *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info V p = mem_pool_info
                   (V&#10631;freeing_node := (freeing_node V)(t := None),
                        mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
                          (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                                      (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
                        free_block_r := (free_block_r V)(t := False)&#10632;) p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools V = mem_pools (V&#10631;freeing_node := (freeing_node V)(t := None),
                             mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
                               (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                                           (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
                             free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>13</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_aux_vars</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info V &#8743; inv_aux_vars V &#10233;
  allocating_node V t = None &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
  block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
  bn V t = block b div 4 ^ (level b - lvl V t) &#10233;
  lvl V t &#8804; level b &#10233;
  freeing_node V t = Some blka &#10233;
  pool blka = pool b &#10233;
  level blka = lvl V t &#10233;
  block blka = block b div 4 ^ (level b - lvl V t) &#10233;
  inv_aux_vars
   (V&#10631;freeing_node := (freeing_node V)(t := None),
        mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
          (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                      (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
        free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_aux_vars_def</span><span> </span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V (pool b))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V (pool b)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t n. freeing_node s t = Some n &#10230; get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = pool blka &#8743; level n = level blka &#8743; block n = block blka)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n &#8800; pool blka&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8800; level blka&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8800; block blka&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V (pool b)))
                  [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                     &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                        free_list :=
                          free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                          [buf (mem_pool_info V (pool b)) +
                           max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                  level n) !
            block n = bits (levels (mem_pool_info V (pool b)) ! level n) ! block n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V (pool b)))
                  [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                     &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                        free_list :=
                          free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                          [buf (mem_pool_info V (pool b)) +
                           max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                  level n) = (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE]&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING &#8743; mem_block_addr_valid s n
                &#10230; (&#8707;t. freeing_node s t = Some n) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! level n) ! block n = FREEING
                        &#8743; (lvl V t &#8800; level n &#8744; block b div 4 ^ (level b - lvl V t) &#8800; block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = level n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) = block n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid V n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blka &#8800; n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>option.inject</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid V n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>option.inject</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t n. allocating_node s t = Some n &#10230; get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = level n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) = block n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING &#8743; mem_block_addr_valid s n
                &#10230; (&#8707;t. allocating_node s t = Some n) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! level n) ! block n = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = level n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block b div 4 ^ (level b - lvl V t) = block n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid V n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid V n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info V &#8743; inv_bitmap0 V &#10233;
  allocating_node V t = None &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
  block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
  bn V t = block b div 4 ^ (level b - lvl V t) &#10233;
  lvl V t &#8804; level b &#10233;
  freeing_node V t = Some blka &#10233;
  pool blka = pool b &#10233;
  level blka = lvl V t &#10233;
  block blka = block b div 4 ^ (level b - lvl V t) &#10233;
  inv_bitmap0
   (V&#10631;freeing_node := (freeing_node V)(t := None),
        mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
          (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                      (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
        free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span> </span><span>ALIGN4_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool b) 0 i &#8800; NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
                           [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                              &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                                 free_list :=
                                   free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                                   [buf (mem_pool_info V (pool b)) +
                                    (max_sz (mem_pool_info V (pool b)) + 3) div 4 * 4 div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                           0)) = length (bits (levels (mem_pool_info V (pool b)) ! 0))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V (pool b)) ! 0))[block b div 4 ^ (level b - lvl V t) := FREE]&quot;</span></span></span><span>
</span><span>                       </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V (pool b)))
                       [0 := (levels (mem_pool_info V (pool b)) ! 0)
                          &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! NULL))[block b div 4 ^ level b := FREE],
                             free_list :=
                               free_list (levels (mem_pool_info V (pool b)) ! NULL) @
                               [buf (mem_pool_info V (pool b)) + (max_sz (mem_pool_info V (pool b)) + 3) div 4 * 4 * (block b div 4 ^ level b)]&#10632;] !
                       0)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = block b div 4 ^ (level b - lvl V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmapn</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info V &#8743; inv_bitmapn V &#10233;
  allocating_node V t = None &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
  block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
  bn V t = block b div 4 ^ (level b - lvl V t) &#10233;
  lvl V t &#8804; level b &#10233;
  freeing_node V t = Some blka &#10233;
  pool blka = pool b &#10233;
  level blka = lvl V t &#10233;
  block blka = block b div 4 ^ (level b - lvl V t) &#10233;
  inv_bitmapn
   (V&#10631;freeing_node := (freeing_node V)(t := None),
        mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
          (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                      (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
        free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span> </span><span>ALIGN4_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool b) (length (levels (mem_pool_info V (pool b))) - Suc 0) i &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V (pool b)))
                           [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                              &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                                 free_list :=
                                   free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                                   [buf (mem_pool_info V (pool b)) +
                                    (max_sz (mem_pool_info V (pool b)) + 3) div 4 * 4 div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                           (length (levels (mem_pool_info V (pool b))) - Suc 0)))
                      = length (bits (levels (mem_pool_info V (pool b)) ! (length (levels (mem_pool_info V (pool b))) - Suc 0)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = (length (levels (mem_pool_info V (pool b))) - Suc 0)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V (pool b)) ! (length (levels (mem_pool_info V (pool b))) - Suc 0)))
                                [block b div 4 ^ (level b - lvl V t) := FREE]&quot;</span></span></span><span>
</span><span>                       </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info V (pool b)))
                       [(length (levels (mem_pool_info V (pool b))) - Suc 0) :=
                          (levels (mem_pool_info V (pool b)) ! (length (levels (mem_pool_info V (pool b))) - Suc 0))
                          &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! NULL))[block b div 4 ^ level b := FREE],
                             free_list :=
                               free_list (levels (mem_pool_info V (pool b)) ! NULL) @
                               [buf (mem_pool_info V (pool b)) + (max_sz (mem_pool_info V (pool b)) + 3) div 4 * 4 * (block b div 4 ^ level b)]&#10632;] !
                       (length (levels (mem_pool_info V (pool b))) - Suc 0))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = (length (levels (mem_pool_info V (pool b))) - Suc 0)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = block b div 4 ^ (level b - lvl V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap_not4free</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = NULL &#8744;
    &#172; partner_bits (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
        (block b div 4 ^ (level b - lvl V t)) &#10233;
  inv_mempool_info V &#8743; inv_bitmap_not4free V &#10233;
  allocating_node V t = None &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
  block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
  bn V t = block b div 4 ^ (level b - lvl V t) &#10233;
  lvl V t &#8804; level b &#10233;
  freeing_node V t = Some blka &#10233;
  pool blka = pool b &#10233;
  level blka = lvl V t &#10233;
  block blka = block b div 4 ^ (level b - lvl V t) &#10233;
  inv_bitmap_not4free
   (V&#10631;freeing_node := (freeing_node V)(t := None),
        mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
          (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                      (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
        free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_not4free_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>append_free_list_def</span><span>
</span><span>                </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span> </span><span>ALIGN4_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>partner_bits_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* lvl V t &#8800; 0 *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = lvl V t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>partner_bits_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j div 4 = block b div 4 ^ (level b - lvl V t) div 4&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* i &#8800; lvl V t *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>partner_bits_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = NULL &#8744;
  &#172; partner_bits (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
      (block b div 4 ^ (level b - lvl V t)) &#10233;
  inv V &#10233;
  allocating_node V t = None &#10233;
  pool b &#8712; mem_pools V &#10233;
  level b &lt; length (levels (mem_pool_info V (pool b))) &#10233;
  block b &lt; length (bits (levels (mem_pool_info V (pool b)) ! level b)) &#10233;
  data b = block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ level b) (block b) &#10233;
  level b &lt; length (lsizes V t) &#10233;
  &#8704;ii&lt;length (lsizes V t). lsizes V t ! ii = ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ ii &#10233;
  block b div 4 ^ (level b - lvl V t) &lt; length (bits (levels (mem_pool_info V (pool b)) ! lvl V t)) &#10233;
  bn V t = block b div 4 ^ (level b - lvl V t) &#10233;
  lvl V t &#8804; level b &#10233;
  free_block_r V t &#10233;
  lsz V t = ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t &#10233;
  blk V t = block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)) &#10233;
  cur V = Some t &#10233;
  data blka = buf (mem_pool_info V (pool b)) + block b div 4 ^ (level b - lvl V t) * (max_sz (mem_pool_info V (pool b)) div 4 ^ lvl V t) &#10233;
  block b div 4 ^ (level b - lvl V t) &lt; n_max (mem_pool_info V (pool b)) * 4 ^ lvl V t &#10233;
  freeing_node V t = Some y &#10233;
  pool y = pool b &#10233;
  level y = lvl V t &#10233;
  block y = block b div 4 ^ (level b - lvl V t) &#10233;
  inv
   (V&#10631;freeing_node := (freeing_node V)(t := None),
        mem_pool_info := (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)))
          (pool b := append_free_list (set_bit_free (mem_pool_info V) (pool b) (lvl V t) (block b div 4 ^ (level b - lvl V t)) (pool b)) (lvl V t)
                      (block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t) (block b div 4 ^ (level b - lvl V t)))),
        free_block_r := (free_block_r V)(t := False)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span> </span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_mempool_info</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap_freelist</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_aux_vars</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmapn</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>                    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv_bitmap_not4free</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_stm8_intI</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;{V} &#8838; &#10627;&#180;(free_block_r_update (&#955;_. &#180;free_block_r(t := False))) &#8712; A&#10628; &#10233;
      {V} &#8838; &#10627;&#180;(free_block_r_update (&#955;_. &#180;free_block_r(t := False))) &#8712; B&#10628; &#10233;
      {V} &#8838; &#10627;&#180;(free_block_r_update (&#955;_. &#180;free_block_r(t := False))) &#8712; A &#8745; B&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712; &#10627;&#180;free_block_r t&#10628; &#8745; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
  {let V2 = free_stm8_precond2 V t b in V2&#10631;mem_pool_info := (mem_pool_info V2)
              (pool b := append_free_list (mem_pool_info V2 (pool b)) (lvl V2 t) (blk V2 t))&#10632;}
  &#8838; &#10627;&#180;(free_block_r_update (&#955;_. &#180;free_block_r(t := False)))
      &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b 0&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_free_stm8_intI</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE] =
                      bits ((levels (mem_pool_info V (pool b)))
                      [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                         &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                            free_list := free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                              [buf (mem_pool_info V (pool b)) + ALIGN4 (max_sz (mem_pool_info V (pool b)))
                                    div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                      ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>length_list_update</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! ii) =
                      bits ((levels (mem_pool_info V (pool b)))
                      [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                         &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                            free_list := free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                              [buf (mem_pool_info V (pool b)) + ALIGN4 (max_sz (mem_pool_info V (pool b)))
                                  div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                      ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* inv *)</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_free_stm8_intI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* inv *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_inv</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvl V t = level b&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE] =
                      bits ((levels (mem_pool_info V (pool b)))
                              [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                 &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                                    free_list :=
                                      free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                                      [buf (mem_pool_info V (pool b)) +
                                       ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                              level b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>length_list_update</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info V (pool b)) ! level b) =
                      bits ((levels (mem_pool_info V (pool b)))
                              [lvl V t := (levels (mem_pool_info V (pool b)) ! lvl V t)
                                 &#10631;bits := (bits (levels (mem_pool_info V (pool b)) ! lvl V t))[block b div 4 ^ (level b - lvl V t) := FREE],
                                    free_list :=
                                      free_list (levels (mem_pool_info V (pool b)) ! lvl V t) @
                                      [buf (mem_pool_info V (pool b)) +
                                       ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t * (block b div 4 ^ (level b - lvl V t))]&#10632;] !
                              level b)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_ptr_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else&#39;</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712; &#10627;&#180;free_block_r t&#10628; &#8745; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t) (&#180;lsz t) THEN
      &#180;mem_pool_info := &#180;mem_pool_info(pool b := append_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;blk t))
    FI;;
    &#180;free_block_r := &#180;free_block_r (t := False))
  sat<span class="hidden">&#8681;</span><sub>p</sub> [{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628;,
                          {(s, t). s = t}, UNIV, &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b 0]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Some (IF block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t) (&#180;lsz t) THEN
      &#180;mem_pool_info := &#180;mem_pool_info(pool b := append_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;blk t))
    FI;;
    &#180;free_block_r := &#180;free_block_r (t := False) )&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span>
</span><span>  </span><span>UNIV</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b 0&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{let V2 = free_stm8_precond2 V t b in V2&#10631;mem_pool_info := (mem_pool_info V2)
      (pool b := append_free_list (mem_pool_info V2 (pool b)) (lvl V2 t) (blk V2 t))&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8745;
                   - &#10627;block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t)
                       (&#180;lsz t)&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_blockfit</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8745;
                   - &#10627;block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t)
                       (&#180;lsz t)&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_blockfit</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_h1</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t) (&#180;lsz t) THEN
      &#180;mem_pool_info := &#180;mem_pool_info(pool b := append_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;blk t))
    FI;;
    &#180;free_block_r := &#180;free_block_r (t := False) )
  sat<span class="hidden">&#8681;</span><sub>p</sub> [{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628;,
                          {(s, t). s = t}, UNIV, &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b 0]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;&#10627;&#180;free_block_r t&#10628; &#8745; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_1 t b &#945; = &#10627;&#180;free_block_r t&#10628; &#8745; mp_free_precond8_1 t b &#945;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_1_imp_free_block_r</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span>Int_absorb1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_1 t b &#945;&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else&#39;</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_rest_extpost</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  {free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; &#8800; {} &#10233;
   &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;lvl := &#180;lvl(t := &#180;lvl t - 1);;
      &#180;bn := &#180;bn(t := &#180;bn t div 4);;
      &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
       &#180;freeing_node := &#180;freeing_node(t &#8614;&#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
          data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;) )
  sat<span class="hidden">&#8681;</span><sub>p</sub> [free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628;, {(s, t). s = t}, UNIV,
        &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0)]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Conseq</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628;&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 V t b &#8745; &#10627;&#180;i t = 4&#10628;&quot;</span></span></span><span>
</span><span>                </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span> </span><span>UNIV</span><span> </span><span>UNIV</span><span>
</span><span>                </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b (&#945; - 1)&quot;</span></span></span><span>
</span><span>                </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0)&quot;</span></span></span><span>
</span><span>                </span><span class="string"><span class="delete"><span class="delete">&quot;Some (&#180;lvl := &#180;lvl(t := &#180;lvl t - 1);;
                &#180;bn := &#180;bn(t := &#180;bn t div 4);;
                &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
                 &#180;freeing_node := &#180;freeing_node(t &#8614;&#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
                    data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody_else_extpost</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712; mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t) (&#180;lsz t) THEN
      &#180;mem_pool_info := &#180;mem_pool_info(pool b := append_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;blk t))
    FI;;
    &#180;free_block_r := &#180;free_block_r (t := False) )
  sat<span class="hidden">&#8681;</span><sub>p</sub> [{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628;,
                          {(s, t). s = t}, UNIV, &#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628;
          &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0)]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Conseq</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628;&quot;</span></span></span><span>
</span><span>                     </span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond2 V t b} &#8745; - &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628;&quot;</span></span></span><span>
</span><span>                     </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span> </span><span>UNIV</span><span> </span><span>UNIV</span><span>
</span><span>                </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; mp_free_precond8_inv t b 0&quot;</span></span></span><span>
</span><span>                </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0)&quot;</span></span></span><span>
</span><span>                </span><span class="string"><span class="delete"><span class="delete">&quot;Some (IF block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t) (&#180;lsz t) THEN
                  &#180;mem_pool_info := &#180;mem_pool_info(pool b := append_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;blk t))
                FI;;
                &#180;free_block_r := &#180;free_block_r (t := False) )&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_atombody</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;mem_pool_info := set_bit_free &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
    &#180;freeing_node := &#180;freeing_node(t := None);;
    IF NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)
    THEN &#180;i := &#180;i(t := 0);;
         WHILE &#180;i t &lt; 4
         DO &#180;bb := &#180;bb(t := &#180;bn t div 4 * 4 + &#180;i t);;
            &#180;mem_pool_info := set_bit_noexist &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bb t);;
            &#180;block_pt := &#180;block_pt(t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bb t));;
            IF &#180;bn t &#8800; &#180;bb t &#8743;
               block_fits (&#180;mem_pool_info (pool b)) (&#180;block_pt t)
                (&#180;lsz t) THEN &#180;mem_pool_info := &#180;mem_pool_info
                              (pool b := remove_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;block_pt t)) FI;;
            &#180;i := &#180;i(t := Suc (&#180;i t))
         OD;;
         (&#180;lvl := &#180;lvl(t := &#180;lvl t - 1);; &#180;bn := &#180;bn(t := &#180;bn t div 4);;
          &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
          &#180;freeing_node := &#180;freeing_node(t &#8614;
          &#10631;pool = pool b, level = &#180;lvl t, block = &#180;bn t,
             data = block_ptr (&#180;mem_pool_info (pool b)) (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ &#180;lvl t) (&#180;bn t)&#10632;))
    ELSE IF block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t)
             (&#180;lsz t) THEN &#180;mem_pool_info := &#180;mem_pool_info
                           (pool b := append_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;blk t)) FI;;
         &#180;free_block_r := &#180;free_block_r(t := False)
    FI) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; UNIV &#8745; {Va}, {(s, t). s = t}, UNIV,
            &#10627;&#180;(Pair Va) &#8712; UNIV&#10628; &#8745; (&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628;
            &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0))]&quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* prepare some new assumptions and simplify the lemma *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; {Va}&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; UNIV &#8745; {Va}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; (mp_free_precond8_inv t b (&#945; - 1))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; UNIV&#10628; &#8745; (&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; (mp_free_precond8_inv t b (&#945; - 1)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V &#8800; Va&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; {Va}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span> </span><span>UNIV</span><span>
</span><span>      </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; UNIV&#10628; &#8745; (&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628; &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0))&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; {Va} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(subgoal_tac &quot;V = Va&quot;) prefer 2 apply force*)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{V}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; {Va}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>two_int_one</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span> </span><span>V</span><span> </span><span>Va</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V&#8712;mp_free_precond8_3 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* start proof *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond2 V t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond1 V t b}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := set_bit_free &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;freeing_node := &#180;freeing_node(t := None) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;lvl t &gt; 0 &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t) THEN *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{free_stm8_precond2 V t b} &#8745; &#10627;NULL &lt; &#180;lvl t &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t)&#10628; = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond4 Va t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;free_stm8_precond3 Va t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;i := &#180;i(t := NULL);; *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_set4partbits_while</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628;
                                &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0)&quot;</span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; UNIV&#10628; &#8745; (&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628;
                                &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_rest_extpost</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628;
                                &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0)&quot;</span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; UNIV&#10628; &#8745; (&#10627;&#180;(Pair V) &#8712; Mem_pool_free_guar t&#10628;
                                &#8745; (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody_else_extpost</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{(s,t). s = t} = Id&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;st8_while_body t b &#8801;
  (t &#9656; &#180;lsz := &#180;lsz (t := &#180;lsizes t ! (&#180;lvl t)));;
  (t &#9656; &#180;blk := &#180;blk (t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bn t)));;

  (t &#9656; ATOMIC

    &#180;mem_pool_info := set_bit_free &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
    &#180;freeing_node := &#180;freeing_node (t := None);;

    IF &#180;lvl t &gt; 0 &#8743; partner_bits (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;bn t) THEN
      FOR &#180;i := &#180;i(t := 0);
          &#180;i t &lt; 4;
          &#180;i := &#180;i(t := &#180;i t + 1) DO
        &#180;bb := &#180;bb (t := (&#180;bn t div 4) * 4 + &#180;i t);;
        &#180;mem_pool_info := set_bit_noexist &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bb t);;
        &#180;block_pt := &#180;block_pt (t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bb t));;
        IF &#180;bn t &#8800; &#180;bb t &#8743; block_fits (&#180;mem_pool_info (pool b))
                                      (&#180;block_pt t)
                                      (&#180;lsz t) THEN

          &#180;mem_pool_info := &#180;mem_pool_info ((pool b) :=
                  remove_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;block_pt t))
        FI
      ROF;;

      (
      &#180;lvl := &#180;lvl (t := &#180;lvl t - 1);;
      &#180;bn := &#180;bn (t := &#180;bn t div 4);;
      &#180;mem_pool_info := set_bit_freeing &#180;mem_pool_info (pool b) (&#180;lvl t) (&#180;bn t);;
      &#180;freeing_node := &#180;freeing_node (t := Some &#10631;pool = (pool b), level = (&#180;lvl t),
                block = (&#180;bn t),
                data = block_ptr (&#180;mem_pool_info (pool b))
                        (((ALIGN4 (max_sz (&#180;mem_pool_info (pool b)))) div (4 ^ (&#180;lvl t))))
                        (&#180;bn t) &#10632;)
      )

    ELSE
      IF block_fits (&#180;mem_pool_info (pool b)) (&#180;blk t) (&#180;lsz t) THEN

        &#180;mem_pool_info := &#180;mem_pool_info ((pool b) :=
                append_free_list (&#180;mem_pool_info (pool b)) (&#180;lvl t) (&#180;blk t) )
      FI;;

      &#180;free_block_r := &#180;free_block_r (t := False)
    FI

  END)
&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_free_precond8_inv_0_stb</span><span> </span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0) (Mem_pool_free_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_un2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_inv_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#945; - 1&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_inv_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>0</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_body_terminate</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (st8_while_body t b)
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, Mem_pool_free_rely t, Mem_pool_free_guar t,
        mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_3 t b &#945;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_2 t b &#945;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* statement: (t &#9656; &#180;lsz := &#180;lsz (t := &#180;lsizes t ! (&#180;lvl t)));; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_1_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_2_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_1 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsz := (lsz V)(t := lsizes V t ! (lvl V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsz := (lsz V)(t := lsizes V t ! (lvl V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* statement: (t &#9656; &#180;blk := &#180;blk (t := block_ptr (&#180;mem_pool_info (pool b)) (&#180;lsz t) (&#180;bn t)));; *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_2 t b &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;blk := (blk V)
           (t := block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t)
                  (block b div 4 ^ (level b - lvl V t)))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;blk := (blk V)
           (t := block_ptr (mem_pool_info V (pool b)) (ALIGN4 (max_sz (mem_pool_info V (pool b))) div 4 ^ lvl V t)
                  (block b div 4 ^ (level b - lvl V t)))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* statement: (t &#9656; ATOMIC ...  *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_inv_0_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_atombody</span><span class="delimiter">[</span><span>of</span><span> </span><span>b</span><span> </span><span>t</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* end of statement: (t &#9656; ATOMIC ...  *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>loopbody_sat_invterm_imp_inv_post&#39;</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar, mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0]
 &#10233;  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Conseq</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>          </span><span>rely</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0&quot;</span></span></span><span>
</span><span>          </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Some P&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>stm8_inv_imp_prepost2&#39;</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; (&#8704;&#945;. &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar,
                          mp_free_precond8_inv t b (&#945; - 1) &#8746; mp_free_precond8_inv t b 0])
  &#10233; &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;v. v&#8712;mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628; &#10230;
      &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [{v}, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;, rely, guar,mp_free_precond8 t b]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>allpre_eq_pre</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;&quot;</span></span></span><span>
</span><span>                          </span><span class="string"><span class="delete"><span class="delete">&quot;Some P&quot;</span></span></span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;&#945;. v &#8712; mp_free_precond8_inv t b &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>looppre_imp_exist_&#945;gt0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>exE</span><span class="delimiter">)</span><span>
</span><span>
</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>sat_pre_imp_allinpre</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Some P&quot;</span></span></span><span> </span><span>_</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>    </span><span>loopbody_sat_invterm_imp_inv_post&#39;</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8_body</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (st8_while_body t b)
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b &#8745; &#10627;&#180;free_block_r t&#10628;, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond8 t b]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stm8_inv_imp_prepost2&#39;</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(st8_while_body t b)&quot;</span></span></span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_free_rely t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_free_guar t&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>      </span><span>mempool_free_stm8_body_terminate</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm8</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (WHILE &#180;free_block_r t DO
       st8_while_body t b
     OD)
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond8 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, mp_free_precond9 t b]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond8_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond9_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span> </span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8_body</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;statement 9&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stm9_precond_while Va t b
  &#8801; {V. inv V &#8743; cur V = cur Va &#8743; tick V = tick Va &#8743; (V,Va)&#8712;gvars_conf_stable
        &#8743; freeing_node V t = freeing_node Va t &#8743; allocating_node V t = allocating_node Va t
        &#8743; (&#8704;p. levels (mem_pool_info V p) = levels (mem_pool_info Va p))
        &#8743; (&#8704;p. p &#8800; pool b &#10230; mem_pool_info V p = mem_pool_info Va p)
        &#8743; (&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; V Va)}&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>va_precond_while</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv Va &#10233; Va &#8712; stm9_precond_while Va t b&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_resch_inv_help</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233;  thd_state V t = RUNNING &#10233;
    (SOME ta. ta &#8800; t &#10230; thd_state V ta = READY) = t &#10233;
    V = V&#10631;cur := Some (SOME ta. ta &#8800; t &#10230; thd_state V ta = READY),
            thd_state := (thd_state V)(t := READY, SOME ta. ta &#8800; t &#10230; thd_state V ta = READY := RUNNING)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state V t = RUNNING&quot;</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(thd_state V)(t := RUNNING) = thd_state V&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>fun_upd_triv</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V = V&#10631;cur := Some t, thd_state := (thd_state V)(t := RUNNING)&#10632;&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_resch_inv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233; inv (V&#10631;cur := Some (SOME ta. ta &#8800; t &#10230; thd_state V ta = READY),
          thd_state := (thd_state V)(t := READY, SOME ta. ta &#8800; t &#10230; thd_state V ta = READY := RUNNING)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state V t = RUNNING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(SOME ta. ta &#8800; t &#10230; thd_state V ta = READY) = t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V = V&#10631;cur := Some (SOME ta. ta &#8800; t &#10230; thd_state V ta = READY),
    thd_state := (thd_state V)(t := READY, SOME ta. ta &#8800; t &#10230; thd_state V ta = READY := RUNNING)&#10632;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_resch_inv_help</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>t</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state V (SOME ta. ta &#8800; t &#10230; thd_state V ta = READY) = READY&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_aux_vars_def</span><span> </span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span class="delimiter">)</span><span>
</span><span>                      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_not4free_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>mono_tags</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>someI_ex</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_cur_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_ifpart_one</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_free_precond9 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
    V &#8712; stm9_precond_while Va t b &#8745; &#10627;wait_q (&#180;mem_pool_info (pool b)) = []&#10628; &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF &#180;need_resched t THEN reschedule FI )
    sat<span class="hidden">&#8681;</span><sub>p</sub> [{V}, {(x, y). x = y}, UNIV, &#10627;&#180;(Pair Va) &#8712; Mem_pool_free_guar t&#10628; &#8745; Mem_pool_free_post t]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* reschedule sat<span class="hidden">&#8681;</span><sub>p</sub> []*)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>reschedule_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{V&#10631;thd_state := (thd_state V)(the (cur V) := READY)&#10632;
              &#10631;cur := Some (SOME t. (thd_state (V&#10631;thd_state := (thd_state V)(the (cur V) := READY)&#10632;)) t = READY)&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{V&#10631;thd_state := (thd_state V)(the (cur V) := READY)&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_resch_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_post_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_resch_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Skip_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_free_post_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_ifpart</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_free_precond9 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF &#180;need_resched t THEN reschedule FI )
      sat<span class="hidden">&#8681;</span><sub>p</sub> [stm9_precond_while Va t b &#8745; &#10627;wait_q (&#180;mem_pool_info (pool b)) = []&#10628;,
            {(x, y). x = y}, UNIV, &#10627;&#180;(Pair Va) &#8712; Mem_pool_free_guar t&#10628; &#8745; Mem_pool_free_post t]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_ifpart_one</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span>
</span><span>    </span><span>Allprecond</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>U</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;stm9_precond_while Va t b &#8745; &#10627;wait_q (&#180;mem_pool_info (pool b)) = []&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                      </span><span>P</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Some (IF &#180;need_resched t THEN reschedule FI)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(x, y). x = y}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                      </span><span>guar</span><span class="delimiter">=</span><span> </span><span>UNIV</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_free_guar t&#10628; &#8745; Mem_pool_free_post t&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_loopbody_one</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_free_precond9 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   Vb &#8712; stm9_precond_while Va t b &#8745; &#10627;wait_q (&#180;mem_pool_info (pool b)) &#8800; []&#10628; &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;th := &#180;th(t := hd (wait_q (&#180;mem_pool_info (pool b))));;
          &#180;mem_pool_info := &#180;mem_pool_info
          (pool b := &#180;mem_pool_info (pool b)&#10631;wait_q := tl (wait_q (&#180;mem_pool_info (pool b)))&#10632;);;
          &#180;thd_state := &#180;thd_state(&#180;th t := READY);;
          &#180;need_resched := &#180;need_resched(t := True) )
   sat<span class="hidden">&#8681;</span><sub>p</sub> [{Vb},{(x, y). x = y}, UNIV, stm9_precond_while Va t b]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Vb&#10631;th := (th Vb) (t := hd (wait_q ((mem_pool_info Vb) (pool b))))&#10632;
                           &#10631;mem_pool_info := (mem_pool_info Vb)
                            (pool b := (mem_pool_info Vb) (pool b)&#10631;wait_q := tl (wait_q ((mem_pool_info Vb) (pool b)))&#10632;)&#10632;
                           &#10631;thd_state := (thd_state Vb)(hd (wait_q ((mem_pool_info Vb) (pool b))) := READY) &#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Vb&#10631;th := (th Vb) (t := hd (wait_q ((mem_pool_info Vb) (pool b))))&#10632;
                             &#10631;mem_pool_info := (mem_pool_info Vb)
                              (pool b := (mem_pool_info Vb) (pool b)&#10631;wait_q := tl (wait_q ((mem_pool_info Vb) (pool b)))&#10632;)&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Vb&#10631;th := (th Vb) (t := hd (wait_q ((mem_pool_info Vb) (pool b))))&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span> </span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>List.nth_tl</span><span> </span><span>Nitpick.size_list_simp</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Suc_mono</span><span> </span><span>gr_implies_not0</span><span>
</span><span>              </span><span>hd_conv_nth</span><span> </span><span>in_set_conv_nth</span><span> </span><span>length_pos_if_in_set</span><span> </span><span>lessI</span><span> </span><span>list.set_sel</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>meson</span><span> </span><span>list.set_sel</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>list.set_sel</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>hd_Cons_tl</span><span> </span><span>set_ConsD</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>List.nth_tl</span><span> </span><span>Nitpick.size_list_simp</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span>
</span><span>                                            </span><span>One_nat_def</span><span> </span><span>Suc_mono</span><span> </span><span>length_tl</span><span> </span><span>nat.inject</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>list.set_sel</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>list.set_sel</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_aux_vars_def</span><span> </span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span class="delimiter">)</span><span>
</span><span>                    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_not4free_def</span><span> </span><span>partner_bits_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_loopbody</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_free_precond9 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;th := &#180;th(t := hd (wait_q (&#180;mem_pool_info (pool b))));;
          &#180;mem_pool_info := &#180;mem_pool_info
          (pool b := &#180;mem_pool_info (pool b)&#10631;wait_q := tl (wait_q (&#180;mem_pool_info (pool b)))&#10632;);;
          &#180;thd_state := &#180;thd_state(&#180;th t := READY);;
          &#180;need_resched := &#180;need_resched(t := True) )
   sat<span class="hidden">&#8681;</span><sub>p</sub> [stm9_precond_while Va t b &#8745; &#10627;wait_q (&#180;mem_pool_info (pool b)) &#8800; []&#10628;,
        {(x, y). x = y}, UNIV, stm9_precond_while Va t b]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_loopbody_one</span><span>
</span><span>        </span><span>Allprecond</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>U</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;stm9_precond_while Va t b &#8745; &#10627;wait_q (&#180;mem_pool_info (pool b)) &#8800; []&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>P</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Some (&#180;th := &#180;th(t := hd (wait_q (&#180;mem_pool_info (pool b))));;
             &#180;mem_pool_info := &#180;mem_pool_info(pool b := &#180;mem_pool_info (pool b)&#10631;wait_q := tl (wait_q (&#180;mem_pool_info (pool b)))&#10632;);;
             &#180;thd_state := &#180;thd_state(&#180;th t := READY);;
             &#180;need_resched := &#180;need_resched (t := True))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(x, y). x = y}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar</span><span class="delimiter">=</span><span> </span><span>UNIV</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stm9_precond_while Va t b&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_body_loopinv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_free_precond9 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (WHILE wait_q (&#180;mem_pool_info (pool b)) &#8800; []
       DO &#180;th := &#180;th(t := hd (wait_q (&#180;mem_pool_info (pool b))));;
          &#180;mem_pool_info := &#180;mem_pool_info
          (pool b := &#180;mem_pool_info (pool b)&#10631;wait_q := tl (wait_q (&#180;mem_pool_info (pool b)))&#10632;);;
          &#180;thd_state := &#180;thd_state(&#180;th t := READY);;
          &#180;need_resched := &#180;need_resched(t := True)
       OD;;
       IF &#180;need_resched t THEN reschedule FI )
   sat<span class="hidden">&#8681;</span><sub>p</sub> [stm9_precond_while Va t b, {(x, y). x = y}, UNIV, {s. (Va,s)&#8712;Mem_pool_free_guar t} &#8745; Mem_pool_free_post t]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;stm9_precond_while Va t b &#8745; &#10627; wait_q (&#180;mem_pool_info (pool b)) = []&#10628; &quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_loopbody</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_ifpart</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9_body</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; mp_free_precond9 t b &#8745; &#10627;&#180;inv&#10628; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} &#8800; {} &#10233;
    &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (WHILE wait_q (&#180;mem_pool_info (pool b)) &#8800; []
       DO &#180;th := &#180;th(t := hd (wait_q (&#180;mem_pool_info (pool b))));;
          &#180;mem_pool_info := &#180;mem_pool_info(pool b := &#180;mem_pool_info (pool b)&#10631;wait_q := tl (wait_q (&#180;mem_pool_info (pool b)))&#10632;);;
          &#180;thd_state := &#180;thd_state(&#180;th t := READY);;
          &#180;need_resched := &#180;need_resched(t := True)
       OD;;
       IF &#180;need_resched t THEN reschedule FI )
    sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond9 t b &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va},
          {(s, t). s = t}, UNIV, &#10627;&#180;(Pair Va) &#8712; Mem_pool_free_guar t&#10628; &#8745; Mem_pool_free_post t]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_free_precond9 t b &#8745; &#10627;&#180;inv&#10628; &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_body_loopinv</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span>va_precond_while</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span>
</span><span>    </span><span>Conseq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>pre</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Va}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>pre&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;stm9_precond_while Va t b&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(x, y). x = y}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(x, y). x = y}&quot;</span></span></span><span>
</span><span>            </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar</span><span class="delimiter">=</span><span>UNIV</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar&#39;</span><span class="delimiter">=</span><span>UNIV</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_free_guar t&#10628; &#8745; Mem_pool_free_post t&quot;</span></span></span><span>
</span><span>            </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_free_guar t&#10628; &#8745; Mem_pool_free_post t&quot;</span></span></span><span>
</span><span>            </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Some (WHILE wait_q (&#180;mem_pool_info (pool b)) &#8800; []
             DO &#180;th := &#180;th(t := hd (wait_q (&#180;mem_pool_info (pool b))));;
                &#180;mem_pool_info := &#180;mem_pool_info
                (pool b := &#180;mem_pool_info (pool b)&#10631;wait_q := tl (wait_q (&#180;mem_pool_info (pool b)))&#10632;);;
                &#180;thd_state := &#180;thd_state(&#180;th t := READY);;
                &#180;need_resched := &#180;need_resched(t := True)
             OD;;
             IF &#180;need_resched t THEN reschedule FI )&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mempool_free_stm9</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; ATOMIC
      WHILE wait_q (&#180;mem_pool_info (pool b)) &#8800; [] DO
        &#180;th := &#180;th (t := hd (wait_q (&#180;mem_pool_info (pool b))));;
        &#180;mem_pool_info := &#180;mem_pool_info (pool b := &#180;mem_pool_info (pool b)
                &#10631;wait_q := tl (wait_q (&#180;mem_pool_info (pool b)))&#10632;);;
        &#180;thd_state := &#180;thd_state (&#180;th t := READY);;
        &#180;need_resched := &#180;need_resched(t := True)
      OD;;

      IF &#180;need_resched t THEN
        reschedule
      FI
    END)
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_free_precond9 t b, Mem_pool_free_rely t, Mem_pool_free_guar t, Mem_pool_free_post t]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_free_precond9_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mem_pool_free_post_stb</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V = Va&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond9 t b &#8745; &#10627;&#180;inv&#10628; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Emptyprecond</span><span> </span><span>stable_id2</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9_body</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Emptyprecond</span><span> </span><span>stable_id2</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;final proof&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_ev_satRG</span><span class="delimiter">:</span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#8866;<span class="hidden">&#8681;</span><sub>I</sub> (free_ev t b) sat<span class="hidden">&#8681;</span><sub>p</sub> [Mem_pool_free_pre t &#8745;  
                           &#10627;pool b &#8712; &#180;mem_pools &#8743; 
                            level b &lt; length (levels (&#180;mem_pool_info (pool b))) &#8743;
                            block b &lt; length (bits (levels (&#180;mem_pool_info (pool b)) ! level b)) &#8743;
                            data b = block_ptr (&#180;mem_pool_info (pool b))
                                     (ALIGN4 (max_sz (&#180;mem_pool_info (pool b))) div 4 ^ level b)
                                     (block b)&#10628;, 
                          Mem_pool_free_rely t, Mem_pool_free_guar t,Mem_pool_free_post t] &#8743; 
   stable (Mem_pool_free_pre t) (Mem_pool_free_rely t) &#8743; (&#8704;s. (s, s) &#8712; Mem_pool_free_guar t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>free_ev_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond9 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond8 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond7 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond6 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond5 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond4 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond3 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_free_precond2 t b&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm1</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm2</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm3</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm4</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm5</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm6</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm7</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm8</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mempool_free_stm9</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>b</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* stable of post condition wrt the rely cond *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>stable_equiv</span><span> </span><span>mem_pool_free_pre_stb</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_free_guar_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>Mempool_free_satRG</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Evt_sat_RG &#915; (Mem_pool_free_RGCond t b)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Evt_sat_RG_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_free_def</span><span> </span><span>Mem_pool_free_RGCond_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Evt_Basic</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>body_def</span><span> </span><span>guard_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_ev_satRG</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* stable of post condition wrt the rely cond *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>stable_equiv</span><span> </span><span>mem_pool_free_pre_stb</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span></pre>

</div>
</body>
</html>
