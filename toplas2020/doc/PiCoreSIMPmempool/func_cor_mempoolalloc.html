<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Theory func_cor_mempoolalloc (Isabelle2020: April 2020)</title>
<link media="all" rel="stylesheet" type="text/css" href="isabelle.css"/>
</head>

<body>
<div class="head"><h1>Theory func_cor_mempoolalloc</h1>

<span class="command">theory</span> <span class="name">func_cor_mempoolalloc</span><br/>
<span class="keyword">imports</span> <a href="func_cor_lemma.html"><span class="name">func_cor_lemma</span></a> <a href="../PiCoreSIMP/picore_SIMP_lemma.html"><span class="name">picore_SIMP_lemma</span></a><br/>

</div>
<div class="source">
<pre class="source"><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
Created by Yongwang Zhao (zhaoyw@buaa.edu.cn)
School of Computer Science &amp; Engineering, Beihang University, China
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">theory</span></span><span> </span><span>func_cor_mempoolalloc</span><span>
</span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span>func_cor_lemma</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;PiCoreSIMP.picore_SIMP_lemma&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;Functional correctness of $k\_mem\_pool\_alloc$ &#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;intermediate conditions and their stable to rely cond&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1 t p tm &#8801;
  Mem_pool_alloc_pre t &#8745; &#10627;p &#8712; &#180;mem_pools &#8743; tm &#8805; -1&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;p &#8712; &#180;mem_pools &#8743; tm &#8805; -1&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1 t p tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_pool_alloc_pre_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2 t p tm &#8801;
  mp_alloc_precond1 t p tm &#8745; &#10627;&#180;tmout t = tm&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;tmout t = tm&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> 
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2 t p tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond2_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond3 t p tm &#8801;
  mp_alloc_precond2 t p tm &#8745; &#10627;&#180;endt t = 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond3_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;endt t = 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>  
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond3_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond3 t p tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond2_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond3_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond4 t p tm &#8801;
  mp_alloc_precond2 t p tm &#8745; &#10627;&#180;endt t &#8805; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond4_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;endt t &#8805; 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond4_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond4 t p tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond2_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond4_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond5 t p tm &#8801;
  mp_alloc_precond4 t p tm &#8745; &#10627;&#180;mempoolalloc_ret t = None&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond5_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;mempoolalloc_ret t = None&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>                        
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond5_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond5 t p tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond5_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond6 t p tm &#8801;
  mp_alloc_precond5 t p tm &#8745; &#10627;&#180;ret t = ESIZEERR&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond6_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;ret t = ESIZEERR&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>  
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond6_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond6 t p tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond6_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
precondition of &quot;WHILE &#172; (&#180;rf t) DO&quot;
i.e. loop invariant
*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond7_ext t p sz timeout &#8801;
  {s. (rf s t &#10230; (timeout = FOREVER &#10230; (ret s t = ESIZEERR &#8743; mempoolalloc_ret s t = None
                                &#8744; ret s t = OK &#8743; (&#8707;mblk. mempoolalloc_ret s t = Some mblk &#8743; alloc_memblk_valid s p sz mblk)))
          &#8743; (timeout = NOWAIT &#10230; ((ret s t = ENOMEM &#8744; ret s t = ESIZEERR) &#8743; mempoolalloc_ret s t = None)
                                  &#8744; (ret s t = OK &#8743; (&#8707;mblk. mempoolalloc_ret s t = Some mblk &#8743; alloc_memblk_valid s p sz mblk)))
          &#8743; (timeout &gt; 0 &#10230; ((ret s t = ETIMEOUT &#8744; ret s t = ESIZEERR) &#8743; mempoolalloc_ret s t = None)
                             &#8744; (ret s t = OK &#8743; (&#8707;mblk. mempoolalloc_ret s t = Some mblk &#8743; alloc_memblk_valid s p sz mblk))))
      &#8743; (&#172;rf s t &#10230; mempoolalloc_ret s t = None)
      &#8743; (timeout = FOREVER &#10230; tmout s t = FOREVER)}&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond7 t p sz timeout &#8801;
  mp_alloc_precond1 t p timeout &#8745; mp_alloc_precond7_ext t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond7_inv t p sz timeout &#945; &#8801;
  mp_alloc_precond7 t p sz timeout
    &#8745; &#10627; &#945; = (if &#180;rf t &#8744; &#180;mempoolalloc_ret t &#8800; None then 0  &#8998;&#8249;(* if timeout = 0 (NOWAIT), rf is true *)&#8250;
             else if timeout &gt; 0 then &#180;endt t - &#180;tick
                  &#8998;&#8249;(* in rely cond, tick&#39; &#8805; tick, thus convergent &#946; &#8804; &#945;, not &lt; &#945;, thus not absolutely convergent *)&#8250;
                  else 1)
                  &#8998;&#8249;(* cannot find convergent &#945; for FOREVER, so just set 1 *)&#8250;&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond7_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond7_ext t p sz timeout) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_post_stb</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x = y&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond7_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond7 t p sz timeout) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond7_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_0 t p sz tm &#8801;
  mp_alloc_precond7 t p sz tm &#8745; &#10627;&#172; &#180;rf t&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_0_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable &#10627;&#172; &#180;rf t&#10628; (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> 
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_0_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_0 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_0_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_1 t p sz tm &#8801;
  mp_alloc_precond1_0 t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_0_stb</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(rule stable_int2)
  using mp_alloc_precond1_0_stb apply auto[1]
  apply(simp add:stable_def) apply(rule allI) apply(rule impI) apply(rule allI) apply(rule impI)
  apply(simp add:Mem_pool_alloc_rely_def)
  apply(simp add:lvars_nochange_rel_def lvars_nochange_def) apply metis
done*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_2 t p sz tm &#8801;
  mp_alloc_precond1_1 t p sz tm &#8745; &#10627;&#180;alloc_lsize_r t = False&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_2 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_3 t p sz tm &#8801;
  mp_alloc_precond1_2 t p sz tm &#8745; &#10627;&#180;alloc_l t = -1&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_3_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable &#10627;&#180;alloc_l t = -1&#10628; (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_3_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_3 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_3_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_4 t p sz tm &#8801;
  mp_alloc_precond1_3 t p sz tm &#8745; &#10627;&#180;free_l t = -1&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_4_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable &#10627;&#180;free_l t = -1&#10628; (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_4_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_4 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_4_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_5 t p sz tm &#8801;
  mp_alloc_precond1_4 t p sz tm &#8745; &#10627;&#180;lsizes t = [ALIGN4 (max_sz (&#180;mem_pool_info p))]&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_5_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable &#10627;&#180;lsizes t = [ALIGN4 (max_sz (&#180;mem_pool_info p))]&#10628; (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_5_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_5 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_5_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
precondition of &quot;WHILE &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#172; &#180;alloc_lsize_r t DO&quot;
i.e. loop invariant
*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_ext t p sz tm &#8801;
  &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info p))) div (4 ^ ii))
     &#8743; length (&#180;lsizes t) &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; (&#180;i t = 0 &#10230; &#180;alloc_l t = -1 &#8743; &#180;free_l t = -1 &#8743; length (&#180;lsizes t) = 1)
     &#8743; &#180;i t &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; -1 &#8804; &#180;free_l t &#8743; &#180;free_l t &#8804;  int (&#180;i t) - 1 &#8743; &#180;free_l t &#8804; &#180;alloc_l t
     &#8743; &#180;alloc_l t = int (&#180;i t) - 1
     &#8743; (&#180;alloc_l t &#8805; 0 &#10230; (&#8704;ii. ii &#8804; nat (&#180;alloc_l t) &#10230; &#180;lsizes t ! ii &#8805; sz))
     &#8743; (&#172; &#180;alloc_lsize_r t &#10230; (&#180;i t = 0 &#10230; length (&#180;lsizes t) = 1) &#8743; (&#180;i t &gt; 0 &#10230; length (&#180;lsizes t) = &#180;i t ))
     &#8743; (&#180;alloc_lsize_r t &#10230; length (&#180;lsizes t) = &#180;i t + 1 &#8743; &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#180;lsizes t ! (&#180;i t) &lt; sz)&#10628;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz tm &#8801;
  mp_alloc_precond1_1 t p sz tm &#8745; mp_alloc_precond1_6_ext t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizeloop_&#945;_cond t p &#945; &#8801;
  &#10627;&#945; = (if &#180;alloc_lsize_r t
        then 0 else n_levels (&#180;mem_pool_info p) - &#180;i t) &#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8801;
  mp_alloc_precond1_6 t p sz tm &#8745; mp_alloc_lsizeloop_&#945;_cond t p &#945;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopcond t p &#8801; &#10627; &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#172; &#180;alloc_lsize_r t &#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_loopinv_imp_precond</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8838; mp_alloc_precond1_6 t p sz tm&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_loopinv_&#945;gt0_imp_loopcond</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; &gt; 0&#10628; &#8838; mp_alloc_lsizestm_loopcond t p&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_loopinv_&#945;eq0_imp_notloopcond</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; = 0&#10628; &#8838; - mp_alloc_lsizestm_loopcond t p&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_loopinv_&#945;eq0_imp_notloopcond2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm 0 &#8838; - mp_alloc_lsizestm_loopcond t p&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_pre_loopcond_imp_loopinv_&#945;gt0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;x&#8712;mp_alloc_precond1_6 t p sz tm &#8745; mp_alloc_lsizestm_loopcond t p &#10233;
  &#8707;&#945;. x&#8712;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_pre_notloopcond_imp_loopinv_&#945;eq0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;x&#8712;mp_alloc_precond1_6 t p sz tm &#8745; - mp_alloc_lsizestm_loopcond t p &#10233;
  x&#8712;mp_alloc_lsizestm_loopinv t p sz tm 0&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_pre_notloopcond_imp_loopinv_&#945;eq0&#39;</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz tm &#8745; - mp_alloc_lsizestm_loopcond t p
        &#8838; mp_alloc_lsizestm_loopinv t p sz tm 0&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> 
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizestm_pre_notloopcond_eq_loopinv_&#945;eq0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz tm &#8745; - mp_alloc_lsizestm_loopcond t p
        = mp_alloc_lsizestm_loopinv t p sz tm 0&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subset_antisym</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizestm_pre_notloopcond_imp_loopinv_&#945;eq0&#39;</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizestm_loopinv_imp_precond</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span> </span><span>0</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizestm_loopinv_&#945;eq0_imp_notloopcond2</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizeloop_inv_cond_eq_&#945;gt0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; mp_alloc_lsizestm_loopcond t p
        = mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subset_antisym</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_ext t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_lsizeloop_&#945;_cond_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_lsizeloop_&#945;_cond t p &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_lsizestm_loopinv t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizeloop_&#945;_cond_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_presv_rely</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;s&#8712;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#10233; (s,r)&#8712;Mem_pool_alloc_rely t &#10233; &#8707;&#946;&#8804;&#945;. r&#8712;mp_alloc_lsizestm_loopinv t p sz tm &#946;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>exI</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>x</span><span class="delimiter">=</span><span>&#945;</span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_1 t p sz tm &#945; &#8801;
  mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; mp_alloc_lsizestm_loopcond t p&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_lsizestm_loopcond t p) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_1 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_6_1_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_10 t p sz tm &#945; &#8801;
  mp_alloc_precond1_6_1 t p sz tm &#945; &#8745; &#10627;&#180;i t &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_10_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;i t &gt; 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_10_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_10 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_6_10_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_11 t p sz tm &#945; &#8801;
  mp_alloc_precond1_6_1 t p sz tm &#945; &#8745; - &#10627;&#180;i t &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_11_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (- &#10627;&#180;i t &gt; 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_11_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_11 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_6_11_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_2_ext t p sz tm &#945; &#8801;
  &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info p))) div (4 ^ ii))
     &#8743; length (&#180;lsizes t) &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; (&#180;i t = 0 &#10230; &#180;alloc_l t = -1 &#8743; &#180;free_l t = -1 &#8743; length (&#180;lsizes t) = 1)
     &#8743; &#180;i t &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; -1 &#8804; &#180;free_l t &#8743; &#180;free_l t &#8804;  int (&#180;i t) - 1 &#8743; &#180;free_l t &#8804; &#180;alloc_l t
     &#8743; &#180;alloc_l t = int (&#180;i t) - 1
     &#8743; (&#180;alloc_l t &#8805; 0 &#10230; (&#8704;ii. ii &#8804; nat (&#180;alloc_l t) &#10230; &#180;lsizes t ! ii &#8805; sz))
     &#8743; (&#172; &#180;alloc_lsize_r t &#10230; (&#180;i t = 0 &#10230; length (&#180;lsizes t) = 1) &#8743; (&#180;i t &gt; 0 &#10230; length (&#180;lsizes t) = &#180;i t + 1))
      &#8998;&#8249;(* here &#180;i t + 1 is different from  mp_alloc_precond1_6_ext, *)&#8250;
     &#8743; (&#180;alloc_lsize_r t &#10230; length (&#180;lsizes t) = &#180;i t + 1 &#8743; &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#180;lsizes t ! (&#180;i t) &lt; sz)&#10628;
  &#8745; mp_alloc_lsizeloop_&#945;_cond t p &#945;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_2 t p sz tm &#945; &#8801;
  mp_alloc_precond1_2 t p sz tm &#8745; mp_alloc_precond1_6_2_ext t p sz tm &#945;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_2_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_2_ext t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizeloop_&#945;_cond_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_2 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_2_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_20 t p sz tm &#945; &#8801;
  mp_alloc_precond1_6_2 t p sz tm &#945; &#8745; &#10627;&#180;lsizes t ! &#180;i t &lt; sz&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_20_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;lsizes t ! &#180;i t &lt; sz&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_20_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_20 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_6_20_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21 t p sz tm &#945; &#8801;
  mp_alloc_precond1_6_2 t p sz tm &#945; &#8745; - &#10627;&#180;lsizes t ! &#180;i t &lt; sz&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_21_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (- &#10627;&#180;lsizes t ! &#180;i t &lt; sz&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_21_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_21 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_6_21_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1_ext t p sz tm &#945; &#8801;
    &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info p))) div (4 ^ ii))
     &#8743; length (&#180;lsizes t) &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; (&#180;i t = 0 &#10230; &#180;alloc_l t = 0 &#8743; &#180;free_l t = -1 &#8743; length (&#180;lsizes t) = 1)
     &#8743; &#180;i t &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; -1 &#8804; &#180;free_l t &#8743; &#180;free_l t &#8804;  int (&#180;i t) - 1 &#8743; &#180;free_l t &#8804; &#180;alloc_l t
     &#8743; &#180;alloc_l t = int (&#180;i t)
     &#8743; (&#180;alloc_l t &#8805; 0 &#10230; (&#8704;ii. ii &lt; nat (&#180;alloc_l t) &#10230; &#180;lsizes t ! ii &#8805; sz))
     &#8743; (&#172; &#180;alloc_lsize_r t &#10230; (&#180;i t = 0 &#10230; length (&#180;lsizes t) = 1) &#8743; (&#180;i t &gt; 0 &#10230; length (&#180;lsizes t) = &#180;i t + 1))
     &#8743; (&#180;alloc_lsize_r t &#10230; length (&#180;lsizes t) = &#180;i t + 1 &#8743; &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#180;lsizes t ! (&#180;i t) &lt; sz)
     &#8743; &#172; &#180;lsizes t ! &#180;i t &lt; sz&#10628; &#8745; mp_alloc_lsizeloop_&#945;_cond t p &#945;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz tm &#945; &#8801;
  mp_alloc_precond1_2 t p sz tm &#8745; mp_alloc_precond1_6_21_1_ext t p sz tm &#945;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_21_1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_21_1_ext t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizeloop_&#945;_cond_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_21_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_21_1 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_1_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2_ext t p sz tm &#945; &#8801;
    &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info p))) div (4 ^ ii))
     &#8743; length (&#180;lsizes t) &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; (&#180;i t = 0 &#10230; &#180;alloc_l t = 0 &#8743; length (&#180;lsizes t) = 1)
     &#8743; &#180;i t &#8804; n_levels (&#180;mem_pool_info p)
     &#8743; -1 &#8804; &#180;free_l t &#8743; &#180;free_l t &#8804;  int (&#180;i t) &#8743; &#180;free_l t &#8804; &#180;alloc_l t
     &#8743; &#180;alloc_l t = int (&#180;i t)
     &#8743; (&#180;alloc_l t &#8805; 0 &#10230; (&#8704;ii. ii &lt; nat (&#180;alloc_l t) &#10230; &#180;lsizes t ! ii &#8805; sz))
     &#8743; (&#172; &#180;alloc_lsize_r t &#10230; (&#180;i t = 0 &#10230; length (&#180;lsizes t) = 1) &#8743; (&#180;i t &gt; 0 &#10230; length (&#180;lsizes t) = &#180;i t + 1))
     &#8743; (&#180;alloc_lsize_r t &#10230; length (&#180;lsizes t) = &#180;i t + 1 &#8743; &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#180;lsizes t ! (&#180;i t) &lt; sz)
     &#8743; &#172; &#180;lsizes t ! &#180;i t &lt; sz&#10628; &#8745; mp_alloc_lsizeloop_&#945;_cond t p &#945;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz tm &#945; &#8801;
    mp_alloc_precond1_2 t p sz tm &#8745; mp_alloc_precond1_6_21_2_ext t p sz tm &#945;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_21_2_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_21_2_ext t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizeloop_&#945;_cond_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_6_21_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_6_21_2 t p sz tm &#945;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_2_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_7 t p sz tm &#8801;
  mp_alloc_precond1_6 t p sz tm &#8745; &#10627;&#180;i t &#8805; n_levels (&#180;mem_pool_info p) &#8744; &#180;alloc_lsize_r t &#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_7_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;i t &#8805; n_levels (&#180;mem_pool_info p) &#8744; &#180;alloc_lsize_r t &#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_7_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_7 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_7_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_ext t p sz tm &#8801;
     &#10627;(&#8704;ii&lt;length (&#180;lsizes t). &#180;lsizes t ! ii = (ALIGN4 (max_sz (&#180;mem_pool_info p))) div (4 ^ ii))
       &#8743; length (&#180;lsizes t) &#8804; n_levels (&#180;mem_pool_info p)
       &#8743; &#180;alloc_l t &lt; int (n_levels (&#180;mem_pool_info p))
       &#8743; -1 &#8804; &#180;free_l t &#8743; &#180;free_l t &#8804; &#180;alloc_l t
       &#8743; (&#180;alloc_l t = -1 &#8743; &#180;free_l t = -1 &#8743; length (&#180;lsizes t) = 1
           &#8744; (&#180;alloc_l t &#8805; 0 &#8743; (&#8704;ii. ii &#8804; nat (&#180;alloc_l t) &#10230; &#180;lsizes t ! ii &#8805; sz)
              &#8743; ((&#180;alloc_l t = int (length (&#180;lsizes t)) - 1) &#8743; length (&#180;lsizes t) = n_levels (&#180;mem_pool_info p)
                  &#8744; &#180;alloc_l t = int (length (&#180;lsizes t)) - 2 &#8743; &#180;lsizes t ! nat (&#180;alloc_l t + 1) &lt; sz)))&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70 t p sz tm &#8801;
  mp_alloc_precond1_1 t p sz tm &#8745; mp_alloc_precond1_70_ext t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_70_ext t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_70 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>precnd17_bl_170</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_7 t p sz tm &#8838; mp_alloc_precond1_70 t p sz tm&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i x t = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_lsize_r x t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_1 t p sz tm &#8801;
  mp_alloc_precond1_70 t p sz tm &#8745; &#10627;&#180;alloc_l t &lt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;alloc_l t &lt; 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_70_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_70_1_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2 t p sz tm &#8801;
  mp_alloc_precond1_70 t p sz tm &#8745; - &#10627;&#180;alloc_l t &lt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_2_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (- &#10627;&#180;alloc_l t &lt; 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_70_2 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_70_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_1 t p sz tm &#8801;
  mp_alloc_precond1_70_2 t p sz tm &#8745; &#10627;&#180;free_l t &lt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_2_1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;free_l t &lt; 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_2_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_70_2_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_70_2_1_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_2 t p sz tm &#8801;
  mp_alloc_precond1_70_2 t p sz tm &#8745; - &#10627;&#180;free_l t &lt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_2_2_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (- &#10627;&#180;free_l t &lt; 0&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_70_2_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_70_2_2 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond1_70_2_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>alloc_memblk_data_valid_stb</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = buf (mem_pool_info x p) +
   block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (free_l x t)) *
   (max_sz (mem_pool_info x p) div 4 ^ nat (free_l x t)) &#10233;
   block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (free_l x t)) &lt; n_max (mem_pool_info x p) * 4 ^ nat (free_l x t) &#10233;
   allocating_node x t =
   Some &#10631;pool = p, level = nat (free_l x t), block = block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (free_l x t)),
           data = blk x t&#10632; &#10233;
   (x, y) &#8712; lvars_nochange_rel t &#10233;
   (x, y) &#8712; gvars_conf_stable &#10233;
   alloc_memblk_data_valid y p (the (allocating_node y t))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_l x t = free_l y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = allocating_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_ext t p sz tm &#8801;
  &#10627;(&#180;blk t = NULL &#8743; &#180;allocating_node t = None)
   &#8744; (&#180;blk t &gt; NULL &#8743; &#180;alloc_memblk_data_valid p (the (&#180;allocating_node t))
         &#8743; &#180;allocating_node t = Some &#10631;pool = p, level = nat (&#180;free_l t),
                                      block = (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;free_l t)))),
                                      data = &#180;blk t &#10632;
        &#8743; (&#8707;n. n &lt; n_max (&#180;mem_pool_info p) * (4 ^ (nat (&#180;free_l t)))
                &#8743; &#180;blk t = buf (&#180;mem_pool_info p) + n * (max_sz (&#180;mem_pool_info p) div (4 ^ (nat (&#180;free_l t))))))&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1 t p sz tm &#8801;
  {s. inv s} &#8745; &#10627;&#180;freeing_node t = None&#10628; &#8745; &#10627;p &#8712; &#180;mem_pools &#8743; tm &#8805; -1&#10628; &#8745; mp_alloc_precond7_ext t p sz tm &#8745; &#10627;&#172; &#180;rf t&#10628;
  &#8745; mp_alloc_precond1_70_ext t p sz tm &#8745; - &#10627;&#180;alloc_l t &lt; 0&#10628;
  &#8745; - &#10627;&#180;free_l t &lt; 0&#10628; &#8745; mp_alloc_precond2_1_ext t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1 t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_freenode_stb</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;stable &#10627;&#180;freeing_node t = None&#10628; (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_ext t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_l x t = free_l y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span> 
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = allocating_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span> 
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info x p) = n_max (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (free_l x t))
                      = block_num (mem_pool_info y p) (blk y t) (lsizes y t ! nat (free_l y t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_num_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>stable_inv_alloc_rely1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_freenode_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond7_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_0_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_ext_stb</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_0 t p sz tm &#8801;
  mp_alloc_precond2_1 t p sz tm &#8745; &#10627;&#180;blk t = NULL&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_0_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (&#10627;&#180;blk t = NULL&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_0_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_0 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond2_1_0_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1 t p sz tm &#8801;
  mp_alloc_precond2_1 t p sz tm &#8745; -&#10627;&#180;blk t = NULL&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1 t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_1_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (-&#10627;&#180;blk t = NULL&#10628;) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_precond2_1_1_ext_stb</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_ext t p sz tm &#8801;
  -&#10627;&#180;blk t = NULL&#10628; &#8745; &#10627;&#180;from_l t &#8804; &#180;alloc_l t &#8743; &#180;from_l t &#8805; &#180;free_l t &#8743; &#180;allocating_node t = Some &#10631;pool = p, level = nat (&#180;from_l t),
                            block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;from_l t))),
                            data = &#180;blk t &#10632;
        &#8743; &#180;alloc_memblk_data_valid p (the (&#180;allocating_node t))
        &#8743; (&#8707;n. n &lt; n_max (&#180;mem_pool_info p) * (4 ^ (nat (&#180;from_l t)))
              &#8743; &#180;blk t = buf (&#180;mem_pool_info p) + n * (max_sz (&#180;mem_pool_info p) div (4 ^ (nat (&#180;from_l t))))) &#10628;&quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
abbreviation &quot;mp_alloc_precond2_1_1_loopinv t p sz tm &#8801;
  mp_alloc_precond1_70_2_2 t p sz tm &#8745; mp_alloc_precond2_1_1_loopinv_ext t p sz tm&quot;
*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv t p sz tm &#8801;
  {s. inv s} &#8745; &#10627;&#180;freeing_node t = None&#10628; &#8745; &#10627;p &#8712; &#180;mem_pools &#8743; tm &#8805; -1&#10628; &#8745; mp_alloc_precond7_ext t p sz tm &#8745; &#10627;&#172; &#180;rf t&#10628;
  &#8745; mp_alloc_precond1_70_ext t p sz tm &#8745; - &#10627;&#180;alloc_l t &lt; 0&#10628;
  &#8745; - &#10627;&#180;free_l t &lt; 0&#10628; &#8745; mp_alloc_precond2_1_1_loopinv_ext t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>alloc_memblk_data_valid_stb2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = buf (mem_pool_info x p) +
       block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (from_l x t)) *
       (max_sz (mem_pool_info x p) div 4 ^ nat (from_l x t)) &#10233;
  block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (from_l x t)) &lt; n_max (mem_pool_info x p) * 4 ^ nat (from_l x t) &#10233;
   allocating_node x t =
   Some &#10631;pool = p, level = nat (from_l x t), block = block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (from_l x t)),
           data = blk x t&#10632; &#10233;
   (x, y) &#8712; lvars_nochange_rel t &#10233;
   (x, y) &#8712; gvars_conf_stable &#10233;
   alloc_memblk_data_valid y p (the (allocating_node y t))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l x t = from_l y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = allocating_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_ext_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_1_loopinv_ext t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond2_1_1_ext_stb</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> 
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>2</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l x t = from_l y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> 
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> 
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>2</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = allocating_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>2</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>2</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info x p) = n_max (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> 
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>erule</span><span> </span><span>disjE</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>2</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (from_l x t))
                      = block_num (mem_pool_info y p) (blk y t) (lsizes y t ! nat (from_l y t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_num_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_1_loopinv t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>stable_inv_alloc_rely1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_freenode_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond7_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_0_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*abbreviation &quot;mp_alloc_precond2_1_2 t p sz tm &#8801;
  mp_alloc_precond1_70_2_2 t p sz tm &#8745; -&#10627;&#180;blk t = NULL&#10628;
    &#8745; &#10627;&#180;allocating_node t = Some &#10631;pool = p, level = nat (&#180;alloc_l t),
                            block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))),
                            data = &#180;blk t &#10632; &#8743; &#180;alloc_memblk_data_valid p (the (&#180;allocating_node t)) &#10628;&quot;*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz tm &#8801;
  {s. inv s} &#8745; &#10627;&#180;freeing_node t = None&#10628; &#8745; &#10627;p &#8712; &#180;mem_pools &#8743; tm &#8805; -1&#10628; &#8745; mp_alloc_precond7_ext t p sz tm &#8745; &#10627;&#172; &#180;rf t&#10628;
  &#8745; mp_alloc_precond1_70_ext t p sz tm &#8745; - &#10627;&#180;alloc_l t &lt; 0&#10628; &#8745; - &#10627;&#180;free_l t &lt; 0&#10628; &#8745; -&#10627;&#180;blk t = NULL&#10628;
    &#8745; &#10627;&#180;allocating_node t = Some &#10631;pool = p, level = nat (&#180;alloc_l t),
                            block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))),
                            data = &#180;blk t &#10632; &#8743; &#180;alloc_memblk_data_valid p (the (&#180;allocating_node t)) &#10628;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv t p sz tm&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>alloc_memblk_data_valid_stb3</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = buf (mem_pool_info x p) +
   block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (alloc_l x t)) *
   (max_sz (mem_pool_info x p) div 4 ^ nat (alloc_l x t)) &#10233;
   block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (alloc_l x t)) &lt; n_max (mem_pool_info x p) * 4 ^ nat (alloc_l x t) &#10233;
   allocating_node x t =
   Some &#10631;pool = p, level = nat (alloc_l x t), block = block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (alloc_l x t)),
           data = blk x t&#10632; &#10233;
   (x, y) &#8712; lvars_nochange_rel t &#10233;
   (x, y) &#8712; gvars_conf_stable &#10233;
   alloc_memblk_data_valid y p (the (allocating_node y t))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l x t = alloc_l y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = allocating_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_2 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>stable_inv_alloc_rely1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_freenode_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond7_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_0_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond2_1_1_ext_stb</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_num_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>fastforce</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>fastforce</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l x t = alloc_l y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>fastforce</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = allocating_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>fastforce</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info x p) = n_max (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (alloc_l x t))
                      = block_num (mem_pool_info y p) (blk y t) (lsizes y t ! nat (alloc_l y t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>option.sel</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_num_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*abbreviation &quot;mp_alloc_precond2_1_3 t p sz tm &#8801;
  mp_alloc_precond2_1_2 t p sz tm &#8745; &#10627;&#180;allocating_node t = None&#10628;&quot;*)</span></span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*abbreviation &quot;mp_alloc_precond2_1_3 t p sz tm &#8801;
  mp_alloc_precond1_70_2_2 t p sz tm &#8745; -&#10627;&#180;blk t = NULL&#10628; &#8745; &#10627;&#180;allocating_node t = None&#10628;&quot;*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_3 t p sz tm &#8801;
  mp_alloc_precond1_70_2_2 t p sz tm &#8745; -&#10627;&#180;blk t = NULL&#10628;
    &#8745; &#10627;&#180;alloc_blk_valid p (nat (&#180;alloc_l t)) (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))))
          (&#180;blk t) &#8743; &#180;allocating_node t = None&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_3_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_3 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
abbreviation &quot;mp_alloc_precond2_1_4 t p sz tm &#8801;
  mp_alloc_precond2_1_3 t p sz tm &#8745; &#10627;&#8707;mblk. &#180;mempoolalloc_ret t = Some mblk &#8743; &#180;alloc_memblk_valid p sz mblk&#10628;&quot;
*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_4 t p sz tm &#8801;
mp_alloc_precond1 t p tm &#8745; &#10627;&#172;&#180;rf t&#10628; &#8745; &#10627; (tm = FOREVER &#10230; &#180;tmout t = FOREVER) &#10628;
    &#8745; {s. (&#8707;mblk. mempoolalloc_ret s t = Some mblk &#8743; alloc_memblk_valid s p sz mblk)}&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_4_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_4 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;tm = ETIMEOUT&quot;</span></span></span><span class="delimiter">,</span><span> </span><span>auto</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8 t p sz tm &#8801;
  mp_alloc_precond1 t p tm &#8745; &#10627;&#172;&#180;rf t&#10628; &#8745; &#10627; (tm = FOREVER &#10230; &#180;tmout t = FOREVER) &#10628;
    &#8745; {s. (ret s t = OK &#8743; (&#8707;mblk. mempoolalloc_ret s t = Some mblk &#8743; alloc_memblk_valid s p sz mblk))
        &#8744; ((ret s t = ESIZEERR &#8744; ret s t = EAGAIN &#8744; ret s t = ENOMEM) &#8743; mempoolalloc_ret s t = None) }&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>mem_Collect_eq</span><span> </span><span>mp_alloc_precond2_ext_stb</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(simp add:stable_def Mem_pool_alloc_rely_def lvars_nochange_rel_def lvars_nochange_def) apply auto[1]*)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_0 t p sz tm &#8801;
  mp_alloc_precond1 t p tm &#8745; &#10627; (tm = FOREVER &#10230; &#180;tmout t = FOREVER) &#10628;
    &#8745; {s. (ret s t = OK &#8743; (&#8707;mblk. mempoolalloc_ret s t = Some mblk &#8743; alloc_memblk_valid s p sz mblk))
        &#8744; ((ret s t = ESIZEERR &#8744; ret s t = EAGAIN &#8744; ret s t = ENOMEM) &#8743; mempoolalloc_ret s t = None) }&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_0_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_0 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>mem_Collect_eq</span><span> </span><span>mp_alloc_precond2_ext_stb</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(simp add:stable_def Mem_pool_alloc_rely_def lvars_nochange_rel_def lvars_nochange_def) apply auto[1]*)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_1 t p sz tm &#8801;
  mp_alloc_precond1_8 t p sz tm
    &#8745; &#10627;&#180;ret t = OK &#8744; tm = NOWAIT &#8744; &#180;ret t = ESIZEERR&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_1_1 t p sz tm &#8801;
  mp_alloc_precond1_8_0 t p sz tm &#8745; &#10627;&#180;ret t = OK &#8744; tm = NOWAIT &#8744; &#180;ret t = ESIZEERR&#10628; &#8745; &#10627;&#180;rf t = True&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_1_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_1_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_0_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_1_2 t p sz tm &#8801;
  mp_alloc_precond1_8_1_1 t p sz tm &#8745; &#10627;&#180;ret t = EAGAIN&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_1_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_1_2 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_1_3 t p sz tm &#8801;
  mp_alloc_precond1_8_1_1 t p sz tm &#8745; -&#10627;&#180;ret t = EAGAIN&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_1_3_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_1_3 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2 t p sz tm &#8801;
  mp_alloc_precond1_8 t p sz tm
    &#8745; -&#10627;&#180;ret t = OK &#8744; tm = NOWAIT &#8744; &#180;ret t = ESIZEERR&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_1 t p sz tm &#8801;
  mp_alloc_precond1_8_2 t p sz tm &#8745; &#10627;&#180;ret t = EAGAIN&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_2 t p sz tm &#8801;
  mp_alloc_precond1_8_2 t p sz tm &#8745; -&#10627;&#180;ret t = EAGAIN&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_2_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_2 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_3 t p sz tm &#8801;
  mp_alloc_precond1_8_2_2 t p sz tm &#8745; &#10627;&#180;tmout t &#8800; FOREVER&#10628; &#8745; &#10627;tm &gt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_pred1823_eq</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_3 t p sz tm = mp_alloc_precond1_8_2_2 t p sz tm &#8745; &#10627;&#180;tmout t &#8800; FOREVER&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_3_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_3 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_20 t p sz tm &#8801;
  mp_alloc_precond1_8_2_2 t p sz tm &#8745; -&#10627;&#180;tmout t &#8800; FOREVER&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_20_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_20 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_4 t p sz tm &#8801; mp_alloc_precond1_8_2_2 t p sz tm &#8745; &#10627;tm &gt; 0&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_4_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_4 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_40 t p sz tm &#8801;
  mp_alloc_precond1_8_2_4 t p sz tm &#8745; &#10627;&#180;tmout t &lt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_40_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_40 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_40 t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_41 t p sz tm &#8801;
  mp_alloc_precond1_8_2_4 t p sz tm &#8745; -&#10627;&#180;tmout t &lt; 0&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_41_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_41 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_5 t p sz tm &#8801;
  mp_alloc_precond1_8_0 t p sz tm &#8745; &#10627;tm &gt; 0&#10628; &#8745; -&#10627;&#180;ret t = OK &#8744; tm = NOWAIT &#8744; &#180;ret t = ESIZEERR&#10628; &#8745; -&#10627;&#180;ret t = EAGAIN&#10628;
    &#8745; &#10627;&#180;tmout t &lt; 0&#10628; &#8745; &#10627;&#180;rf t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_5 t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond1_8_2_5_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond1_8_2_5 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_0_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;proof of each statement&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;stm1&#8250;</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm1_lm0</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233;
     V&#10631;lsizes := (lsizes V)(t := lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)])&#10632;
           &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)])&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm1_lm1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_10 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V}
         &#8838; &#10627;&#180;(lsizes_update (&#955;_. &#180;lsizes(t := &#180;lsizes t @ [ALIGN4 (&#180;lsizes t ! (&#180;i t - Suc NULL) div 4)])))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745;
                mp_alloc_precond1_6_2 t p sz timeout &#945;&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_alloc_stm1_lm0</span><span class="delimiter">,</span><span> </span><span>blast</span><span class="delimiter">,</span><span> </span><span>blast</span><span class="delimiter">)</span><span> 
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (V&#10631;lsizes := (lsizes V)(t := lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)])&#10632;) t
                        = lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)]&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (V&#10631;lsizes := (lsizes V)(t := lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)])&#10632;) t&quot;</span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes V t @ [ALIGN4 (lsizes V t ! (i V t - Suc NULL) div 4)]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (lsizes V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>nth_append</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii = length (lsizes V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(lsizes V t @ [ALIGN4 (ALIGN4 (max_sz (mem_pool_info V p)) div 4 ^ (i V t - Suc NULL) div 4)]) ! ii
                            = ALIGN4 (ALIGN4 (max_sz (mem_pool_info V p)) div 4 ^ (i V t - Suc NULL) div 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>meson</span><span> </span><span>nth_append_length</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info V p)) div 4 ^ (i V t - Suc NULL) div 4
                          = ALIGN4 (max_sz (mem_pool_info V p)) div 4 ^ ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Divides.div_mult2_eq</span><span> </span><span>One_nat_def</span><span> </span><span>power_minus_mult</span><span> </span><span>zero_le_numeral</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ALIGN4 (max_sz (mem_pool_info V p)) div 4 ^ ii) mod 4 = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&gt;0. max_sz (mem_pool_info V p) = (4 * n) * (4 ^ n_levels (mem_pool_info V p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>inv_maxsz_align4</span><span> </span><span>less_imp_le_nat</span><span>
</span><span>                        </span><span>m_mod_div</span><span> </span><span>mod_mult_self1_is_0</span><span> </span><span>mult.assoc</span><span> </span><span>pow_mod_0</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>align40</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>le_nat_iff</span><span> </span><span>nth_append</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm1_lm</span><span class="delimiter">:</span><span>
</span><span>   </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF &#180;i t &gt; 0 THEN
          (t &#9656; &#180;lsizes := &#180;lsizes(t := &#180;lsizes t @ [ALIGN4 (&#180;lsizes t ! (&#180;i t - 1) div 4)]))
        FI) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6_1 t p sz timeout &#945;, Mem_pool_alloc_rely t,
                  Mem_pool_alloc_guar t, mp_alloc_precond1_6_2 t p sz timeout &#945;]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_10_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>         </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_10 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>2</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm1_lm1</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_11_stb</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;stm2&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm2_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233;  V&#10631;alloc_lsize_r := (alloc_lsize_r V)(t := True)&#10632; &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_lsize_r := (alloc_lsize_r V)(t := True)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_20 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V}
         &#8838; &#10627;&#180;(alloc_lsize_r_update (&#955;_. &#180;alloc_lsize_r(t := True)))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_lsizestm_loopinv t p sz timeout 0 &#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm2_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_lsize_r := (alloc_lsize_r V)(t := True)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm4_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233; V&#10631;alloc_l := (alloc_l V)(t := int (i V t))&#10632; &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_l := (alloc_l V)(t := int (i V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm4</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V}
         &#8838; &#10627;&#180;(alloc_l_update (&#955;_. &#180;alloc_l(t := int (&#180;i t))))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745;
                mp_alloc_precond1_6_21_1 t p sz timeout &#945;&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm4_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(rule conjI)*)</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_l := (alloc_l V)(t := int (i V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(simp add:alloc_memblk_valid_def)*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm5_1_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233;  V&#10631;free_l := (free_l V)(t := int (i V t))&#10632; &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;free_l := (free_l V)(t := int (i V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm5_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V}
         &#8838; &#10627;&#180;(free_l_update (&#955;_. &#180;free_l(t := int (&#180;i t))))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745;
                mp_alloc_precond1_6_21_2 t p sz timeout &#945;&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm5_1_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(rule conjI)*)</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;free_l := (free_l V)(t := int (i V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(simp add:alloc_memblk_valid_def)*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm5</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;free_l := &#180;free_l (t := int (&#180;i t)))
    sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6_21_1 t p sz timeout &#945;, Mem_pool_alloc_rely t,
          Mem_pool_alloc_guar t, mp_alloc_precond1_6_21_2 t p sz timeout &#945;]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm5_1</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm6</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some SKIP sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6_21_1 t p sz timeout &#945;, Mem_pool_alloc_rely t,
                  Mem_pool_alloc_guar t, mp_alloc_precond1_6_21_2 t p sz timeout &#945;]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(rule IntI)*)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span class="delimiter">+</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm7_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233; V&#10631;i := (i V)(t := (i V t) + 1)&#10632; &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := (i V t) + 1)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm7</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V}
         &#8838; &#10627;&#180;(i_update (&#955;_. &#180;i(t := Suc (&#180;i t))))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745;
                mp_alloc_lsizestm_loopinv t p sz timeout (&#945; - 1)&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm7_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := (i V t) + 1)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; i V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii = i V t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>subset_un_I1</span><span class="delimiter">[</span><span>intro</span><span class="delimiter">]</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;A &#8838; B &#10233; A &#8838; B &#8746; C&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>subset_un_I2</span><span class="delimiter">[</span><span>intro</span><span class="delimiter">]</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;A &#8838; C &#10233; A &#8838; B &#8746; C&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm8</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;P &#8838; &#10627;&#180;(alloc_lsize_r_update (&#955;_. &#180;alloc_lsize_r(t := True)))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; B &#10628; &#10233;
  P &#8838; &#10627;&#180;(alloc_lsize_r_update (&#955;_. &#180;alloc_lsize_r(t := True)))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; (A &#8746; B) &#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm9</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;P &#8838; &#10627;&#180;(i_update (&#955;_. &#180;i(t := Suc (&#180;i t))))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; A&#10628; &#10233;
  P &#8838; &#10627;&#180;(i_update (&#955;_. &#180;i(t := Suc (&#180;i t))))
             &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; (A &#8746; B)&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm2_lm</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF &#180;lsizes t ! &#180;i t &lt; sz THEN
       t &#9656; &#180;alloc_lsize_r := &#180;alloc_lsize_r(t := True)
     ELSE (t &#9656; &#180;alloc_l := &#180;alloc_l(t := int (&#180;i t)));;
       IF &#172; level_empty (&#180;mem_pool_info p) (&#180;i t) THEN
          t &#9656; &#180;free_l := &#180;free_l(t := int (&#180;i t))
       FI;;
       (t &#9656; &#180;i := &#180;i(t := Suc (&#180;i t)))
     FI) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6_2 t p sz timeout &#945;, Mem_pool_alloc_rely t,
              Mem_pool_alloc_guar t, mp_alloc_lsizestm_loopinv t p sz timeout (&#945; - 1)
                                      &#8746; mp_alloc_lsizestm_loopinv t p sz timeout 0]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;alloc_lsize_r := &#180;alloc_lsize_r(t := True)) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_20_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_un2</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_20 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_alloc_stm2_lm8</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>t</span><span> </span><span>_</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz timeout 0&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz timeout (&#945; - 1)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm2</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz timeout &#945;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz timeout &#945;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;alloc_l := &#180;alloc_l(t := int (&#180;i t)));; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm4</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#172; level_empty (&#180;mem_pool_info p) (&#180;i t) THEN
        (t &#9656; &#180;free_l := &#180;free_l(t := int (&#180;i t)))
      FI;;*)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(***********************************************
    here, since ``level_empty (&#180;mem_pool_info p) (&#180;i t)&#39;&#39; is not stable on rely, we relax the precondition.
    actually, remove the ``level_empty (&#180;mem_pool_info p) (&#180;i t)&#39;&#39; from the precondition.
    ************************************************)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Conseq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>pre</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz timeout &#945; &#8745; &#10627;&#172; level_empty (&#180;mem_pool_info p) (&#180;i t)&#10628;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>pre&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz timeout &#945;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_rely t&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_rely t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_guar t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_guar t&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz timeout &#945;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz timeout &#945;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Some (t &#9656; &#180;free_l := &#180;free_l (t := int (&#180;i t)))&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>     </span><span>mp_alloc_stm2_lm5</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Conseq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>pre</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz timeout &#945; &#8745; - &#10627;&#172; level_empty (&#180;mem_pool_info p) (&#180;i t)&#10628;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>pre&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_1 t p sz timeout &#945;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_rely t&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_rely t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_guar t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_guar t&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz timeout &#945;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz timeout &#945;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Some SKIP&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>      </span><span>mp_alloc_stm2_lm6</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;i := &#180;i(t := &#180;i t + 1)) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_21_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_un2</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_lsizestm_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_21_2 t p sz timeout &#945; &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_alloc_stm2_lm9</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>t</span><span> </span><span>_</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz timeout (&#945; - 1)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz timeout 0&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm7</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1 t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">&#8249;lsize while loop&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_lsize_loopbody t p sz &#8801;
  IF &#180;i t &gt; 0 THEN
    (t &#9656; &#180;lsizes := &#180;lsizes(t := &#180;lsizes t @ [ALIGN4 (&#180;lsizes t ! (&#180;i t - 1) div 4)]))
  FI;;
  IF &#180;lsizes t ! &#180;i t &lt; sz THEN
    (t &#9656; &#180;alloc_lsize_r := &#180;alloc_lsize_r(t := True))
  ELSE
    (t &#9656; &#180;alloc_l := &#180;alloc_l(t := int (&#180;i t)));;
    IF &#172; level_empty (&#180;mem_pool_info p) (&#180;i t) THEN
      (t &#9656; &#180;free_l := &#180;free_l(t := int (&#180;i t)))
    FI;;
    (t &#9656; &#180;i := &#180;i(t := &#180;i t + 1))
  FI&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsize_loop_body_terminate</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (alloc_lsize_loopbody t p sz)
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, Mem_pool_alloc_rely t, Mem_pool_alloc_guar t,
        mp_alloc_lsizestm_loopinv t p sz tm (&#945; - 1) &#8746; mp_alloc_lsizestm_loopinv t p sz tm 0]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_2 t p sz tm &#945;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;i t &gt; 0 THEN
      (t &#9656; &#180;lsizes := &#180;lsizes(t := &#180;lsizes t @ [ALIGN4 (&#180;lsizes t ! (&#180;i t - 1) div 4)]))
    FI;; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6_1 t p sz tm &#945;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                          </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizeloop_inv_cond_eq_&#945;gt0</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm1_lm</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span> </span><span>&#945;</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;lsizes t ! &#180;i t &lt; sz THEN *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm2_lm</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizeloopbody_sat_invterm_imp_inv_post</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [pre, rely, guar,
           mp_alloc_lsizestm_loopinv t p sz tm (&#945; - 1) &#8746; mp_alloc_lsizestm_loopinv t p sz tm 0]
 &#10233;  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [pre, rely, guar,mp_alloc_precond1_6 t p sz tm]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Conseq</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pre&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pre&quot;</span></span></span><span>
</span><span>          </span><span>rely</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_lsizestm_loopinv t p sz tm (&#945; - 1) &#8746; mp_alloc_lsizestm_loopinv t p sz tm 0&quot;</span></span></span><span>
</span><span>          </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz tm&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Some P&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span class="delimiter">+</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizeloopbody_term_imp_prepost</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot; (&#8704;&#945;. &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; &gt; 0&#10628;, rely, guar,
        mp_alloc_lsizestm_loopinv t p sz tm (&#945; - 1) &#8746; mp_alloc_lsizestm_loopinv t p sz tm 0])
  &#10233; &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6 t p sz tm &#8745; mp_alloc_lsizestm_loopcond t p,
                rely, guar, mp_alloc_precond1_6 t p sz tm]&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;v. v&#8712;mp_alloc_precond1_6 t p sz tm &#8745; mp_alloc_lsizestm_loopcond t p &#10230;
      &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [{v}, rely, guar, mp_alloc_precond1_6 t p sz tm]&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some P sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6 t p sz tm &#8745; mp_alloc_lsizestm_loopcond t p,
                rely, guar, mp_alloc_precond1_6 t p sz tm]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>allpre_eq_pre</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz tm &#8745; mp_alloc_lsizestm_loopcond t p&quot;</span></span></span><span>
</span><span>                          </span><span class="string"><span class="delete"><span class="delete">&quot;Some P&quot;</span></span></span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz tm&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;&#945;. v &#8712; mp_alloc_lsizestm_loopinv t p sz tm &#945; &#8745; &#10627;&#945; &gt; 0&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizestm_pre_loopcond_imp_loopinv_&#945;gt0</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>erule</span><span> </span><span>exE</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>sat_pre_imp_allinpre</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Some P&quot;</span></span></span><span> </span><span>_</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz tm&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>      </span><span>lsizeloopbody_sat_invterm_imp_inv_post</span><span class="delimiter">[</span><span>of</span><span> </span><span>P</span><span> </span><span>_</span><span> </span><span>rely</span><span> </span><span>guar</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>tm</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsize_loop_body_satprepost</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (alloc_lsize_loopbody t p sz)
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6 t p sz timeout &#8745; mp_alloc_lsizestm_loopcond t p,
        Mem_pool_alloc_rely t, Mem_pool_alloc_guar t, mp_alloc_precond1_6 t p sz timeout]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizeloopbody_term_imp_prepost</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_lsize_loopbody t p sz&quot;</span></span></span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_rely t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Mem_pool_alloc_guar t&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>      </span><span>lsize_loop_body_terminate</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>sz</span><span> </span><span>p</span><span> </span><span>timeout</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsize_loop_stm</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (WHILE &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#172; &#180;alloc_lsize_r t DO
     alloc_lsize_loopbody t p sz
   OD) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_6 t p sz timeout, Mem_pool_alloc_rely t,
              Mem_pool_alloc_guar t, mp_alloc_precond1_7 t p sz timeout]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(rule Int_greatest) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsize_loop_body_satprepost</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>sz</span><span> </span><span>p</span><span> </span><span>timeout</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;stm3&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; n_levels mp &#10233;
    length (levels mp) = n_levels mp &#10233;
    free_list (levels mp ! ii) = [] &#10233;
    rmhead_free_list mp ii = mp&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_pool.surjective</span><span> </span><span>Mem_pool.update_convs</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span>
</span><span>      </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>list_update_id</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;head_free_list mp ii = NULL &#10233;
    ii &lt; n_levels mp &#10233;
    NULL &lt; buf mp &#10233;
    &#8704;i&lt;n_levels mp.
       &#8704;j&lt;length (free_list (levels mp ! i)).
          buf mp &#8804; free_list (levels mp ! i) ! j &#10233;
    length (levels mp) = n_levels mp &#10233;
    free_list (levels mp ! ii) &#8800; [] &#10233;
    False&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;hd (free_list (levels mp ! ii)) &#8800; NULL&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>hd_conv_nth</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm3</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond1_70_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
    (if level_empty (mem_pool_info Va p) (nat (free_l Va t)) then
       {V. V = Va&#10631;blk:=(blk Va)(t:=NULL)&#10632; &#8743; level_empty (mem_pool_info Va p) (nat (free_l Va t))}
     else
       {V. V = Va&#10631;blk:=(blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
        mem_pool_info := (mem_pool_info Va)(p:=rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
         &#8743; &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))}) &#8745;
    - &#10627;&#180;blk t &#8800; NULL&#10628;
    &#8838; &#10627;&#180;id &#8712; &#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1 t p sz timeout&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8805; 0 &#8743; nat (free_l Va t) &lt; n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (levels (mem_pool_info Va p)).
        &#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! i)).
            buf (mem_pool_info Va p) &#8804; (free_list (levels (mem_pool_info Va p) ! i)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_leI</span><span> </span><span>lessI</span><span> </span><span>not_le</span><span> </span><span>trans_le_add1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p)) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))).
          buf (mem_pool_info Va p) &#8804; free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8800; i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8805; 0 &#8743; nat (free_l Va t) &lt; n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (levels (mem_pool_info Va p)).
        &#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! i)).
            buf (mem_pool_info Va p) &#8804; (free_list (levels (mem_pool_info Va p) ! i)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_leI</span><span> </span><span>lessI</span><span> </span><span>not_less</span><span> </span><span>trans_le_add1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p)) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))).
          buf (mem_pool_info Va p) &#8804; free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8800; i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8805; 0 &#8743; nat (free_l Va t) &lt; n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (levels (mem_pool_info Va p)).
        &#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! i)).
            buf (mem_pool_info Va p) &#8804; (free_list (levels (mem_pool_info Va p) ! i)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_leI</span><span> </span><span>lessI</span><span> </span><span>not_less</span><span> </span><span>trans_le_add1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p)) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))).
          buf (mem_pool_info Va p) &#8804; free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8800; i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8805; 0 &#8743; nat (free_l Va t) &lt; n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (levels (mem_pool_info Va p)).
        &#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! i)).
            buf (mem_pool_info Va p) &#8804; (free_list (levels (mem_pool_info Va p) ! i)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_leI</span><span> </span><span>lessI</span><span> </span><span>not_less</span><span> </span><span>trans_le_add1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p)) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))).
          buf (mem_pool_info Va p) &#8804; free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! j&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>UnI1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &#8800; i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t))) = []&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) = mem_pool_info Va p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va,Va&#10631;blk := (blk Va)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
lemma mp_alloc_stm3_lm2_1:
  &quot;ii &lt; length (levels mp) &#10233;
    length (bits (levels mp ! ii)) =
    length (bits (levels mp [ii := (levels mp [ii := (levels mp ! ii) &#10631;free_list := fl&#10632;] ! ii)
                     &#10631;bits := bits (levels mp [ii := (levels mp ! ii) &#10631;free_list := fl&#10632;] ! ii)
                        [jj := ALLOCATING]&#10632;] ! ii))&quot;
by simp*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels mp ! ii)) =
    length (bits ((levels mp) [ii := ((levels mp) [ii := (levels mp ! ii) &#10631;free_list := fl&#10632;] ! ii)
                     &#10631;bits := (bits ((levels mp) [ii := (levels mp ! ii) &#10631;free_list := fl&#10632;] ! ii))
                        [jj := ALLOCATING]&#10632;] ! ii))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels mp)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*
lemma mp_alloc_stm3_lm2_2:
  &quot;ii &lt; length (levels mp) &#10233;
    length (bits (levels mp ! ii)) =
    length (bits (levels mp [ii := (levels mp ! ii) &#10631;free_list := fl, bits := bits (levels mp ! ii) [jj := ALLOCATING]&#10632;] ! ii))&quot;
by simp*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels mp ! ii)) =
    length (bits ((levels mp) [ii := (levels mp ! ii) &#10631;free_list := fl, bits := (bits (levels mp ! ii)) [jj := ALLOCATING]&#10632;] ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels mp)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_meminfo</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;pa &#8800; p &#10233;
    set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
              (nat (free_l Va t))
              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
              pa = (mem_pool_info Va) pa&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;buf (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                 (nat (free_l Va t))
                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                 p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                 (nat (free_l Va t))
                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                 p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_minf_nmax</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                 (nat (free_l Va t))
                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                 p) = n_max (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_minf_nlvls</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                 (nat (free_l Va t))
                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                 p) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_len_lvls</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
         (nat (free_l Va t))
         (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
           (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
         p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_len_bits</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (set_bit_allocating
             ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
             (nat (free_l Va t))
             (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
               (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
             p) !
    ii)) = length (bits ((levels (mem_pool_info Va p))!ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Mem_pool_lvl.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span> </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>      </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>list_update_beyond</span><span> </span><span>list_updt_samelen</span><span> </span><span>not_less</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_frlst_otherlvl</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;ii &#8800; nat (free_l Va t) &#10233;
  free_list (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                          (nat (free_l Va t))
                          (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                            (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                            (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                          p) ! ii) = free_list (levels (mem_pool_info Va p) ! ii)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_body_frlst_samelvl</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p)) &#10233; ii = nat (free_l Va t) &#10233;
  free_list (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                          (nat (free_l Va t))
                          (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                            (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                            (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                          p) ! ii) = tl (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_1_1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(jj::nat) &#8800; (a - b) div c &#10233;
    (a - b) mod c = 0 &#10233;
    c &#8800; 0 &#10233;
    b + jj * c &#8800; a&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_1_2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&gt;0. (a::nat) = 4 * n * 4 ^ b &#10233;
    ii &lt; b &#10233; 0 &lt; a div 4 ^ ii&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>div_eq_0_iff</span><span> </span><span>divisors_zero</span><span> </span><span>less_imp_le_nat</span><span> </span><span>m_mod_div</span><span> </span><span>mod_if</span><span> </span><span>not_gr0</span><span> </span><span>pow_mod_0</span><span> </span><span>power_not_zero</span><span> </span><span>zero_neq_numeral</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) ii &#10233; p &#8712; mem_pools Va &#10233;
  inv_mempool_info Va &#10233;
   &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
   &#8704;p&#8712;mem_pools Va.
      &#8704;i&lt;length (levels (mem_pool_info Va p)).
         (&#8704;j&lt;length (bits (levels (mem_pool_info Va p) ! i)).
             (get_bit_s Va p i j = FREE) =
             (buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ i)
              &#8712; set (free_list (levels (mem_pool_info Va p) ! i)))) &#8743;
         (&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! i)).
             &#8707;n&lt;n_max (mem_pool_info Va p) * 4 ^ i.
                free_list (levels (mem_pool_info Va p) ! i) ! j =
                buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ i)) &#8743;
         distinct (free_list (levels (mem_pool_info Va p) ! i)) &#10233;
   length (lsizes Va t) &#8804; length (levels (mem_pool_info Va p)) &#10233;
   ii &lt; length (lsizes Va t) &#10233;
   length (bits (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) ii)) p ii
                          ((head_free_list (mem_pool_info Va p) ii - buf (rmhead_free_list (mem_pool_info Va p) ii)) div
                           lsizes Va t ! ii)
                          p) !
                 ii)) =
   length (bits (levels (mem_pool_info Va p) ! ii)) &#10233;
   jj &lt; length (bits (levels (set_bit_allocating
                               (&#955;a. if a = p then rmhead_free_list (mem_pool_info Va p) ii else mem_pool_info Va a) p ii
                               ((head_free_list (mem_pool_info Va p) ii - buf (rmhead_free_list (mem_pool_info Va p) ii)) div
                                lsizes Va t ! ii)
                               p) !
                      ii)) &#10233;
   nat (free_l Va t) = ii &#10233;
   jj &#8800; (head_free_list (mem_pool_info Va p) ii - buf (rmhead_free_list (mem_pool_info Va p) ii)) div lsizes Va t ! ii &#10233;
   buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii) &#8800; head_free_list (mem_pool_info Va p) ii&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (rmhead_free_list (mem_pool_info Va p) ii) = buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p)) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_mempool_info_maxsz_align4</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(head_free_list (mem_pool_info Va p) ii - buf (rmhead_free_list (mem_pool_info Va p) ii)) mod lsizes Va t ! ii = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>head_free_list_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n. hd (free_list (levels (mem_pool_info Va p) ! ii)) =
                  buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! ii)).
            (&#8707;n&lt;n_max (mem_pool_info Va p) * 4 ^ ii. free_list (levels (mem_pool_info Va p) ! ii) ! j =
                 buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>linorder_not_less</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>full_types</span><span class="delimiter">,</span><span> </span><span>hide_lams</span><span class="delimiter">)</span><span> </span><span>hd_conv_nth</span><span> </span><span>length_greater_0_conv</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>hide_lams</span><span class="delimiter">)</span><span> </span><span>add_diff_cancel_left&#39;</span><span> </span><span>mod_mult_self2_is_0</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! ii &#8800; 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&gt;0. max_sz (mem_pool_info Va p) = 4 * n * 4 ^ n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p)) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_1_2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span>ii</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>add_lessD1</span><span> </span><span>le_eq_less_or_eq</span><span> </span><span>less_imp_add_positive</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_1_1</span><span class="delimiter">[</span><span>of</span><span> </span><span>jj</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;head_free_list (mem_pool_info Va p) ii&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (rmhead_free_list (mem_pool_info Va p) ii)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! ii&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(a::nat) + jj * b &#8800; c &#10233; &#8707;n. a + n * b = c &#10233;
       (c - a) div b &#8800; jj&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_thd_waitq</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_thd_waitq Va &#10233;
inv_thd_waitq
 (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
       mem_pool_info :=
         set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
          (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
            (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
       allocating_node := allocating_node Va(t &#8614;
         &#10631;pool = p, level = nat (free_l Va t),
            block = block_num
                     (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                       p)
                     (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
            data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span>
</span><span>                          </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span>
</span><span>                          </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span>
</span><span>                          </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span>
</span><span>           </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (pool n = p &#8743; level n = nat (free_l Va t) &#8743; block n =
          block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
           (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
           (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))) &#10233;
        get_bit_s (Va&#10631;mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;)
             (pool n) (level n) (block n) = get_bit_s Va (pool n) (level n) (block n)&quot;</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(unfold set_bit_allocating_def set_bit_def)*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
     (Va&#10631;mem_pool_info :=
           set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
            (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;)
     (pool n) (level n) (block n)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
     (Va&#10631;mem_pool_info :=
           set_bit_allocating (mem_pool_info Va) p (nat (free_l Va t))
            (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;)
     (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Mem_pool_lvl.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span>
</span><span>          </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>linorder_not_less</span><span> </span><span>list_update_beyond</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Mem_pool_lvl.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span>
</span><span>          </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>linorder_not_less</span><span> </span><span>list_update_beyond</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars_2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va &#10233;
    &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
    p &#8712; mem_pools Va &#10233;
      pool n = p &#8743;
       level n = nat (free_l Va t) &#8743;
       block n =
       block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) &#10233;
  get_bit_s (Va&#10631;mem_pool_info :=
              set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
               (nat (free_l Va t))
               (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
                 (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t)))&#10632;)
        (pool n) (level n) (block n) =
       get_bit
        (set_bit_allocating (mem_pool_info Va) p (nat (free_l Va t))
          (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
            (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))))
        p (nat (free_l Va t))
        (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
          (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;p&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;pool n&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;level n&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va (pool n)) (free_list (levels (mem_pool_info Va (pool n)) ! level n) ! NULL)
       (max_sz (mem_pool_info Va (pool n)) div 4 ^ level n))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block n&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
     (Va&#10631;mem_pool_info :=
           set_bit_allocating ((mem_pool_info Va)(pool n := rmhead_free_list (mem_pool_info Va (pool n)) (level n))) (pool n) (level n)
            (block n)&#10632;)
     (pool n) (level n) (block n)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (set_bit_allocating ((mem_pool_info Va)(pool n := rmhead_free_list (mem_pool_info Va (pool n)) (level n))) (pool n) (level n)
            (block n)) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8805; length (levels (mem_pool_info Va (pool n)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
    allocating_node Va t = None &#10233;
    freeing_node Va t = None &#10233;
    inv_cur Va &#8743; inv_thd_waitq Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va &#8743; inv_bitmap Va &#8743; inv_aux_vars Va &#10233;
    p &#8712; mem_pools Va &#10233;
    ETIMEOUT &#8804; timeout &#10233;
    timeout = ETIMEOUT &#10230; tmout Va t = ETIMEOUT &#10233;
    &#172; rf Va t &#10233;
    &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
    length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
    alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
    free_l Va t &#8804; alloc_l Va t &#10233;
    &#172; free_l Va t &lt; OK &#10233;
    alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
    alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &#10233;
    length (lsizes Va t) &#8804; length (levels (mem_pool_info Va p)) &#10233;
    nat (free_l Va t) &lt; length (lsizes Va t) &#10233;
    inv_aux_vars
     (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
           mem_pool_info :=
             set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
           allocating_node := allocating_node Va(t &#8614;
             &#10631;pool = p, level = nat (free_l Va t),
                block = block_num
                         (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                           (nat (free_l Va t))
                           (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                           p)
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>inv_aux_vars_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (&#8704;t n. freeing_node s t = Some n &#10230; get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node
           (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                 mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                 allocating_node := allocating_node Va(t &#8614;
                   &#10631;pool = p, level = nat (free_l Va t),
                      block = block_num
                               (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                 p (nat (free_l Va t))
                                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                 p)
                               (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                               (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                      data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;) = freeing_node Va&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n) (level n) (block n) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(pool n) = p &#8743; (level n) = nat (free_l Va t)
        &#8743; (block n) = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p (nat (free_l Va t)) (block_num (mem_pool_info Va p)
                             ((free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t)))) ! 0)
                             (max_sz (mem_pool_info Va p) div 4 ^ (nat (free_l Va t)))) = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_fl_FREE</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
           (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
           (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
             (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>block_num_def</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: &#172; ((pool n) = p &#8743; (level n) = nat (free_l Va t)
        &#8743; (block n) = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
           (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                 mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                 allocating_node := allocating_node Va(t &#8614;
                   &#10631;pool = p, level = nat (free_l Va t),
                      block = block_num
                               (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                 p (nat (free_l Va t))
                                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                 p)
                               (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                               (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                      data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)
           (pool n) (level n) (block n) = get_bit_s Va (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
           (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                 mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                 allocating_node := allocating_node Va(t &#8614;
                   &#10631;pool = p, level = nat (free_l Va t),
                      block = block_num
                               (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                 p (nat (free_l Va t))
                                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                 p)
                               (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                               (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                      data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;) (pool n) (level n) (block n)
             = get_bit_s (Va&#10631; mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>frule</span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars_1</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (&#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING &#8743; mem_block_addr_valid s n &#10230; (&#8707;t. freeing_node s t = Some n)) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
           (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                 mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                 allocating_node := allocating_node Va(t &#8614;
                   &#10631;pool = p, level = nat (free_l Va t),
                      block = block_num
                               (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                 p (nat (free_l Va t))
                                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                 p)
                               (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                               (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                      data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;) (pool n) (level n) (block n)
             = get_bit_s (Va&#10631; mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(pool n) = p &#8743; (level n) = nat (free_l Va t)
        &#8743; (block n) = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (Va&#10631; mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (set_bit_allocating (mem_pool_info Va) p (nat (free_l Va t))
                                 (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
                                   (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))))
                         p (nat (free_l Va t))
                         (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
                           (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>set_bit_get_bit_eq</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va&quot;</span></span></span><span> </span><span>p</span><span>
</span><span>                      </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
       (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;set_bit_allocating (mem_pool_info Va) p (nat (free_l Va t))
       (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
         (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_fl_bnum_in</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>meson</span><span> </span><span>le_trans</span><span> </span><span>length_greater_0_conv</span><span> </span><span>linorder_not_less</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (Va&#10631; mem_pool_info :=
                   set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                    (nat (free_l Va t))
                    (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n)
             = get_bit (set_bit_allocating (mem_pool_info Va) p (nat (free_l Va t))
                                 (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
                                   (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))))
                         p (nat (free_l Va t))
                         (block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
                           (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
                           (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars_2</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span>t</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: &#172; ((pool n) = p &#8743; (level n) = nat (free_l Va t)
        &#8743; (block n) = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))))*)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool n) (level n) (block n) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
          (Va&#10631;mem_pool_info :=
                set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                 (nat (free_l Va t))
                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;)
          (pool n) (level n) (block n) = get_bit (mem_pool_info Va) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars_1</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>p</span><span> </span><span>Va</span><span> </span><span>t</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid Va n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm3_body_meminfo</span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;t. freeing_node Va t = Some n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ta. freeing_node Va ta = freeing_node
               (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                     mem_pool_info :=
                       set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                        (nat (free_l Va t))
                        (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                          (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                          (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                     allocating_node := allocating_node Va(t &#8614;
                       &#10631;pool = p, level = nat (free_l Va t),
                          block = block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                          data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;) ta&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t n. allocating_node s t = Some n &#10230; get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
             (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                   mem_pool_info :=
                     set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                      (nat (free_l Va t))
                      (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                        (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                   allocating_node := allocating_node Va(t &#8614;
                     &#10631;pool = p, level = nat (free_l Va t),
                        block = block_num
                                 (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                   p (nat (free_l Va t))
                                   (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                     (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                     (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                   p)
                                 (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                 (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                        data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)
             (pool n) (level n) (block n)
         = get_bit_s (Va&#10631; mem_pool_info :=
               set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                (nat (free_l Va t))
                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (Va&#10631; mem_pool_info :=
               set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                (nat (free_l Va t))
                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n)
                = get_bit_s (Va&#10631; mem_pool_info := set_bit_allocating (mem_pool_info Va) p
                (nat (free_l Va t))
                (block_num (mem_pool_info Va p)
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Mem_pool_lvl.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span>
</span><span>                </span><span>linorder_not_less</span><span> </span><span>list_update_beyond</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (Va&#10631; mem_pool_info := set_bit_allocating (mem_pool_info Va) p
                (nat (free_l Va t))
                (block_num (mem_pool_info Va p)
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;) (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t = ta&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: t = ta *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(pool n) = p &#8743; (level n) = nat (free_l Va t)
        &#8743; (block n) = block_num (mem_pool_info Va p)
                                 (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                 (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block n) = block_num (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                       p (nat (free_l Va t))
                                       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                       p)
                                     (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                     (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                       p (nat (free_l Va t))
                                       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                       p)
                                     (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                     (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))
                        = block_num (mem_pool_info Va p)
                                     (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                     (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>block_num_def</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                               (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))
                              &lt; length (bits (levels (mem_pool_info Va p) ! nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>frule</span><span> </span><span>inv_bitmap_freelist_fl_bnum_in</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>hd_conv_nth</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_get_bit_eq2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span> </span><span>ALLOCATING</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: &#172; (t = ta) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node
             (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                   mem_pool_info :=
                     set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                      (nat (free_l Va t))
                      (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                        (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                   allocating_node := allocating_node Va(t &#8614;
                     &#10631;pool = p, level = nat (free_l Va t),
                        block = block_num
                                 (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                                   p (nat (free_l Va t))
                                   (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                     (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                     (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                   p)
                                 (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                 (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                        data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)
             ta = allocating_node Va ta&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
                             ((free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t)))) ! 0)
                             (max_sz (mem_pool_info Va p) div 4 ^ (nat (free_l Va t)))
                        = block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                        (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(pool n) = p &#8743; (level n) = nat (free_l Va t)
                          &#8743; (block n) = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                        (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p (nat (free_l Va t)) (block_num (mem_pool_info Va p)
                             ((free_list ((levels (mem_pool_info Va p)) ! (nat (free_l Va t)))) ! 0)
                             (max_sz (mem_pool_info Va p) div 4 ^ (nat (free_l Va t)))) = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_fl_FREE</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (Va&#10631;mem_pool_info :=
         set_bit_allocating (mem_pool_info Va) p (nat (free_l Va t))
          (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
            (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;)
            (pool n) (level n) (block n) = get_bit_s Va (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>set_bit_get_bit_neq2</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>nat_less_iff</span><span> </span><span>nth_equalityI</span><span> </span><span>set_bit_get_bit_eq</span><span> </span><span>set_bit_get_bit_neq</span><span> </span><span>set_bit_prev_len</span><span> </span><span>zle_int</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING &#8743; mem_block_addr_valid s n &#10230; (&#8707;t. allocating_node s t = Some n) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(pool n) = p &#8743; (level n) = nat (free_l Va t)
                &#8743; (block n) = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node
               (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                     mem_pool_info :=
                       set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                        (nat (free_l Va t))
                        (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                          (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                          (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                     allocating_node := allocating_node Va(t &#8614;
                       &#10631;pool = p, level = nat (free_l Va t),
                          block = block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                          data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;) t =
              Some n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node
               (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                     mem_pool_info :=
                       set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                        (nat (free_l Va t))
                        (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                          (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                          (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
                     allocating_node := allocating_node Va(t &#8614;
                       &#10631;pool = p, level = nat (free_l Va t),
                          block = block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                          data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;) t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Some &#10631;pool = p, level = nat (free_l Va t),
                          block = block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                          data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span>
</span><span>                              </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; buf (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
               (nat (free_l Va t))
               (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                 (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                 (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
               p) +
         block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
          (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) *
         (max_sz (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                   (nat (free_l Va t))
                   (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                     (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                     (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                   p) div
          4 ^ nat (free_l Va t)) = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
               (nat (free_l Va t))
               (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                 (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                 (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
               p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span>
</span><span>            </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                   (nat (free_l Va t))
                   (block_num (mem_pool_info Va p) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                     (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                   p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>ref_byblkn_self</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;head_free_list (mem_pool_info Va p) (nat (free_l Va t))&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_buf_le_fl</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>hd_conv_nth</span><span> </span><span>length_greater_0_conv</span><span> </span><span>nat_less_iff</span><span> </span><span>zle_int</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_fl_mod_sz0</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>hd_conv_nth</span><span> </span><span>le_eq_less_or_eq</span><span> </span><span>le_trans</span><span> </span><span>length_greater_0_conv</span><span> </span><span>nat_eq_iff</span><span> </span><span>nat_less_iff</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case &quot;&#172; (pool n) = p &#8743; (level n) = nat (free_l Va t)
                &#8743; (block n) = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s
          (Va&#10631;mem_pool_info :=
                set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                 (nat (free_l Va t))
                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;)
          (pool n) (level n) (block n) = get_bit (mem_pool_info Va) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars_1</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>p</span><span> </span><span>Va</span><span> </span><span>t</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;ta. ta &#8800; t &#8743; allocating_node Va ta = Some n&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid Va n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm3_body_meminfo</span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. t1 &#8800; t2 &#8743; freeing_node s t1 = Some n1 &#8743; freeing_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;t. freeing_node
        (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
              mem_pool_info :=
                set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                 (nat (free_l Va t))
                 (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
              allocating_node := allocating_node Va(t &#8614;
                &#10631;pool = p, level = nat (free_l Va t),
                   block = block_num
                            (set_bit_allocating
                              ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                              (nat (free_l Va t))
                              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                              p)
                            (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                            (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                   data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)
        t = freeing_node Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. t1 &#8800; t2 &#8743; allocating_node s t1 = Some n1 &#8743; allocating_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t = t1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n1) (level n1) (block n1) = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n1 = p &#8743; level n1 = nat (free_l Va t) &#8743; block n1 = block_num
                              (set_bit_allocating
                                ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                (nat (free_l Va t))
                                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                p)
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))) =
                        block_num (mem_pool_info Va p)
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_fl_FREE</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span> </span><span>le_trans</span><span> </span><span>length_greater_0_conv</span><span> </span><span>linorder_not_less</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n2) (level n2) (block n2) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t = t2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n2) (level n2) (block n2) = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n2 = p &#8743; level n2 = nat (free_l Va t) &#8743; block n2 = block_num
                              (set_bit_allocating
                                ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                (nat (free_l Va t))
                                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                p)
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))) =
                        block_num (mem_pool_info Va p)
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>level_empty_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_fl_FREE</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span> </span><span>le_trans</span><span> </span><span>length_greater_0_conv</span><span> </span><span>linorder_not_less</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n1) (level n1) (block n1) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: t &#8800; t1 &#8743; t &#8800; t2 *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t2 = Some n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. allocating_node s t1 = Some n1 &#8743; freeing_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t = t1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n1) (level n1) (block n1) = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n1 = p &#8743; level n1 = nat (free_l Va t) &#8743; block n1 = block_num
                              (set_bit_allocating
                                ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                (nat (free_l Va t))
                                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                p)
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num
                                   (set_bit_allocating
                                     ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                                     (nat (free_l Va t))
                                     (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                       (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                                     p)
                                   (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                   (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                          ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))) =
                        block_num (mem_pool_info Va p)
                              (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                              ((ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_fl_FREE</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span> </span><span>le_trans</span><span> </span><span>length_greater_0_conv</span><span> </span><span>linorder_not_less</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n2) (level n2) (block n2) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t2 = Some n2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va &#8743; inv_bitmap0 Va &#10233;
    p &#8712; mem_pools Va &#10233;
    inv_bitmap0
     (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
           mem_pool_info :=
             set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
           allocating_node := allocating_node Va(t &#8614;
             &#10631;pool = p, level = nat (free_l Va t),
                block = block_num
                         (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                           (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                           p)
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap0
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
             (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))
                &#10631;levels := (levels (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                   [nat (free_l Va t) :=
                      (levels (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) ! nat (free_l Va t))
                      &#10631;bits := (bits (levels (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) !
                                     nat (free_l Va t)))
                         [block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) :=
                            ALLOCATING]&#10632;]&#10632;)&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p)) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (bits (levels (mem_pool_info Va p) ! 0)).
                      (bits (levels (mem_pool_info Va p) ! 0)) ! i &#8800; NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap0_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = (head_free_list (mem_pool_info Va p) NULL - buf (mem_pool_info Va p)) div
                      ALIGN4 (max_sz (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va p))
               [NULL := ((levels (mem_pool_info Va p))
                         [NULL := (levels (mem_pool_info Va p) ! NULL)
                            &#10631;free_list := tl (free_list (levels (mem_pool_info Va p) ! NULL))&#10632;] !
                         NULL)
                  &#10631;bits := (bits ((levels (mem_pool_info Va p))
                                 [NULL := (levels (mem_pool_info Va p) ! NULL)
                                    &#10631;free_list := tl (free_list (levels (mem_pool_info Va p) ! NULL))&#10632;] !
                                 NULL))
                     [(head_free_list (mem_pool_info Va p) NULL - buf (mem_pool_info Va p)) div
                      ALIGN4 (max_sz (mem_pool_info Va p)) :=
                        ALLOCATING]&#10632;] ! NULL) ! i = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! 0))
                        [(head_free_list (mem_pool_info Va p) NULL - buf (mem_pool_info Va p)) div
                      ALIGN4 (max_sz (mem_pool_info Va p)) := ALLOCATING]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* i &#8800; (head_free_list (mem_pool_info Va p) NULL - buf (mem_pool_info Va p)) div
                      ALIGN4 (max_sz (mem_pool_info Va p)) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! NULL))
         [(head_free_list (mem_pool_info Va p) NULL - buf (mem_pool_info Va p)) div
          ALIGN4 (max_sz (mem_pool_info Va p)) := ALLOCATING] ! i &#8800; NOEXIST&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* nat (free_l Va t) &#8800; 0 *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmapn</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va &#8743; inv_bitmapn Va &#10233;
  p &#8712; mem_pools Va &#10233;
  inv_bitmapn
   (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
         mem_pool_info :=
           set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
            (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
         allocating_node := allocating_node Va(t &#8614;
           &#10631;pool = p, level = nat (free_l Va t),
              block = block_num
                       (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                         (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                         p)
                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
              data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmapn
     (Va&#10631;mem_pool_info := (mem_pool_info Va)
             (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))
                &#10631;levels := (levels (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))))
                   [nat (free_l Va t) :=
                      (levels (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) ! nat (free_l Va t))
                      &#10631;bits := (bits (levels (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) !
                                     nat (free_l Va t)))
                         [block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) :=
                            ALLOCATING]&#10632;]&#10632;)&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p)) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i&lt;length (bits (levels (mem_pool_info Va p) ! (length (levels (mem_pool_info Va p)) - Suc 0))).
                      (bits (levels (mem_pool_info Va p) ! (length (levels (mem_pool_info Va p)) - Suc 0))) ! i &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmapn_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = length (levels (mem_pool_info Va p)) - Suc 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = (head_free_list (mem_pool_info Va p) (length (levels (mem_pool_info Va p)) - Suc NULL) -
           buf (mem_pool_info Va p)) div
          (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ (length (levels (mem_pool_info Va p)) - Suc NULL))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! (length (levels (mem_pool_info Va p)) - Suc NULL)))
         [(head_free_list (mem_pool_info Va p) (length (levels (mem_pool_info Va p)) - Suc NULL) -
           buf (mem_pool_info Va p)) div
          (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ (length (levels (mem_pool_info Va p)) - Suc NULL)) :=
            ALLOCATING] ! i &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! 0))
                        [(head_free_list (mem_pool_info Va p) NULL - buf (mem_pool_info Va p)) div
                      ALIGN4 (max_sz (mem_pool_info Va p)) := ALLOCATING]&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* i &#8800; (head_free_list (mem_pool_info Va p) (length (levels (mem_pool_info Va p)) - Suc NULL) -
           buf (mem_pool_info Va p)) div
          (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ (length (levels (mem_pool_info Va p)) - Suc NULL)) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! NULL))
         [(head_free_list (mem_pool_info Va p) NULL - buf (mem_pool_info Va p)) div
          ALIGN4 (max_sz (mem_pool_info Va p)) := ALLOCATING] ! i &#8800; DIVIDED&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* nat (free_l Va t) = length (levels (mem_pool_info Va p)) - Suc 0 *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap_not4free</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va &#8743; inv_bitmap_not4free Va &#10233;
    p &#8712; mem_pools Va &#10233;
   inv_bitmap_not4free
     (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
           mem_pool_info :=
             set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
           allocating_node := allocating_node Va(t &#8614;
             &#10631;pool = p, level = nat (free_l Va t),
                block = block_num
                         (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                           (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                           p)
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_not4free (Va&#10631;mem_pool_info :=
             set_bit_allocating ((mem_pool_info Va)(p :=
                rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>Let_def</span><span> </span><span>partner_bits_def</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>Let_def</span><span> </span><span>partner_bits_def</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = i&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits ((levels (mem_pool_info Va p))
                 [nat (free_l Va t) :=
                    ((levels (mem_pool_info Va p))
                     [nat (free_l Va t) := (levels (mem_pool_info Va p) ! nat (free_l Va t))
                        &#10631;free_list := tl (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)))&#10632;] !
                     nat (free_l Va t))
                    &#10631;bits := (bits ((levels (mem_pool_info Va p))
                                   [nat (free_l Va t) := (levels (mem_pool_info Va p) ! nat (free_l Va t))
                                      &#10631;free_list := tl (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)))&#10632;] !
                                   nat (free_l Va t)))
                       [(head_free_list (mem_pool_info Va p) (nat (free_l Va t)) - buf (mem_pool_info Va p)) div
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) :=
                          ALLOCATING]&#10632;] !
                 i) = (bits (levels (mem_pool_info Va p) ! i)) [(head_free_list (mem_pool_info Va p) (nat (free_l Va t)) - buf (mem_pool_info Va p)) div
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) :=
                          ALLOCATING]&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(head_free_list (mem_pool_info Va p) (nat (free_l Va t)) - buf (mem_pool_info Va p)) div
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = j div 4 * 4&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(head_free_list (mem_pool_info Va p) (nat (free_l Va t)) - buf (mem_pool_info Va p)) div
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = Suc (j div 4 * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc (j div 4 * 4) &lt; length (bits (levels (mem_pool_info Va p) ! i))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>list_update_beyond</span><span> </span><span>not_less</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(head_free_list (mem_pool_info Va p) (nat (free_l Va t)) - buf (mem_pool_info Va p)) div
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = j div 4 * 4 + 2&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j div 4 * 4 + 2 &lt; length (bits (levels (mem_pool_info Va p) ! i))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>list_update_beyond</span><span> </span><span>not_less</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(head_free_list (mem_pool_info Va p) (nat (free_l Va t)) - buf (mem_pool_info Va p)) div
                        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) = j div 4 * 4 + 3&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j div 4 * 4 + 3 &lt; length (bits (levels (mem_pool_info Va p) ! i))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>list_update_beyond</span><span> </span><span>not_less</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_mempool_info</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va &#8743;
  p &#8712; mem_pools Va &#10233;
  &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
  length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
  &#172; free_l Va t &lt; OK &#10233;
  nat (free_l Va t) &lt; length (lsizes Va t) &#10233;
  inv_mempool_info
   (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
         mem_pool_info :=
           set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
            (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
         allocating_node := allocating_node Va(t &#8614;
           &#10631;pool = p, level = nat (free_l Va t),
              block = block_num
                       (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                         (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                         p)
                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
              data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span>
</span><span>           </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply clarify *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = i&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info Va p) ! (nat (free_l Va t))))
                          = n_max (mem_pool_info Va p) * 4 ^ (nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_2</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>ii</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>mp</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>fl</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;tl (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>jj</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))) - buf (mem_pool_info Va p)) div
                        lsizes Va t ! nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap_freelist</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
    inv_bitmap_freelist Va &#8743; inv_mempool_info Va &#10233;
    p &#8712; mem_pools Va &#10233;
    &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
    length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
    alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
    free_l Va t &#8804; alloc_l Va t &#10233;
    &#172; free_l Va t &lt; OK &#10233;
    length (lsizes Va t) &#8804; length (levels (mem_pool_info Va p)) &#10233;
    nat (free_l Va t) &lt; length (lsizes Va t) &#10233;
    inv_bitmap_freelist
     (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
           mem_pool_info :=
             set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
           allocating_node := allocating_node Va(t &#8614;
             &#10631;pool = p, level = nat (free_l Va t),
                block = block_num
                         (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                           (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                           p)
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pa &#8800; p&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_meminfo</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                         (nat (free_l Va t))
                         (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                         p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_len_lvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                (nat (free_l Va t))
                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                (nat (free_l Va t))
                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_minf_nmax</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                (nat (free_l Va t))
                (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span>pa</span><span> </span><span>ii</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (set_bit_allocating
                               ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                               (nat (free_l Va t))
                               (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                 (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                               p) ! ii))=length (bits ((levels (mem_pool_info Va p))!ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_len_bits</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (&#8704;j &lt; length bts. bts ! j = FREE &#10231; buf mp + j * (max_sz mp div (4 ^ i)) &#8712; set fl)  *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>iffI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span>pa</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* bts ! j = FREE &#10233;  buf mp + j * (max_sz mp div (4 ^ i)) &#8712; set fl) *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: nat (free_l Va t) = ii *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: jj = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))*)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                        (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                          (lsizes Va t ! nat (free_l Va t))))
                      p ii jj = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>17</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: jj &#8800; (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                      (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))*)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) p ii jj = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                            &#8712; set (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm3_body_len_lvls</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                      &#8800; head_free_list (mem_pool_info Va p) (nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_num_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>list_nhd_in_tl_set</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: nat (free_l Va t) &#8800; ii *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) p ii jj = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                          &#8712; set (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm3_body_len_lvls</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* buf mp + j * (max_sz mp div (4 ^ i)) &#8712; set fl) &#10233; bts ! j = FREE *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span>pa</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                         (nat (free_l Va t))
                         (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                         p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_len_lvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: nat (free_l Va t) = ii *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                              &#8712; set (tl (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span> </span><span>mp_alloc_stm3_body_frlst_samelvl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                              &#8712; set (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>metis</span><span> </span><span>list.set_sel</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>tl_Nil</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) p ii jj = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)) &#8800; jj&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                          &#8800; head_free_list (mem_pool_info Va p) (nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>dist_hd_nin_tl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>mono_tags</span><span class="delimiter">,</span><span> </span><span>hide_lams</span><span class="delimiter">)</span><span> </span><span>le_eq_less_or_eq</span><span> </span><span>le_trans</span><span> </span><span>linorder_not_less</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (rmhead_free_list (mem_pool_info Va p) ii) = buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n. head_free_list (mem_pool_info Va p) ii =
                    buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ ii)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>head_free_list_def</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add_lessD1</span><span> </span><span>hd_conv_nth</span><span> </span><span>le_eq_less_or_eq</span><span> </span><span>length_greater_0_conv</span><span> </span><span>less_imp_add_positive</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: nat (free_l Va t) &#8800; ii *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + jj * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                          &#8712; set (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm3_body_frlst_otherlvl</span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) p ii jj = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;j &lt; length fl. (&#8707;n. fl ! j = buf mp + n * (max_sz mp div (4 ^ i)))
                            &#8743; fl ! j &lt; buf mp + n_max mp * max_sz mp *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span>pa</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                         (nat (free_l Va t))
                         (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                         p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_len_lvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: nat (free_l Va t) = ii *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(free_list
             (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                       (nat (free_l Va t))
                       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                       p) ! ii)) = (tl (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;tl (free_list (levels (mem_pool_info Va p) ! ii)) ! jj = (free_list (levels (mem_pool_info Va p) ! ii)) ! Suc jj&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>List.nth_tl</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (tl (free_list (levels (mem_pool_info Va p) ! ii))) = length (free_list
             (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                       (nat (free_l Va t))
                       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                       p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#8707;n. n &lt; n_max (mem_pool_info Va p) * (4 ^ ii) &#8743; (free_list (levels (mem_pool_info Va p) ! ii)) ! Suc jj =
                buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span> </span><span>mp_alloc_stm3_body_minf_nmax</span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Suc jj &lt; length (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (tl (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* case: nat (free_l Va t) &#8800; ii *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_minf_buf</span><span> </span><span>mp_alloc_stm3_body_minf_maxsz</span><span> </span><span>mp_alloc_stm3_body_minf_nmax</span><span>
</span><span>         </span><span>mp_alloc_stm3_body_frlst_otherlvl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* distinct fl *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(free_list
             (levels (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                       (nat (free_l Va t))
                       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                       p) ! ii)) = (tl (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span> </span><span>set_bit_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>distinct_tl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm3_body_len_lvls</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_body_frlst_otherlvl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
  inv_mempool_info Va &#8743; inv_bitmap_freelist Va &#8743; inv_bitmap Va &#10233;
  p &#8712; mem_pools Va &#10233;
  length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
  alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
  free_l Va t &#8804; alloc_l Va t &#10233;
  &#172; free_l Va t &lt; OK &#10233;
  length (lsizes Va t) &#8804; length (levels (mem_pool_info Va p)) &#10233;
  nat (free_l Va t) &lt; length (lsizes Va t) &#10233;
  inv_bitmap
   (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
         mem_pool_info :=
           set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
            (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
              (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
         allocating_node := allocating_node Va(t &#8614;
           &#10631;pool = p, level = nat (free_l Va t),
              block = block_num
                       (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
                         (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                           (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                         p)
                       (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
              data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap (set_bit_s Va p (nat (free_l Va t))
       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
       ALLOCATING)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p (nat (free_l Va t))
                      (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                                  (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))) = FREE&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) ! NULL)
                                (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t)))
    = (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
        (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
        (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_fl_FREE</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_presv_setbit</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (free_l Va t))&quot;</span></span></span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                    (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                    (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))&quot;</span></span></span><span> </span><span>ALLOCATING</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;set_bit_s Va p (nat (free_l Va t))
       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
       ALLOCATING&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>inv_bitmap_presv_mpls_mpi2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(set_bit_s Va p (nat (free_l Va t))
       (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t))) (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
       ALLOCATING)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
           mem_pool_info :=
             set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t))),
           allocating_node := allocating_node Va(t &#8614;
             &#10631;pool = p, level = nat (free_l Va t),
                block = block_num
                         (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                           (nat (free_l Va t))
                           (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)))
                           p)
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                         (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (free_l Va t)),
                data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span> </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span>
</span><span>          </span><span>linorder_not_less</span><span> </span><span>list_update_beyond</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_inv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
    inv Va &#10233;
    allocating_node Va t = None &#10233;
    freeing_node Va t = None &#10233;
    p &#8712; mem_pools Va &#10233;
    ETIMEOUT &#8804; timeout &#10233;
    timeout = ETIMEOUT &#10230; tmout Va t = ETIMEOUT &#10233;
    &#172; rf Va t &#10233;
    &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
    length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
    alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
    free_l Va t &#8804; alloc_l Va t &#10233;
    &#172; free_l Va t &lt; 0 &#10233;
    alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
    alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &#10233;
    inv (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
           mem_pool_info :=
             set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
              (nat (free_l Va t))
              (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t))),
           allocating_node := allocating_node Va(t &#8614;
             &#10631;pool = p, level = nat (free_l Va t),
                block = block_num
                         (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
                           (nat (free_l Va t))
                           (block_num (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))
                             (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)))
                           p)
                         (head_free_list (mem_pool_info Va p) (nat (free_l Va t))) (lsizes Va t ! nat (free_l Va t)),
                data = head_free_list (mem_pool_info Va p) (nat (free_l Va t))&#10632;)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &lt; length (lsizes Va t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* inv_cur *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* inv_thd_waitq *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_thd_waitq</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* inv_mempool_info *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_mempool_info</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* inv_bitmap_freelist *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap_freelist</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_aux_vars</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmapn</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv_bitmap_not4free</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_3_1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;(a::nat) mod b = 0 &#10233; c * b * (a div b) = c * a&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_3</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
    inv Va &#10233;
    alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
    free_l Va t &#8804; alloc_l Va t &#10233;
    p &#8712; mem_pools Va &#10233;
    &#172; free_l Va t &lt; 0 &#10233;
    max_sz (mem_pool_info Va p) = ALIGN4 (max_sz (mem_pool_info Va p)) &#10233;
    let fl = hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))); mp = mem_pool_info Va p
    in &#8707;n&lt;n_max mp * 4 ^ nat (free_l Va t). fl = buf mp + n * (max_sz mp div 4 ^ nat (free_l Va t)) &#10233;
    hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)))
    &lt; buf (mem_pool_info Va p) + n_max (mem_pool_info Va p) * max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))) &#8805; buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_buf_le_fl</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span> </span><span>level_empty_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) mod (4 ^ nat (free_l Va t)) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>ge_pow_mod_0</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n * (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))
  &lt; n_max (mem_pool_info Va p) * max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p) * 4 ^ nat (free_l Va t) * (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))
                      = n_max (mem_pool_info Va p) * max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_3_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ nat (free_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n * (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))
                     &lt; (n_max (mem_pool_info Va p) * 4 ^ nat (free_l Va t)) * (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_def</span><span> </span><span>mp_alloc_stm3_lm2_inv_1_2</span><span> </span><span>mult_less_mono1</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_5</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
  inv Va &#10233;
  alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
  free_l Va t &#8804; alloc_l Va t &#10233;
  p &#8712; mem_pools Va &#10233;
  &#172; free_l Va t &lt; 0 &#10233;
  (hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))) - buf (mem_pool_info Va p)) div
    (max_sz (mem_pool_info Va p) div 4 ^ nat (free_l Va t))
    &lt; n_max (mem_pool_info Va p) * 4 ^ nat (free_l Va t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))) &#8805; buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_buf_le_fl</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span> </span><span>0</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>block_num_def</span><span> </span><span>inv_bitmap_freelist_fl_bnum_in</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>length_greater_0_conv</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2_4</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv Va &#8743;
    p &#8712; mem_pools Va &#8743;
    free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)) &#8800; [] &#10233;
    nat (free_l Va t) &lt; length (levels (mem_pool_info Va p)) &#10233; NULL &lt; hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_imp_fl_lt0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>hd_conv_nth</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond1_70_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
    &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
    &#10627;let vb = Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                   mem_pool_info := (mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
     in &#180;(=) (vb&#10631;mem_pool_info :=
                    set_bit_allocating (mem_pool_info vb) p (nat (free_l vb t))
                     (block_num (mem_pool_info vb p) (blk vb t) (lsizes vb t ! nat (free_l vb t)))&#10632;) &#8743;
        &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))&#10628;
    &#8838; &#10627;&#180;(allocating_node_update
           (&#955;_. &#180;allocating_node(t &#8614;
               &#10631;pool = p, level = nat (&#180;free_l t), block = block_num (&#180;mem_pool_info p) (&#180;blk t) (&#180;lsizes t ! nat (&#180;free_l t)),
                  data = &#180;blk t&#10632;)))
        &#8712; &#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1 t p sz timeout&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;head_free_list (mem_pool_info Va p) (nat (free_l Va t)) &#8800; NULL&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (free_l Va t)) &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>     </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>head_free_list_def</span><span> </span><span>level_empty_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_4</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (Va, Va...) &#8712; Mem_pool_alloc_guar t *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t) = i&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (free_l Va t)&quot;</span></span></span><span>
</span><span>            </span><span class="string"><span class="delete"><span class="delete">&quot;tl (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)))&quot;</span></span></span><span>
</span><span>            </span><span class="string"><span class="delete"><span class="delete">&quot;(hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))) - buf (mem_pool_info Va p)) div
                                 lsizes Va t ! nat (free_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* invariant *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; s r) *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* invariant *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>head_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p (nat (free_l Va t))
          ((head_free_list (mem_pool_info Va p) (nat (free_l Va t)) -
            buf (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) div
           lsizes Va t ! nat (free_l Va t))
          p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>head_free_list_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (set_bit_allocating ((mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) p
              (nat (free_l Va t))
              ((head_free_list (mem_pool_info Va p) (nat (free_l Va t)) -
                buf (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) div
               lsizes Va t ! nat (free_l Va t))
              p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>head_free_list_def</span><span> </span><span>rmhead_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (free_l Va t) = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ (nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) = ALIGN4 (max_sz (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>align40</span><span> </span><span>mod_mult_self1_is_0</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>17</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;let fl = hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t)));
                         mp = (mem_pool_info Va p) in
                      (&#8707;n.  n &lt; n_max mp * (4 ^ (nat (free_l Va t)))
                            &#8743; fl = buf mp + n * (max_sz mp div (4 ^ (nat (free_l Va t)))))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>level_empty_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (free_l Va t)) &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>in_set_conv_nth</span><span> </span><span>list.set_sel</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add_diff_cancel_left&#39;</span><span> </span><span>div_mult_self_is_m</span><span> </span><span>mult_is_0</span><span> </span><span>neq0_conv</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (set_bit_allocating (&#955;a. if a = p then rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)) else mem_pool_info Va a)
              p (nat (free_l Va t))
              ((hd (free_list (levels (mem_pool_info Va p) ! nat (free_l Va t))) -
                buf (rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))) div
               lsizes Va t ! nat (free_l Va t))
              p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>rmhead_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_5</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2_3</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;head_free_list (mem_pool_info Va p) (nat (free_l Va t)) &#8800; NULL &#10233;
    {Va&#10631;blk := (blk Va)(t := NULL)&#10632;, Va &#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
        mem_pool_info := (mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;} &#8745;
    &#10627;NULL &lt; &#180;blk t&#10628; =
    {Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
          mem_pool_info := (mem_pool_info Va)(p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;}&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm1_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv Va &#10233; p &#8712; mem_pools Va &#10233; nat (free_l Va t) &lt; length (levels (mem_pool_info Va p)) &#10233;
  &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t)) &#10233;
  {V. V = Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                mem_pool_info := (mem_pool_info Va)
                  (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
         &#8743; blk V t &#8800; NULL}
  ={V. V = Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                mem_pool_info := (mem_pool_info Va)
                  (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;}&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>equalityI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subsetI</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subsetI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>head_free_list_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>level_empty_def</span><span> </span><span>mp_alloc_stm3_lm2_4</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} = {Va}
    &#10233;  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (IF level_empty (&#180;mem_pool_info p) (nat (&#180;free_l t)) THEN
              &#180;blk := &#180;blk(t := NULL)
            ELSE
              &#180;blk := &#180;blk(t := head_free_list (&#180;mem_pool_info p) (nat (&#180;free_l t)));;

              &#180;mem_pool_info := &#180;mem_pool_info (p := rmhead_free_list (&#180;mem_pool_info p) (nat (&#180;free_l t)))

            FI;;

            IF &#180;blk t &#8800; NULL THEN
              &#180;mem_pool_info := set_bit_allocating &#180;mem_pool_info p (nat (&#180;free_l t))
                                  (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;free_l t))));;
              &#180;allocating_node := &#180;allocating_node (t := Some &#10631;pool = p, level = nat (&#180;free_l t),
                    block = (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;free_l t)))), data = &#180;blk t &#10632;)
            FI) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_70_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va},
                  {(s, t). s = t}, UNIV, &#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply simp *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Va&#8712;mp_alloc_precond1_70_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;
    if level_empty (mem_pool_info Va p) (nat (free_l Va t)) then
       {V. V = Va&#10631;blk:=(blk Va)(t:=NULL)&#10632; &#8743; level_empty (mem_pool_info Va p) (nat (free_l Va t))}
     else
       {V. V = Va&#10631;blk:=(blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
        mem_pool_info := (mem_pool_info Va)(p:=rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
         &#8743; &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF level_empty (&#180;mem_pool_info p) (nat (&#180;free_l t)) THEN
        &#180;blk := &#180;blk(t := NULL)
      ELSE *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;blk := &#180;blk(t := NULL) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE ... *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{V. V = Va&#10631;blk:=(blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
                                    &#8743; &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* apply(subgoal_tac &quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))&quot;)
        prefer 2 apply(simp add:level_empty_def) *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;blk t &#8800; NULL THEN ....... *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{Va&#10631;blk := (blk Va)(t := NULL)&#10632;, Va
                                  &#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                                     mem_pool_info := (mem_pool_info Va)
                                       (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;} &#8745;
                                 &#10627;&#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))&#10628; = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;Some (&#180;mem_pool_info := set_bit_allocating &#180;mem_pool_info p (nat (&#180;free_l t))
                                (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;free_l t))));;
            &#180;allocating_node := &#180;allocating_node (t := Some &#10631;pool = p, level = nat (&#180;free_l t),
                  block = (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;free_l t)))), data = &#180;blk t &#10632;))&quot;</span></span></span><span>
</span><span>                </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(x,y). x=y}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar</span><span class="delimiter">=</span><span>UNIV</span><span>
</span><span>                </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(if level_empty (mem_pool_info Va p) (nat (free_l Va t))
                                  then &#10627;&#180;(=) (Va&#10631;blk := (blk Va)(t := NULL)&#10632;) &#8743; level_empty (mem_pool_info Va p) (nat (free_l Va t))&#10628;
                                  else &#10627;&#180;(=) (Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                                                    mem_pool_info := (mem_pool_info Va)
                                                      (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;) &#8743;
                                        &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))&#10628;) &#8745;
                                 &#10627;&#180;blk t &#8800;
                                  NULL&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{V. V = Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                                                    mem_pool_info := (mem_pool_info Va)
                                                      (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
                                             &#8743; &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))
                                             &#8743; blk V t &#8800; NULL}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{V. V = Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                                                    mem_pool_info := (mem_pool_info Va)
                                                      (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
                                             &#8743; &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))
                                             &#8743; blk V t &#8800; NULL}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{V. V = Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                                                    mem_pool_info := (mem_pool_info Va)
                                                      (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
                                             &#8743; &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (free_l Va t)) &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm1_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply simp*)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;
        {V. let vb = Va&#10631;blk := (blk Va)(t := head_free_list (mem_pool_info Va p) (nat (free_l Va t))),
                        mem_pool_info := (mem_pool_info Va) (p := rmhead_free_list (mem_pool_info Va p) (nat (free_l Va t)))&#10632;
            in V = vb&#10631; mem_pool_info := set_bit_allocating (mem_pool_info vb) p (nat (free_l vb t))
                           (block_num (mem_pool_info vb p) (blk vb t) ((lsizes vb t)!(nat (free_l vb t))))&#10632;
               &#8743; &#172; level_empty (mem_pool_info Va p) (nat (free_l Va t))}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm3</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm3_lm</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; ATOMIC
          IF level_empty (&#180;mem_pool_info p) (nat (&#180;free_l t)) THEN
            &#180;blk := &#180;blk(t := NULL)
          ELSE
            &#180;blk := &#180;blk(t := head_free_list (&#180;mem_pool_info p) (nat (&#180;free_l t)));;

            &#180;mem_pool_info := &#180;mem_pool_info (p := rmhead_free_list (&#180;mem_pool_info p) (nat (&#180;free_l t)))

          FI;;

          IF &#180;blk t &#8800; NULL THEN
            &#180;mem_pool_info := set_bit_allocating &#180;mem_pool_info p (nat (&#180;free_l t))
                                (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;free_l t))));;
            &#180;allocating_node := &#180;allocating_node (t := Some &#10631;pool = p, level = nat (&#180;free_l t),
                  block = (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;free_l t)))), data = &#180;blk t &#10632;)
          FI
        END)
      sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_70_2_2 t p sz timeout, Mem_pool_alloc_rely t, Mem_pool_alloc_guar t,
            mp_alloc_precond2_1 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>clarify</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V = Va&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_2 t p sz timeout
        &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_2 t p sz timeout
                            &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} = {Va}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>int1_eq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm1</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_2 t p sz timeout&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1 t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;stm4&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz tm &#8801;
  mp_alloc_precond2_1_1_loopinv t p sz tm &#8745; &#10627;&#180;from_l t &lt; &#180;alloc_l t&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*abbreviation &quot;mp_alloc_precond2_1_1_loopinv_0&#39; t p sz tm &#8801;
  mp_alloc_precond1_70_2_2 t p sz tm  &#8745; -&#10627;&#180;blk t = NULL&#10628;
    &#8745; &#10627;&#180;from_l t &#8804; &#180;alloc_l t &#8743; &#180;allocating_node t = Some &#10631;pool = p, level = nat (&#180;from_l t),
                            block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;from_l t))),
                            data = &#180;blk t &#10632; &#10628; &#8745; &#10627;&#180;from_l t &lt; &#180;alloc_l t&#10628;&quot;
*)</span></span></span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* mp_alloc_precond1_70_2_2 t p sz tm  *)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_0_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_1_loopinv_0 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_num_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1&#39; t p sz tm &#8801;
  mp_alloc_precond2_1_1 t p sz tm &#8745; &#10627;&#180;from_l t &#8804; &#180;alloc_l t &#8743; &#180;from_l t &#8805; &#180;free_l t
          &#8743; &#180;allocating_node t = Some &#10631;pool = p, level = nat (&#180;from_l t + 1),
                                  block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;from_l t + 1))),
                                  data = &#180;blk t &#10632; &#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz tm &#8801;
  {s. inv s} &#8745; &#10627;&#180;freeing_node t = None&#10628; &#8745; &#10627;p &#8712; &#180;mem_pools &#8743; tm &#8805; -1&#10628; &#8745; mp_alloc_precond7_ext t p sz tm &#8745; &#10627;&#172; &#180;rf t&#10628;
  &#8745; mp_alloc_precond1_70_ext t p sz tm &#8745; - &#10627;&#180;alloc_l t &lt; 0&#10628;
  &#8745; - &#10627;&#180;free_l t &lt; 0&#10628; &#8745; -&#10627;&#180;blk t = NULL&#10628; &#8745; &#10627;&#180;from_l t &lt; &#180;alloc_l t&#10628;
  &#8745; &#10627;&#180;from_l t &#8804; &#180;alloc_l t &#8743; &#180;from_l t &#8805; &#180;free_l t
          &#8743; &#180;allocating_node t = Some &#10631;pool = p, level = nat (&#180;from_l t + 1),
                                  block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;from_l t + 1))),
                                  data = &#180;blk t &#10632;
    &#8743; &#180;alloc_memblk_data_valid p (the (&#180;allocating_node t))
        &#8743; (&#8707;n. n &lt; n_max (&#180;mem_pool_info p) * (4 ^ (nat (&#180;from_l t + 1)))
              &#8743; &#180;blk t = buf (&#180;mem_pool_info p) + n * (max_sz (&#180;mem_pool_info p) div (4 ^ (nat (&#180;from_l t + 1))))) &#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz tm&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz tm&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1&#39; t p sz tm&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_1&#39;_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_1_loopinv_1&#39; t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_num_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_1_stb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;stable (mp_alloc_precond2_1_1_loopinv_1 t p sz tm) (Mem_pool_alloc_rely t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>stable_int2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>stable_inv_alloc_rely1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_freenode_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond7_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_0_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_precond1_70_2_2_ext_stb</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_ext_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l x t + 1 = from_l y t + 1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = blk y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = allocating_node y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x t = lsizes y t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info x p) = n_max (mem_pool_info y p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (from_l x t + 1))
                      = block_num (mem_pool_info y p) (blk y t) (lsizes y t ! nat (from_l y t + 1))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>block_num_def</span><span> </span><span>Mem_pool_alloc_rely_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x=y&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_rely_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_rel_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond1 Va t p &#8801;
  Va&#10631;bn := (bn Va) (t := block_num (mem_pool_info Va p) (blk Va t) ((lsizes Va t)!(nat (from_l Va t))))&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond2 Va t p &#8801;
  Va&#10631;mem_pool_info := set_bit_divide (mem_pool_info Va) p (nat (from_l Va t)) (bn Va t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond3 Va t p &#8801;
  Va&#10631;mem_pool_info := set_bit_allocating (mem_pool_info Va) p (nat (from_l Va t + 1)) (4 * bn Va t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond4 Va t p &#8801;
  Va&#10631;allocating_node := (allocating_node Va)(t := Some &#10631;pool = p, level = nat (from_l Va t + 1),
            block = 4 * bn Va t, data = blk Va t &#10632;)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond5 Va t p &#8801; Va&#10631;i := (i Va) (t := 1)&#10632;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond_f Va t p
   &#8801; mp_alloc_stm4_pre_precond5
      (mp_alloc_stm4_pre_precond4
      (mp_alloc_stm4_pre_precond3
      (mp_alloc_stm4_pre_precond2
      (mp_alloc_stm4_pre_precond1 Va t p) t p) t p) t p) t p&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_loopinv Va t mp
  &#8801; {V. cur V = cur Va &#8743; tick V = tick Va &#8743; thd_state V = thd_state Va &#8743; (V,Va)&#8712;gvars_conf_stable
        &#8743; (&#8704;p. p &#8800; mp &#10230; mem_pool_info V p = mem_pool_info Va p)
        &#8743; wait_q (mem_pool_info V mp) = wait_q (mem_pool_info Va mp)
        &#8743; (&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; V Va)
        &#8743; (&#8704;jj. jj &#8800; nat (from_l Va t + 1) &#10230; levels (mem_pool_info V mp) ! jj = levels (mem_pool_info Va mp) ! jj)
        &#8743; (bits (levels (mem_pool_info V mp) ! nat (from_l Va t + 1))
            = list_updates_n (bits (levels (mem_pool_info Va mp) ! nat (from_l Va t + 1))) (bn Va t * 4 + 1) (i V t - 1) FREE)
        &#8743; (free_list (levels (mem_pool_info V mp) ! nat (from_l Va t + 1))
            = inserts (map (&#955;ii. (lsizes Va t) ! (nat (from_l Va t + 1))  * ii + blk V t) [1..&lt;i V t])
                (free_list (levels (mem_pool_info Va mp) ! nat (from_l Va t + 1))))
        &#8743; j V = j Va &#8743; ret V = ret Va &#8743; endt V = endt Va &#8743; rf V = rf Va &#8743; tmout V = tmout Va
        &#8743; lsizes V = lsizes Va &#8743; alloc_l V = alloc_l Va &#8743; free_l V = free_l Va
        &#8743; from_l V = from_l Va &#8743; blk V = blk Va &#8743; nodev V = nodev Va
        &#8743; bn V = bn Va &#8743; alloc_lsize_r V = alloc_lsize_r Va &#8743; lvl V = lvl Va &#8743; bb V = bb Va
        &#8743; block_pt V = block_pt Va &#8743; th V = th Va &#8743; need_resched V = need_resched Va
        &#8743; mempoolalloc_ret V = mempoolalloc_ret Va &#8743; freeing_node V = freeing_node Va
        &#8743; allocating_node V = allocating_node Va
        &#8743; i V t &gt; 0 &#8743; i V t &#8804; 4}&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>in_mp_alloc_stm4_loopinv</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 1 &#10233; V &#8712; mp_alloc_stm4_loopinv V t mp&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inserts_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_while_precond1 V t p &#8801;
  V&#10631;lbn := (lbn V) (t := 4 * bn V t + i V t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_while_precond2 V t p &#8801;
  V&#10631;lsz := (lsz V) (t := lsizes V t ! nat (from_l V t + 1))&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_while_precond3 V t p &#8801;
  V&#10631;block2 := (block2 V) (t := lsz V t * i V t + blk V t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_while_precond4 V t p &#8801;
  V&#10631;mem_pool_info := set_bit_free (mem_pool_info V) p (nat (from_l V t + 1)) (lbn V t)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_while_precond5 V t p &#8801;
  V&#10631;mem_pool_info := (mem_pool_info V) (p := append_free_list (mem_pool_info V p) (nat (from_l V t + 1)) (block2 V t))&#10632;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_in</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond4
    (mp_alloc_stm4_while_precond3
    (mp_alloc_stm4_while_precond2
    (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p} &#8745;
      &#10627;block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t)&#10628;
    &#8838; &#10627;&#180;mp_alloc_stm4_while_precond5 t p
        &#8712; {mp_alloc_stm4_while_precond5
            (mp_alloc_stm4_while_precond4
            (mp_alloc_stm4_while_precond3
            (mp_alloc_stm4_while_precond2
            (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p) t p}&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_lsizes</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t = lsizes (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_froml</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t = from_l (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_buf</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va q) = buf (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) q)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_nmax</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va q) = n_max (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) q)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_maxsz</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va q) = max_sz (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) q)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blk</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk Va = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit_help_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233; inv Va &#10233;
  (&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii) &#10233;
  length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
  ALIGN4 (max_sz (mem_pool_info Va p)) = max_sz (mem_pool_info Va p) &#10233;
  Suc (nat (from_l Va t)) &lt; length (lsizes Va t) &#10233;
  max_sz (mem_pool_info Va p) = 4 ^ nat (from_l Va t) * lsizes Va t ! nat (from_l Va t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&gt;0. max_sz (mem_pool_info Va p) = 4 * n * 4 ^ n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) mod (4 ^ nat (from_l Va t)) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>ge_pow_mod_0</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mod0_div_self</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ nat (from_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit_help_2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;ii &#8805; 0 &#10233; (a::nat) mod 4 ^ nat (ii+1) = 0 &#10233; a div 4 ^ nat (ii+1) * 4 = a div 4 ^ (nat ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (ii+1) = nat ii + 1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit_help3</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv Va &#10233;
    p &#8712; mem_pools Va &#10233;
    nmax &gt; 0 &#10233;
    maxsz mod frml = 0 &#10233;
    n &lt; nmax * frml &#10233;
       blk Va t = buf (mem_pool_info Va p) + n * (maxsz div frml) &#10233;
       maxsz div frml + blk Va t
       &#8804; nmax * maxsz + buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Nat.add_0_right</span><span> </span><span>add_le_mono1</span><span> </span><span>div_le_dividend</span><span> </span><span>div_mult_self1_is_m</span><span> </span><span>le_trans</span><span> </span><span>mult_is_0</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t &#8804; buf (mem_pool_info Va p) + (nmax * frml - 1) * (maxsz div frml)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add.left_commute</span><span> </span><span>add_diff_cancel_left&#39;</span><span> </span><span>le_diff_conv</span><span> </span><span>mp_alloc_stm3_lm2_3_1</span><span> </span><span>mult_eq_if</span><span> </span><span>nat_add_left_cancel_le</span><span> </span><span>not_less_zero</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va &#8743;
  p &#8712; mem_pools Va &#8743;
  length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#8743;
  alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#8743;
  from_l Va t &lt; alloc_l Va t &#8743;
  &#172; free_l Va t &lt; OK &#8743;
  free_l Va t &#8804; from_l Va t &#10233;
  ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1) * 4 = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p)) mod 4 ^ nat (from_l Va t + 1) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) &lt; n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>nat_less_iff</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info Va p) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>ge_pow_mod_0</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_alloc_stm4_blockfit_help_2</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>int_nat_eq</span><span> </span><span>linorder_not_less</span><span> </span><span>nat_int</span><span> </span><span>neq0_conv</span><span> </span><span>zless_nat_conj</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit_help</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8743; ii &lt; 4
    &#10233; block_fits (mem_pool_info Va p) (lsizes Va t ! nat (from_l Va t + 1) * ii + blk Va t)
                   (lsizes Va t ! nat (from_l Va t + 1))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_fits_def</span><span> </span><span>block_num_def</span><span> </span><span>buf_size_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = ETIMEOUT &#8743; free_l Va t = ETIMEOUT &#8743; length (lsizes Va t) = Suc NULL&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t + 1) = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) &lt; length (lsizes Va t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>nat_less_iff</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t) &lt; length (lsizes Va t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>nat_less_iff</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t + 1) * ii + blk Va t + lsizes Va t ! nat (from_l Va t + 1)&quot;</span></span></span><span>
</span><span>                        </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1) * ii + blk Va t + ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk Va t - buf (mem_pool_info Va p)) div lsizes Va t ! nat (from_l Va t)
                    &lt; n_max (mem_pool_info Va p) * 4 ^  nat (from_l Va t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t &#8805; buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk Va t - buf (mem_pool_info Va p)) mod (ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t)) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>diff_add_inverse</span><span> </span><span>inv_maxsz_align4</span><span> </span><span>mod_mult_self2_is_0</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1) * ii + blk Va t +
    ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1)
    &#8804; ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1) * 4 + blk Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t + 1) * 4
                       = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t) + blk Va t
                    &#8804; n_max (mem_pool_info Va p) * max_sz (mem_pool_info Va p) + buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>gr0I</span><span> </span><span>mult_is_0</span><span> </span><span>not_less_zero</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) mod 4 ^ nat (from_l Va t) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&gt;0. max_sz (mem_pool_info Va p) = (4 * n) * (4 ^ n_levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>ge_pow_mod_0</span><span> </span><span>of_nat_less_imp_less</span><span> </span><span>zless_nat_conj</span><span> </span><span>zless_nat_eq_int_zless</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_blockfit_help3</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span>_</span><span> </span><span>t</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_maxsz_align4</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;a &#8805; b &#10233; c * d &#8805; e &#10233; (a::nat) - b &#8804; c * d - e &#10233; a + e - b &#8804; c * d&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Nat.le_diff_conv2</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;a + b &gt; c &#10233; a + b - c &#8804; d &#10233; e + f &lt; b &#10233; e + a + f - Suc c &lt; d&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(x::nat) &gt; y &#10233; &#8707;n. (4::nat) ^ x = 4 ^ y * n&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ x = 4 ^ y * 4 ^ (x - y)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add_diff_inverse_nat</span><span> </span><span>less_imp_le_nat</span><span> </span><span>not_less</span><span> </span><span>power_add</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>int_empt1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;v. v &#8712; P &#10230; v &#8713; Q) &#10233; P &#8745; Q = {}&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit1_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
    Some &#10631;pool = p, level = nat (from_l Va t), block = block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)),
            data = blk Va t&#10632; &#8743; data (the (allocating_node Va t)) = buf (mem_pool_info Va p) +
    block (the (allocating_node Va t)) * (max_sz (mem_pool_info Va p) div 4 ^ level (the (allocating_node Va t)))
  &#8743; block (the (allocating_node Va t)) &lt; n_max (mem_pool_info Va p) * 4 ^ level (the (allocating_node Va t)) &#10233;
  alloc_blk_valid Va p (nat (from_l Va t)) (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) (blk Va t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_num_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   V &#8712; mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
   &#8704;v. v &#8712; {mp_alloc_stm4_while_precond4
        (mp_alloc_stm4_while_precond3
        (mp_alloc_stm4_while_precond2
        (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p} &#10230;
      v &#8713; - &#10627;block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t)&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>block_fits_def</span><span> </span><span>buf_size_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (mp_alloc_stm4_pre_precond_f Va t p) t = lsizes Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lsizes</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p) t = from_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) = buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_buf</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) = n_max (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_nmax</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_maxsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk (mp_alloc_stm4_pre_precond_f Va t p) = blk Va&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_blk</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info V p) = buf (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V p) = n_max (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V p) = max_sz (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info V p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info V p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info V p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_blockfit_help</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>block_fits_def</span><span> </span><span>buf_size_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = ETIMEOUT &#8743; free_l Va t = ETIMEOUT &#8743; length (lsizes Va t) = Suc NULL&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_blk_valid Va p (nat (from_l Va t)) (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) (blk Va t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_blockfit1_1</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* axiomatization where mp_alloc_stm4_blockfit: *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_blockfit</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
   V &#8712; mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
      {mp_alloc_stm4_while_precond4
        (mp_alloc_stm4_while_precond3
        (mp_alloc_stm4_while_precond2
        (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p} &#8745;
            - &#10627;block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t)&#10628; = {}&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_blockfit1</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>V</span><span class="delimiter">]</span><span>
</span><span>  </span><span>int_empt1</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond4
        (mp_alloc_stm4_while_precond3
        (mp_alloc_stm4_while_precond2
        (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p}&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;- &#10627;block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t)&#10628;&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &lt; 4&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond4
        (mp_alloc_stm4_while_precond3
        (mp_alloc_stm4_while_precond2
        (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p} &#8745;
            - &#10627;block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t)&#10628;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_mif_buf</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va pa) = buf (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_mif_mxsz</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va pa) = max_sz (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_mif_nmax</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va pa) = n_max (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_mif_nlvls</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info Va pa) = n_levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_mif_len</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va pa)) = length (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa) ! ii))
        = length (bits (levels (mem_pool_info Va pa) ! ii))&quot;</span></span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8800; pa&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t) = ii&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>set_bit_prev_len</span><span> </span><span>set_bit_prev_len2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>set_bit_prev_len</span><span> </span><span>set_bit_prev_len2</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>inserts_comm</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inserts ilst lst @ [v] = inserts (ilst @ [v]) lst&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inserts_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_while_isucc&#39;&#39;</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Vb t + 1) &lt; length (levels (mem_pool_info Vb p)) &#10233;
  V &#8712; mp_alloc_stm4_loopinv Vb t p &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
  i V t &gt; 0 &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;i := &#180;i(t := Suc (&#180;i t))) sat<span class="hidden">&#8681;</span><sub>p</sub>
    [{mp_alloc_stm4_while_precond5
      (mp_alloc_stm4_while_precond4
      (mp_alloc_stm4_while_precond3
      (mp_alloc_stm4_while_precond2
      (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p) t p},
    {(s, t). s = t}, UNIV, mp_alloc_stm4_loopinv Vb t p]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &#8800; nat (from_l Vb t + 1)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ia &lt; length (levels (mem_pool_info Vb p))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Vb p)) = length (levels (mem_pool_info V p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Vb t + 1) &lt; length (levels (mem_pool_info Vb p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lst_updts_eq_updts_updt</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info Vb p) ! nat (from_l Vb t + 1))&quot;</span></span></span><span>
</span><span>                                 </span><span class="string"><span class="delete"><span class="delete">&quot;Suc (bn Vb t * 4)&quot;</span></span></span><span> </span><span>FREE</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>append_free_list_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inserts_comm</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_while_isucc</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
    V &#8712; mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
   &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;i := &#180;i(t := Suc (&#180;i t))) sat<span class="hidden">&#8681;</span><sub>p</sub>
    [{mp_alloc_stm4_while_precond5
      (mp_alloc_stm4_while_precond4
      (mp_alloc_stm4_while_precond3
      (mp_alloc_stm4_while_precond2
      (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p) t p},
    {(s, t). s = t}, UNIV, mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_alloc_stm4_while_isucc&#39;&#39;</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                    </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_len</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info Va p) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>assumption</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_while_help</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  V &#8712; mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &lt; 4&#10628; &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;lbn := &#180;lbn(t := 4 * &#180;bn t + &#180;i t);;
     &#180;lsz := &#180;lsz(t := &#180;lsizes t ! nat (&#180;from_l t + 1));;
     &#180;block2 := &#180;block2(t := &#180;lsz t * &#180;i t + &#180;blk t);;
     &#180;mem_pool_info := set_bit_free &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (&#180;lbn t);;
     IF block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t) THEN
       &#180;mem_pool_info := &#180;mem_pool_info(p := append_free_list (&#180;mem_pool_info p) (nat (&#180;from_l t + 1)) (&#180;block2 t))
     FI;;
     &#180;i := &#180;i(t := Suc (&#180;i t)) )
  sat<span class="hidden">&#8681;</span><sub>p</sub> [{V}, {(s, t). s = t}, UNIV, mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond5
                            (mp_alloc_stm4_while_precond4
                            (mp_alloc_stm4_while_precond3
                            (mp_alloc_stm4_while_precond2
                            (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond4
                            (mp_alloc_stm4_while_precond3
                            (mp_alloc_stm4_while_precond2
                            (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond3
                            (mp_alloc_stm4_while_precond2
                            (mp_alloc_stm4_while_precond1 V t p) t p) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond2
                            (mp_alloc_stm4_while_precond1 V t p) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond1 V t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;lbn := &#180;lbn (t := 4 * &#180;bn t + &#180;i t);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;lsz := &#180;lsz(t := &#180;lsizes t ! nat (&#180;from_l t + 1));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;block2 := &#180;block2(t := &#180;lsz t * &#180;i t + &#180;blk t);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := set_bit_free &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (&#180;lbn t);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := &#180;mem_pool_info(p := append_free_list (&#180;mem_pool_info p) (nat (&#180;from_l t + 1)) (&#180;block2 t)) *)</span></span></span></span></span><span>
</span><span>     </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_in</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE body *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_while_precond4
        (mp_alloc_stm4_while_precond3
        (mp_alloc_stm4_while_precond2
        (mp_alloc_stm4_while_precond1 V t p) t p) t p) t p} &#8745;
            - &#10627;block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t)&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_blockfit</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>V</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;i := &#180;i(t := Suc (&#180;i t))  *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_while_isucc</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span>V</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_while_1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;4 &#8804; &#180;i t&#10628; = - &#10627;&#180;i t &lt; 4&#10628;&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_while</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (WHILE &#180;i t &lt; 4 DO
       &#180;lbn := &#180;lbn (t := 4 * &#180;bn t + &#180;i t);;
        &#180;lsz := &#180;lsz (t := (&#180;lsizes t) ! (nat (&#180;from_l t + 1)));;
        &#180;block2 := &#180;block2(t := &#180;lsz t * &#180;i t + &#180;blk t);;

        &#180;mem_pool_info := set_bit_free &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (&#180;lbn t);;

        IF block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t) THEN

          &#180;mem_pool_info := &#180;mem_pool_info (p :=
                  append_free_list (&#180;mem_pool_info p) (nat (&#180;from_l t + 1)) (&#180;block2 t) )
        FI;;
        &#180;i := &#180;i(t := Suc (&#180;i t))
     OD) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p, {(s, t). s = t}, UNIV,
              mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &#8805; 4&#10628;]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;- &#10627;&#180;i t &lt; 4&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;4 &#8804; &#180;i t&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_while_1</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_while_help</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span> </span><span class="delimiter">]</span><span>
</span><span>      </span><span>Allprecond</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745;&#10627;&#180;i t &lt; 4&#10628;&quot;</span></span></span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;Some (&#180;lbn := &#180;lbn(t := 4 * &#180;bn t + &#180;i t);;
         &#180;lsz := &#180;lsz(t := &#180;lsizes t ! nat (&#180;from_l t + 1));;
         &#180;block2 := &#180;block2(t := &#180;lsz t * &#180;i t + &#180;blk t);;
         &#180;mem_pool_info := set_bit_free &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (&#180;lbn t);;
         IF block_fits (&#180;mem_pool_info p) (&#180;block2 t)
             (&#180;lsz t) THEN &#180;mem_pool_info := &#180;mem_pool_info
                           (p := append_free_list (&#180;mem_pool_info p) (nat (&#180;from_l t + 1)) (&#180;block2 t)) FI;;
         &#180;i := &#180;i(t := Suc (&#180;i t)))&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span> </span><span>UNIV</span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_in_mp_alloc_stm4_loopinv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond_f Va t p &#8712; mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i (mp_alloc_stm4_pre_precond_f Va t p) t = 1&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>in_mp_alloc_stm4_loopinv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233; mem_pools x = mem_pools Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_mempools2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools (mp_alloc_stm4_pre_precond_f Va t p) = mem_pools x &#10233; mem_pools x = mem_pools Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_cur</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur Va = Some t &#10233; &#8704;ta. (t = ta) = (thd_state Va ta = RUNNING) &#10233;
            (cur (mp_alloc_stm4_pre_precond_f Va t p) = Some ta) = (thd_state (mp_alloc_stm4_pre_precond_f Va t p) ta = RUNNING)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_thd_state</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
      thd_state x = thd_state (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
         &#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa &#10233;
         wait_q (mem_pool_info x p) = wait_q (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) &#10233;
        inv_thd_waitq Va &#10233; inv_thd_waitq x&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;q&#8712;mem_pools x. wait_q (mem_pool_info x q)
        = wait_q (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) q)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;q = p&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;q&#8712;mem_pools Va. wait_q (mem_pool_info Va q)
      = wait_q (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) q)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state (mp_alloc_stm4_pre_precond_f Va t p) = thd_state Va&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>inv_mpinfo_inv_mpinfo_stm4</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va &#10233; inv_mempool_info (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span>pa</span><span> </span><span>ii</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels ((set_bit_divide (mem_pool_info Va) p (nat (from_l Va t))
                                      (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) pa) !
                           ii)) = length (bits (levels (mem_pool_info Va pa) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>fun_upd_apply</span><span> </span><span>set_bit_def</span><span>
</span><span>                 </span><span>set_bit_prev_len</span><span> </span><span>set_bit_prev_len2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (set_bit_allocating
                                    (set_bit_divide (mem_pool_info Va) p (nat (from_l Va t))
                                      (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))
                                    p (nat (from_l Va t + 1))
                                    (4 * block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) pa) !
                           ii)) = length (bits (levels ((set_bit_divide (mem_pool_info Va) p (nat (from_l Va t))
                                      (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) pa) !
                           ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii = nat (from_l Va t + 1)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_prev_len</span><span> </span><span>set_bit_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (set_bit_allocating
                     (set_bit_divide (mem_pool_info Va) p (nat (from_l Va t))
                       (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))
                     p (nat (from_l Va t + 1)) (4 * block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) pa) *
             4 ^ ii =  n_max (mem_pool_info Va pa) * 4 ^ ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (set_bit_allocating
                                   (set_bit_divide (mem_pool_info Va) p (nat (from_l Va t))
                                     (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))
                                   p (nat (from_l Va t + 1))
                                   (4 * block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) pa))
                    = length (levels (mem_pool_info Va pa))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_mempool_info</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
        inv_mempool_info Va &#10233; inv_mempool_info x&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>inv_mpinfo_inv_mpinfo_stm4</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>gvars_conf_stb_inv_mpinf</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233; (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
      length (levels (mem_pool_info x pa)) = length (levels (mem_pool_info Va pa))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233; (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
      max_sz (mem_pool_info x pa) = max_sz (mem_pool_info Va pa)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233; (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
      buf (mem_pool_info x pa) = buf (mem_pool_info Va pa)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;pa &#8800; p &#10230; mem_pool_info Va pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
   from_l x = from_l Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lvars_nochange</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;t&#39; &#8800; t &#10233; lvars_nochange t&#39; Va (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_tick</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;tick Va = tick (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def_frnode</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_mpls</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233; (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233; p &#8712; mem_pools x&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_rf</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;rf (mp_alloc_stm4_pre_precond_f Va t p) t &#10233; rf Va t&quot;</span></span></span><span>
</span><span> </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_ret</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;mempoolalloc_ret Va = mempoolalloc_ret (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_tmout</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;tmout Va = tmout (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (mp_alloc_stm4_pre_precond_f Va t p) = lsizes Va&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocl</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l (mp_alloc_stm4_pre_precond_f Va t p) = alloc_l Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p) = from_l Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_freel</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;free_l (mp_alloc_stm4_pre_precond_f Va t p) = free_l Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_blk</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;blk (mp_alloc_stm4_pre_precond_f Va t p) = blk Va&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_level_set_bit_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i1&#8800;i&#39; &#10233;
       levels ((set_bit mp_info p i&#39; j&#39; b) p)!i1 = levels (mp_info p)!i1&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_set_bit_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i1&#8800;i&#39; &#10233;
       bits (levels ((set_bit mp_info p i&#39; j&#39; b) p)!i1) = bits (levels (mp_info p)!i1)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_level_set_bit_l</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_set_bit_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;
       j1&#8800;j&#39; &#10233;
       bits (levels ((set_bit mp_info p i&#39; j&#39; b) p)!i1)!j1 = bits (levels (mp_info p)!i1)!j1&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_get_bit_neq</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span> </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>list_update_beyond</span><span> </span><span>not_less</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>set_bit_set_bit</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;l1&#8800;l2 &#8744; b1&#8800;b2 &#10233;
   set_bit_s (set_bit_s Va p l1 b1 st1) p l2 b2 st2 =
     set_bit_s ((set_bit_s Va p l2 b2 st2)) p l1 b1 st1&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b1=b2&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>list_update_swap</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>list_update_swap</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;l1=l2&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;l1&lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>list_update_swap</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>get_bit_set_bit_set_bit</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l1&#8800;l2 &#8744; b1&#8800;b2&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l1 &lt; length (levels ((mem_pool_info Va) p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b1 &lt; length (bits (levels ((mem_pool_info Va) p) ! l1))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (set_bit_s (set_bit_s Va p l1 b1 st1) p l2 b2 st2) p l1 b1 = st1&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a1&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l1 &lt; length (levels ((mem_pool_info (set_bit_s Va p l2 b2 st2)) p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a2&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b1 &lt; length (bits (levels ((mem_pool_info (set_bit_s Va p l2 b2 st2)) p) ! l1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span> </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>a1</span><span>
</span><span>       </span><span>length_list_update</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_get_bit_eq2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1&#39;</span><span> </span><span>a2&#39;</span><span class="delimiter">]</span><span> </span><span>set_bit_set_bit</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_s_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_same_bits</span><span class="delimiter">:</span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>       </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i1=(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i2 = (nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Va&#39; = mp_alloc_stm4_pre_precond_f Va t p&quot;</span></span></span><span>
</span><span>     </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i j. &#172;((i=i1) &#8744;(i=i2)) &#10230;
        get_bit (mem_pool_info Va&#39;) p i j  = get_bit (mem_pool_info Va) p i j&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>set_bit_get_bit_neq</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f</span><span class="delimiter">:</span><span>
</span><span>       </span><span class="string"><span class="delete"><span class="delete">&quot;i1=(nat (from_l Va t)) &#10233;
       j1= (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) &#10233;
       i2 = (nat (from_l Va t + 1)) &#10233;
       j2 = (4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) &#10233;
       Va&#39; = mp_alloc_stm4_pre_precond_f Va t p &#10233;
      &#8704;i j. &#172;((i=i1 &#8743; j=j1) &#8744;(i=i2 &#8743; j=j2)) &#10230;
             get_bit (mem_pool_info Va&#39;) p i j  = get_bit (mem_pool_info Va) p i j&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>set_bit_get_bit_neq</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span class="delimiter">+</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>      </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((l=(nat (from_l Va t)) &#8743; b=(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) &#8744;
                   (l=(nat (from_l Va t + 1)) &#8743; b=(4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(get_bit_s Va p l b = get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p l b)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f11</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=(nat (from_l Va t)) &#8743; b=(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &#8805; length (levels (mem_pool_info Va p)) &#8744;
               b&#8805;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p l b = get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p l b&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span>
</span><span>     </span><span>list_update_beyond</span><span> </span><span>not_less</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f12</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=(nat (from_l Va t + 1)) &#8743; b=4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &#8805; length (levels (mem_pool_info Va p)) &#8744;
               b&#8805;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p l b = get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p l b&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>list_update_beyond</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span> </span><span>length_list_update</span><span> </span><span>list_update_beyond</span><span>
</span><span>     </span><span>not_less</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &#8805; length (levels (mem_pool_info Va p)) &#8744;
               b&#8805;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p l b = get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p l b &quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; ((l=(nat (from_l Va t + 1)) &#8743;
                 b=4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) &#8744;
               (l=(nat (from_l Va t)) &#8743; b=(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>intro</span><span class="delimiter">:</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f11</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f12</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_divided</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=(nat (from_l Va t)) &#8743; b=(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(from_l Va t) &#8805; 0&quot;</span></span></span><span>
</span><span>        </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p l b = DIVIDED&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;l &#8800; nat (from_l Va t + 1) &#8744; b &#8800; 4*b&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a3</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>   </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a3</span><span> </span><span>set_bit_get_bit_eq2</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>set_bit_get_bit_neq</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_allocating</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=(nat (from_l Va t + 1)) &#8743; b=4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>          </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(from_l Va t) &#8805; 0&quot;</span></span></span><span>
</span><span>        </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p l b = ALLOCATING&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?Va</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;set_bit_s Va p (nat (from_l Va t))
         (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) DIVIDED&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a1&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info ?Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a2&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info ?Va p) ! l))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a0</span><span> </span><span>a3</span><span> </span><span>eq_nat_nat_iff</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>set_bit_get_bit_eq2</span><span> </span><span>a3</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_s_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>set_bit_get_bit_eq</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>eq_free_list_set_bit_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;
       free_list (levels ((set_bit mp_info p i&#39; j&#39; b) p)!i1) = free_list (levels (mp_info p)!i1)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>set_bit_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i&#39;&lt; length (levels (mp_info p))&quot;</span></span></span><span class="delimiter">;</span><span> </span><span>auto</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_pool_lvl.surjective</span><span> </span><span>Mem_pool_lvl.update_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>nth_list_update_eq</span><span> </span><span>nth_list_update_neq</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! l) =
       free_list (levels (mem_pool_info Va p) ! l)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>eq_free_list_set_bit_l</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_i</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(i  (mp_alloc_stm4_pre_precond_f Va t p)) t = Suc 0 &#8743;
       (&#8704;t&#39;. t&#39;&#8800;t &#10230; (i  (mp_alloc_stm4_pre_precond_f Va t p)) t&#39; = (i Va) t&#39;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(bn (mp_alloc_stm4_pre_precond_f Va t p)) t =
       block_num (mem_pool_info Va p) (blk Va t) ((lsizes Va t)!(nat (from_l Va t)))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocating</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;
(allocating_node  (mp_alloc_stm4_pre_precond_f Va t p)) t =
  Some &#10631;pool = p, level = nat (from_l Va t + 1),
        block = 4 * block_num (mem_pool_info Va p) (blk Va t) ((lsizes Va t)!(nat (from_l Va t))),
        data = blk Va t &#10632; &quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>get_bit_x_l_b</span><span class="delimiter">:</span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=(nat (from_l (Va::State) t )) &#8743; b=(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(from_l Va t) &#8805; 0&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l Va t + 1) &#10230;
         levels (mem_pool_info x p) ! jj =
         levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span>
</span><span>     </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p l b = DIVIDED&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_divided</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>get_bit_x_l1_b4</span><span class="delimiter">:</span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=(nat (from_l (Va::State) t + 1)) &#8743; b=4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(from_l Va t) &#8805; 0&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
        list_updates_n
          (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
               nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
          (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span>
</span><span>     </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p l b = ALLOCATING&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_allocating</span><span>
</span><span>       </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span>
</span><span>       </span><span>mp_alloc_stm4_pre_froml</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>lessI</span><span> </span><span>list_updates_n_neq</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>get_bit_x_l1_b41</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l=(nat (from_l (Va::State) t + 1)) &#8743;
               (b=Suc(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) &#8744;
                b=Suc(Suc(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))) &#8744;
                b=Suc(Suc(Suc(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(from_l Va t) &#8805; 0&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l Va t + 1) &#10230;
         levels (mem_pool_info x p) ! jj =
         levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
        list_updates_n
          (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
               nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
          (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a5</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span>
</span><span>     </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p l b = FREE&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>a5</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span>
</span><span>       </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>Suc_numeral</span><span> </span><span>add_2_eq_Suc</span><span> </span><span>add_Suc_right</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add.commute</span><span> </span><span>lessI</span><span> </span><span>less_add_same_cancel2</span><span>
</span><span>             </span><span>list_updates_n_eq</span><span> </span><span>mult.commute</span><span> </span><span>nat_less_le</span><span> </span><span>neq0_conv</span><span> </span><span>not_le</span><span> </span><span>semiring_norm</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>get_bit_x_l1_b41&#39;</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l=(nat (from_l (Va::State) t + 1)) &#8743;
               (b=(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) + 1 &#8744;
                b=(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))+2 &#8744;
                b=(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))+3)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(from_l Va t) &#8805; 0&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l Va t + 1) &#10230;
         levels (mem_pool_info x p) ! jj =
         levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
        list_updates_n
          (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
               nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
          (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a5</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span>
</span><span>     </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p l b = FREE&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>a5</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span>
</span><span>       </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add.right_neutral</span><span> </span><span>less_not_refl</span><span> </span><span>list_updates_n_eq</span><span> </span><span>mult.commute</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>not_less</span><span> </span><span>zero_less_numeral</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add.commute</span><span> </span><span>add_Suc</span><span> </span><span>less_Suc_eq</span><span> </span><span>less_add_same_cancel2</span><span> </span><span>list_updates_n_eq</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span> </span><span>mult.commute</span><span> </span><span>nat_less_le</span><span> </span><span>numeral_3_eq_3</span><span class="delimiter">)</span><span> </span><span class="delimiter">+</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>get_bit_x_stm4_pre_eq</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>      </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (Va::State) t + 1) &#10230;
         levels (mem_pool_info x p) ! jj =
         levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
        list_updates_n
          (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
               nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
          (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>       </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l = nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;b1 = (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b2 = Suc (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b3  = Suc (Suc (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i j. &#172;((i=l &#8743; j=b1) &#8744;(i=l &#8743; j=b2) &#8744; (i=l &#8743; j=b3)) &#10230;
    get_bit_s x p i j = get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p i j&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>a5</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span> </span><span>eval_nat_numeral</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span>
</span><span>     </span><span>less_Suc_eq</span><span> </span><span>list_updates_n_neq</span><span> </span><span>not_less</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f_x</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (Va::State) t + 1) &#10230;
         levels (mem_pool_info x p) ! jj =
         levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
        list_updates_n
          (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
               nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
          (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i1=(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j1= (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i2 = nat (from_l Va t + 1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j2 = (4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j3 = Suc(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j4 = Suc(Suc(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j5 = Suc(Suc(Suc(4*(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))))&quot;</span></span></span><span>
</span><span>   </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;i j. &#172;((i=i1 &#8743; j=j1) &#8744;(i=i2 &#8743; j=j2) &#8744; (i=i2 &#8743; j=j3)&#8744; (i=i2 &#8743; j=j4)&#8744; (i=i2 &#8743; j=j5)) &#10230;
             get_bit_s x p i j  = get_bit_s Va p i j&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span>a8</span><span>  </span><span>get_bit_x_stm4_pre_eq</span><span>
</span><span>        </span><span>same_bit_mp_alloc_stm4_pre_precond_f</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>i</span><span> </span><span>j</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((i=i1 &#8743; j=j1) &#8744;(i=i2 &#8743; j=j2) &#8744; (i=i2 &#8743; j=j3)&#8744; (i=i2 &#8743; j=j4)&#8744; (i=i2 &#8743; j=j5))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p i j =
         get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p i j&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span> </span><span>a2</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>a5</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">also</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i j =
         get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p i j&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span>a8</span><span>  </span><span>get_bit_x_stm4_pre_eq</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a1</span><span class="delimiter">]</span><span>
</span><span>           </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span>  </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">finally</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i j = get_bit_s Va p i j &quot;</span></span></span><span> </span><span class="keyword1"><span class="command">.</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>       </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l Va t + 1) &#10230;
         levels (mem_pool_info x p) ! jj =
         levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>     </span><span>a1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
        list_updates_n
          (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
               nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
          (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((l=(nat (from_l Va t)) &#8743; b=(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) &#8744;
           (l=(nat (from_l Va t + 1)) &#8743; b=(4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))) &#8744;
           (l=(nat (from_l Va t + 1)) &#8743; b=Suc((4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))) &#8744;
           (l=(nat (from_l Va t + 1)) &#8743; b=Suc(Suc((4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))))&#8744;
           (l=(nat (from_l Va t + 1)) &#8743; b=Suc(Suc(Suc((4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))))))))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(get_bit_s x p l b = get_bit_s Va p l b)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a1</span><span class="delimiter">]</span><span> </span><span>a2</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_list_x</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">shows</span></span><span class="string"><span class="delete"><span class="delete">&quot;
  free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) = (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))@
        [lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             2 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
             lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t]&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>numeral_3_eq_3</span><span> </span><span>numeral_Bit0</span><span> </span><span>inserts_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>listx1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;
jj =  length (free_list (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
        nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1))) &#10233;
free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 (free_list (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))@
        [lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
         lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 2 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
          lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t] &#10233;
 free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1))! jj =
  lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>listx3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;
jj =  Suc(Suc (length (free_list (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
        nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1))))) &#10233;
free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 (free_list (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))@
        [lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
         lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 2 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
          lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t] &#10233;
 free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1))! jj =
  lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>nth_append</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>set_free_x_va</span><span class="delimiter">:</span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">shows</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;set (free_list (levels (mem_pool_info x p) ! nat (from_l Va t + 1))) =
          set (free_list (levels (mem_pool_info Va p) ! nat (from_l Va t + 1))) &#8746;
          {lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             2 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
             lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t}&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l Va t + 1)) =
         (free_list
    (levels (mem_pool_info Va p) !
     nat (from_l Va t + 1)))@
        [lsizes Va t !
             nat (from_l Va t + 1) *
             1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l Va t + 1) *
             2 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
             lsizes Va t !
             nat (from_l Va t + 1) *
             3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_list_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span> </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>empty_set</span><span> </span><span>list.simps</span><span class="delimiter">(</span><span>15</span><span class="delimiter">)</span><span> </span><span>set_append</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_list_x_subset_va</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;set (free_list (levels (mem_pool_info Va p) ! nat (from_l Va t + 1))) &#8838;
        set (free_list (levels (mem_pool_info x p) ! nat (from_l Va t + 1)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l Va t + 1)) =
         (free_list
    (levels (mem_pool_info Va p) !
     nat (from_l Va t + 1)))@
        [lsizes Va t !
             nat (from_l Va t + 1) *
             1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l Va t + 1) *
             2 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
             lsizes Va t !
             nat (from_l Va t + 1) *
             3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_list_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span> </span><span>mp_alloc_stm4_pre_froml</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span>  </span><span>free_level_x_va</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>    </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj =
       levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      free_list (levels (mem_pool_info x p) !jj) = free_list (levels (mem_pool_info Va p)! jj)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>assms</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_bitmap_not_free</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(get_bit_s Va p l b &#8800; FREE)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>              </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>              </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;b&lt;length (bits (levels (mem_pool_info Va p) ! l))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>              </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(from_l Va t) &#8805; 0&quot;</span></span></span><span>
</span><span>            </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(get_bit_s (mp_alloc_stm4_pre_precond_f Va t p) p l b &#8800; FREE)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a3</span><span>  </span><span>same_bit_mp_alloc_stm4_pre_precond_divided</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_allocating</span><span>
</span><span>        </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>11</span><span class="delimiter">)</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>17</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1orj1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &#8800; ?i2 &#8744; ?j1 &#8800; ?j2&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a3</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((l=?i1 &#8743; b=?j1) &#8744;(l=?i2 &#8743; b=?j2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span> </span><span>a0</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=?i1 &#8743; b=?j1)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_divided</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a00</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a3</span><span class="delimiter">]</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(l=?i2 &#8743; b=?j2)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_allocating</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a00</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a3</span><span class="delimiter">]</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_pre_inv_nmax</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa) * 4 ^ ii =
       n_max (mem_pool_info Va pa) * 4 ^ ii&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>allocating_next_notexists</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap Va &#10233;
       p&#8712;mem_pools Va &#10233;
      ii &lt; length (levels (mem_pool_info Va p)) &#10233;
      jj &lt; length (bits (levels (mem_pool_info Va p) ! ii)) &#10233;
      get_bit_s Va p ii jj = ALLOCATING &#10233;
      ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii + 1) (jj * 4)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap_def</span><span>  </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>block_n</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>    </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;OK &#8804; from_l Va t&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) = n&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#8707;n&gt;NULL. max_sz (mem_pool_info Va p) = 4 * n * 4 ^ n_levels (mem_pool_info Va p)) &#8743;
        NULL &lt; n_max (mem_pool_info Va p) &#8743;
        NULL &lt; n_levels (mem_pool_info Va p) &#8743; n_levels (mem_pool_info Va p) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>mp_alloc_stm3_lm2_inv_1_2</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span class="delimiter">]</span><span>  </span><span>nat_less_iff</span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>block_num_def</span><span>  </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>less_numeral_extra</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>addr</span><span class="delimiter">::</span><span class="string"><span class="delete"><span class="delete">&quot;nat &#8658; nat &#8658; nat &#8658; nat &#8658; nat&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;addr m_size init l n &#8801; init + n *(m_size div 4 ^ l)&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>next_addr</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat &#8658; nat &#8658; nat &#8658; nat &#8658; nat&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;next_addr m_size c_addr l n &#8801; (m_size div 4 ^ (l + 1))*n + c_addr&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>next_level_addr</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>   </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;m. m_size = m*4^ p&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>   </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &gt; l+1&quot;</span></span></span><span>
</span><span> </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;next_addr m_size (addr m_size init l n) l ch = addr m_size init (l+1) (n*4 + ch)&quot;</span></span></span><span>
</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>next_addr_def</span><span> </span><span>addr_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span class="delimiter">(</span><span>induct</span><span> </span><span>ch</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>0</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?case</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>dvd_mult_div_cancel</span><span> </span><span>dvd_triv_right</span><span> </span><span>less_imp_le_nat</span><span> </span><span>mult.commute</span><span> </span><span>mult.left_commute</span><span> </span><span>nonzero_mult_div_cancel_left</span><span> </span><span>power_Suc0_right</span><span>
</span><span>           </span><span>power_add</span><span> </span><span>power_le_dvd</span><span> </span><span>power_not_zero</span><span> </span><span>zero_neq_numeral</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Suc</span><span> </span><span>ch</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>m</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;m_size = m*(4::nat) ^ p&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?case</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>next_level_addr_eq1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>   </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;m. m_size = m*4^ p&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>   </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &gt; l+1&quot;</span></span></span><span>
</span><span> </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;next_addr m_size (addr m_size init l n) l 0 = addr m_size init l n&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>next_level_addr</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>next_addr_def</span><span> </span><span>addr_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>next_level_addr_eq</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>   </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;m. m_size = m*4^ p&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>   </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &gt; l+1&quot;</span></span></span><span>
</span><span> </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; addr m_size init (l + 1) (n * 4) = addr m_size init l n&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>next_level_addr</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a1</span><span class="delimiter">]</span><span> </span><span>next_level_addr_eq1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>diff_n_m_addr</span><span class="delimiter">:</span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n&#8800;m &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;m_size &#8805; 4^l&quot;</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;addr m_size init l n &#8800; addr m_size init l m &quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Euclidean_Division.div_eq_0_iff</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>lsizes_addr</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;l+1 &lt;length (lsizes Va t)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. (lsizes Va t ! (l+1)) * j +
           (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ l)) =
       addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (l + 1)
        ((block_num (mem_pool_info Va p) (buf (mem_pool_info Va p) +
                  n * (max_sz (mem_pool_info Va p) div 4 ^ l))
       (lsizes Va t ! l))*4 + j)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span>
</span><span>    </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?blk</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ l))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>m</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>max_sz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) = 4 * m * 4 ^ n_levels (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a3</span><span> </span><span>a0</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>b1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?blk =
       addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) l
            (block_num (mem_pool_info Va p) ?blk (lsizes Va t ! l))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>    </span><span>a4</span><span>   </span><span>a0</span><span> </span><span>a1</span><span>  </span><span>a3</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span> </span><span>block_num_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span>  </span><span>add.commute</span><span> </span><span>add_lessD1</span><span> </span><span>div_mult_self_is_m</span><span>
</span><span>            </span><span>inv_mempool_info_maxsz_align4</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>b2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(lsizes Va t ! (l+1)) * j + ?blk =
                   addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (l+1)
                          ((block_num (mem_pool_info Va p) ?blk (lsizes Va t ! l))*4 + j)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>a4</span><span> </span><span>inv_mempool_info_maxsz_align4</span><span> </span><span>max_sz</span><span> </span><span>b1</span><span> </span><span>next_level_addr</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>next_addr_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>le_eq_less_or_eq</span><span> </span><span>le_less_trans</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_list_updates_inv1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i x t = 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a19</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a22</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span>   </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a23</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a24</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; &#8704;j&lt;length (bits (levels (mem_pool_info x p) ! ii)).
       (get_bit_s x p ii j = FREE) =
       (buf (mem_pool_info x p) + j * (max_sz (mem_pool_info x p) div 4 ^ ii)
        &#8712; set (free_list (levels (mem_pool_info x p) ! ii)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span class="keyword1"><span class="command">{</span></span><span>
</span><span> </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&lt;length ?bts&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a00&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j &lt; length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a13</span><span> </span><span>a18</span><span> </span><span>length_list_update_n</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;j&lt;length (bits (levels (mem_pool_info Va p) ! ii)).
           (get_bit_s Va p ii j = FREE) =
             (buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                &#8712; set (free_list (levels (mem_pool_info Va p) ! ii))))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>a0</span><span>  </span><span>a22</span><span>  </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_freelist_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a9</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_eq</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
      length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a22</span><span> </span><span>a8</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>get_bits_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(get_bit_s Va p ii j = FREE) =
               (buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                  &#8712; set (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span>  </span><span>a00</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>mem_pools</span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a19&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a22</span><span> </span><span>mp_alloc_stm4_inv_mif_len</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>len_levels</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&#8800;?i1 &#8743; ii&#8800;?i2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii j  = get_bit_s Va p ii j&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a9</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a9</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a18</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! ii) =
                 free_list (levels (mem_pool_info Va p) ! ii)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_level_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span>  </span><span>a03</span><span> </span><span>a9</span><span> </span><span>from_l</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bits_va</span><span> </span><span>eq_get_bit_i_j</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>buf</span><span> </span><span>maxsz</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii=?i1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>free</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! ii) =
                 free_list (levels (mem_pool_info Va p) ! ii)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_level_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span>  </span><span>a03</span><span> </span><span>a9</span><span> </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8800;?j1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii j  = get_bit_s Va p ii j&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a9</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a18</span><span class="delimiter">]</span><span>
</span><span>               </span><span>a03</span><span> </span><span>from_l_gt0</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eq_nat_nat_iff</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>buf</span><span>  </span><span>get_bits_va</span><span> </span><span>maxsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j=?j1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = DIVIDED)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l_b</span><span> </span><span>a03</span><span> </span><span>a13</span><span> </span><span>a00</span><span> </span><span>a22</span><span>  </span><span>len_levels</span><span>
</span><span>             </span><span>len_eq</span><span> </span><span>a13</span><span>   </span><span>from_l</span><span> </span><span>from_l_gt0</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a9</span><span> </span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii) &#8713;
           set (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bits_va</span><span>  </span><span>a03</span><span> </span><span>a20</span><span> </span><span>a21</span><span> </span><span>a04</span><span> </span><span>a7</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>17</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>buf</span><span> </span><span>free</span><span> </span><span>maxsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii=?i2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>block_n</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p)
                   (blk Va t) (lsizes Va t ! nat (from_l Va t))) = n&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) =
                 ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^
                   (nat (from_l Va t))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a14</span><span> </span><span>lsizes_x_va</span><span> </span><span>a16</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>a9</span><span> </span><span>from_l</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_n</span><span> </span><span>a21</span><span> </span><span>a0</span><span> </span><span>a0</span><span>  </span><span>a7</span><span>   </span><span>a3</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>m</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>max_sz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) = 4 * m * 4 ^ n_levels (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>a0</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>ls</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ ii dvd 4 * m * 4 ^ n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a22</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>dvd_triv_right</span><span>  </span><span>inv_mempool</span><span> </span><span>len_levels</span><span> </span><span>less_imp_le_nat</span><span> </span><span>power_le_dvd</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>b0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii) =
          addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) ii j&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 1&lt; length (lsizes Va t)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>b2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. (lsizes Va t ! nat (from_l Va t + 1)) * j + blk Va t =
                   addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (nat (from_l Va t + 1))
                          ((block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))*4 + j)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizes_addr</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a14</span><span> </span><span>a17</span><span> </span><span>a21</span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">]</span><span> </span><span>a7</span><span> </span><span>from_l_gt0</span><span> </span><span>block_n</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Suc_nat_eq_nat_zadd1</span><span> </span><span>add.commute</span><span> </span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>b2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
                      nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * j +
                        blk (mp_alloc_stm4_pre_precond_f Va t p) t =
                   addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (nat (from_l Va t + 1))
                          ((block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))*4 + j)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm4_blk</span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8800;?j2 &#8743; j&#8800;Suc ?j2 &#8743; j&#8800;Suc (Suc ?j2) &#8743; j&#8800;Suc (Suc (Suc ?j2))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii j  = get_bit_s Va p ii j&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a9</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a18</span><span class="delimiter">]</span><span>
</span><span>               </span><span>a03</span><span> </span><span>from_l_gt0</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eq_nat_nat_iff</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; get_bit_s Va p ii j = FREE&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                  &#8712; set (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>get_bits_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_list_x_subset_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span> </span><span>a03</span><span> </span><span>buf</span><span> </span><span>maxsz</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ii j &#8800; FREE&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>not_in_free_Va</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                  &#8713; set (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>get_bits_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8713; set ?fl)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;k. k&lt;4 &#10230; (buf ?mp + j * (max_sz ?mp div 4 ^ ii)) &#8800;
                   lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
                             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * k +
                            blk (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>diff_n_m_addr</span><span> </span><span>b2</span><span> </span><span>b0</span><span>  </span><span>a03</span><span> </span><span>a04</span><span> </span><span>Euclidean_Division.div_eq_0_iff</span><span> </span><span>buf</span><span> </span><span>inv_mempool</span><span>
</span><span>                 </span><span>ls</span><span> </span><span>max_sz</span><span> </span><span>maxsz</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Groups.mult_ac</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>add.right_neutral</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span>
</span><span>               </span><span>dvd_div_mult_self</span><span> </span><span>less_2_cases</span><span> </span><span>less_Suc_eq</span><span> </span><span>div_greater_zero_iff</span><span>
</span><span>               </span><span>mult_is_0</span><span> </span><span>neq0_conv</span><span> </span><span>numeral_Bit0</span><span> </span><span>power_not_zero</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>buf</span><span> </span><span>maxsz</span><span> </span><span>not_in_free_Va</span><span> </span><span>set_free_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">,</span><span> </span><span>simplified</span><span class="delimiter">]</span><span> </span><span>a03</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8713; set ?fl)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a03</span><span> </span><span>buf</span><span> </span><span>maxsz</span><span> </span><span>a04</span><span>  </span><span>set_free_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>eq_get_bit_i_j</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j=?j2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a03&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii = nat (from_l x t + 1) &#8743;
                    j = 4*block_num (mem_pool_info x p) (blk x t) (lsizes x t ! nat (from_l x t))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a22</span><span> </span><span>a23</span><span> </span><span>a24</span><span> </span><span>from_l</span><span> </span><span>buf</span><span> </span><span>from_l</span><span> </span><span>a03</span><span>
</span><span>        </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>block_num_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm4_pre_precond_f_blk</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = ALLOCATING)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span>  </span><span>a22</span><span> </span><span>a00</span><span> </span><span>a03</span><span>  </span><span>len_levels</span><span> </span><span>a04</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>get_bit_x_l1_b4</span><span> </span><span>len_eq</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a04</span><span> </span><span>a18</span><span> </span><span>get_bit_x_l1_b4</span><span> </span><span>len_eq</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>bts_j_not_free</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j &#8800; FREE)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>not_in_free_Va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii) &#8713;
               set (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a20</span><span> </span><span>a21</span><span> </span><span>a7</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span>
</span><span>           </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) (?i1 + 1) (?j1 * 4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))-1&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a19&#39;</span><span> </span><span>from_l_gt0</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>inv_mempool</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt;  length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>calculation</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span>inv_mempool</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>alloc_i1_j1</span><span> </span><span>a21</span><span> </span><span>a19&#39;</span><span>   </span><span>a00&#39;</span><span>  </span><span>a0</span><span>  </span><span>a03</span><span> </span><span>a04</span><span>
</span><span>            </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>inv_mempool</span><span> </span><span>less_Suc_eq</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(get_bit_s Va p ii j = NOEXIST)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>from_l_gt0</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mult.commute</span><span> </span><span>nat_add_distrib</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bits_va</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8713; set ?fl)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;k. k&gt;0 &#8743; k&lt;4 &#10230; (buf ?mp + j * (max_sz ?mp div 4 ^ ii)) &#8800;
                 lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
                           nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * k +
                          blk (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>diff_n_m_addr</span><span> </span><span>b2</span><span> </span><span>b0</span><span>  </span><span>a03</span><span> </span><span>a04</span><span> </span><span>buf</span><span> </span><span>inv_mempool</span><span>
</span><span>                </span><span>maxsz</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a19&#39;</span><span> </span><span>add_cancel_right_right</span><span> </span><span>div_greater_zero_iff</span><span>
</span><span>                 </span><span>mp_alloc_stm3_lm2_inv_1_2</span><span> </span><span>mult.commute</span><span> </span><span>neq0_conv</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>buf</span><span> </span><span>maxsz</span><span> </span><span>not_in_free_Va</span><span> </span><span>set_free_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">,</span><span> </span><span>simplified</span><span class="delimiter">]</span><span> </span><span>a03</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>bts_j_not_free</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j=Suc ?j2 &#8744; j = Suc (Suc ?j2) &#8744; j = Suc (Suc (Suc ?j2))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a04&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j=(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)) * 4 + 1) &#8744;
                      j = (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)) * 4 + 2) &#8744;
                     j = (block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)) * 4 + 3)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l1_b41</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjI</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a03</span><span> </span><span>a04</span><span class="delimiter">]</span><span> </span><span>from_l_gt0</span><span> </span><span>_</span><span> </span><span>a18</span><span> </span><span>a19&#39;</span><span> </span><span>a00&#39;</span><span> </span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a13</span><span> </span><span>a9</span><span> </span><span>from_l</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span>  </span><span>a04&#39;</span><span class="delimiter">[</span><span>simplified</span><span class="delimiter">]</span><span> </span><span>set_free_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>b2</span><span> </span><span>buf</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span>maxsz</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>b0</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>buf</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span>maxsz</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span>a03</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ ii) &#8712; set ?fl)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_list_updates_inv2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a5</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a14</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span>   </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; &#8704;j&lt;length (free_list (levels (mem_pool_info x p) ! ii)).
       &#8707;n&lt;n_max (mem_pool_info x p) * 4 ^ ii.
          free_list (levels (mem_pool_info x p) ! ii) ! j =
          buf (mem_pool_info x p) + n * (max_sz (mem_pool_info x p) div 4 ^ ii)&quot;</span></span></span><span>
</span><span>
</span><span> </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&lt;length ?fl&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! ii)).
             &#8707;n&lt;n_max (mem_pool_info Va p) * 4 ^ ii.
               free_list (levels (mem_pool_info Va p) ! ii) ! j =
                 buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a15</span><span> </span><span>a0</span><span>  </span><span>a16</span><span>  </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_freelist_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a9</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a12</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_eq</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
      length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a16</span><span> </span><span>a8</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a15</span><span> </span><span>mem_pools</span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a15&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a16</span><span> </span><span>mp_alloc_stm4_inv_mif_len</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>len_levels</span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nmax</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info x p) = n_max (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a8</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm4_nmax</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&#8800; ?i2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; &#8707;n&lt;n_max ?mp * 4 ^ ii. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a00</span><span>  </span><span>a10</span><span> </span><span>buf</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span>
</span><span>            </span><span>inv_bitmap2</span><span> </span><span>maxsz</span><span> </span><span>nmax</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span> </span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii= ?i2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 1&lt; length (lsizes Va t)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsize_i</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) =
                 ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^
                   (nat (from_l Va t))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a11</span><span> </span><span>add_lessD1</span><span> </span><span>suc_from_l_lt_lsize</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>block_n</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p)
                   (blk Va t) (lsizes Va t ! nat (from_l Va t))) = n&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_n</span><span> </span><span>a0</span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>a15</span><span> </span><span>a7</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsize_ii</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! ii =
                 ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a11</span><span> </span><span>from_l_gt0</span><span>  </span><span>suc_from_l_lt_lsize</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a03</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&lt; length (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info Va p) ! ii) ! j = ?fl ! j&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span>  </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span class="delimiter">]</span><span> </span><span>a03</span><span>
</span><span>        </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inserts_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>nth_append</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&lt;n_max (mem_pool_info Va p) * 4 ^ ii.
       free_list (levels (mem_pool_info Va p) ! ii) ! j =
       buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ ii)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a04</span><span> </span><span>inv_bitmap2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; &#8707;n&lt;n_max ?mp * 4 ^ ii. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span>   </span><span>buf</span><span> </span><span>maxsz</span><span> </span><span>nmax</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j =  length (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>fl_lsizes</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?fl ! j = lsizes Va t ! nat (from_l Va t + 1) * 1 + blk Va t&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_list_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">]</span><span>  </span><span>a03</span><span> </span><span>a9</span><span>   </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span>
</span><span>         </span><span>nth_append_length</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>lsizes_x_va</span><span> </span><span>mp_alloc_stm4_blk</span><span class="delimiter">)</span><span>
</span><span>       </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?nb</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p)
        (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
        (lsizes Va t ! nat (from_l Va t)) *  4 + 1)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_suc_from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat (from_l Va t) + 1&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>fl_lsizes</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a7</span><span> </span><span>this</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?fl ! j =
             addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (nat (from_l Va t) + 1)
     (block_num (mem_pool_info Va p)
       (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
       (lsizes Va t ! nat (from_l Va t)) * 4 + 1)&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>spec</span><span class="delimiter">[</span><span>OF</span><span> </span><span>lsizes_addr</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a11</span><span> </span><span>a13</span><span> </span><span>a15</span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>1</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
                       n_max (mem_pool_info x p) * 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a15</span><span> </span><span>a0</span><span>
</span><span>         </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a15&#39;</span><span> </span><span>len_eq</span><span> </span><span>nmax</span><span class="delimiter">)</span><span>
</span><span>       </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?nb &lt; n_max (mem_pool_info x p) * 4 ^ ii&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a6</span><span> </span><span>a03</span><span>  </span><span>a0</span><span> </span><span>nmax</span><span>  </span><span>lsize_ii</span><span> </span><span>lsize_i</span><span> </span><span>eq_suc_from_l</span><span>
</span><span>                </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>a0</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>block_num_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;?nb &lt; n_max ?mp * 4 ^ ii &#8743; ?fl ! j = buf ?mp + ?nb * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_n</span><span> </span><span>a7</span><span> </span><span>buf</span><span> </span><span>nmax</span><span> </span><span>maxsz</span><span> </span><span>a6</span><span> </span><span>a03</span><span> </span><span>eq_suc_from_l</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&lt;n_max ?mp * 4 ^ ii. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>     </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>     </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j =  Suc (length (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>fl_lsizes</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?fl ! j = lsizes Va t ! nat (from_l Va t + 1) * 2 + blk Va t&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_list_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">]</span><span>  </span><span>a03</span><span> </span><span>a9</span><span>   </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span>
</span><span>         </span><span>nth_append_length</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>lsizes_x_va</span><span> </span><span>mp_alloc_stm4_blk</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add.right_neutral</span><span> </span><span>add_Suc_right</span><span> </span><span>nth_Cons_Suc</span><span> </span><span>nth_append_length_plus</span><span class="delimiter">)</span><span>
</span><span>       </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?nb</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p)
        (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
        (lsizes Va t ! nat (from_l Va t)) *  4 + 2)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_suc_from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat (from_l Va t) + 1&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>fl_lsizes</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a7</span><span> </span><span>this</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?fl ! j =
             addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (nat (from_l Va t) + 1)
     (block_num (mem_pool_info Va p)
       (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
       (lsizes Va t ! nat (from_l Va t)) * 4 + 2)&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>spec</span><span class="delimiter">[</span><span>OF</span><span> </span><span>lsizes_addr</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a11</span><span> </span><span>a13</span><span> </span><span>a15</span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>2</span><span> </span><span>n</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>       </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
                       n_max (mem_pool_info x p) * 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a15</span><span> </span><span>a0</span><span>
</span><span>         </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a15&#39;</span><span> </span><span>len_eq</span><span> </span><span>nmax</span><span class="delimiter">)</span><span>
</span><span>       </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?nb &lt; n_max (mem_pool_info x p) * 4 ^ ii&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a6</span><span> </span><span>a03</span><span>  </span><span>a0</span><span> </span><span>nmax</span><span>  </span><span>lsize_ii</span><span> </span><span>lsize_i</span><span>  </span><span>eq_suc_from_l</span><span>
</span><span>                </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>a0</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>block_num_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;?nb &lt; n_max ?mp * 4 ^ ii &#8743; ?fl ! j = buf ?mp + ?nb * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_n</span><span> </span><span>a7</span><span> </span><span>buf</span><span> </span><span>nmax</span><span> </span><span>maxsz</span><span> </span><span>a6</span><span> </span><span>a03</span><span> </span><span>eq_suc_from_l</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&lt;n_max ?mp * 4 ^ ii. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>     </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>     </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j =  Suc (Suc (length (free_list (levels (mem_pool_info Va p) ! ii))))&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>fl_lsizes</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?fl ! j = lsizes Va t ! nat (from_l Va t + 1) * 3 + blk Va t&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_list_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">]</span><span>  </span><span>a03</span><span> </span><span>a9</span><span>   </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span>
</span><span>         </span><span>nth_append_length</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>lsizes_x_va</span><span> </span><span>mp_alloc_stm4_blk</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add.right_neutral</span><span> </span><span>add_Suc_right</span><span> </span><span>nth_Cons_Suc</span><span> </span><span>nth_append_length_plus</span><span class="delimiter">)</span><span>
</span><span>       </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?nb</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p)
        (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
        (lsizes Va t ! nat (from_l Va t)) *  4 + 3)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_suc_from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat (from_l Va t) + 1&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>fl_lsizes</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a7</span><span> </span><span>this</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?fl ! j =
             addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (nat (from_l Va t) + 1)
     (block_num (mem_pool_info Va p)
       (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
       (lsizes Va t ! nat (from_l Va t)) * 4 + 3)&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>spec</span><span class="delimiter">[</span><span>OF</span><span> </span><span>lsizes_addr</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a11</span><span> </span><span>a13</span><span> </span><span>a15</span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>3</span><span> </span><span>n</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>       </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
                       n_max (mem_pool_info x p) * 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a15</span><span> </span><span>a0</span><span>
</span><span>         </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a15&#39;</span><span> </span><span>len_eq</span><span> </span><span>nmax</span><span class="delimiter">)</span><span>
</span><span>       </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?nb &lt; n_max (mem_pool_info x p) * 4 ^ ii&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a6</span><span> </span><span>a03</span><span>  </span><span>a0</span><span> </span><span>nmax</span><span>  </span><span>lsize_ii</span><span> </span><span>lsize_i</span><span>  </span><span>eq_suc_from_l</span><span>
</span><span>                </span><span>inv_mempool_info_maxsz_align4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>a0</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>block_num_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>
</span><span>        </span><span class="string"><span class="delete"><span class="delete">&quot;?nb &lt; n_max ?mp * 4 ^ ii &#8743; ?fl ! j = buf ?mp + ?nb * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_n</span><span> </span><span>a7</span><span> </span><span>buf</span><span> </span><span>nmax</span><span> </span><span>maxsz</span><span> </span><span>a6</span><span> </span><span>a03</span><span> </span><span>eq_suc_from_l</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&lt;n_max ?mp * 4 ^ ii. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>     </span><span class="keyword1"><span class="command">}</span></span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;n&lt;n_max ?mp * 4 ^ ii. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>free_list_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">,</span><span>
</span><span>                             </span><span>simplified</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span class="delimiter">]</span><span> </span><span>a03</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; &#8707;n&lt;n_max ?mp * 4 ^ ii. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ ii)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>next_block_less_length_bits</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>  </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n &lt; length (bits (levels pi ! ii))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(ii+1) &lt; length (levels pi)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;i&lt;length (levels pi).
        length (bits (levels pi ! i)) = n_max pi * 4 ^ i)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;4*n + 3 &lt; length (bits (levels pi ! (ii+1)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;n&lt; n_max pi * 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels pi!(ii+1))) = n_max pi * 4 ^(ii+1)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>distinct_lists</span><span class="delimiter">:</span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;distinct l1&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;distinct l2&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;e&#8712;set l2. e &#8713; set l1&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (l1 @ l2)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>induct</span><span> </span><span>l1</span><span class="delimiter">,</span><span> </span><span>auto</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>free_list_updates_inv3</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i x t = 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a19</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a22</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span>   </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a23</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a24</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span class="keyword1"><span class="command">{</span></span><span>
</span><span> </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;j&lt;length (bits (levels (mem_pool_info Va p) ! ii)).
           (get_bit_s Va p ii j = FREE) =
             (buf (mem_pool_info Va p) + j * (max_sz (mem_pool_info Va p) div 4 ^ ii)
                &#8712; set (free_list (levels (mem_pool_info Va p) ! ii))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span>inv_bitmap2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;j&lt;length (free_list (levels (mem_pool_info Va p) ! ii)).
             &#8707;n&lt;n_max (mem_pool_info Va p) * 4 ^ ii.
               free_list (levels (mem_pool_info Va p) ! ii) ! j =
                 buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ ii))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>         </span><span>inv_bitmap3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>a0</span><span>  </span><span>a22</span><span>  </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_freelist_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span class="delimiter">+</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a9</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_eq</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
      length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a22</span><span> </span><span>a8</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>mem_pools</span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a22&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a22</span><span> </span><span>mp_alloc_stm4_inv_mif_len</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>len_levels</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&#8800;?i2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! ii) =
                 free_list (levels (mem_pool_info Va p) ! ii)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>free_level_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span>  </span><span>a03</span><span> </span><span>a9</span><span> </span><span>from_l</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>inv_bitmap3</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii=?i2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>block_n</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p)
                   (blk Va t) (lsizes Va t ! nat (from_l Va t))) = n&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) =
                 ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^
                   (nat (from_l Va t))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a14</span><span> </span><span>lsizes_x_va</span><span> </span><span>a16</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>a9</span><span> </span><span>from_l</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_n</span><span> </span><span>a21</span><span> </span><span>a0</span><span> </span><span>a0</span><span>  </span><span>a7</span><span>   </span><span>a3</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ( nat (from_l Va t )) n = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a20</span><span> </span><span>a13</span><span> </span><span>a21</span><span> </span><span>a7</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>n_len</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n&lt; length (bits (levels (mem_pool_info Va p) ! nat (from_l Va t )))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a22&#39;</span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span>inv_mempool</span><span> </span><span>local.block_n</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ii (n * 4)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>allocating_next_notexists</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a21</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a0</span><span> </span><span>_</span><span> </span><span class="delimiter">]</span><span> </span><span>a21</span><span> </span><span>a0</span><span> </span><span>a03</span><span> </span><span>a21</span><span> </span><span>a0</span><span> </span><span>a22&#39;</span><span>
</span><span>       </span><span>from_l_gt0</span><span> </span><span>from_l_suc</span><span> </span><span>inv_mempool</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ii (n*4 + 1) &#8800; FREE &#8743;
               get_bit_s Va p ii (n*4 + 2) &#8800; FREE &#8743;
               get_bit_s Va p ii (n*4 + 3) &#8800; FREE&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;n*4 + 3 &lt; length (bits (levels (mem_pool_info Va p) ! nat (from_l Va t + 1)))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a22&#39;</span><span> </span><span>n_len</span><span> </span><span>inv_mempool</span><span> </span><span>from_l_gt0</span><span> </span><span>next_block_less_length_bits</span><span> </span><span>from_l_suc</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>not_in_freelist</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(buf (mem_pool_info Va p) + (n*4 + 1) * (max_sz (mem_pool_info Va p) div 4 ^ ii)
        &#8713; set (free_list (levels (mem_pool_info Va p) ! ii))) &#8743;
          (buf (mem_pool_info Va p) + (n*4 + 2) * (max_sz (mem_pool_info Va p) div 4 ^ ii)
        &#8713; set (free_list (levels (mem_pool_info Va p) ! ii))) &#8743;
          (buf (mem_pool_info Va p) + (n*4 + 3) * (max_sz (mem_pool_info Va p) div 4 ^ ii)
        &#8713; set (free_list (levels (mem_pool_info Va p) ! ii)))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>a03</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>add_lessD1</span><span> </span><span>numeral_3_eq_3</span><span>
</span><span>          </span><span>one_add_one</span><span> </span><span>plus_1_eq_Suc</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>21</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>m</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>max_sz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) = 4 * m * 4 ^ n_levels (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>a0</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>ls</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;4 ^ ii dvd 4 * m * 4 ^ n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a22</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>dvd_triv_right</span><span>  </span><span>inv_mempool</span><span> </span><span>len_levels</span><span> </span><span>less_imp_le_nat</span><span> </span><span>power_le_dvd</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 1&lt; length (lsizes Va t)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a4</span><span> </span><span>a5</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>b2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. (lsizes Va t ! nat (from_l Va t + 1)) * j + blk Va t =
                   addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (nat (from_l Va t + 1))
                          ((block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))*4 + j)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsizes_addr</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a14</span><span> </span><span>a17</span><span> </span><span>a21</span><span> </span><span>suc_from_l_lt_lsize</span><span class="delimiter">]</span><span> </span><span>a7</span><span> </span><span>from_l_gt0</span><span> </span><span>block_n</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Suc_nat_eq_nat_zadd1</span><span> </span><span>add.commute</span><span> </span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>b2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
                      nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * j +
                        blk (mp_alloc_stm4_pre_precond_f Va t p) t =
                   addr (max_sz (mem_pool_info Va p)) (buf (mem_pool_info Va p)) (nat (from_l Va t + 1))
                          ((block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))*4 + j)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm4_blk</span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;distinct [lsizes (mp_alloc_stm4_pre_precond_f Va t p) t ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 1 +
     blk (mp_alloc_stm4_pre_precond_f Va t p) t,
     lsizes (mp_alloc_stm4_pre_precond_f Va t p) t ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 2 +
     blk (mp_alloc_stm4_pre_precond_f Va t p) t,
     lsizes (mp_alloc_stm4_pre_precond_f Va t p) t ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 3 +
     blk (mp_alloc_stm4_pre_precond_f Va t p) t]&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>b2</span><span> </span><span>a03</span><span> </span><span>a22&#39;</span><span> </span><span>inv_mempool</span><span> </span><span>mp_alloc_stm3_lm2_inv_1_2</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add_diff_cancel_left&#39;</span><span> </span><span>distinct_length_2_or_more</span><span>
</span><span>               </span><span>distinct_singleton</span><span> </span><span>mult_cancel_right</span><span> </span><span>nat_less_le</span><span> </span><span>num.distinct</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>num.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span>
</span><span>             </span><span>numeral_eq_iff</span><span> </span><span>numeral_eq_one_iff</span><span> </span><span>semiring_norm</span><span class="delimiter">(</span><span>85</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;e&#8712;set [lsizes (mp_alloc_stm4_pre_precond_f Va t p) t ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 1 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
             lsizes (mp_alloc_stm4_pre_precond_f Va t p) t ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 2 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t,
             lsizes (mp_alloc_stm4_pre_precond_f Va t p) t ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) * 3 +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t].
       e &#8713; set (free_list (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>b2</span><span> </span><span>a03</span><span> </span><span>not_in_freelist</span><span> </span><span>local.block_n</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>not_in_freelist</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>12</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>distinct_lists</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv_bitmap3</span><span> </span><span>h1</span><span> </span><span>h2</span><span class="delimiter">]</span><span> </span><span>free_list_x</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a03</span><span> </span><span>eq_free_list_mp_alloc_stm4_pre_precond_f</span><span> </span><span>mp_alloc_stm4_pre_froml</span><span class="delimiter">)</span><span>
</span><span>     </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap_freelist</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a4&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &quot;</span></span></span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a12&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a12&#39;&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i x t = 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a12&#39;&#39;&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a12&#39;&#39;&#39;&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a14</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; inv_mempool_info Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_freelist Va &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_freelist x&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>p&#39;</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39;&#8712;mem_pools x&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p&#8800;p&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&#39; = mem_pool_info Va p&#39;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a11</span><span> </span><span>calculation</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_freelist_mp x p&#39;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a18</span><span> </span><span>a00</span><span>  </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a7</span><span class="delimiter">]</span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a7</span><span class="delimiter">]</span><span>
</span><span>        </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a7</span><span class="delimiter">]</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a8</span><span class="delimiter">]</span><span>  </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a7</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>eq_p</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p=p&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&#39;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a15</span><span> </span><span>eq_p</span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a7</span><span class="delimiter">]</span><span> </span><span>a00</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>i</span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i&lt;length (levels ?mp)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;j&lt;length (bits (levels (mem_pool_info Va p&#39;) ! i)).
                     (get_bit_s Va p&#39; i j = FREE) =
                       (buf (mem_pool_info Va p&#39;) + j * (max_sz (mem_pool_info Va p&#39;) div 4 ^ i)
                          &#8712; set (free_list (levels (mem_pool_info Va p&#39;) ! i))))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                   </span><span>inv_bitmap2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;j&lt;length (free_list (levels (mem_pool_info Va p&#39;) ! i)).
                       &#8707;n&lt;n_max (mem_pool_info Va p&#39;) * 4 ^ i.
                         free_list (levels (mem_pool_info Va p&#39;) ! i) ! j =
                           buf (mem_pool_info Va p&#39;) + n * (max_sz (mem_pool_info Va p&#39;) div 4 ^ i))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                   </span><span>inv_bitmap3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;distinct (free_list (levels (mem_pool_info Va p&#39;) ! i))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a16</span><span> </span><span>eq_p</span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a7</span><span class="delimiter">]</span><span> </span><span>a00</span><span>  </span><span>a01</span><span>   </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a7</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_freelist_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span class="delimiter">+</span><span>
</span><span>        </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! i)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! i)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>f1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;j&lt;length ?bts. (?bts ! j = FREE) = (buf ?mp + j * (max_sz ?mp div 4 ^ i) &#8712; set ?fl))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>free_list_updates_inv1</span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>eq_p</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>f2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; (&#8704;j&lt;length ?fl. &#8707;n&lt;n_max ?mp * 4 ^ i. ?fl ! j = buf ?mp + n * (max_sz ?mp div 4 ^ i))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>free_list_updates_inv2</span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>eq_p</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>f3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;distinct ?fl&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>free_list_updates_inv3</span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>eq_p</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>conjI</span><span class="delimiter">[</span><span>OF</span><span> </span><span>f1</span><span> </span><span>conjI</span><span class="delimiter">[</span><span>OF</span><span> </span><span>f2</span><span> </span><span>f3</span><span class="delimiter">]</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_freelist_mp x p&#39;&quot;</span></span></span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_freelist_mp x p&#39;&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap_freelist_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>noexists_eq_bits</span><span class="delimiter">:</span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span>  </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; jj &#8743; j&#8804; Suc(Suc (Suc jj)) &#10230;
         get_bit_s x p ii j = get_bit_s Va p ii j&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ii jj&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info x p) ii jj&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a1</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(get_bit_s x p ii jj = FREE &#8744; get_bit_s x p ii jj = FREEING &#8744; get_bit_s x p ii jj = ALLOCATED &#8744; get_bit_s x p ii jj = ALLOCATING &#10230;
        (NULL &lt; ii &#10230; get_bit_s x p (ii - 1) (jj div 4) = DIVIDED) &#8743;
        (ii &lt; length (levels (mem_pool_info x p)) - 1 &#10230; noexist_bits (mem_pool_info x p) (ii + 1) (jj * 4)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a5</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a17</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) - 1&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 2&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?j20&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?j2 * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j21&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+1) * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j22&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+2)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j23&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+3)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j24&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+4)*4&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>i1_len</span><span> </span><span>a9</span><span> </span><span>a12</span><span> </span><span>a1</span><span> </span><span>inv</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?btsva</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a01&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>len_levels</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span>
</span><span>   </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j &lt; length (bits (levels (mem_pool_info Va p) ! ii)).
            (?btsva ! j = FREE &#8744; ?btsva ! j = FREEING &#8744; ?btsva ! j = ALLOCATED &#8744; ?btsva ! j = ALLOCATING &#10230;
                  (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
                  &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4) ))
          &#8743; (?btsva ! j = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
          &#8743; (?btsva ! j = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
                &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4))
          &#8743; (?btsva ! j = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv</span><span>  </span><span>mem_pools</span><span> </span><span>a1</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span>   </span><span>a7</span><span> </span><span>a0</span><span> </span><span>a12</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_predi1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &gt; 0 &#10230; get_bit_s Va p (?i1 - 1) (?j1 div 4) = DIVIDED&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>inv</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>nexisti2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2 ?j2&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>         </span><span>alloc_i1_j1</span><span> </span><span>from_l_suc</span><span>  </span><span>i2_len</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>a1</span><span>
</span><span>   </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>add.commute</span><span> </span><span>inv_mempool</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nexisti3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1 &#10230;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (bits (levels (mem_pool_info Va p) ! ?i2)).
                get_bit_s Va p ?i2 j = NOEXIST &#10230; noexist_bits (mem_pool_info Va p) ?i2&#39; (j * 4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i2_len</span><span>
</span><span>           </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>j2_len</span><span> </span><span>nexisti2</span><span> </span><span>Suc_lessD</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span> </span><span>numeral_3_eq_3</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a02&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>a13</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
        length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>  </span><span>a14</span><span> </span><span>a15</span><span> </span><span>length_list_update_n</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(?btsva ! jj = FREE &#8744; ?btsva ! jj = FREEING &#8744; ?btsva ! jj = ALLOCATED &#8744; ?btsva ! jj = ALLOCATING &#10230;
                (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
                &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4) ))
        &#8743; (?btsva ! jj = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
        &#8743; (?btsva ! jj = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
              &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4))
        &#8743; (?btsva ! jj = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>a02&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a05</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((ii=?i1 &#8743; jj=?j1) &#8744;
                 (ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt; ?j2+4) &#8744;
                 (ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;) &#8744;
                 (?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a050&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a051&#39;</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2 + 4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a052&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a053&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; &#172;(?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>a051&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&gt;0 &#10230; get_bit_s x p (ii-1) (jj div 4) = get_bit_s Va p (ii-1) (jj div 4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&gt;0&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; &#172;((ii - 1) = ?i1 &#8743; jj div 4 = ?j1)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>a051&#39;</span><span>  </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; ?j2 &#8743; j&#8804; ?j2+3 &#10230; &#172;((ii - 1) = ?i2 &#8743; jj div 4 = j)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a051&#39;</span><span> </span><span>a052&#39;</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = get_bit_s Va p (ii-1) (jj div 4)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span>
</span><span>         </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii -1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj div 4&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i2_j2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; (jj * 4) &#8743; j&#8804; Suc(Suc (Suc (jj * 4))) &#10230;
           get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8805; (jj * 4) &#8743; j&#8804; (jj * 4)+3&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>n1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((ii + 1) = ?i1 &#8743; j = ?j1)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a053&#39;</span><span> </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>n2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; ?j2 &#8743; j&#8804; ?j2+3 &#10230; &#172;((ii + 1) = ?i2 &#8743; jj * 4 = j)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span>
</span><span>         </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii + 1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j&quot;</span></span></span><span class="delimiter">]</span><span> </span><span>n1</span><span> </span><span>n2</span><span> </span><span>a00</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j=jj*4&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = FREE &#8744;
                 get_bit_s x p ii jj = FREEING &#8744;
                 get_bit_s x p ii jj = ALLOCATED &#8744;
                 get_bit_s x p ii jj = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;NULL &lt; ii&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii - 1) (jj div 4) = DIVIDED&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>eq_get_bit_i1_j1</span><span>  </span><span>eq_get_bit_i_j</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p)) - 1&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>ilen</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p)) - 1&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>len_levels</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ii jj = FREE &#8744;
                 get_bit_s Va p ii jj = FREEING &#8744;
                 get_bit_s Va p ii jj = ALLOCATED &#8744;
                 get_bit_s Va p ii jj = ALLOCATING&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>eq_get_bit_i_j</span><span> </span><span>a06</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) (ii + 1) (jj * 4)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>ilen</span><span>  </span><span>inv_va</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info x p) (ii + 1) (jj * 4)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>eq_get_bit_i2_j2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>numeral_3_eq_3</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = DIVIDED&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l_b</span><span> </span><span>a14</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2+4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a06&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j2 &#8744; jj=?j2+1 &#8744; jj=?j2+2 &#8744; jj =?j2 + 3&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;NULL &lt; ii&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a08</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j2&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>get_bit</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>a06</span><span> </span><span>a15</span><span> </span><span>eq_len</span><span> </span><span>get_bit_x_l1_b4</span><span> </span><span>i2_len</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span>  </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = DIVIDED&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span>a08</span><span> </span><span>get_bit_x_l_b</span><span> </span><span>a14</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a18</span><span>  </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>from_l_suc</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj&#8800;?j2&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a07&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj div 4 = ?j1&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = FREE&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a06</span><span> </span><span>a02</span><span> </span><span>a15</span><span>  </span><span>a07</span><span>  </span><span>from_l</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>a18</span><span> </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>   </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = DIVIDED&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span>a07&#39;</span><span> </span><span>a14</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a18</span><span> </span><span>get_bit_x_l_b</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>from_l_suc</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p)) - 1 &quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>get_s</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; (jj * 4) &#8743; j&#8804; Suc(Suc (Suc (jj * 4))) &#10230;
                   get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                                     </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii + 1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj*4&quot;</span></span></span><span class="delimiter">]</span><span>  </span><span>a06</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_1</span><span> </span><span>Suc_eq_plus1</span><span> </span><span>a14</span><span> </span><span>a18</span><span> </span><span>add.right_neutral</span><span> </span><span>add_Suc_right</span><span> </span><span>add_left_cancel</span><span>
</span><span>                  </span><span>from_l</span><span> </span><span>from_l_suc</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span> </span><span>zero_neq_numeral</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info x p) (ii + 1) (jj*4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a07</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>len_levels</span><span class="delimiter">]</span><span>  </span><span>a06</span><span> </span><span>inv_va</span><span> </span><span>nexisti2</span><span>
</span><span>                </span><span>noexists_eq_bits</span><span class="delimiter">[</span><span>OF</span><span> </span><span>get_s</span><span class="delimiter">]</span><span> </span><span>a06&#39;</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a06&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j20&#39; &#8744; jj=?j20&#39;+1 &#8744; jj=?j20&#39;+2 &#8744; jj=?j20&#39;+3 &#8744;
                   jj=?j21&#39; &#8744; jj=?j21&#39;+1 &#8744; jj=?j21&#39;+2 &#8744; jj=?j21&#39;+3 &#8744;
                   jj=?j22&#39; &#8744; jj=?j22&#39;+1 &#8744; jj=?j22&#39;+2 &#8744; jj=?j22&#39;+3 &#8744;
                   jj=?j23&#39; &#8744; jj=?j23&#39;+1 &#8744; jj=?j23&#39;+2 &#8744; jj=?j23&#39; + 3&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                                                         </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>from_l_suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i2_lt_length</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span>a01</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>len_levels</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = FREE &#8744;
                 get_bit_s x p ii jj = FREEING &#8744;
                 get_bit_s x p ii jj = ALLOCATED &#8744;
                 get_bit_s x p ii jj = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ii jj = NOEXIST&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a07</span><span> </span><span>a06</span><span> </span><span>inv_va</span><span>  </span><span>nexisti3</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>i2_lt_length</span><span class="delimiter">]</span><span> </span><span>a06&#39;</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = NOEXIST&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>eq_get_bit_i_j</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; (?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                                                         </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>get_bit_divided</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = DIVIDED&quot;</span></span></span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span>  </span><span>alloc_predi1_j1</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = FREE &#8744; get_bit_s x p ii jj = FREEING &#8744;
                 get_bit_s x p ii jj = ALLOCATED &#8744; get_bit_s x p ii jj = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_divided</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = DIVIDED&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &lt; ii&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii - 1) (jj div 4) = DIVIDED&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a5</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a16</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) - 1&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 2&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?j20&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?j2 * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j21&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+1) * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j22&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+2)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j23&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+3)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j24&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+4)*4&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>i1_len</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>a1</span><span> </span><span>inv</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?btsva</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a01&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>len_levels</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span>
</span><span>   </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j &lt; length (bits (levels (mem_pool_info Va p) ! ii)).
            (?btsva ! j = FREE &#8744; ?btsva ! j = FREEING &#8744; ?btsva ! j = ALLOCATED &#8744; ?btsva ! j = ALLOCATING &#10230;
                  (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
                  &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4) ))
          &#8743; (?btsva ! j = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
          &#8743; (?btsva ! j = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
                &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4))
          &#8743; (?btsva ! j = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv</span><span>  </span><span>mem_pools</span><span> </span><span>a1</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span>   </span><span>a7</span><span> </span><span>a0</span><span> </span><span>a11</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_predi1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &gt; 0 &#10230; get_bit_s Va p (?i1 - 1) (?j1 div 4) = DIVIDED&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>inv</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>nexisti2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2 ?j2&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>         </span><span>alloc_i1_j1</span><span> </span><span>from_l_suc</span><span>  </span><span>i2_len</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>a1</span><span>
</span><span>   </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>add.commute</span><span> </span><span>inv_mempool</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nexisti3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1 &#10230;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (bits (levels (mem_pool_info Va p) ! ?i2)).
                get_bit_s Va p ?i2 j = NOEXIST &#10230; noexist_bits (mem_pool_info Va p) ?i2&#39; (j * 4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i2_len</span><span>
</span><span>           </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>j2_len</span><span> </span><span>nexisti2</span><span> </span><span>Suc_lessD</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span> </span><span>numeral_3_eq_3</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a02&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>a12</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
        length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>  </span><span>a13</span><span> </span><span>a14</span><span> </span><span>length_list_update_n</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(?btsva ! jj = FREE &#8744; ?btsva ! jj = FREEING &#8744; ?btsva ! jj = ALLOCATED &#8744; ?btsva ! jj = ALLOCATING &#10230;
                (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
                &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4) ))
        &#8743; (?btsva ! jj = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
        &#8743; (?btsva ! jj = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
              &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4))
        &#8743; (?btsva ! jj = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>a02&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a05</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((ii=?i1 &#8743; jj=?j1) &#8744;
                 (ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt; ?j2+4) &#8744;
                 (ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;) &#8744;
                 (?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a050&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a051&#39;</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2 + 4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a052&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a053&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; &#172;(?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>a051&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&gt;0 &#10230; get_bit_s x p (ii-1) (jj div 4) = get_bit_s Va p (ii-1) (jj div 4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&gt;0&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; &#172;((ii - 1) = ?i1 &#8743; jj div 4 = ?j1)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>a051&#39;</span><span>  </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; ?j2 &#8743; j&#8804; ?j2+3 &#10230; &#172;((ii - 1) = ?i2 &#8743; jj div 4 = j)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a051&#39;</span><span> </span><span>a052&#39;</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = get_bit_s Va p (ii-1) (jj div 4)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span>
</span><span>         </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii -1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj div 4&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i2_j2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; (jj * 4) &#8743; j&#8804; Suc(Suc (Suc (jj * 4))) &#10230;
           get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8805; (jj * 4) &#8743; j&#8804; (jj * 4)+3&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>n1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((ii + 1) = ?i1 &#8743; j = ?j1)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a053&#39;</span><span> </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>n2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; ?j2 &#8743; j&#8804; ?j2+3 &#10230; &#172;((ii + 1) = ?i2 &#8743; jj * 4 = j)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span>
</span><span>         </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii + 1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j&quot;</span></span></span><span class="delimiter">]</span><span> </span><span>n1</span><span> </span><span>n2</span><span> </span><span>a00</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j=jj*4&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>eq_get_bit_i1_j1</span><span> </span><span>eq_get_bit_i_j</span><span> </span><span>inv_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a04</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_eq_plus1</span><span> </span><span>Suc_pred</span><span> </span><span>a13</span><span> </span><span>a17</span><span>
</span><span>               </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_cancel_right_right</span><span>
</span><span>               </span><span>alloc_predi1_j1</span><span> </span><span>from_l</span><span> </span><span>from_l_suc</span><span>
</span><span>             </span><span>same_bit_mp_alloc_stm4_pre_precond_f</span><span> </span><span>zero_neq_numeral</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2+4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a06&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j2 &#8744; jj=?j2+1 &#8744; jj=?j2+2 &#8744; jj =?j2 + 3&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>l1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(ii - 1) = ?i1 &#8743; (jj div 4) = ?j1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a01</span><span> </span><span>a02</span><span>  </span><span>a02&#39;</span><span> </span><span>a06</span><span> </span><span>a13</span><span> </span><span>a14</span><span> </span><span>a06&#39;</span><span>
</span><span>            </span><span>from_l_gt0</span><span> </span><span>from_l_suc</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add.commute</span><span> </span><span>add_mult_distrib2</span><span>
</span><span>              </span><span>diff_add_inverse2</span><span> </span><span>div_nat_eqI</span><span> </span><span>mult.commute</span><span>
</span><span>               </span><span>nat_mult_1_right</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l_b</span><span class="delimiter">[</span><span>OF</span><span> </span><span>l1</span><span class="delimiter">]</span><span>  </span><span>a13</span><span>
</span><span>       </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span>from_l_suc</span><span> </span><span>i1_len</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a17</span><span> </span><span>j1_len</span><span> </span><span>l1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a06&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j20&#39; &#8744; jj=?j20&#39;+1 &#8744; jj=?j20&#39;+2 &#8744; jj=?j20&#39;+3 &#8744;
                   jj=?j21&#39; &#8744; jj=?j21&#39;+1 &#8744; jj=?j21&#39;+2 &#8744; jj=?j21&#39;+3 &#8744;
                   jj=?j22&#39; &#8744; jj=?j22&#39;+1 &#8744; jj=?j22&#39;+2 &#8744; jj=?j22&#39;+3 &#8744;
                   jj=?j23&#39; &#8744; jj=?j23&#39;+1 &#8744; jj=?j23&#39;+2 &#8744; jj=?j23&#39; + 3&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                                                         </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>from_l_suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i2_lt_length</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span>
</span><span>      </span><span>a06</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>len_levels</span><span class="delimiter">]</span><span> </span><span>a01</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>len_levels</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ii jj = NOEXIST&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span>a01</span><span> </span><span>a06</span><span> </span><span>inv_va</span><span>  </span><span>nexisti3</span><span> </span><span>a06&#39;</span><span>  </span><span>a06</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>len_levels</span><span class="delimiter">]</span><span> </span><span>a01</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>len_levels</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; (?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                                                         </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a13</span><span> </span><span>a17</span><span> </span><span>from_l</span><span> </span><span>inv_va</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span>
</span><span>                       </span><span>calculation</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>calculation</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>calculation</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>calculation</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Suc_pred</span><span> </span><span>add_diff_cancel_left&#39;</span><span> </span><span>int_nat_eq</span><span> </span><span>inv_va</span><span> </span><span>of_nat_Suc</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap3</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = NOEXIST&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p)) - 1 &quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info x p) (ii + 1) (jj * 4)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a5</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a17</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) - 1&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 2&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?j20&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?j2 * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j21&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+1) * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j22&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+2)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j23&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+3)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j24&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+4)*4&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>i1_len</span><span> </span><span>a9</span><span> </span><span>a12</span><span> </span><span>a1</span><span> </span><span>inv</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?btsva</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a01&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>len_levels</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span>
</span><span>   </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j &lt; length (bits (levels (mem_pool_info Va p) ! ii)).
            (?btsva ! j = FREE &#8744; ?btsva ! j = FREEING &#8744; ?btsva ! j = ALLOCATED &#8744; ?btsva ! j = ALLOCATING &#10230;
                  (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
                  &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4) ))
          &#8743; (?btsva ! j = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
          &#8743; (?btsva ! j = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
                &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4))
          &#8743; (?btsva ! j = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv</span><span>  </span><span>mem_pools</span><span> </span><span>a1</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span>   </span><span>a7</span><span> </span><span>a0</span><span> </span><span>a12</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_predi1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &gt; 0 &#10230; get_bit_s Va p (?i1 - 1) (?j1 div 4) = DIVIDED&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>inv</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>nexisti2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2 ?j2&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>         </span><span>alloc_i1_j1</span><span> </span><span>from_l_suc</span><span>  </span><span>i2_len</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>a1</span><span>
</span><span>   </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>add.commute</span><span> </span><span>inv_mempool</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nexisti3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1 &#10230;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (bits (levels (mem_pool_info Va p) ! ?i2)).
                get_bit_s Va p ?i2 j = NOEXIST &#10230; noexist_bits (mem_pool_info Va p) ?i2&#39; (j * 4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i2_len</span><span>
</span><span>           </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>j2_len</span><span> </span><span>nexisti2</span><span> </span><span>Suc_lessD</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span> </span><span>numeral_3_eq_3</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a02&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>a13</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
        length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>  </span><span>a14</span><span> </span><span>a15</span><span> </span><span>length_list_update_n</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(?btsva ! jj = FREE &#8744; ?btsva ! jj = FREEING &#8744; ?btsva ! jj = ALLOCATED &#8744; ?btsva ! jj = ALLOCATING &#10230;
                (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
                &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4) ))
        &#8743; (?btsva ! jj = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
        &#8743; (?btsva ! jj = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
              &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4))
        &#8743; (?btsva ! jj = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>a02&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a05</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((ii=?i1 &#8743; jj=?j1) &#8744;
                 (ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt; ?j2+4) &#8744;
                 (?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a050&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a051&#39;</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2 + 4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a053&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; &#172;(?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>a051&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i2_j2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; (jj * 4) &#8743; j&#8804; Suc(Suc (Suc (jj * 4))) &#10230;
           get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8805; (jj * 4) &#8743; j&#8804; (jj * 4)+3&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>n1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((ii + 1) = ?i1 &#8743; j = ?j1)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a053&#39;</span><span> </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>n2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; ?j2 &#8743; j&#8804; ?j2+3 &#10230; &#172;((ii + 1) = ?i2 &#8743; jj * 4 = j)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span>
</span><span>         </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii + 1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j&quot;</span></span></span><span class="delimiter">]</span><span> </span><span>n1</span><span> </span><span>n2</span><span> </span><span>a00</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j=jj*4&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a04</span><span> </span><span>len_levels</span><span> </span><span>eq_get_bit_i_j</span><span> </span><span>a03</span><span> </span><span>inv_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>numeral_3_eq_3</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = DIVIDED&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l_b</span><span> </span><span>a14</span><span> </span><span>a18</span><span> </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2+4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a06&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j2 &#8744; jj=?j2+1 &#8744; jj=?j2+2 &#8744; jj =?j2 + 3&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>get_s</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; (jj * 4) &#8743; j&#8804; Suc(Suc (Suc (jj * 4))) &#10230;
                 get_bit_s x p (ii+1) j = get_bit_s Va p (ii+1) j&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                                   </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii + 1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj*4&quot;</span></span></span><span class="delimiter">]</span><span>  </span><span>a06</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_1</span><span> </span><span>Suc_eq_plus1</span><span> </span><span>a14</span><span> </span><span>a18</span><span> </span><span>add.right_neutral</span><span> </span><span>add_Suc_right</span><span> </span><span>add_left_cancel</span><span>
</span><span>                </span><span>from_l</span><span> </span><span>from_l_suc</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span> </span><span>zero_neq_numeral</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a04</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>len_levels</span><span class="delimiter">]</span><span>  </span><span>a06</span><span> </span><span>inv_va</span><span> </span><span>nexisti2</span><span>
</span><span>              </span><span>noexists_eq_bits</span><span class="delimiter">[</span><span>OF</span><span> </span><span>get_s</span><span class="delimiter">]</span><span> </span><span>a06&#39;</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; (?i1 &gt;0 &#8743; ii = (?i1 - 1) &#8743; jj = ?j1 div 4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                                                         </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>get_bit_divided</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = DIVIDED&quot;</span></span></span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span>  </span><span>alloc_predi1_j1</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_divided</span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap4</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info x p) ! ii))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = NOEXIST&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &lt; ii&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii - 1) (jj div 4) &#8800; DIVIDED&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a5</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a16</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) - 1&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 2&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?j20&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?j2 * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j21&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+1) * 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j22&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+2)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>      </span><span class="var">?j23&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+3)*4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?j24&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?j2+4)*4&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a1</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>i1_len</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>a1</span><span> </span><span>inv</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?btsva</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a01&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>len_levels</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span>
</span><span>   </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j &lt; length (bits (levels (mem_pool_info Va p) ! ii)).
            (?btsva ! j = FREE &#8744; ?btsva ! j = FREEING &#8744; ?btsva ! j = ALLOCATED &#8744; ?btsva ! j = ALLOCATING &#10230;
                  (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
                  &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4) ))
          &#8743; (?btsva ! j = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) = DIVIDED)
          &#8743; (?btsva ! j = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
                &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (j*4))
          &#8743; (?btsva ! j = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv</span><span>  </span><span>mem_pools</span><span> </span><span>a1</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span>   </span><span>a7</span><span> </span><span>a0</span><span> </span><span>a11</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_predi1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &gt; 0 &#10230; get_bit_s Va p (?i1 - 1) (?j1 div 4) = DIVIDED&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>inv</span><span> </span><span>a1</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>nexisti2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2 ?j2&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>         </span><span>alloc_i1_j1</span><span> </span><span>from_l_suc</span><span>  </span><span>i2_len</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>a1</span><span>
</span><span>   </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>add.commute</span><span> </span><span>inv_mempool</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nexisti3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1 &#10230;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
        noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p)) - 1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j&lt;length (bits (levels (mem_pool_info Va p) ! ?i2)).
                get_bit_s Va p ?i2 j = NOEXIST &#10230; noexist_bits (mem_pool_info Va p) ?i2&#39; (j * 4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i2_len</span><span>
</span><span>           </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2&#39; ?j20&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j21&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j22&#39; &#8743;
                 noexist_bits (mem_pool_info Va p) ?i2&#39; ?j23&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>j2_len</span><span> </span><span>nexisti2</span><span> </span><span>Suc_lessD</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span> </span><span>numeral_3_eq_3</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! ii)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! ii)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a02&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj &lt; length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>a12</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! ii)) =
        length (bits (levels (mem_pool_info Va p) ! ii))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>  </span><span>a13</span><span> </span><span>a14</span><span> </span><span>length_list_update_n</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(?btsva ! jj = FREE &#8744; ?btsva ! jj = FREEING &#8744; ?btsva ! jj = ALLOCATED &#8744; ?btsva ! jj = ALLOCATING &#10230;
                (ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
                &#8743; (ii &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4) ))
        &#8743; (?btsva ! jj = DIVIDED &#10230; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) = DIVIDED)
        &#8743; (?btsva ! jj = NOEXIST &#10230; ii &lt; length (levels (mem_pool_info Va p)) - 1
              &#10230; noexist_bits (mem_pool_info Va p) (ii+1) (jj*4))
        &#8743; (?btsva ! jj = NOEXIST &#8743; ii &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (ii - 1))) ! (jj div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>a02&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a05</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((ii=?i1 &#8743; jj=?j1) &#8744;
                 (ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt; ?j2+4) &#8744;
                 (ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a050&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a051&#39;</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2 + 4)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>               </span><span>a052&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj  = get_bit_s Va p ii jj&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>ii</span><span> </span><span>jj</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>a051&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>eq_get_bit_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&gt;0 &#10230; get_bit_s x p (ii-1) (jj div 4) = get_bit_s Va p (ii-1) (jj div 4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ii&gt;0&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot; &#172;((ii - 1) = ?i1 &#8743; jj div 4 = ?j1)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a050&#39;</span><span> </span><span>a051&#39;</span><span>  </span><span>from_l_suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j. j&#8805; ?j2 &#8743; j&#8804; ?j2+3 &#10230; &#172;((ii - 1) = ?i2 &#8743; jj div 4 = j)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a051&#39;</span><span> </span><span>a052&#39;</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = get_bit_s Va p (ii-1) (jj div 4)&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span>
</span><span>         </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii -1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj div 4&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>eq_get_bit_i1_j1</span><span> </span><span>eq_get_bit_i_j</span><span> </span><span>inv_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i1 &#8743; jj=?j1)&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = DIVIDED&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l_b</span><span> </span><span>a13</span><span> </span><span>a17</span><span> </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i2 &#8743; jj&#8805; ?j2 &#8743; jj&lt;?j2+4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a06&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j2 &#8744; jj=?j2+1 &#8744; jj=?j2+2 &#8744; jj =?j2 + 3&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a08</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>get_bit</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>a06</span><span> </span><span>a14</span><span> </span><span>eq_len</span><span> </span><span>get_bit_x_l1_b4</span><span> </span><span>a04</span><span> </span><span>i2_len</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj&#8800;?j2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a07&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj div 4 = ?j1&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ii jj = FREE&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a06</span><span> </span><span>a02</span><span> </span><span>a14</span><span>  </span><span>a07</span><span>  </span><span>from_l</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>a17</span><span> </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>   </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a06</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(ii=?i2&#39; &#8743; jj&#8805; ?j20&#39; &#8743; jj&lt; ?j24&#39;)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a06&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;jj=?j20&#39; &#8744; jj=?j20&#39;+1 &#8744; jj=?j20&#39;+2 &#8744; jj=?j20&#39;+3 &#8744;
                   jj=?j21&#39; &#8744; jj=?j21&#39;+1 &#8744; jj=?j21&#39;+2 &#8744; jj=?j21&#39;+3 &#8744;
                   jj=?j22&#39; &#8744; jj=?j22&#39;+1 &#8744; jj=?j22&#39;+2 &#8744; jj=?j22&#39;+3 &#8744;
                   jj=?j23&#39; &#8744; jj=?j23&#39;+1 &#8744; jj=?j23&#39;+2 &#8744; jj=?j23&#39; + 3&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>ij</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(ii-1 = ?i2 &#8743; (jj div 4)&#8805; ?j2 &#8743; (jj div 4) &#8804; ?j2 + 3)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a04</span><span> </span><span>a06</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a08</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(jj div 4)=?j2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>get_bit</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>ij</span><span> </span><span>a02</span><span> </span><span>a14</span><span> </span><span>eq_len</span><span> </span><span>get_bit_x_l1_b4</span><span> </span><span>a04</span><span> </span><span>i2_len</span><span> </span><span>from_l_gt0</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_lessD</span><span> </span><span>j2_len</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(jj div 4)&#8800;?j2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;ii-1 = ?i2 &#8743; (jj div 4 = Suc ?j2 &#8744; jj div 4 = Suc (Suc ?j2) &#8744; jj div 4 = Suc (Suc (Suc?j2)))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>ij</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (ii-1) (jj div 4) = FREE&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>ij</span><span> </span><span>a01</span><span> </span><span>a02</span><span> </span><span>i2_len</span><span> </span><span>j2_len</span><span>
</span><span>              </span><span>get_bit_x_l1_b41</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a17</span><span class="delimiter">]</span><span>
</span><span>                                  </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a17</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span>from_l</span><span class="delimiter">]</span><span> </span><span>a14</span><span class="delimiter">,</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii-1&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;jj div 4&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_lessD</span><span>  </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ETIMEOUT &#8804; timeout&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;timeout = ETIMEOUT &#10230; tmout Va t = ETIMEOUT&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; rf Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;NULL &lt; buf (mem_pool_info Va p) &#8744; NULL &lt; n &#8743; NULL &lt; max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;cur Va = Some t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mempoolalloc_ret Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&#8804;nat (alloc_l Va t). sz &#8804; lsizes Va t ! ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a22</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i x t = 4 &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a23</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;cur x = cur (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a24</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;tick x = tick (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a25</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;thd_state x = thd_state (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a26</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a27</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a28</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;wait_q (mem_pool_info x p) = wait_q (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a29</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; x (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a30</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a31</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a32</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a33</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j x = j (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a34</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;ret x = ret (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a35</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;endt x = endt (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a36</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;rf x = rf (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a37</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;tmout x = tmout (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a38</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a39</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l x = alloc_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a40</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l x = free_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a41</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a42</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a43</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nodev x = nodev (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a44</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bn x = bn (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a45</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_lsize_r x = alloc_lsize_r (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a46</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lvl x = lvl (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a47</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bb x = bb (mp_alloc_stm4_pre_precond_f Va t p) &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a48</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_pt x = block_pt (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a49</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;th x = th (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a50</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;need_resched x = need_resched (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a51</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mempoolalloc_ret x = mempoolalloc_ret (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a52</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a53</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap x&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a11</span><span> </span><span>a9</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info x p)) = length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a26</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a26</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a26</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a41</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a26</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a38</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;OK &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a11</span><span> </span><span>a9</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>p&#39;</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39;&#8712;mem_pools x&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(4*block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?i1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) - 1&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?j1&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?i2&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t)) + 2&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?j2&#39;</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))) * 16&quot;</span></span></span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>   </span><span>a12</span><span> </span><span>a0</span><span> </span><span>a18</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p&#8800;p&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&#39; = mem_pool_info Va p&#39;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a27</span><span> </span><span>calculation</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_mp x p&#39;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a00</span><span> </span><span>inv</span><span> </span><span>len_levels</span><span> </span><span>maxsz</span><span> </span><span>buf</span><span> </span><span>from_l</span><span>  </span><span>mem_pools</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>eq_p</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p=p&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?mp</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info x p&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>eq_p</span><span> </span><span>mem_pools</span><span> </span><span>a00</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>i</span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i&lt;length (levels ?mp)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! i)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?btsva</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(bits (levels (mem_pool_info Va p) ! i))&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a01&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>len_levels</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_bitmap1</span><span class="delimiter">:</span><span>
</span><span>         </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j &lt; length (bits (levels (mem_pool_info Va p) ! i)).
                  (?btsva ! j = FREE &#8744; ?btsva ! j = FREEING &#8744; ?btsva ! j = ALLOCATED &#8744; ?btsva ! j = ALLOCATING &#10230;
                        (i &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (i - 1))) ! (j div 4) = DIVIDED)
                        &#8743; (i &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (i+1) (j*4) ))
                &#8743; (?btsva ! j = DIVIDED &#10230; i &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (i - 1))) ! (j div 4) = DIVIDED)
                &#8743; (?btsva ! j = NOEXIST &#10230; i &lt; length (levels (mem_pool_info Va p)) - 1
                      &#10230; noexist_bits (mem_pool_info Va p) (i+1) (j*4))
                &#8743; (?btsva ! j = NOEXIST &#8743; i &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (i - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv</span><span> </span><span>eq_p</span><span> </span><span>mem_pools</span><span> </span><span>a00</span><span>
</span><span>          </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">let</span></span><span>  </span><span class="var">?bts</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels ?mp ! i)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="var">?fl</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels ?mp ! i)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>f1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;j &lt; length ?bts.
                  (?bts ! j = FREE &#8744; ?bts ! j = FREEING &#8744; ?bts ! j = ALLOCATED &#8744; ?bts ! j = ALLOCATING &#10230;
                        (i &gt; 0 &#10230; (bits (levels (mem_pool_info x p) ! (i - 1))) ! (j div 4) = DIVIDED)
                        &#8743; (i &lt; length (levels (mem_pool_info x p)) - 1 &#10230; noexist_bits (mem_pool_info x p) (i+1) (j*4) ))
                &#8743; (?bts ! j = DIVIDED &#10230; i &gt; 0 &#10230; (bits (levels (mem_pool_info x p) ! (i - 1))) ! (j div 4) = DIVIDED)
                &#8743; (?bts ! j = NOEXIST &#10230; i &lt; length (levels (mem_pool_info x p)) - 1
                      &#10230; noexist_bits (mem_pool_info x p) (i+1) (j*4))
                &#8743; (?bts ! j = NOEXIST &#8743; i &gt; 0 &#10230; (bits (levels (mem_pool_info x p) ! (i - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&lt;length ?bts&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>a02&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j &lt; length (bits (levels (mem_pool_info Va p) ! i))&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a26</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_def</span><span> </span><span>gvars_conf_stable_def</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! i)) =
                length (bits (levels (mem_pool_info Va p) ! i))&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>  </span><span>a30</span><span> </span><span>a31</span><span> </span><span>length_list_update_n</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(?btsva ! j = FREE &#8744; ?btsva ! j = FREEING &#8744; ?btsva ! j = ALLOCATED &#8744; ?btsva ! j = ALLOCATING &#10230;
                        (i &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (i - 1))) ! (j div 4) = DIVIDED)
                        &#8743; (i &lt; length (levels (mem_pool_info Va p)) - 1 &#10230; noexist_bits (mem_pool_info Va p) (i+1) (j*4) ))
                &#8743; (?btsva ! j = DIVIDED &#10230; i &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (i - 1))) ! (j div 4) = DIVIDED)
                &#8743; (?btsva ! j = NOEXIST &#10230; i &lt; length (levels (mem_pool_info Va p)) - 1
                      &#10230; noexist_bits (mem_pool_info Va p) (i+1) (j*4))
                &#8743; (?btsva ! j = NOEXIST &#8743; i &gt; 0 &#10230; (bits (levels (mem_pool_info Va p) ! (i - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap1</span><span> </span><span>a02&#39;</span><span> </span><span>eq_p</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?goal1</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = FREE &#8744; ?bts ! j = FREEING &#8744; ?bts ! j = ALLOCATED &#8744; ?bts ! j = ALLOCATING &#10230;
                        (i &gt; 0 &#10230; (bits (levels (mem_pool_info x p) ! (i - 1))) ! (j div 4) = DIVIDED)
                        &#8743; (i &lt; length (levels (mem_pool_info x p)) - 1 &#10230; noexist_bits (mem_pool_info x p) (i+1) (j*4) ))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?goal2</span><span> </span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = DIVIDED &#10230; i &gt; 0 &#10230; (bits (levels (mem_pool_info x p) ! (i - 1))) ! (j div 4) = DIVIDED)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?goal3</span><span> </span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = NOEXIST &#10230; i &lt; length (levels (mem_pool_info x p)) - 1
                      &#10230; noexist_bits (mem_pool_info x p) (i+1) (j*4))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?goal4</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(?bts ! j = NOEXIST &#8743; i &gt; 0 &#10230; (bits (levels (mem_pool_info x p) ! (i - 1))) ! (j div 4) &#8800; DIVIDED)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?goal1</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>eq_p</span><span>
</span><span>             </span><span>mp_alloc_stm4_inv_bitmap1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a6</span><span> </span><span>a8</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>a12</span><span> </span><span>a13</span><span> </span><span>a14</span><span> </span><span>a15</span><span> </span><span>a17</span><span> </span><span>a18</span><span> </span><span>a26</span><span> </span><span>a30</span><span> </span><span>a31</span><span> </span><span>a32</span><span> </span><span>a38</span><span> </span><span>a41</span><span> </span><span>a01</span><span> </span><span>a02</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?goal2</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span>a8</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>a12</span><span> </span><span>a13</span><span> </span><span>a14</span><span> </span><span>a15</span><span> </span><span>a18</span><span> </span><span>a26</span><span> </span><span>a30</span><span> </span><span>a31</span><span> </span><span>a32</span><span> </span><span>a38</span><span> </span><span>a41</span><span> </span><span>a01</span><span> </span><span>a02</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?goal3</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap3</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a6</span><span> </span><span>a8</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>a12</span><span> </span><span>a13</span><span> </span><span>a14</span><span> </span><span>a15</span><span> </span><span>a17</span><span> </span><span>a18</span><span> </span><span>a26</span><span> </span><span>a30</span><span> </span><span>a31</span><span> </span><span>a32</span><span> </span><span>a38</span><span> </span><span>a41</span><span> </span><span>a01</span><span> </span><span>a02</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?goal4</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span>a8</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>a12</span><span> </span><span>a13</span><span> </span><span>a14</span><span> </span><span>a15</span><span> </span><span>a18</span><span> </span><span>a26</span><span> </span><span>a30</span><span> </span><span>a31</span><span> </span><span>a32</span><span> </span><span>a38</span><span> </span><span>a41</span><span> </span><span>a01</span><span> </span><span>a02</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?goal1 &#8743; ?goal2 &#8743; ?goal3 &#8743; ?goal4&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>       </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>     </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_mp x p&#39;&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>eq_p</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>   </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_mp x p&#39;&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span> </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x t&#39; = Some m&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x (pool m) (level m) (block m) = FREEING&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a7</span><span> </span><span>a6</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_aux_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;t n. freeing_node Va t = Some n &#10230;
        get_bit (mem_pool_info Va) (pool n) (level n) (block n) = FREEING)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a2</span><span> </span><span>a5</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>     </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span> </span><span>a2</span><span> </span><span>a5</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>i1_len</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a17</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t&#39;= t&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>a19</span><span> </span><span>a21</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def_frnode</span><span> </span><span>option.distinct</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;t&#39;&#8800;t&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node (mp_alloc_stm4_pre_precond_f Va t p) t&#39; =  freeing_node Va t&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_alloc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t&#39; = freeing_node x t&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a19</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t2_same_allocating_node_Va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t&#39; = Some m&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a0</span><span>  </span><span>a21</span><span> </span><span>a19</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>invariant.inv_def</span><span>  </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>diff_t</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool m = p &#8743; level m = ?i1 &#8743; block m = ?j1)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a21</span><span> </span><span>a8</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>a11</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool m &#8800; p&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a13</span><span> </span><span>a21</span><span> </span><span>eq_alloc</span><span>  </span><span>mp_alloc_stm4_pres_mpinfo</span><span>
</span><span>        </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>not_pool_p_allocating</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;pool m = p&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>bit_m_va_alloc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool m) (level m) (block m) = FREEING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>eq_alloc</span><span> </span><span>inv_aux_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a8</span><span> </span><span>a0</span><span> </span><span>a11</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>nexisti2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2 ?j2&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>        </span><span>alloc_i1_j1</span><span> </span><span>from_l_suc</span><span>  </span><span>i2_len</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>a1</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>add.commute</span><span> </span><span>inv_mempool</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(level m = ?i1 &#8743; block m = ?j1)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>diff_t</span><span> </span><span>a01</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(level m = ?i1 &#8743; block m = ?j1)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(level m = ?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt;?j2 + 4)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (level m) (block m)  =
                                     get_bit_s Va p (level m) (block m)&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span>
</span><span>              </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level m&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block m&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>             </span><span>a01</span><span> </span><span>a02</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>a20</span><span> </span><span>inv_aux_va</span><span> </span><span>not_pool_p_allocating</span><span>
</span><span>              </span><span>a21</span><span> </span><span>eq_alloc</span><span> </span><span>inv_aux_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(level m = ?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt;?j2 + 4)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;block m = ?j2 &#8744; block m = ?j2 + 1 &#8744; block m = ?j2 + 2 &#8744; block m = ?j2 + 3&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>bit_m_va_alloc</span><span> </span><span>nexisti2</span><span> </span><span>a01</span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a54</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x (pool m) (level m) (block m) = FREEING &#8743; mem_block_addr_valid x m&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#8707;t. freeing_node x t = Some m)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a5</span><span> </span><span>a4</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>block_valid_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid Va m&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>a9</span><span> </span><span>a54</span><span>  </span><span>mp_alloc_stm4_buf</span><span> </span><span>mp_alloc_stm4_maxsz</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mem_block_addr_valid_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_aux_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;n. get_bit (mem_pool_info Va) (pool n) (level n) (block n) = FREEING &#8743; mem_block_addr_valid Va n
                &#10230; (&#8707;t. freeing_node Va t = Some n))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(pool m) &#8800; p &quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool m) (level m) (block m) = get_bit_s x (pool m) (level m) (block m)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a54</span><span> </span><span>inv_aux_va</span><span> </span><span>block_valid_va</span><span> </span><span>a14</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def_frnode</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;pool m = p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a9</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a7</span><span> </span><span>a2</span><span> </span><span>a3</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a7</span><span> </span><span>a2</span><span> </span><span>a3</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a6</span><span> </span><span>a8</span><span> </span><span>i1_len</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(((level m)=?i1 &#8743; (block m)=?j1) &#8744;
                 ((level m)=?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt; ?j2+4))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a020&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((level m)=?i1 &#8743; (block m)=?j1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                </span><span>a021&#39;</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((level m)=?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt;?j2 + 4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span class="delimiter">+</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (level m) (block m)  = get_bit_s Va p (level m) (block m)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a11</span><span class="delimiter">[</span><span>simplified</span><span>
</span><span>              </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a12</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level m&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block m&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a020&#39;</span><span> </span><span>a021&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>a54</span><span> </span><span>inv_aux_va</span><span>
</span><span>        </span><span>block_valid_va</span><span> </span><span>a14</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def_frnode</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;((level m)=?i1 &#8743; (block m)=?j1)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ?i1 ?j1 = DIVIDED&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a11</span><span> </span><span>from_l_gt0</span><span> </span><span>from_l_suc</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span>
</span><span>                     </span><span>same_bit_mp_alloc_stm4_pre_precond_divided</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a54</span><span> </span><span>a02</span><span> </span><span>a01</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(level m)=?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt; ?j2+4&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ?i2 ?j2 = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i2_len</span><span> </span><span>j2_len</span><span>  </span><span>a12</span><span> </span><span>get_bit_x_l1_b4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span> </span><span>a12</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="var">?i2</span><span> </span><span class="var">?j2</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span> </span><span>add_lessD1</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(block m)&#8800;?j2&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(level m) = ?i2 &#8743; ((block m) = Suc ?j2 &#8744;
                   (block m) = Suc (Suc ?j2) &#8744; (block m) = Suc (Suc (Suc?j2)))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (level m) (block m) = FREE&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>i2_len</span><span> </span><span>j2_len</span><span>
</span><span>              </span><span>get_bit_x_l1_b41</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a13</span><span class="delimiter">]</span><span>
</span><span>                                  </span><span>a11</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a13</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span>from_l</span><span class="delimiter">]</span><span> </span><span>a12</span><span class="delimiter">,</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level m&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block m&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_lessD</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a54</span><span> </span><span>a02</span><span> </span><span>a01</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars3</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t&#39; = Some m&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x (pool m) (level m) (block m) = ALLOCATING&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a5</span><span> </span><span>a4</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_aux_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;t n. allocating_node Va t = Some n &#10230;
        get_bit (mem_pool_info Va) (pool n) (level n) (block n) = ALLOCATING)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>  </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a10</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a16</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a8</span><span> </span><span>a2</span><span> </span><span>a3</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>     </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a8</span><span> </span><span>a2</span><span> </span><span>a3</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a7</span><span> </span><span>a9</span><span> </span><span>i1_len</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a15</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;t&#39; &#8800; t&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t&#39; =  allocating_node Va t&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_alloc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t&#39; = allocating_node x t&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a17</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>diff_t</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool m = p &#8743; level m = ?i1 &#8743; block m = ?j1)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a18</span><span> </span><span>a6</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>a9</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool m &#8800; p&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a11</span><span> </span><span>a18</span><span> </span><span>eq_alloc</span><span> </span><span>inv_aux_va</span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>not_pool_p_allocating</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;pool m = p&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>bit_m_va_alloc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit (mem_pool_info Va) (pool m) (level m) (block m) = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a18</span><span> </span><span>eq_alloc</span><span> </span><span>inv_aux_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a10</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a10</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a0</span><span> </span><span>a9</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>nexisti2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2 ?j2&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>        </span><span>alloc_i1_j1</span><span> </span><span>from_l_suc</span><span>  </span><span>i2_len</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>a1</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>add.commute</span><span> </span><span>inv_mempool</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(level m = ?i1 &#8743; block m = ?j1)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>diff_t</span><span> </span><span>a01</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(level m = ?i1 &#8743; block m = ?j1)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(level m = ?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt;?j2 + 4)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (level m) (block m)  =
                                     get_bit_s Va p (level m) (block m)&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a12</span><span class="delimiter">[</span><span>simplified</span><span>
</span><span>              </span><span>a16</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a16</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a13</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level m&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block m&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>             </span><span>a01</span><span> </span><span>a02</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>a17</span><span> </span><span>inv_aux_va</span><span> </span><span>not_pool_p_allocating</span><span>
</span><span>              </span><span>a18</span><span> </span><span>eq_alloc</span><span> </span><span>inv_aux_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(level m = ?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt;?j2 + 4)&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;block m = ?j2 &#8744; block m = ?j2 + 1 &#8744; block m = ?j2 + 2 &#8744; block m = ?j2 + 3&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>bit_m_va_alloc</span><span> </span><span>nexisti2</span><span> </span><span>a01</span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t&#39;=t&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(pool m) = p &#8743; (level m) = ?i2 &#8743; (block m) = ?j2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>a17</span><span> </span><span>a18</span><span>
</span><span>                </span><span>mp_alloc_stm4_pre_precond_f_allocating</span><span> </span><span>mult.commute</span><span> </span><span>option.sel</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l1_b4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span> </span><span>a13</span><span> </span><span>i2_len</span><span> </span><span class="delimiter">]</span><span> </span><span>j2_len</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_lessD</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars4</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x (pool m) (level m) (block m) = ALLOCATING &#8743; mem_block_addr_valid x m&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#8707;t. allocating_node x t = Some m)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a5</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>block_valid_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid Va m&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>a12</span><span> </span><span>a21</span><span>  </span><span>mp_alloc_stm4_buf</span><span> </span><span>mp_alloc_stm4_maxsz</span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mem_block_addr_valid_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>data_m</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;data m =
              buf (mem_pool_info x (pool m)) + (block m) * ((max_sz (mem_pool_info x (pool m))) div (4 ^ (level m)))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mem_block_addr_valid_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv_aux_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(&#8704;n. get_bit (mem_pool_info Va) (pool n) (level n) (block n) = ALLOCATING &#8743; mem_block_addr_valid Va n
                &#10230; (&#8707;t. allocating_node Va t = Some n))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(pool m) &#8800; p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>t&#39;</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t&#39; = Some m&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_aux_va</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a13</span><span> </span><span>a21</span><span> </span><span>block_valid_va</span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t&#39;&#8800;t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a7</span><span> </span><span>calculation</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t&#39; =  allocating_node Va t&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_alloc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t&#39; = allocating_node x t&#39;&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a20</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;pool m = p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a9</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a9</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a8</span><span> </span><span>a10</span><span> </span><span>i1_len</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a17</span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a12</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(((level m)=?i1 &#8743; (block m)=?j1) &#8744;
                 ((level m)=?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt; ?j2+4))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>a020&#39;</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((level m)=?i1 &#8743; (block m)=?j1)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>                </span><span>a021&#39;</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;((level m)=?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt;?j2 + 4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span class="delimiter">+</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (level m) (block m)  = get_bit_s Va p (level m) (block m)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span>
</span><span>              </span><span>a18</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a18</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level m&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block m&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a020&#39;</span><span> </span><span>a021&#39;</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool m) (level m) (block m) = ALLOCATING &#8743; mem_block_addr_valid Va m&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>a21</span><span> </span><span>block_valid_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>t&#39;</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t&#39; = Some m&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_aux_va</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t&#39;&#8800;t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>a7</span><span> </span><span>a10</span><span> </span><span>calculation</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t&#39; =  allocating_node Va t&#39;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_alloc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t&#39; = allocating_node x t&#39;&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a20</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;((level m)=?i1 &#8743; (block m)=?j1)&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ?i1 ?j1 = DIVIDED&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a14</span><span> </span><span>from_l_gt0</span><span> </span><span>from_l_suc</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span>
</span><span>                     </span><span>same_bit_mp_alloc_stm4_pre_precond_divided</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>a02</span><span> </span><span>a01</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(level m)=?i2 &#8743; (block m)&#8805; ?j2 &#8743; (block m)&lt; ?j2+4&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>block_n</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p)
                   (blk Va t) (lsizes Va t ! nat (from_l Va t))) = n&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) =
                 ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^
                   (nat (from_l Va t))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a3</span><span> </span><span>lsizes_x_va</span><span>  </span><span>a5</span><span> </span><span>a6</span><span> </span><span>a9</span><span> </span><span>a11</span><span> </span><span>a5</span><span> </span><span>from_l</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>block_n</span><span> </span><span>inv</span><span> </span><span>a2</span><span>  </span><span>a10</span><span>   </span><span>a4</span><span> </span><span>a9</span><span> </span><span>from_l_gt0</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ?i2 ?j2 = ALLOCATING&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i2_len</span><span> </span><span>j2_len</span><span>  </span><span>a15</span><span> </span><span>get_bit_x_l1_b4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span> </span><span>a15</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="var">?i2</span><span> </span><span class="var">?j2</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_Suc_right</span><span> </span><span>add_lessD1</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block m = ?j2&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;m = &#10631;pool = p, level = ?i2, block = ?j2,
                           data = buf (mem_pool_info x p) +
                                   ?j2 * (max_sz (mem_pool_info x p) div 4 ^ ?i2)
                          &#10632;&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>data_m</span><span> </span><span>a03</span><span> </span><span>a02</span><span> </span><span>a01</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>       </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;blk x t = buf (mem_pool_info x p) +
                                   ?j1 * ((max_sz (mem_pool_info x p) div 4 ^ ?i1))&quot;</span></span></span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a10</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>buf</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span>maxsz</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>block_n</span><span> </span><span>a19</span><span> </span><span>mp_alloc_stm4_blk</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t = Some &#10631;pool = p, level = ?i2, block = ?j2,
                                            data = buf (mem_pool_info x p) +
                                                  ?j1 *  (max_sz (mem_pool_info x p) div 4 ^ ?i1)&#10632;&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a20</span><span> </span><span>a19</span><span> </span><span>mp_alloc_stm4_blk</span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocating</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>buf</span><span> </span><span>maxsz</span><span> </span><span>next_level_addr_eq</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>addr_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>from_l_suc</span><span> </span><span>i2_len</span><span> </span><span>inv_mempool</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(block m)&#8800;?j2&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(level m) = ?i2 &#8743; ((block m) = Suc ?j2 &#8744;
                   (block m) = Suc (Suc ?j2) &#8744; (block m) = Suc (Suc (Suc?j2)))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p (level m) (block m) = FREE&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a02</span><span> </span><span>i2_len</span><span> </span><span>j2_len</span><span>
</span><span>              </span><span>get_bit_x_l1_b41</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a18</span><span class="delimiter">]</span><span>
</span><span>                                  </span><span>a14</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a18</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span> </span><span>from_l</span><span class="delimiter">]</span><span> </span><span>a15</span><span class="delimiter">,</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level m&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block m&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_lessD</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a21</span><span> </span><span>a01</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars5</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot; t1 &#8800; t2 &#8743; freeing_node x t1 = Some n1 &#8743; freeing_node x t2 = Some n2&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1 &#8800; t2 &#8743; freeing_node Va t1 = Some n1 &#8743; freeing_node Va t2 = Some n2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>a2</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def_frnode</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_aux_vars_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars6</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;t1 &#8800; t2 &#8743; allocating_node x t1 = Some n1 &#8743; allocating_node x t2 = Some n2&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars Va &#8743; inv_bitmap Va &#8743; inv_mempool_info Va &#8743; inv_bitmap_freelist Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a5</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>         </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>         </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>         </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a11</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>mem_pools</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a17</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a9</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>     </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a9</span><span> </span><span>a2</span><span> </span><span>a4</span><span> </span><span>from_l_gt0</span><span> </span><span>inv</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>a8</span><span> </span><span>a10</span><span> </span><span>i1_len</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lsizes_x_va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x  = lsizes Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span>a16</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>maxsz</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_maxsz</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a11</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>buf</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p) = buf (mem_pool_info Va p)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_buf</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a11</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>alloc_i1_j1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va p ?i1 ?j1 = ALLOCATING&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a7</span><span> </span><span>a0</span><span> </span><span>a10</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span> </span><span>invariant.inv_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>nexisti2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;noexist_bits (mem_pool_info Va p) ?i2 ?j2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span>  </span><span>conjunct1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>conjunct2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>inv</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simplified</span><span> </span><span>Let_def</span><span> </span><span>inv_bitmap_def</span><span class="delimiter">]</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span>
</span><span>    </span><span>alloc_i1_j1</span><span> </span><span>from_l_suc</span><span>  </span><span>i2_len</span><span> </span><span>i1_len</span><span> </span><span>j1_len</span><span> </span><span>a1</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span> </span><span>Suc_pred</span><span> </span><span>add.commute</span><span> </span><span>inv_mempool</span><span> </span><span>nat_add_left_cancel_less</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t&#8800;t1&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t&#8800;t2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a0</span><span> </span><span>a19</span><span> </span><span>a18</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>invariant.inv_def</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;t=t1&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t2&#8800;t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a19</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t2_same_allocating_node_Va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t2 = Some n2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a0</span><span> </span><span>a19</span><span> </span><span>a18</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>invariant.inv_def</span><span>  </span><span>inv_aux_vars_def</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>get_bit_n2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n2) (level n2) (block n2) = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a0</span><span> </span><span>a19</span><span> </span><span>a18</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>invariant.inv_def</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) =
          (pool n1 = pool n2 &#10230; &#172;(level n1 = level n2 &#8743; block n1 = block n2))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;pool n1 = pool n2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n1 = &#10631;pool = p, level = ?i2, block = ?j2,
                           data = blk Va t
                          &#10632;&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a19</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a00</span><span> </span><span>a18</span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocating</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(level n1 = level n2 &#8743; block n1 = block n2)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_n2</span><span> </span><span>a02</span><span> </span><span>nexisti2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;t=t2&quot;</span></span></span><span>
</span><span>   </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t1&#8800;t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a19</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t2_same_allocating_node_Va</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t1 = Some n1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a0</span><span> </span><span>a19</span><span> </span><span>a18</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>invariant.inv_def</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>get_bit_n2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s Va (pool n1) (level n1) (block n1) = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a0</span><span> </span><span>a19</span><span> </span><span>a18</span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>invariant.inv_def</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) =
          (pool n1 = pool n2 &#10230; &#172;(level n1 = level n2 &#8743; block n1 = block n2))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;pool n1 = pool n2&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n2 = &#10631;pool = p, level = ?i2, block = ?j2,
                           data = blk Va t
                          &#10632;&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a19</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a00</span><span> </span><span>a18</span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocating</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(level n1 = level n2 &#8743; block n1 = block n2)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_n2</span><span> </span><span>a02</span><span> </span><span>nexisti2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars7</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a23</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a22</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x t1 = Some n1 &#8743; freeing_node x t2 = Some n2&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172; (pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n1 = pool n2&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x (pool n1) (level n1) (block n1) = ALLOCATING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars3</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x (pool n2) (level n2) (block n2) = FREEING&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars1</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword3"><span class="command">thus</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a22</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a23</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_aux_vars x&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_aux_vars_def</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span>
</span><span>    </span><span>mp_alloc_stm4_inv_aux_vars1</span><span class="delimiter">[</span><span>OF</span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span>-</span><span>9</span><span class="delimiter">,</span><span>11</span><span>-</span><span>22</span><span class="delimiter">)</span><span class="delimiter">]</span><span>
</span><span>    </span><span>mp_alloc_stm4_inv_aux_vars2</span><span class="delimiter">[</span><span>OF</span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span>-</span><span>3</span><span class="delimiter">,</span><span>6</span><span>-</span><span>8</span><span class="delimiter">,</span><span>11</span><span>-</span><span>17</span><span class="delimiter">,</span><span>20</span><span>-</span><span>21</span><span class="delimiter">)</span><span class="delimiter">]</span><span>
</span><span>    </span><span>mp_alloc_stm4_inv_aux_vars3</span><span class="delimiter">[</span><span>OF</span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span>-</span><span>3</span><span class="delimiter">,</span><span>6</span><span>-</span><span>7</span><span class="delimiter">,</span><span>8</span><span>-</span><span>9</span><span class="delimiter">,</span><span>11</span><span>-</span><span>20</span><span class="delimiter">,</span><span>22</span><span class="delimiter">)</span><span class="delimiter">]</span><span>
</span><span>    </span><span>mp_alloc_stm4_inv_aux_vars4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span>-</span><span>4</span><span class="delimiter">,</span><span>6</span><span>-</span><span>9</span><span class="delimiter">,</span><span>11</span><span>-</span><span>13</span><span class="delimiter">,</span><span>23</span><span class="delimiter">,</span><span>14</span><span>-</span><span>20</span><span class="delimiter">,</span><span>24</span><span class="delimiter">,</span><span>22</span><span class="delimiter">)</span><span class="delimiter">]</span><span>
</span><span>mp_alloc_stm4_inv_aux_vars5</span><span class="delimiter">[</span><span>OF</span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span class="delimiter">,</span><span>21</span><span class="delimiter">)</span><span class="delimiter">]</span><span>
</span><span>mp_alloc_stm4_inv_aux_vars6</span><span class="delimiter">[</span><span>OF</span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span>-</span><span>3</span><span class="delimiter">,</span><span>5</span><span>-</span><span>9</span><span class="delimiter">,</span><span>11</span><span>-</span><span>20</span><span class="delimiter">,</span><span>22</span><span class="delimiter">)</span><span class="delimiter">]</span><span> </span><span>mp_alloc_stm4_inv_aux_vars7</span><span class="delimiter">[</span><span>OF</span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span>-</span><span>22</span><span class="delimiter">)</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap0</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a22</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a23</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap0 x&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span> </span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>p&#39;</span><span> </span><span>j</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39; &#8712; mem_pools x&quot;</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&lt;length (bits (levels (mem_pool_info x p&#39;) ! NULL))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p&#39;&#8800; p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; NULL j &#8800; NOEXIST&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>a13</span><span> </span><span>a14</span><span> </span><span>inv_bitmap0_def</span><span>
</span><span>         </span><span>invariant.inv_def</span><span> </span><span>mp_alloc_stm4_mempools</span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39; = p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1)) &gt; 0&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>zero_lt_len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a13</span><span> </span><span>a2</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_eq</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! 0)) =
      length (bits (levels (mem_pool_info Va p) ! 0))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a13</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>       </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>     </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a7</span><span> </span><span>a6</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>     </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j = ?j1&quot;</span></span></span><span>
</span><span>       </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; NULL j &#8800; NOEXIST&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>a02</span><span>
</span><span>          </span><span>get_bit_x_l_b</span><span> </span><span>a13</span><span>
</span><span>           </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a2</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span>len_eq</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span>
</span><span>          </span><span>from_l_gt0</span><span> </span><span>a19</span><span> </span><span>a0</span><span> </span><span>a15</span><span> </span><span>a2</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_divided</span><span>
</span><span>         </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap0_def</span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_same_bits</span><span> </span><span>zero_lt_len_levels</span><span>
</span><span>         </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>BlockState.distinct</span><span class="delimiter">(</span><span>19</span><span class="delimiter">)</span><span>  </span><span>nat_0_iff</span><span>  </span><span class="delimiter">)</span><span>
</span><span>     </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>     </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8800;?j1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p 0 j  = get_bit_s Va p 0 j&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a19</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>0</span><span> </span><span>j</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; NULL j &#8800; NOEXIST&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_bitmap0_def</span><span> </span><span>a00</span><span> </span><span>a01</span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a2</span><span> </span><span>len_eq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; NULL j &#8800; NOEXIST&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; NULL j &#8800; NOEXIST&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;p&#8712;mem_pools x.
             &#8704;i&lt;length (bits (levels (mem_pool_info x p) ! NULL)).
               get_bit_s x p NULL i &#8800; NOEXIST&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmapn</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmapn x&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span> </span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>p&#39;</span><span> </span><span>j</span><span>
</span><span>    </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?k</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(length (levels (mem_pool_info x p&#39;)) - Suc 0)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39; &#8712; mem_pools x&quot;</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&lt;length (bits (levels (mem_pool_info x p&#39;) ! ?k))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p&#39;&#8800; p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?k j &#8800; DIVIDED&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>a0</span><span> </span><span>a8</span><span> </span><span>a9</span><span> </span><span>mp_alloc_stm4_mempools</span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span>
</span><span>      </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmapn_def</span><span> </span><span>inv_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>One_nat_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39; = p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>    </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1)) &gt; 0&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a3</span><span> </span><span>a4</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>zero_lt_len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a8</span><span> </span><span>a1</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_eq</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! 0)) =
      length (bits (levels (mem_pool_info Va p) ! 0))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a8</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>       </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a1</span><span> </span><span>mem_pools</span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>from_l_gt0</span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>       </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a6</span><span> </span><span>a1</span><span> </span><span>a2</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a0</span><span> </span><span>a1</span><span> </span><span>a5</span><span> </span><span>a7</span><span> </span><span>i1_len</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>invariant.inv_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>a4</span><span> </span><span>a3</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 = ?k&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8805; ?j2 &#8743; j&lt;?j2+4&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a05</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j=?j2&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?i2 j = ALLOCATING&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span>
</span><span>            </span><span>get_bit_x_l1_b4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span> </span><span>a11</span><span> </span><span>i2_len</span><span class="delimiter">,</span><span>of</span><span> </span><span class="var">?j2</span><span class="delimiter">]</span><span> </span><span>a8</span><span> </span><span>zero_lt_len_levels</span><span>
</span><span>             </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span>len_eq</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span>
</span><span>            </span><span>from_l_gt0</span><span> </span><span>a13</span><span> </span><span>j2_len</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>meson</span><span> </span><span>Suc_lessD</span><span> </span><span>mult.commute</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?i2 j &#8800; DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a05</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&#8805; ?j2 + 1 &#8743; j&lt;?j2+4&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?i2 j = FREE&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span>
</span><span>            </span><span>get_bit_x_l1_b41</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span> </span><span>a10</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a13</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a11</span><span> </span><span>i2_len</span><span class="delimiter">,</span><span>of</span><span> </span><span class="var">?j2</span><span class="delimiter">]</span><span> </span><span>a8</span><span> </span><span>zero_lt_len_levels</span><span>
</span><span>             </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a1</span><span> </span><span>a8</span><span class="delimiter">]</span><span> </span><span>len_eq</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span>
</span><span>            </span><span>from_l_gt0</span><span> </span><span>a13</span><span> </span><span>j2_len</span><span> </span><span>a11</span><span> </span><span>mp_alloc_stm4_pre_precond_f_bn</span><span>
</span><span>             </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>One_nat_def</span><span>  </span><span>add.commute</span><span> </span><span>add_Suc_shift</span><span> </span><span>length_list_update_n</span><span> </span><span>list_updates_n_eq</span><span>
</span><span>               </span><span>numeral_2_eq_2</span><span> </span><span>numeral_3_eq_3</span><span> </span><span>numeral_Bit0</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?i2 j &#8800; DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?i2 j &#8800; DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a04</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(j&#8805; ?j2 &#8743; j&lt;?j2+4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ?i2 j  = get_bit_s Va p ?i2 j&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span>from_l_suc</span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>
</span><span>            </span><span>a10</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a11</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="var">?i2</span><span> </span><span>j</span><span class="delimiter">]</span><span>
</span><span>          </span><span>from_l_gt0</span><span> </span><span>calculation</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>force</span><span>
</span><span>        </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?i2 j &#8800; DIVIDED&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>One_nat_def</span><span> </span><span>a01</span><span> </span><span>a8</span><span> </span><span>a10</span><span> </span><span>a11</span><span> </span><span>a1</span><span> </span><span>length_list_update_n</span><span>
</span><span>               </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?k j &#8800; DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a03</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &#8800; ?k&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span>  </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;?i2&lt;?k&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>calculation</span><span> </span><span>a00</span><span> </span><span>a02</span><span> </span><span>a8</span><span> </span><span>i2_len</span><span> </span><span>mem_pools</span><span> </span><span>mp_alloc_stm4_lvl_len</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;?i1&#8800;?k&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p ?k j  = get_bit_s Va p ?k j&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span>  </span><span>from_l_suc</span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>
</span><span>            </span><span>a10</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a13</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a11</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span class="var">?i2</span><span> </span><span>j</span><span class="delimiter">]</span><span>
</span><span>          </span><span>from_l_gt0</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a10</span><span> </span><span>a13</span><span> </span><span>from_l</span><span> </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?k j &#8800; DIVIDED&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a02</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>One_nat_def</span><span> </span><span>a01</span><span> </span><span>a8</span><span> </span><span>a10</span><span> </span><span>a11</span><span> </span><span>a1</span><span> </span><span>length_list_update_n</span><span>
</span><span>               </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>mp_alloc_stm4_lvl_len</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?k j &#8800; DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; ?k j &#8800; DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; &#8704;p&#8712;mem_pools x.
       &#8704;i&lt;length (bits (levels (mem_pool_info x p) ! (length (levels (mem_pool_info x p)) - Suc NULL))).
          get_bit_s x p (length (levels (mem_pool_info x p)) - Suc NULL) i &#8800; DIVIDED&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap4free</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span>
</span><span> </span><span>a0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node Va t = None&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a3</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a4</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a5</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t &lt; int (n_levels (mem_pool_info Va p))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a6</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#172; free_l Va t &lt; OK&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a7</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_l Va t &#8804; from_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a8</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a9</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a10</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a11</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &lt; alloc_l Va t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a12</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a13</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a14</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a15</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a16</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a17</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a18</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a19</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a20</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a21</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a22</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span> </span><span>a23</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;blk x = blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_not4free x&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>p&#39;</span><span> </span><span>i</span><span> </span><span>j</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a00</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39; &#8712; mem_pools x&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>            </span><span>a01</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i&lt;length (levels (mem_pool_info x p&#39;))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>            </span><span>a02</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;j&lt;length (bits (levels (mem_pool_info x p&#39;) ! i))&quot;</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a03</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &lt; i&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>            </span><span>a04</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (Suc (Suc (j div 4 * 4))) = FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>            </span><span>a05</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i  (Suc (j div 4 * 4)) = FREE&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>            </span><span>a06</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i   (j div 4 * 4) = FREE&quot;</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;p&#39;&#8800; p&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE &quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>a0</span><span> </span><span>a8</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a00</span><span> </span><span>a01</span><span> </span><span>a0</span><span> </span><span>a8</span><span> </span><span>a9</span><span> </span><span>mp_alloc_stm4_mempools</span><span> </span><span>mp_alloc_stm4_pres_mpinfo</span><span>
</span><span>          </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>inv_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a13</span><span> </span><span>a14</span><span> </span><span>add.commute</span><span>
</span><span>               </span><span>add_2_eq_Suc&#39;</span><span> </span><span>partner_bits_def</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>not_p</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a07</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;p&#39; = p&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?i1</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?j1</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t)))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?i2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span>
</span><span>        </span><span class="var">?j2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(block_num (mem_pool_info Va p) (blk Va t) (lsizes Va t ! nat (from_l Va t))*4)&quot;</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;(nat (from_l Va t + 1)) &gt; 0&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>zero_lt_len_levels</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &lt; length (levels (mem_pool_info x p))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a2</span><span> </span><span>mp_alloc_stm4_lvl_len</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_mempool_info_def</span><span> </span><span>inv_def</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a01</span><span> </span><span>a07</span><span> </span><span>gr_implies_not0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>len_eq</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;length (bits (levels (mem_pool_info x p) ! 0)) =
          length (bits (levels (mem_pool_info Va p) ! 0))&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a13</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>           </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span>
</span><span>           </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mem_pools</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pools x = mem_pools Va&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a13</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_mempool_info_mp Va p&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>mem_pools</span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>inv_mempool</span><span class="delimiter">=</span><span>this</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>Let_def</span><span class="delimiter">]</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;from_l x = from_l Va&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_suc</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t + 1) = nat(from_l Va t) + 1&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i1 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a2</span><span> </span><span>a11</span><span> </span><span>a5</span><span>  </span><span>from_l_gt0</span><span> </span><span>a0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>           </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span>  </span><span>i2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?i2 &lt; length (levels (mem_pool_info Va p))&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a0</span><span> </span><span>a5</span><span> </span><span>a2</span><span> </span><span>a11</span><span> </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span>
</span><span>           </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j1_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;?j1 &lt; length (bits (levels (mem_pool_info Va p) ! ?i1))&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span class="delimiter">(</span><span>11</span><span class="delimiter">)</span><span> </span><span>assms</span><span class="delimiter">(</span><span>13</span><span class="delimiter">)</span><span> </span><span>i1_len</span><span> </span><span>inv_mempool</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>j2_len</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;Suc (Suc (Suc ?j2)) &lt; length (bits (levels (mem_pool_info Va p) ! ?i2))&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>i1_len</span><span> </span><span>i2_len</span><span> </span><span>j1_len</span><span>  </span><span>inv_mempool</span><span>  </span><span>from_l_suc</span><span>
</span><span>           </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>         </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>from_l_gt0</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;0 &#8804; from_l Va t&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a6</span><span> </span><span>a7</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>linarith</span><span>
</span><span>         </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a08</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i&#8800;?i1 &#8743; i&#8800;?i2&quot;</span></span></span><span>
</span><span>           </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4 * 4 + 3)  = get_bit_s Va p i (j div 4 * 4 + 3)&quot;</span></span></span><span>
</span><span>             </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span>
</span><span>                      </span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a19</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                               </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4 * 4 + 3)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                   </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>           </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4 * 4)  = get_bit_s Va p i (j div 4 * 4)&quot;</span></span></span><span>
</span><span>             </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span>
</span><span>                      </span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a19</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                               </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4 * 4)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span>a08</span><span>
</span><span>                </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (Suc (j div 4 * 4))  = get_bit_s Va p i (Suc (j div 4 * 4))&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span>
</span><span>                      </span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a19</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                               </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Suc (j div 4 * 4))&quot;</span></span></span><span class="delimiter">]</span><span> </span><span>a08</span><span>
</span><span>               </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eq_get_bit_i_j</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (Suc (Suc (j div 4 * 4)))  = get_bit_s Va p i (Suc (Suc (j div 4 * 4)))&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span>
</span><span>                      </span><span class="delimiter">[</span><span>OF</span><span> </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>a19</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>mp_alloc_stm4_froml</span><span class="delimiter">[</span><span>OF</span><span> </span><span>a19</span><span class="delimiter">]</span><span class="delimiter">,</span><span>
</span><span>                               </span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(Suc (Suc (j div 4 * 4)))&quot;</span></span></span><span class="delimiter">]</span><span> </span><span>a08</span><span>
</span><span>               </span><span>from_l_gt0</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE &quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a07</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a0</span><span> </span><span>a13</span><span> </span><span>a15</span><span> </span><span>a16</span><span> </span><span>a2</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span>
</span><span>                  </span><span>mp_alloc_stm4_lvl_len</span><span>
</span><span>            </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>inv_def</span><span> </span><span>Let_def</span><span> </span><span>partner_bits_def</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>length_list_update_n</span><span>  </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i=?i1&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE &quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>not_p</span><span> </span><span>a0</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a15</span><span> </span><span>a19</span><span> </span><span>a2</span><span>  </span><span>from_l</span><span> </span><span>from_l_gt0</span><span> </span><span>from_l_suc</span><span> </span><span>i1_len</span><span>  </span><span>j1_len</span><span>
</span><span>                  </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>mp_alloc_stm4_pre_precond_f_bitmap_not_free</span><span>
</span><span>                  </span><span>same_bit_mp_alloc_stm4_pre_precond_f1</span><span>
</span><span>            </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>invariant.inv_def</span><span> </span><span>partner_bits_def</span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span>   </span><span>add_2_eq_Suc&#39;</span><span> </span><span>add_eq_self_zero</span><span> </span><span>le_zero_eq</span><span>  </span><span>nat_int_add</span><span> </span><span>not_one_le_zero</span><span>
</span><span>                 </span><span>plus_1_eq_Suc</span><span> </span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span class="keyword1"><span class="command">note</span></span><span> </span><span>i1</span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>a08</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;i=?i2&quot;</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j &#8805; ?j2 &#8743; j &#8804; ?j2 + 3&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j = ?j2 &#8744; j= ?j2 + 1 &#8744; j= ?j2 + 2 &#8744; j = ?j2 + 3&quot;</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j div 4 * 4 = ?j2&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i ?j2 = ALLOCATING&quot;</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>get_bit_x_l1_b4</span><span class="delimiter">[</span><span>OF</span><span> </span><span>_</span><span> </span><span>from_l_gt0</span><span> </span><span>a16</span><span> </span><span>i2_len</span><span> </span><span class="delimiter">]</span><span> </span><span>a08</span><span>  </span><span>a07</span><span> </span><span>mult.commute</span><span> </span><span>j2_len</span><span>
</span><span>              </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_lessD</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE&quot;</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>a06</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>            </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(j&#8805;?j2 &#8743; j&#8804; ?j2 + 3)&quot;</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j &lt; ?j2 &#8744; j &gt; ?j2 + 3&quot;</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j&lt;?j2&quot;</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j div 4 * 4 + 3 &lt; ?j2&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4)  = get_bit_s Va p i (j div 4*4)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4+1)  = get_bit_s Va p i (j div 4*4+1)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4+1)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4+2)  = get_bit_s Va p i (j div 4*4+2)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4+2)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4+3)  = get_bit_s Va p i (j div 4*4+3)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4+3)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>  </span><span>_</span><span> </span><span>a16</span><span class="delimiter">]</span><span> </span><span>a15</span><span> </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>i1</span><span>
</span><span>                </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>partner_bits_def</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>length_list_update_n</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">moreover</span></span><span class="keyword1"><span class="command">{</span></span><span>
</span><span>              </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;j&gt;?j2 + 3&quot;</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot; j div 4 * 4 &gt; ?j2 + 3&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>presburger</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4)  = get_bit_s Va p i (j div 4*4)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4+1)  = get_bit_s Va p i (j div 4*4+1)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4+1)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4+2)  = get_bit_s Va p i (j div 4*4+2)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4+2)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p i (j div 4*4+3)  = get_bit_s Va p i (j div 4*4+3)&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>   </span><span>a15</span><span class="delimiter">[</span><span>simplified</span><span> </span><span>from_l</span><span> </span><span>a19</span><span class="delimiter">[</span><span>THEN</span><span> </span><span>sym</span><span class="delimiter">]</span><span class="delimiter">]</span><span> </span><span>a16</span><span class="delimiter">,</span><span> </span><span>of</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(j div 4*4+3)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>                     </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span> </span><span>calculation</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>from_l_suc</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>a16</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE&quot;</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>same_bit_mp_alloc_x_va</span><span class="delimiter">[</span><span>OF</span><span>  </span><span>_</span><span> </span><span>a16</span><span class="delimiter">]</span><span> </span><span>a15</span><span> </span><span>a01</span><span> </span><span>a02</span><span> </span><span>a03</span><span> </span><span>a04</span><span> </span><span>a05</span><span> </span><span>a06</span><span> </span><span>a07</span><span> </span><span>a08</span><span> </span><span>a00</span><span>
</span><span>                     </span><span>a0</span><span> </span><span>a16</span><span> </span><span>a19</span><span> </span><span>a2</span><span> </span><span>from_l</span><span> </span><span>i2_len</span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span>i1</span><span>
</span><span>                </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>partner_bits_def</span><span>
</span><span>                </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add.commute</span><span> </span><span>add_2_eq_Suc&#39;</span><span> </span><span>length_list_update_n</span><span> </span><span>plus_1_eq_Suc</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE &quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE &quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE &quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>     </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s x p&#39; i (j div 4 * 4 + 3) &#8800; FREE &quot;</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>   </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span> </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_not4free x&quot;</span></span></span><span>
</span><span>     </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_bitmap_not4free_def</span><span> </span><span>Let_def</span><span> </span><span>partner_bits_def</span><span>
</span><span>     </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span> </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_inv</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;inv Va &#10233;
 freeing_node Va t = None &#10233;
 p &#8712; mem_pools Va &#10233;
 ETIMEOUT &#8804; timeout &#10233;
 timeout = ETIMEOUT &#10230; tmout Va t = ETIMEOUT &#10233;
 &#172; rf Va t &#10233;
 &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
 length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
 alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
 &#172; free_l Va t &lt; OK &#10233;
 NULL &lt; buf (mem_pool_info Va p) &#8744; NULL &lt; n &#8743; NULL &lt; max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) &#10233;
 free_l Va t &#8804; from_l Va t &#10233;
 allocating_node Va t =
 Some &#10631;pool = p, level = nat (from_l Va t),
         block = block_num (mem_pool_info Va p)
                  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
                  (lsizes Va t ! nat (from_l Va t)),
         data = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&#10632; &#10233;
 n = block_num (mem_pool_info Va p)
      (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
      (lsizes Va t ! nat (from_l Va t)) &#8744;
 max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) = NULL &#10233;
 block_num (mem_pool_info Va p)
  (buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))
  (lsizes Va t ! nat (from_l Va t))
 &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t) &#10233;
 from_l Va t &lt; alloc_l Va t &#10233;
 cur Va = Some t &#10233;
 n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t) &#10233;
 blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) &#10233;
 mempoolalloc_ret Va t = None &#10233;
 &#8704;ii&#8804;nat (alloc_l Va t). sz &#8804; lsizes Va t ! ii &#10233;
 alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
 alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &#10233;
 i x t = 4 &#10233;
 cur x = cur (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 tick x = tick (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 thd_state x = thd_state (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
 &#8704;pa. pa &#8800; p &#10230; mem_pool_info x pa = mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) pa &#10233;
 wait_q (mem_pool_info x p) = wait_q (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) &#10233;
 &#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; x (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 &#8704;jj. jj &#8800; nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) &#10230;
      levels (mem_pool_info x p) ! jj = levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) ! jj &#10233;
 bits (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 list_updates_n
  (bits (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))
  (Suc (bn (mp_alloc_stm4_pre_precond_f Va t p) t * 4)) 3 FREE &#10233;
 free_list (levels (mem_pool_info x p) ! nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)) =
 inserts
  (map (&#955;ii. lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
             nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1) *
             ii +
             blk (mp_alloc_stm4_pre_precond_f Va t p) t)
    [Suc NULL..&lt;4])
  (free_list
    (levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p) !
     nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1))) &#10233;
 j x = j (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 ret x = ret (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 endt x = endt (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 rf x = rf (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 tmout x = tmout (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 lsizes x = lsizes (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 alloc_l x = alloc_l (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 free_l x = free_l (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 from_l x = from_l (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 blk x = blk (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 nodev x = nodev (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 bn x = bn (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 alloc_lsize_r x = alloc_lsize_r (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 lvl x = lvl (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 bb x = bb (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 block_pt x = block_pt (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 th x = th (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 need_resched x = need_resched (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 mempoolalloc_ret x = mempoolalloc_ret (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 freeing_node x = freeing_node (mp_alloc_stm4_pre_precond_f Va t p) &#10233;
 allocating_node x = allocating_node (mp_alloc_stm4_pre_precond_f Va t p) &#10233; inv x&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_cur</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_thd_state</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mempool_info</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap_freelist</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_aux_vars</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap0</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmapn</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bitmap4free</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inv_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233;
 inv Va &#10233;
 alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
 from_l Va t &lt; alloc_l Va t &#10233;
 &#172; free_l Va t &lt; 0 &#10233;
 free_l Va t &#8804; from_l Va t &#10233;
 &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
 length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
 alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
    alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &#10233;
 blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) &#10233;
 (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
   allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t =
       Some &#10631;pool = p, level = nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1),
               block = block_num (mem_pool_info x p) (blk (mp_alloc_stm4_pre_precond_f Va t p) t)
                        (lsizes (mp_alloc_stm4_pre_precond_f Va t p) t !
                         nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)),
               data = blk (mp_alloc_stm4_pre_precond_f Va t p) t&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) -
     buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_maxsz_align4</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t + 1)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>div_mult_self1_is_m</span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span> </span><span>nat_less_iff</span><span>
</span><span>            </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span> </span><span>zero_less_numeral</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>div_eq_0_iff</span><span> </span><span>m_mod_div</span><span> </span><span>mod_mult_self2_is_0</span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span>
</span><span>        </span><span>nat_less_iff</span><span> </span><span>nonzero_mult_div_cancel_right</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h2</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233;
 inv Va &#10233;
 alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
 from_l Va t &lt; alloc_l Va t &#10233;
 &#172; free_l Va t &lt; 0 &#10233;
 free_l Va t &#8804; from_l Va t &#10233;
 &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
 length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
 alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
    alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &#10233;
 blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) &#10233;
 (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
 data (the (allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t)) =
   buf (mem_pool_info x p) +
   block (the (allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t)) *
   (max_sz (mem_pool_info x p) div 4 ^ level (the (allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t))&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) -
     buf (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = (max_sz (mem_pool_info Va p)) div 4 ^ ii&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_maxsz_align4</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t) div 4&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t + 1)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>div_mult_self1_is_m</span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span> </span><span>nat_less_iff</span><span>
</span><span>            </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span> </span><span>zero_less_numeral</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t) div 4&quot;</span></span></span><span>
</span><span>                    </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t + 1)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>inv_maxsz_align4</span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span> </span><span>nonzero_mult_div_cancel_right</span><span> </span><span>zero_neq_numeral</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)&quot;</span></span></span><span>
</span><span>                    </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>nat_less_iff</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;m&gt;0. max_sz (mem_pool_info Va p) = (4 * m) * (4 ^ n_levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>add_left_cancel</span><span> </span><span>inv_maxsz_align4</span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span> </span><span>mult.assoc</span><span> </span><span>mult_is_0</span><span> </span><span>nonzero_mult_div_cancel_left</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h3_1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va t &#8805;0 &#10233;  n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t) &#10233;
         4 * n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t + 1)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span>  </span><span>mult.assoc</span><span> </span><span>Divides.div_mult2_eq</span><span> </span><span>Suc_nat_eq_nat_zadd1</span><span> </span><span>div_eq_0_iff</span><span>
</span><span>      </span><span>div_mult_mult1_if</span><span> </span><span>gr_implies_not0</span><span> </span><span>mult.commute</span><span> </span><span>mult_eq_0_iff</span><span> </span><span>power_Suc</span><span>
</span><span>      </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span> </span><span>zero_less_numeral</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h3</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233;
 inv Va &#10233;
 alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
 from_l Va t &lt; alloc_l Va t &#10233;
 &#172; free_l Va t &lt; 0 &#10233;
 free_l Va t &#8804; from_l Va t &#10233;
 &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
 length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
 alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
    alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &#10233;
 n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t) &#10233;
 (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
 blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) &#10233;
 block (the (allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t))
           &lt; n_max (mem_pool_info x p) * 4 ^ level (the (allocating_node (mp_alloc_stm4_pre_precond_f Va t p) t))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)&quot;</span></span></span><span>
</span><span>                   </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va t ! nat (from_l Va t)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_maxsz_align4</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info x p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;m&gt;0. max_sz (mem_pool_info Va p) = (4 * m) * (4 ^ n_levels (mem_pool_info Va p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (from_l Va t) &lt; n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;(n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) div
         (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)))&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mp_alloc_stm3_lm2_inv_1_2</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h3_1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h4</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233;
 inv Va &#10233;
 alloc_l Va t &lt; int (n_levels (mem_pool_info Va p)) &#10233;
 from_l Va t &lt; alloc_l Va t &#10233;
 &#172; free_l Va t &lt; 0 &#10233;
 free_l Va t &#8804; from_l Va t &#10233;
 &#8704;ii&lt;length (lsizes Va t). lsizes Va t ! ii = ALIGN4 (max_sz (mem_pool_info Va p)) div 4 ^ ii &#10233;
 length (lsizes Va t) &#8804; n_levels (mem_pool_info Va p) &#10233;
 alloc_l Va t = int (length (lsizes Va t)) - 1 &#8743; length (lsizes Va t) = n_levels (mem_pool_info Va p) &#8744;
    alloc_l Va t = int (length (lsizes Va t)) - 2 &#8743; lsizes Va t ! nat (alloc_l Va t + 1) &lt; sz &#10233;
 n &lt; n_max (mem_pool_info Va p) * 4 ^ nat (from_l Va t) &#10233;
 blk Va t = buf (mem_pool_info Va p) + n * (max_sz (mem_pool_info Va p) div 4 ^ nat (from_l Va t)) &#10233;
 (x, mp_alloc_stm4_pre_precond_f Va t p) &#8712; gvars_conf_stable &#10233;
 (&#8707;n&lt;n_max (mem_pool_info x p) * 4 ^ nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1).
     blk (mp_alloc_stm4_pre_precond_f Va t p) t =
     buf (mem_pool_info x p) +
     n * (max_sz (mem_pool_info x p) div 4 ^ nat (from_l (mp_alloc_stm4_pre_precond_f Va t p) t + 1)))&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;n_max (mem_pool_info x p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;buf (mem_pool_info x p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;from_l Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;blk Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;blk (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info Va p)&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>mp_alloc_stm4_pre_precond_f_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>exI</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>x</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;4 * n&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>inv_maxsz_align4</span><span> </span><span>mp_alloc_stm4_blockfit_help4</span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h3_1</span><span>
</span><span>      </span><span>mult.assoc</span><span> </span><span>semiring_normalization_rules</span><span class="delimiter">(</span><span>7</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &#8805; 4&#10628;
  &#8838; &#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1_1_loopinv_1 t p sz timeout&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8838; &#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; gvars_conf_stable *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_mempools2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_buf</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_mxsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_nmax</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_nlvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_len</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_bits_len</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* inv Va &#10233; inv x *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_inv</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>_</span><span> </span><span>sz</span><span> </span><span>_</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t&#39;. t&#39; &#8800; t &#10230; lvars_nochange t&#39; Va x *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvars_nochange t&#39; x (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lvars_nochange t&#39; Va (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lvars_nochange</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>t</span><span> </span><span>Va</span><span> </span><span>p</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lvars_nochange_trans</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>Va</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_pre_precond_f Va t p&quot;</span></span></span><span> </span><span>_</span><span class="delimiter">]</span><span>
</span><span>          </span><span>lvars_nochange_sym</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_tick</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8838; Collect invariant.inv *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_inv</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>_</span><span> </span><span>sz</span><span> </span><span>_</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_def_frnode</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_mpls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rf Va t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_rf</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_ret</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_tmout</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;rf Va t&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_rf</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info x p) = max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;max_sz (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p)
                  = max_sz (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_maxsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (mp_alloc_stm4_pre_precond_f Va t p) t = lsizes Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info x p) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p)
                = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_nlvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (mp_alloc_stm4_pre_precond_f Va t p) t = lsizes Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l (mp_alloc_stm4_pre_precond_f Va t p) t = alloc_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_l (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot; free_l Va t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_freel</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l (mp_alloc_stm4_pre_precond_f Va t p) t = alloc_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_l (mp_alloc_stm4_pre_precond_f Va t p) t&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot; free_l Va t&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_freel</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI2</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes Va&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;lsizes (mp_alloc_stm4_pre_precond_f Va t p)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_lsz</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>linarith</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info x p) = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;n_levels (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p) p)
                = n_levels (mem_pool_info Va p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_inv_mif_nlvls</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l (mp_alloc_stm4_pre_precond_f Va t p) t = alloc_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_l (mp_alloc_stm4_pre_precond_f Va t p) t = free_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_freel</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk Va t &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;blk (mp_alloc_stm4_pre_precond_f Va t p) t = blk Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_blk</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l (mp_alloc_stm4_pre_precond_f Va t p) t = alloc_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p) t = from_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l (mp_alloc_stm4_pre_precond_f Va t p) t = alloc_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_allocl</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p) t = from_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;from_l (mp_alloc_stm4_pre_precond_f Va t p) t = from_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_froml</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;free_l (mp_alloc_stm4_pre_precond_f Va t p) t = free_l Va t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_freel</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>arith</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h3</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post_h4</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state (mp_alloc_stm4_pre_precond_f Va t p) = thd_state Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state (mp_alloc_stm4_pre_precond_f Va t p) = thd_state Va&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;p&#8712;mem_pools Va. wait_q (mem_pool_info Va p) = wait_q (mem_pool_info (mp_alloc_stm4_pre_precond_f Va t p1) p)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_lm1_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;bn := &#180;bn (t := block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;from_l t))));;
      &#180;mem_pool_info := set_bit_divide &#180;mem_pool_info p (nat (&#180;from_l t)) (&#180;bn t);;
      &#180;mem_pool_info := set_bit_allocating &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (4 * &#180;bn t);;
      &#180;allocating_node := &#180;allocating_node (t := Some &#10631;pool = p, level = nat (&#180;from_l t + 1),
            block = 4 * &#180;bn t, data = &#180;blk t &#10632;);;
      FOR &#180;i := &#180;i (t := Suc 0);
          &#180;i t &lt; 4;
          &#180;i := &#180;i (t := Suc (&#180;i t)) DO
        &#180;lbn := &#180;lbn (t := 4 * &#180;bn t + &#180;i t);;
        &#180;lsz := &#180;lsz (t := (&#180;lsizes t) ! (nat (&#180;from_l t + 1)));;
        &#180;block2 := &#180;block2(t := &#180;lsz t * &#180;i t + &#180;blk t);;
        &#180;mem_pool_info := set_bit_free &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (&#180;lbn t);;

        IF block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t) THEN
          &#180;mem_pool_info := &#180;mem_pool_info (p :=
                  append_free_list (&#180;mem_pool_info p) (nat (&#180;from_l t + 1)) (&#180;block2 t) )
        FI
      ROF) sat<span class="hidden">&#8681;</span><sub>p</sub> [{Va}, {(s, t). s = t}, UNIV,
        &#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1_1_loopinv_1 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply simp*)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_pre_precond4
                            (mp_alloc_stm4_pre_precond3
                            (mp_alloc_stm4_pre_precond2
                            (mp_alloc_stm4_pre_precond1 Va t p) t p) t p) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_pre_precond3
                            (mp_alloc_stm4_pre_precond2
                            (mp_alloc_stm4_pre_precond1 Va t p) t p) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_pre_precond2
                            (mp_alloc_stm4_pre_precond1 Va t p) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_pre_precond1 Va t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;bn := &#180;bn (t := block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;from_l t))));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := set_bit_divide &#180;mem_pool_info p (nat (&#180;from_l t)) (&#180;bn t);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := set_bit_allocating &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (4 * &#180;bn t);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;allocating_node := &#180;allocating_node (t := Some &#10631;pool = p, level = nat (&#180;from_l t + 1),
                      block = 4 * &#180;bn t, data = &#180;blk t &#10632;);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_pre_precond_f Va t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;i := &#180;i (t := 1);  *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mp_alloc_stm4_pre_precond_f_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Conseq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>pre</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm4_pre_precond_f Va t p}&quot;</span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>pre&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p&quot;</span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t).s = t}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>rely&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t).s = t}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar</span><span class="delimiter">=</span><span>UNIV</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>guar&#39;</span><span class="delimiter">=</span><span>UNIV</span><span>
</span><span>                      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* and post=&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1_1_loopinv_1 t p sz timeout&quot;*)</span></span></span></span></span><span>
</span><span>                      </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>post&#39;</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm4_loopinv (mp_alloc_stm4_pre_precond_f Va t p) t p &#8745; &#10627;&#180;i t &#8805; 4&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_pre_precond_f_in_mp_alloc_stm4_loopinv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_whlpst_in_post</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_while</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz timeout&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1_1_loopinv_1 t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_lm1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} = {Va} &#10233;
   &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;bn := &#180;bn(t := block_num (&#180;mem_pool_info p) (&#180;blk t) (&#180;lsizes t ! nat (&#180;from_l t)));;
       &#180;mem_pool_info := set_bit_divide &#180;mem_pool_info p (nat (&#180;from_l t)) (&#180;bn t);;
       &#180;mem_pool_info := set_bit_allocating &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (4 * &#180;bn t);;
       &#180;allocating_node := &#180;allocating_node(t &#8614; &#10631;pool = p, level = nat (&#180;from_l t + 1), block = 4 * &#180;bn t, data = &#180;blk t&#10632;);;
       (&#180;i := &#180;i(t := Suc NULL);;
        WHILE &#180;i t &lt; 4
        DO &#180;lbn := &#180;lbn(t := 4 * &#180;bn t + &#180;i t);; &#180;lsz := &#180;lsz(t := &#180;lsizes t ! nat (&#180;from_l t + 1));;
           &#180;block2 := &#180;block2(t := &#180;lsz t * &#180;i t + &#180;blk t);;
           &#180;mem_pool_info := set_bit_free &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (&#180;lbn t);;
           IF block_fits (&#180;mem_pool_info p) (&#180;block2 t)
               (&#180;lsz t) THEN &#180;mem_pool_info := &#180;mem_pool_info
                             (p := append_free_list (&#180;mem_pool_info p) (nat (&#180;from_l t + 1)) (&#180;block2 t)) FI;;
           &#180;i := &#180;i(t := Suc (&#180;i t))
        OD)) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va},
                    {(s, t). s = t}, UNIV,
                  &#10627;&#180;(Pair Va) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1_1_loopinv_1 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Va}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Va &#8712; mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lm1_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv t p sz timeout&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm4_lm</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (WHILE &#180;from_l t &lt; &#180;alloc_l t DO
      (t &#9656; ATOMIC
        &#180;bn := &#180;bn (t := block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;from_l t))));;

        &#180;mem_pool_info := set_bit_divide &#180;mem_pool_info p (nat (&#180;from_l t)) (&#180;bn t);;

        &#180;mem_pool_info := set_bit_allocating &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (4 * &#180;bn t);;

        &#180;allocating_node := &#180;allocating_node (t := Some &#10631;pool = p, level = nat (&#180;from_l t + 1),
              block = 4 * &#180;bn t, data = &#180;blk t &#10632;);;

        FOR &#180;i := &#180;i (t := 1);
            &#180;i t &lt; 4;
            &#180;i := &#180;i (t := &#180;i t + 1) DO
          &#180;lbn := &#180;lbn (t := 4 * &#180;bn t + &#180;i t);;
          &#180;lsz := &#180;lsz (t := (&#180;lsizes t) ! (nat (&#180;from_l t + 1)));;
          &#180;block2 := &#180;block2(t := &#180;lsz t * &#180;i t + &#180;blk t);;

          &#180;mem_pool_info := set_bit_free &#180;mem_pool_info p (nat (&#180;from_l t + 1)) (&#180;lbn t);;

          IF block_fits (&#180;mem_pool_info p) (&#180;block2 t) (&#180;lsz t) THEN

            &#180;mem_pool_info := &#180;mem_pool_info (p :=
                    append_free_list (&#180;mem_pool_info p) (nat (&#180;from_l t + 1)) (&#180;block2 t) )
          FI
        ROF

      END);;
      (t &#9656; &#180;from_l := &#180;from_l(t := &#180;from_l t + 1))
    OD) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond2_1_1_loopinv t p sz timeout, Mem_pool_alloc_rely t, Mem_pool_alloc_guar t,
              mp_alloc_precond2_1_2 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Int_greatest</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;from_l t &#8804; &#180;alloc_l t &#8743; &#180;allocating_node t =
     Some &#10631;pool = p, level = nat (&#180;from_l t), block = block_num (&#180;mem_pool_info p) (&#180;blk t) (&#180;lsizes t ! nat (&#180;from_l t)),
             data = &#180;blk t&#10632;&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#10627;&#180;from_l t &#8804; &#180;alloc_l t&#10628; &#8745; &#10627;&#180;allocating_node t =
     Some &#10631;pool = p, level = nat (&#180;from_l t), block = block_num (&#180;mem_pool_info p) (&#180;blk t) (&#180;lsizes t ! nat (&#180;from_l t)),
             data = &#180;blk t&#10632;&#10628;&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_0_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V = Va&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{(s, t). s = t}&quot;</span></span></span><span> </span><span>UNIV</span><span> </span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {Va} = {Va}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>int1_eq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lm1</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;from_l := &#180;from_l(t := &#180;from_l t + 1)) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {V}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>int1_eq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;from_l := (from_l V)(t := from_l V t + 1)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;from_l := (from_l V)(t := from_l V t + 1)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>less_minus_one_simps</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>smt</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>hide_lams</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>Mem_block.simps</span><span class="delimiter">(</span><span>4</span><span class="delimiter">)</span><span> </span><span>option.sel</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;stm5&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_mempool_info</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;free_l V t &#8804; alloc_l V t &#10233;
  alloc_l V t &lt; int (n_levels (mem_pool_info V p)) &#10233;
  p &#8712; mem_pools V &#10233;
  inv_mempool_info V &#10233;
  &#172; free_l V t &lt; OK &#10233;
  NULL &lt; blk V t &#10233;
  inv_mempool_info
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
        allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rename_tac</span><span> </span><span>ii</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (bits ((levels (mem_pool_info V p))
                   [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                      &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                         [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;] !
                   ii))=length (bits (levels (mem_pool_info V p) ! ii))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ii = nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_h1</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node V t =
    Some &#10631;pool = p, level = nat (alloc_l V t), block = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t), data = blk V t&#10632; &#10233;
    &#8704;t n. allocating_node V t = Some n &#10230; get_bit_s V (pool n) (level n) (block n) = ALLOCATING &#10233;
    get_bit_s V p (nat (alloc_l V t)) ((blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)) = ALLOCATING&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_freelist</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node V t =
  Some &#10631;pool = p, level = nat (alloc_l V t), block = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t), data = blk V t&#10632; &#10233;
  alloc_l V t &lt; int (n_levels (mem_pool_info V p)) &#10233;
  p &#8712; mem_pools V &#10233;
  inv_mempool_info V &#8743; inv_aux_vars V &#8743; inv_bitmap_freelist V &#10233;
  inv_bitmap_freelist
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
        allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_freelist
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;)&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap_freelist (set_bit_s V p (nat (alloc_l V t))
    ((blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)) ALLOCATED)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V p (nat (alloc_l V t))
                    ((blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;t n. allocating_node V t = Some n &#10230; get_bit_s V (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_aux_vars_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_freelist_presv_setbit_notfree</span><span class="delimiter">[</span><span>of</span><span> </span><span>p</span><span> </span><span>V</span><span> </span><span>ALLOCATED</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (alloc_l V t)&quot;</span></span></span><span>
</span><span>    </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node V t =
  Some &#10631;pool = p, level = nat (alloc_l V t), block = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t), data = blk V t&#10632; &#10233;
  p &#8712; mem_pools V &#10233;
  inv_bitmap V &#8743; inv_aux_vars V &#10233;
  inv_bitmap
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
        allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;)&#10632;)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;inv_bitmap (set_bit_s V p (nat (alloc_l V t))
    ((blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)) ALLOCATED)&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>set_bit_s_def</span><span> </span><span>set_bit_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V p (nat (alloc_l V t))
                    ((blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8704;t n. allocating_node V t = Some n &#10230; get_bit_s V (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_aux_vars_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>inv_bitmap_presv_setbit</span><span class="delimiter">[</span><span>of</span><span> </span><span>V</span><span> </span><span>p</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (alloc_l V t)&quot;</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span>
</span><span>        </span><span>ALLOCATED</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;set_bit_s V p (nat (alloc_l V t)) ((blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)) ALLOCATED&quot;</span></span></span><span class="delimiter">]</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_aux_vars</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) &lt; n_max (mem_pool_info V p) * 4 ^ nat (alloc_l V t) &#10233;
    blk V t =
    buf (mem_pool_info V p) +
    (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) * (max_sz (mem_pool_info V p) div 4 ^ nat (alloc_l V t)) &#10233;
  0 &lt; blk V t &#10233;
  allocating_node V t =
  Some &#10631;pool = p, level = nat (alloc_l V t), block = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t),
          data = blk V t&#10632; &#10233;
  alloc_l V t &lt; int (n_levels (mem_pool_info V p)) &#10233;
  p &#8712; mem_pools V &#10233;
  inv_mempool_info V &#8743; inv_aux_vars V &#10233;
  &#8704;ii&lt;length (lsizes V t). lsizes V t ! ii = ALIGN4 (max_sz (mem_pool_info V p)) div 4 ^ ii &#10233;
  inv_aux_vars
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
        allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>inv_aux_vars_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V p (nat (alloc_l V t))
                    ((blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_h1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid V (&#10631;pool = p, level = nat (alloc_l V t),
                    block = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t), data = blk V t&#10632;)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t n. freeing_node s t = Some n &#10230; get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node V ta = Some n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = p &#8743; level n = nat (alloc_l V t)
        &#8743; block n = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool n) (level n) (block n) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool n) (level n) (block n) = get_bit_s
             (V&#10631;mem_pool_info := (mem_pool_info V)
                  (p := mem_pool_info V p
                     &#10631;levels := (levels (mem_pool_info V p))
                        [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                           &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                              [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
                  allocating_node := (allocating_node V)(t := None)&#10632;) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n &#8800; p&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8800; nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8800; (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8805; length (levels (mem_pool_info V (pool n)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = FREEING &#8743; mem_block_addr_valid s n
                &#10230; (&#8707;t. freeing_node s t = Some n) *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;ta. freeing_node V ta = Some n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool n) (level n) (block n) = FREEING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n &#8800; p&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8800; nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8800; (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8805; length (levels (mem_pool_info V (pool n)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8805; length (levels (mem_pool_info V (pool n)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8805; length (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid V n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t n. allocating_node s t = Some n &#10230;
                    get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t &#8800; ta&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node V ta = Some n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = p &#8743; level n = nat (alloc_l V t)
        &#8743; block n = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool n) (level n) (block n) = get_bit_s
             (V&#10631;mem_pool_info := (mem_pool_info V)
                  (p := mem_pool_info V p
                     &#10631;levels := (levels (mem_pool_info V p))
                        [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                           &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                              [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
                  allocating_node := (allocating_node V)(t := None)&#10632;) (pool n) (level n) (block n)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n &#8800; p&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8800; nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8800; (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8805; length (levels (mem_pool_info V (pool n)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>argo</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;n. get_bit (mem_pool_info s) (pool n) (level n) (block n) = ALLOCATING &#8743; mem_block_addr_valid s n
                &#10230; (&#8707;t. allocating_node s t = Some n) *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (alloc_l V t) &lt; length (levels (mem_pool_info V p))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>int_nat_eq</span><span> </span><span>of_nat_0_less_iff</span><span> </span><span>of_nat_less_imp_less</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)
                    &lt; length (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(pool n = p &#8743; level n = nat (alloc_l V t)
        &#8743; block n = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n &#8800; p&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8800; nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8800; (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#8707;ta. ta &#8800; t &#8743; allocating_node V ta = Some n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;get_bit_s V (pool n) (level n) (block n) = ALLOCATING&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;pool n &#8800; p&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8800; nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8800; (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8805; length (levels (mem_pool_info V (pool n)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;level n &#8805; length (levels (mem_pool_info V (pool n)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;block n &#8805; length (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mem_block_addr_valid V n&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>Mem_block.select_convs</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span>option.sel</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. t1 &#8800; t2 &#8743; freeing_node s t1 = Some n1 &#8743; freeing_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. t1 &#8800; t2 &#8743; allocating_node s t1 = Some n1 &#8743; allocating_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node V t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t = t1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node V t2 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t = t2&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8704;t1 t2 n1 n2. allocating_node s t1 = Some n1 &#8743; freeing_node s t2 = Some n2
                        &#10230; &#172;(pool n1 = pool n2 &#8743; level n1 = level n2 &#8743; block n1 = block n2) *)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;allocating_node V t1 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;t = t1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;freeing_node V t2 = Some n1&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap0</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools V &#10233;
    inv_mempool_info V &#8743; inv_bitmap0 V  &#10233;
    inv_bitmap0
     (V&#10631;mem_pool_info := (mem_pool_info V)
          (p := mem_pool_info V p
             &#10631;levels := (levels (mem_pool_info V p))
                [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                   &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                      [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
          allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V p)) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (alloc_l V t) = 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmapn</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools V &#10233;
  inv_mempool_info V &#8743; inv_bitmapn V  &#10233;
  inv_bitmapn
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
        allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V p)) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (alloc_l V t) = length (levels (mem_pool_info V p)) - Suc 0&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_not4free</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) &lt; n_max (mem_pool_info V p) * 4 ^ nat (alloc_l V t) &#10233;
  alloc_l V t &lt; int (n_levels (mem_pool_info V p)) &#10233;
  p &#8712; mem_pools V &#10233;
  inv_mempool_info V &#8743; inv_bitmap_not4free V &#10233;
  inv_bitmap_not4free
   (V&#10631;mem_pool_info := (mem_pool_info V)
        (p := mem_pool_info V p
           &#10631;levels := (levels (mem_pool_info V p))
              [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                 &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                    [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
        allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;length (levels (mem_pool_info V p)) &gt; 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (alloc_l V t) &lt; length (levels (mem_pool_info V p))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>int_nat_eq</span><span> </span><span>of_nat_0_less_iff</span><span> </span><span>of_nat_less_imp_less</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_not4free_def</span><span> </span><span>partner_bits_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t)
                    &lt; length (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span> </span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;nat (alloc_l V t) &lt; length (levels (mem_pool_info V p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) = j div 4 * 4&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) = Suc (j div 4 * 4)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) = Suc (Suc (j div 4 * 4))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) = j div 4 * 4 + 3&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>force</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) &lt; n_max (mem_pool_info V p) * 4 ^ nat (alloc_l V t) &#10233;
    blk V t = buf (mem_pool_info V p) + (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) *
        (max_sz (mem_pool_info V p) div 4 ^ nat (alloc_l V t)) &#10233;
    allocating_node V t =
    Some &#10631;pool = p, level = nat (alloc_l V t), block = (blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t),
            data = blk V t&#10632; &#10233;
    free_l V t &#8804; alloc_l V t &#10233;
    alloc_l V t &lt; int (n_levels (mem_pool_info V p)) &#10233;
    length (lsizes V t) &#8804; n_levels (mem_pool_info V p) &#10233;
    p &#8712; mem_pools V &#10233;
    inv V &#10233;
    &#8704;ii&lt;length (lsizes V t). lsizes V t ! ii = ALIGN4 (max_sz (mem_pool_info V p)) div 4 ^ ii &#10233;
    &#172; free_l V t &lt; OK &#10233;
    NULL &lt; blk V t &#10233;
    &#8704;ii&#8804;nat (alloc_l V t). sz &#8804; lsizes V t ! ii &#10233;
    alloc_l V t = int (length (lsizes V t)) - 1 &#8743; length (lsizes V t) = n_levels (mem_pool_info V p) &#8744;
    alloc_l V t = int (length (lsizes V t)) - 2 &#8743; lsizes V t ! nat (int (length (lsizes V t)) - 1) &lt; sz &#10233;
    inv (V&#10631;mem_pool_info := (mem_pool_info V)
          (p := mem_pool_info V p
             &#10631;levels := (levels (mem_pool_info V p))
                [nat (alloc_l V t) := (levels (mem_pool_info V p) ! nat (alloc_l V t))
                   &#10631;bits := (bits (levels (mem_pool_info V p) ! nat (alloc_l V t)))
                      [(blk V t - buf (mem_pool_info V p)) div lsizes V t ! nat (alloc_l V t) := ALLOCATED]&#10632;]&#10632;),
          allocating_node := (allocating_node V)(t := None)&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_mempool_info</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_freelist</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_aux_vars</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmapn</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>                    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv_bitmap_not4free</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8800; {} &#10233;
   &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;mem_pool_info :=
      set_bit_alloc &#180;mem_pool_info p (nat (&#180;alloc_l t)) (block_num (&#180;mem_pool_info p) (&#180;blk t) (&#180;lsizes t ! nat (&#180;alloc_l t)));;
      &#180;allocating_node := &#180;allocating_node (t := None) )
   sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond2_1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V},
        {(s, t). s = t}, UNIV,&#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745; mp_alloc_precond2_1_3 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V}={V}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>int1_eq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628;&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{V&#10631;mem_pool_info := set_bit_alloc (mem_pool_info V) p (nat (alloc_l V t))
        (block_num ((mem_pool_info V) p) (blk V t) (lsizes V t ! nat (alloc_l V t)))&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := set_bit_alloc &#180;mem_pool_info p (nat (&#180;alloc_l t))
                                  (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;allocating_node := &#180;allocating_node (t := None) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_bit_def</span><span> </span><span>block_num_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; Mem_pool_alloc_guar t *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i = nat (alloc_l V t)&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i &lt; length (levels (mem_pool_info V p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;alloc_l V t = int (length (lsizes V t)) - 1 &#8743; length (lsizes V t) = n_levels (mem_pool_info V p)&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>         </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm5_lm</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;mem_pool_info := set_bit_alloc &#180;mem_pool_info p (nat (&#180;alloc_l t))
                            (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))));;
           &#180;allocating_node := &#180;allocating_node (t := None)
      ) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond2_1_2 t p sz timeout, Mem_pool_alloc_rely t, Mem_pool_alloc_guar t,
              mp_alloc_precond2_1_3 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm_1</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>timeout</span><span> </span><span>sz</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_3 t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;stm6&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm6_lm</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; &#180;mempoolalloc_ret := &#180;mempoolalloc_ret (t :=
        Some &#10631;pool = p, level = nat (&#180;alloc_l t),
              block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))),
              data = &#180;blk t &#10632;))
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond2_1_3 t p sz timeout, Mem_pool_alloc_rely t, Mem_pool_alloc_guar t,
              mp_alloc_precond2_1_4 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;mempoolalloc_ret := mempoolalloc_ret V(t &#8614;
           &#10631;pool = p, level = nat (alloc_l V t), block = block_num (mem_pool_info V p) (blk V t) (lsizes V t ! nat (alloc_l V t)),
              data = blk V t&#10632;)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;mempoolalloc_ret := mempoolalloc_ret V(t &#8614;
         &#10631;pool = p, level = nat (alloc_l V t), block = block_num (mem_pool_info V p) (blk V t) (lsizes V t ! nat (alloc_l V t)),
            data = blk V t&#10632;)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>int_nat_eq</span><span> </span><span>inv_maxsz_align4</span><span> </span><span>less_imp_le_nat</span><span> </span><span>not_less</span><span> </span><span>of_nat_less_iff</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;&#172;(alloc_l V t = int (length (lsizes V t)) - 1 &#8743; length (lsizes V t) = n_levels (mem_pool_info V p))&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>smt</span><span> </span><span>Suc_nat_eq_nat_zadd1</span><span> </span><span>inv_maxsz_align4</span><span> </span><span>lessI</span><span> </span><span>nat_int</span><span> </span><span>power_Suc</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;stm7&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm7_precond1 Va &#8801; Va&#10631;thd_state := (thd_state Va)(the (cur Va) := BLOCKED)&#10632;&quot;</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_stm7_precond3 Va t p &#8801;
  Va&#10631;mem_pool_info := (mem_pool_info Va)(p := (mem_pool_info Va p)&#10631;wait_q := (wait_q (mem_pool_info Va p))@ [the (cur Va)]&#10632;)&#10632;&quot;</span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm7_lm_2_1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(&#955;a. if a = p then mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;
           else mem_pool_info (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;) a) x
        = (&#955;a. if a = p then mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;
           else mem_pool_info Va a) x&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;x = p&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm7_lm_2_2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur Va = Some t &#10233;
    (&#955;a. if a = p
         then mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [the (cur (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;))]&#10632;
         else mem_pool_info (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;) a) =
    (&#955;a. if a = p then mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632; else mem_pool_info Va a)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_lm_2_1</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm7_lm_2</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur Va = Some t &#10233;
    (&#955;a. if a = p then
          mem_pool_info (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;) p
                    &#10631;wait_q := wait_q (mem_pool_info (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;) p)
                      @ [the (cur (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;))]&#10632;
         else mem_pool_info (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;) a) =
    (mem_pool_info Va)(p := mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED)&#10632;) p&quot;</span></span></span><span>
</span><span>          </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mem_pool_info Va p&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>fun_upd_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_lm_2_2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm7_swap_ifbody_inv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233;
    inv Va &#10233;
    cur Va = Some t &#10233;
    (if ta = t then BLOCKED else thd_state Va ta) = READY &#10233;
    inv (mp_alloc_stm7_precond3 Va t p
            &#10631;cur := Some (SOME ta. ta &#8800; t &#8743; (ta &#8800; t &#10230; thd_state Va ta = READY)),
               thd_state :=
                 &#955;x. if x = (SOME ta. ta &#8800; t &#8743; (ta &#8800; t &#10230; thd_state Va ta = READY)) then RUNNING
                     else thd_state
                           (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED),
                                 mem_pool_info := (mem_pool_info Va)
                                   (p := mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;),
                                 cur := Some (SOME ta. (ta = t &#10230; BLOCKED = READY) &#8743; (ta &#8800; t &#10230; thd_state Va ta = READY))&#10632;)
                           x&#10632;)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state Va t = RUNNING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_cur_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;ta &#8800; t &#8743; thd_state Va ta = READY&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Thread_State_Type.distinct</span><span class="delimiter">(</span><span>3</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>presburger</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(SOME ta. ta &#8800; t &#8743; (ta &#8800; t &#10230; thd_state Va ta = READY)) &#8800; t&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>exE_some</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#955;tb. tb &#8800; t &#8743; (tb &#8800; t &#10230; thd_state Va tb = READY)&quot;</span></span></span><span>
</span><span>                    </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>c</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;SOME tb. tb &#8800; t &#8743; (tb &#8800; t &#10230; thd_state Va tb = READY)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state Va (SOME ta. ta &#8800; t &#8743; (ta &#8800; t &#10230; thd_state Va ta = READY)) = READY&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>exE_some</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>P</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;&#955;tb. tb &#8800; t &#8743; (tb &#8800; t &#10230; thd_state Va tb = READY)&quot;</span></span></span><span>
</span><span>                    </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>c</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;SOME tb. tb &#8800; t &#8743; (tb &#8800; t &#10230; thd_state Va tb = READY)&quot;</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Thread_State_Type.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span> </span><span>diff_is_0_eq&#39;</span><span>
</span><span>                        </span><span>less_Suc_eq</span><span> </span><span>less_Suc_eq_le</span><span> </span><span>nth_Cons_0</span><span> </span><span>nth_append</span><span> </span><span>nth_mem</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_aux_vars_def</span><span> </span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span class="delimiter">)</span><span>
</span><span>                    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_not4free_def</span><span> </span><span>partner_bits_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm7_swap_elsebody_inv</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;p &#8712; mem_pools Va &#10233;
    inv Va &#10233;
    cur Va = Some t &#10233;
    (if ta = t then BLOCKED else thd_state Va ta) &#8800; READY &#10233;
    inv (cur_update Map.empty
       (Va&#10631;thd_state := (thd_state Va)(t := BLOCKED),
             mem_pool_info := (mem_pool_info Va)(p := mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;)&#10632;))&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;thd_state Va t = RUNNING&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_cur_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_cur_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_thd_waitq_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Thread_State_Type.distinct</span><span class="delimiter">(</span><span>6</span><span class="delimiter">)</span><span> </span><span>diff_is_0_eq&#39;</span><span> </span><span>less_Suc_eq</span><span>
</span><span>                              </span><span>less_Suc_eq_le</span><span> </span><span>nth_Cons_0</span><span> </span><span>nth_append</span><span> </span><span>nth_mem</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>Thread_State_Type.distinct</span><span class="delimiter">(</span><span>5</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_freelist_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>inv_aux_vars_def</span><span> </span><span>mem_block_addr_valid_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap0_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmapn_def</span><span class="delimiter">)</span><span>
</span><span>                    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_bitmap_not4free_def</span><span> </span><span>partner_bits_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm7_lm_1</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; UNIV &#8745; {Va} &#8800; {} &#10233;
  &#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (&#180;thd_state := &#180;thd_state(the &#180;cur := BLOCKED);;
    &#180;mem_pool_info := &#180;mem_pool_info(p := &#180;mem_pool_info p&#10631;wait_q := wait_q (&#180;mem_pool_info p) @ [the &#180;cur] &#10632;);;
    swap )
  sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_8_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; UNIV &#8745; {Va},
      {(s, t). s = t}, UNIV, &#10627;&#180;(Pair Va) &#8712; UNIV&#10628; &#8745; (&#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628; &#8745;
                                       (mp_alloc_precond1_8_2_2 t p sz timeout))]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;V = Va&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; UNIV &#8745; {Va} = {Va}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; UNIV &#8745; {Va}&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{V}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm7_precond3 (mp_alloc_stm7_precond1 Va) t p}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{mp_alloc_stm7_precond1 Va}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;thd_state := &#180;thd_state(the &#180;cur := BLOCKED);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>fun_upd_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#180;mem_pool_info := &#180;mem_pool_info(p := &#180;mem_pool_info p&#10631;wait_q := wait_q (&#180;mem_pool_info p) @ [t] &#10632;);; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_lm_2</span><span class="delimiter">[</span><span>of</span><span> </span><span>Va</span><span> </span><span>t</span><span> </span><span>p</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>swap_def</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* swap *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF (&#8707;t. &#180;thd_state t = READY) THEN
        &#180;cur := Some (SOME t. &#180;thd_state t = READY);;
        &#180;thd_state := &#180;thd_state(the &#180;cur := RUNNING) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;{Va&#10631;thd_state := (thd_state Va)(t := BLOCKED),
                                mem_pool_info := (mem_pool_info Va)
                                  (p := mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;)&#10632;} &#8745;
                          &#10627;&#8707;t. &#180;thd_state t = READY&#10628; = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>subst</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>t</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Va&#10631;thd_state := (thd_state Va)(t := BLOCKED),
                                mem_pool_info := (mem_pool_info Va)
                                  (p := mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;)&#10632;} &#8745;
                          &#10627;&#8707;t. &#180;thd_state t = READY&#10628;&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>s</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{Va&#10631;thd_state := (thd_state Va)(t := BLOCKED),
                                mem_pool_info := (mem_pool_info Va)
                                  (p := mem_pool_info Va p&#10631;wait_q := wait_q (mem_pool_info Va p) @ [t]&#10632;)&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;{let V = mp_alloc_stm7_precond3 (mp_alloc_stm7_precond1 Va) t p in
                                V&#10631;cur := Some (SOME t. (thd_state V) t = READY)&#10632;}&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* swap: &#180;thd_state := &#180;thd_state(the &#180;cur := READY);; *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* swap: &#180;thd_state := &#180;thd_state(the &#180;cur := RUNNING) *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; Mem_pool_alloc_guar t *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_ifbody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_ifbody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; Mem_pool_alloc_guar t *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_ifbody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_ifbody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE
        &#180;cur := None
      FI *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; Mem_pool_alloc_guar t *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_elsebody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_elsebody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* &#8712; Mem_pool_alloc_guar t *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_elsebody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_swap_elsebody_inv</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm7_lm</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;&#915; &#8866;<span class="hidden">&#8681;</span><sub>I</sub> Some (t &#9656; ATOMIC
          &#180;thd_state := &#180;thd_state(the &#180;cur := BLOCKED);;
          &#180;mem_pool_info := &#180;mem_pool_info(p := &#180;mem_pool_info p&#10631;wait_q := wait_q (&#180;mem_pool_info p) @ [the &#180;cur] &#10632;);;
          swap
        END) sat<span class="hidden">&#8681;</span><sub>p</sub> [mp_alloc_precond1_8_2_2 t p sz timeout, Mem_pool_alloc_rely t, Mem_pool_alloc_guar t,
              mp_alloc_precond1_8_2_2 t p sz timeout]&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_2 t p sz timeout &#8745;
                          &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745; UNIV &#8745; {Va} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Emptyprecond</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_lm_1</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>meson</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">term</span></span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_2 t p sz timeout&quot;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span class="cartouche"><span class="delete"><span class="delete">&#8249;final proof&#8250;</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm8_guar</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233; V&#10631;rf := (rf V)(t := True)&#10632; &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;rf := (rf V)(t := True)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mp_alloc_stm9_guar</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">&quot;cur V = Some t &#10233; inv V &#10233; V&#10631;ret := (ret V)(t := ETIMEOUT)&#10632; &#8712; &#10627;&#180;(Pair V) &#8712; Mem_pool_alloc_guar t&#10628;&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>alloc_ev_satRG</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">&quot;&#8866;<span class="hidden">&#8681;</span><sub>I</sub> (malloc_ev t p sz timeout) sat<span class="hidden">&#8681;</span><sub>p</sub> [Mem_pool_free_pre t &#8745; &#10627;p &#8712; &#180;mem_pools &#8743; ETIMEOUT &#8804; timeout&#10628;, 
                 Mem_pool_alloc_rely t, Mem_pool_alloc_guar t, Mem_pool_alloc_post t] &#8743; 
       PiCore_Hoare.stable (Mem_pool_free_pre t) (Mem_pool_alloc_rely t) &#8743; (&#8704;s. (s, s) &#8712; Mem_pool_alloc_guar t)&quot;</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span>                                                                                         
</span><span>  </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>malloc_ev_def</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond7 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond6 t p timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond5 t p timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond4 t p timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond3 t p timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2 t p timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;tmout := &#180;tmout(t := timeout));; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1 t p timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;tmout := (tmout V)(t := timeout)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;tmout := (tmout V)(t := timeout)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;endt := &#180;endt(t := 0));; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2 t p timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;endt := (endt V)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;endt := (endt V)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; IF timeout &gt; 0 THEN
           &#180;endt := &#180;endt(t := &#180;tick + nat timeout)
         FI);; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond3 t p timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;endt := (endt V)(t := tick V + nat (tmout V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;endt := (endt V)(t := tick V + nat (tmout V t))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond3 t p timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} &#8745;
         - &#10627;OK &lt; timeout&#10628; = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;mempoolalloc_ret := &#180;mempoolalloc_ret (t := None));; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2 t p timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;mempoolalloc_ret := (mempoolalloc_ret V)(t := None)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;mempoolalloc_ret := (mempoolalloc_ret V)(t := None)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;ret := &#180;ret(t := ESIZEERR));; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond5 t p timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ESIZEERR)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ESIZEERR)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;rf := &#180;rf(t := False));; *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond6 t p timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;rf := (rf V)(t := False)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;rf := (rf V)(t := False)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* WHILE &#172; (&#180;rf t) DO *)</span></span></span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>While</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_post_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_post_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>       </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>stable_equiv</span><span> </span><span>mem_pool_alloc_pre_stb</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq2</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mida</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_7 t p sz timeout&quot;</span></span></span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>midb</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*apply(rule Seq[where mid=&quot;mp_alloc_precond1_7 t p sz timeout&quot;])*)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_6 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_5 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_4 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_3 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_2 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_1 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;blk := &#180;blk(t := NULL));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_0_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;blk := (blk V)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;blk := (blk V)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;blk := (blk V)(t := NULL)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;alloc_lsize_r := &#180;alloc_lsize_r(t := False));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_lsize_r := (alloc_lsize_r V)(t := False)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_lsize_r := (alloc_lsize_r V)(t := False)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_lsize_r := (alloc_lsize_r V)(t := False)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;alloc_l := &#180;alloc_l(t := -1));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_l := (alloc_l V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_l := (alloc_l V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;alloc_l := (alloc_l V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;free_l := &#180;free_l(t := -1));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_3 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;free_l := (free_l V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;free_l := (free_l V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;free_l := (free_l V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;lsizes := &#180;lsizes(t := [ALIGN4 (max_sz (&#180;mem_pool_info p))]));; *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_4 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := [ALIGN4 (max_sz (mem_pool_info V p))])&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := [ALIGN4 (max_sz (mem_pool_info V p))])&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;lsizes := (lsizes V)(t := [ALIGN4 (max_sz (mem_pool_info V p))])&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;i := &#180;i(t := 0)) *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_6_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_5 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := 0)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                  </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := 0)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;i := (i V)(t := 0)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>meson</span><span> </span><span>Suc_leI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*  WHILE &#180;i t &lt; n_levels (&#180;mem_pool_info p) &#8743; &#172; &#180;alloc_lsize_r t DO *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>lsize_loop_stm</span><span class="delimiter">[</span><span>of</span><span> </span><span>t</span><span> </span><span>p</span><span> </span><span>sz</span><span> </span><span>timeout</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarsimp</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>precnd17_bl_170</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;alloc_l t &lt; 0 THEN
        (t &#9656; &#180;ret := &#180;ret(t := ESIZEERR))
      ELSE
        IF &#180;free_l t &lt; 0 THEN ..... *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;ret := &#180;ret(t := ESIZEERR)) *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ESIZEERR)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ESIZEERR)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;free_l t &lt; 0 THEN
          (* block-&gt;data = NULL; *)
          (t &#9656; &#180;ret := &#180;ret(t := ENOMEM))
        ELSE ... *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>        </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;ret := &#180;ret(t := ENOMEM)) *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_70_2_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_70_2_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ENOMEM)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ENOMEM)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>        </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE ... *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm3_lm</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>        </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;blk t = NULL THEN
            (t &#9656; &#180;ret := &#180;ret (t := EAGAIN))
          ELSE *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;ret := &#180;ret (t := EAGAIN)) *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_0_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_0 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := EAGAIN)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := EAGAIN)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE ... *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_4 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_3 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_2 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1_loopinv t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* t &#9656; &#180;from_l := &#180;from_l(t := &#180;free_l t)) *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_1_loopinv_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;from_l := (from_l V)(t := free_l V t)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;i V t = 0&quot;</span></span></span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>inv_def</span><span> </span><span>inv_mempool_info_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;from_l := (from_l V)(t := free_l V t)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* FOR (t &#9656; &#180;from_l := &#180;from_l(t := &#180;free_l t));
                 &#180;from_l t &lt; &#180;alloc_l t;
                (t &#9656; &#180;from_l := &#180;from_l(t := &#180;from_l t + 1)) DO *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm4_lm</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;mem_pool_info := set_bit_alloc &#180;mem_pool_info p (nat (&#180;alloc_l t))
                                  (block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))));;
                 &#180;allocating_node := &#180;allocating_node (t := None)
            ) *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm5_lm</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;mempoolalloc_ret := &#180;mempoolalloc_ret (t :=
              Some &#10631;pool = p, level = nat (&#180;alloc_l t),
                    block = block_num (&#180;mem_pool_info p) (&#180;blk t) ((&#180;lsizes t)!(nat (&#180;alloc_l t))),
                    data = &#180;blk t &#10632;));; *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm6_lm</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;ret := &#180;ret (t := OK)) *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond2_1_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond2_1_4 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := OK)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := OK)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>stable_id2</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;ret t = OK &#8744; timeout = NOWAIT &#8744; &#180;ret t = ESIZEERR THEN
        (t &#9656; &#180;rf := &#180;rf(t := True));;
        IF &#180;ret t = EAGAIN THEN &#180;ret := &#180;ret(t := ENOMEM) FI  (*EAGAIN should not export to users*)
      ELSE *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_1_1 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;rf := &#180;rf(t := True));; *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_1 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>clarify</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                    </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;rf := (rf V)(t := True)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>IntI</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                    </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;rf := (rf V)(t := True)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>alloc_memblk_valid_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;ret t = EAGAIN THEN (*EAGAIN should not export to users*)
          (t &#9656; &#180;ret := &#180;ret(t := ENOMEM))
        FI *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_1_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>        </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;ret := &#180;ret(t := ENOMEM)) *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stm_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_1_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_1_2 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ENOMEM)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ENOMEM)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE SKIP *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Skip_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_1_3_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>      </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE
          IF &#180;ret t = EAGAIN THEN SKIP
          ELSE ... *)</span></span></span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Skip_def</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_1_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_2 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>        </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm7_lm</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>
</span><span>        </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;tmout t &#8800; FOREVER THEN
            (t &#9656; &#180;tmout := &#180;tmout (t := int (&#180;endt t) - int &#180;tick));;
            IF &#180;tmout t &lt; 0 THEN
              (t &#9656; &#180;rf := &#180;rf(t := True));;
              (t &#9656; &#180;ret := &#180;ret (t := ETIMEOUT))
            FI
          FI *)</span></span></span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_2_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_4 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* (t &#9656; &#180;tmout := &#180;tmout (t := int (&#180;endt t) - int &#180;tick));; *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_3_stb</span><span> </span><span>mp_pred1823_eq</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_3 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjI1</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span>
</span><span>                        </span><span>gvars_conf_stable_def</span><span> </span><span>gvars_conf_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;tmout := (tmout V)(t := int (endt V t) - int (tick V))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;tmout := (tmout V)(t := int (endt V t) - int (tick V))&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* IF &#180;tmout t &lt; 0 THEN
                (t &#9656; &#180;rf := &#180;rf(t := True));;
                (t &#9656; &#180;ret := &#180;ret (t := ETIMEOUT))
              FI *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Cond</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_4_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Seq</span><span class="delimiter">[</span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>mid</span><span class="delimiter">=</span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_5 t p sz timeout&quot;</span></span></span><span class="delimiter">]</span><span class="delimiter">)</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_40_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_40 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm8_guar</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;rf := (rf V)(t := True)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm8_guar</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;rf := (rf V)(t := True)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm8_guar</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>stm_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Await</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_5_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>case_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;mp_alloc_precond1_8_2_5 t p sz timeout &#8745; &#10627;&#180;cur = Some t&#10628; &#8745; {V} = {}&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm9_guar</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_stm9_guar</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>subgoal_tac</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;(V,V&#10631;ret := (ret V)(t := ETIMEOUT)&#10632;)&#8712;lvars_nochange1_4all&quot;</span></span></span><span class="delimiter">)</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>glnochange_inv0</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>lvars_nochange1_4all_def</span><span> </span><span>lvars_nochange1_def</span><span> </span><span>lvars_nochange_def</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>stable_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_41_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span><span> </span><span>2</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>          </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* ELSE SKIP &#8230; *)</span></span></span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Skip_def</span><span class="delimiter">)</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>            </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Basic</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>auto</span><span class="delimiter">[</span><span>1</span><span class="delimiter">]</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond1_8_2_20_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fast</span><span>
</span><span>              </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>mp_alloc_precond7_stb</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>Mem_pool_alloc_guar_def</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>              </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>Mempool_alloc_satRG</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">&quot;Evt_sat_RG &#915; (Mem_pool_alloc_RGCond t )&quot;</span></span></span><span> 
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Mem_pool_alloc_RGCond_def</span><span> </span><span>Evt_sat_RG_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>Mem_pool_alloc_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>Evt_Basic</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>clarify</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>unfold</span><span> </span><span>body_def</span><span> </span><span>guard_def</span><span> </span><span>snd_conv</span><span> </span><span>fst_conv</span><span class="delimiter">)</span><span> 
</span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>alloc_ev_satRG</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span> 
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span></pre>

</div>
</body>
</html>
